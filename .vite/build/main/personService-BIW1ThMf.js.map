{"version":3,"file":"personService-BIW1ThMf.js","sources":["../../../electron/services/personService.ts"],"sourcesContent":["/**\n * PhotoMind - 人物管理服务\n *\n * 功能：\n * 1. 人物 CRUD 操作\n * 2. 照片人物标记/取消标记\n * 3. 人物照片查询\n */\nimport { PhotoDatabase } from '../database/db.js'\n\nexport interface Person {\n  id: number\n  name: string\n  display_name: string\n  face_count: number\n  created_at: string\n  is_manual: boolean\n}\n\nexport interface PersonTag {\n  id: number\n  photo_id: number\n  person_id: number\n  person_name: string\n  bounding_box?: BoundingBox\n  confidence: number\n  is_manual: boolean\n}\n\nexport interface BoundingBox {\n  x: number\n  y: number\n  width: number\n  height: number\n}\n\nexport interface AddPersonParams {\n  name: string\n  displayName?: string\n}\n\nexport interface TagPersonParams {\n  photoId: number\n  personId: number\n  boundingBox?: BoundingBox\n}\n\nexport class PersonService {\n  private database: PhotoDatabase\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || new PhotoDatabase()\n  }\n\n  /**\n   * 获取所有人物\n   */\n  getAllPersons(): Person[] {\n    const persons = this.database.getAllPersons()\n    return persons.map((p: any) => ({\n      id: p.id,\n      name: p.name,\n      display_name: p.display_name || p.name,\n      face_count: p.face_count || 0,\n      created_at: p.created_at,\n      is_manual: !!p.is_manual\n    }))\n  }\n\n  /**\n   * 根据 ID 获取人物\n   */\n  getPersonById(id: number): Person | null {\n    const person = this.database.getPersonById(id)\n    if (!person) return null\n\n    return {\n      id: person.id,\n      name: person.name,\n      display_name: person.display_name || person.name,\n      face_count: person.face_count || 0,\n      created_at: person.created_at,\n      is_manual: !!person.is_manual\n    }\n  }\n\n  /**\n   * 添加新人物\n   */\n  addPerson(params: AddPersonParams): { success: boolean; personId?: number; error?: string } {\n    try {\n      // 检查是否已存在（不区分大小写）\n      const existing = this.searchPersons(params.name)\n      const normalizedName = params.name.toLowerCase().trim()\n      const found = existing.find(p => p.name.toLowerCase() === normalizedName)\n\n      if (found) {\n        return {\n          success: false,\n          error: `人物 \"${params.name}\" 已存在`\n        }\n      }\n\n      const personId = this.database.addPerson({\n        name: params.name,\n        displayName: params.displayName || params.name\n      })\n\n      console.log(`[PersonService] 添加新人物: ${params.name} (ID: ${personId})`)\n      return { success: true, personId }\n    } catch (error) {\n      console.error('[PersonService] 添加人物失败:', error)\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : '未知错误'\n      }\n    }\n  }\n\n  /**\n   * 更新人物信息\n   */\n  updatePerson(id: number, params: Partial<AddPersonParams>): boolean {\n    return this.database.updatePerson(id, {\n      name: params.name,\n      displayName: params.displayName\n    })\n  }\n\n  /**\n   * 删除人物\n   */\n  deletePerson(id: number): boolean {\n    try {\n      this.database.run('DELETE FROM faces WHERE person_id = ?', [id])\n      this.database.run('DELETE FROM persons WHERE id = ?', [id])\n      console.log(`[PersonService] 删除人物 ID: ${id}`)\n      return true\n    } catch (error) {\n      console.error('[PersonService] 删除人物失败:', error)\n      return false\n    }\n  }\n\n  /**\n   * 搜索人物\n   */\n  searchPersons(query: string): Person[] {\n    const results = this.database.searchPersons(query)\n    return results.map((p: any) => ({\n      id: p.id,\n      name: p.name,\n      display_name: p.display_name || p.name,\n      face_count: p.face_count || 0,\n      created_at: p.created_at,\n      is_manual: !!p.is_manual\n    }))\n  }\n\n  /**\n   * 为照片标记人物\n   */\n  tagPerson(params: TagPersonParams): { success: boolean; tagId?: number; error?: string } {\n    try {\n      // 验证照片存在\n      const photo = this.database.getPhotoById(params.photoId)\n      if (!photo) {\n        return { success: false, error: '照片不存在' }\n      }\n\n      // 验证人物存在\n      const person = this.database.getPersonById(params.personId)\n      if (!person) {\n        return { success: false, error: '人物不存在' }\n      }\n\n      // 检查是否已标记\n      const existingTags = this.database.getFacesByPhoto(params.photoId)\n      const alreadyTagged = existingTags.some((f: any) => f.person_id === params.personId)\n      if (alreadyTagged) {\n        return { success: false, error: '该照片已标记此人物' }\n      }\n\n      // 添加标签\n      const tagId = this.database.addFace({\n        photoId: params.photoId,\n        personId: params.personId,\n        boundingBox: params.boundingBox,\n        confidence: 1.0,\n        isManual: 1  // 手动标记\n      })\n\n      // 更新人物 face_count\n      this.updatePersonFaceCount(params.personId)\n\n      console.log(`[PersonService] 为照片 ${params.photoId} 标记人物: ${person.name}`)\n      return { success: true, tagId }\n    } catch (error) {\n      console.error('[PersonService] 标记人物失败:', error)\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : '未知错误'\n      }\n    }\n  }\n\n  /**\n   * 移除照片的人物标签\n   */\n  untagPerson(photoId: number, personId: number): boolean {\n    try {\n      this.database.run(\n        'DELETE FROM faces WHERE photo_id = ? AND person_id = ?',\n        [photoId, personId]\n      )\n      this.updatePersonFaceCount(personId)\n      console.log(`[PersonService] 移除照片 ${photoId} 的人物标签`)\n      return true\n    } catch (error) {\n      console.error('[PersonService] 移除标签失败:', error)\n      return false\n    }\n  }\n\n  /**\n   * 获取照片的所有人物标签\n   */\n  getPhotoTags(photoId: number): PersonTag[] {\n    const faces = this.database.getFacesByPhoto(photoId)\n    return faces.map((f: any) => ({\n      id: f.id,\n      photo_id: f.photo_id,\n      person_id: f.person_id,\n      person_name: f.person_name || '未知',\n      bounding_box: f.bounding_box ? JSON.parse(f.bounding_box) : undefined,\n      confidence: f.confidence || 0,\n      is_manual: !!f.is_manual\n    }))\n  }\n\n  /**\n   * 获取某人物的所有照片\n   */\n  getPersonPhotos(personId: number): any[] {\n    return this.database.getPhotosByPerson(personId)\n  }\n\n  /**\n   * 根据人物名称搜索照片\n   */\n  searchPhotosByPerson(personName: string): any[] {\n    return this.database.searchPhotosByPerson(personName)\n  }\n\n  /**\n   * 更新人物 face_count\n   */\n  private updatePersonFaceCount(personId: number): void {\n    const photos = this.database.getPhotosByPerson(personId)\n    this.database.run(\n      'UPDATE persons SET face_count = ? WHERE id = ?',\n      [photos.length, personId]\n    )\n  }\n\n  /**\n   * 获取人物统计\n   */\n  getStats(): { totalPersons: number; totalTags: number } {\n    const persons = this.getAllPersons()\n    const totalTags = persons.reduce((sum, p) => sum + p.face_count, 0)\n    return {\n      totalPersons: persons.length,\n      totalTags\n    }\n  }\n\n  /**\n   * 批量标记人物\n   */\n  tagPersons(photoId: number, personIds: number[]): { success: boolean; tagged: number; errors: string[] } {\n    let tagged = 0\n    const errors: string[] = []\n\n    for (const personId of personIds) {\n      const result = this.tagPerson({ photoId, personId })\n      if (result.success) {\n        tagged++\n      } else if (result.error) {\n        errors.push(result.error)\n      }\n    }\n\n    return { success: errors.length === 0, tagged, errors }\n  }\n\n  /**\n   * 移除照片的所有人物标签\n   */\n  untagAllPersons(photoId: number): boolean {\n    try {\n      // 获取所有标签以更新对应的 person face_count\n      const tags = this.getPhotoTags(photoId)\n      const personIds = [...new Set(tags.map(t => t.person_id))]\n\n      this.database.run('DELETE FROM faces WHERE photo_id = ?', [photoId])\n\n      // 更新每个相关人物的 face_count\n      for (const personId of personIds) {\n        this.updatePersonFaceCount(personId)\n      }\n\n      console.log(`[PersonService] 移除照片 ${photoId} 的所有人物标签`)\n      return true\n    } catch (error) {\n      console.error('[PersonService] 移除所有标签失败:', error)\n      return false\n    }\n  }\n}\n\nexport const personService = new PersonService()\n"],"names":[],"mappings":"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"}