{"version":3,"file":"index-BYkeoRh9.js","sources":["../../../electron/services/iCloudService.ts","../../../electron/database/db.ts","../../../electron/services/configService.ts","../../../electron/services/searchService.ts","../../../electron/services/thumbnailService.ts","../../../node_modules/uuid/dist/esm-node/rng.js","../../../node_modules/uuid/dist/esm-node/stringify.js","../../../node_modules/uuid/dist/esm-node/native.js","../../../node_modules/uuid/dist/esm-node/v4.js","../../../electron/services/localPhotoService.ts","../../../electron/services/folderScanner.ts","../../../electron/services/importProgressService.ts","../../../electron/services/embeddingService.ts","../../../electron/services/backgroundVectorService.ts","../../../electron/services/hybridEmbeddingService.ts","../../../electron/services/faceDetectionService.ts","../../../electron/services/scanJobService.ts","../../../electron/services/faceMatchingService.ts","../../../electron/services/faceDetectionQueue.ts","../../../electron/services/importService.ts","../../../electron/services/vectorGenerationService.ts","../../../electron/services/similarityService.ts","../../../electron/services/textPreprocessor.ts","../../../electron/services/semanticSearchService.ts","../../../electron/services/searchSuggestionService.ts","../../../electron/main/index.ts"],"sourcesContent":["/**\n * PhotoMind - iCloud ç…§ç‰‡æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. é€šè¿‡ AppleScript æˆ– apple-photos-js è®¿é—® iCloud ç…§ç‰‡åº“\n * 2. è·å–ç…§ç‰‡åˆ—è¡¨å’Œç›¸å†Œ\n * 3. ä¸‹è½½ç…§ç‰‡åˆ°æœ¬åœ°\n * 4. æ£€æµ‹ iCloud ä¸‹è½½çŠ¶æ€\n */\nimport { exec, execSync } from 'child_process'\nimport { promisify } from 'util'\nimport { PhotoDatabase } from '../database/db.js'\n\nconst execAsync = promisify(exec)\n\n// ç±»å‹å®šä¹‰\nexport interface iCloudPhoto {\n  id: string\n  filename: string\n  date: Date\n  size: number\n  cloudStatus: 'downloaded' | 'waiting' | 'uploading'\n  localPath?: string\n}\n\nexport interface iCloudAlbum {\n  name: string\n  photoCount: number\n}\n\nexport interface iCloudStorageInfo {\n  used: number  // GB\n  available: number  // GB\n}\n\nexport class ICloudService {\n  private libraryPath: string = ''\n  private database: PhotoDatabase\n  private PhotosLibrary: any = null\n  private isAvailable: boolean = false\n\n  constructor(database: PhotoDatabase) {\n    this.database = database\n  }\n\n  /**\n   * æ£€æµ‹ iCloud Photos å¯ç”¨æ€§\n   */\n  async checkAvailability(): Promise<boolean> {\n    try {\n      // æ£€æµ‹ macOS å’Œ iCloud Photos\n      const { stdout } = await execAsync('system_profiler SPSyncServicesDataType | grep \"iCloud\"')\n      this.isAvailable = stdout.includes('iCloud Photos') || stdout.includes('Photos')\n      return this.isAvailable\n    } catch {\n      this.isAvailable = false\n      return false\n    }\n  }\n\n  /**\n   * åˆå§‹åŒ–æœåŠ¡\n   */\n  async initialize(libraryPath: string): Promise<boolean> {\n    try {\n      this.libraryPath = libraryPath\n\n      // å°è¯•åŠ è½½ apple-photos-js\n      try {\n        const PhotosLib = await import('apple-photos-js')\n        this.PhotosLibrary = PhotosLib.default || PhotosLib.Photos\n        console.log('apple-photos-js åŠ è½½æˆåŠŸ')\n      } catch (e) {\n        console.warn('apple-photos-js æœªå®‰è£…ï¼Œä½¿ç”¨ AppleScript æ–¹å¼')\n      }\n\n      // æ£€æµ‹ iCloud å¯ç”¨æ€§\n      await this.checkAvailability()\n\n      console.log('iCloud æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n      return true\n    } catch (error) {\n      console.error('iCloud æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error)\n      return false\n    }\n  }\n\n  /**\n   * è·å– iCloud å¯ç”¨æ€§çŠ¶æ€\n   */\n  getIsAvailable(): boolean {\n    return this.isAvailable\n  }\n\n  /**\n   * è·å–ç›¸å†Œåˆ—è¡¨\n   */\n  async getAlbums(): Promise<iCloudAlbum[]> {\n    // ä¼˜å…ˆä½¿ç”¨ AppleScript\n    if (this.isAvailable) {\n      try {\n        const albums = await this.getAlbumsViaAppleScript()\n        if (albums.length > 0) {\n          return albums\n        }\n      } catch (error) {\n        console.warn('AppleScript è·å–ç›¸å†Œå¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ:', error)\n      }\n    }\n\n    // å¦‚æœæœ‰ PhotosLibraryï¼Œä½¿ç”¨å®ƒ\n    if (this.PhotosLibrary) {\n      try {\n        return this.getAlbumsViaLibrary()\n      } catch (error) {\n        console.warn('PhotosLibrary è·å–ç›¸å†Œå¤±è´¥:', error)\n      }\n    }\n\n    // è¿”å›æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘\n    return this.getMockAlbums()\n  }\n\n  /**\n   * é€šè¿‡ AppleScript è·å–ç›¸å†Œ\n   */\n  private async getAlbumsViaAppleScript(): Promise<iCloudAlbum[]> {\n    const script = `\n      tell application \"Photos\"\n        set albumList to {}\n        repeat with a in albums\n          if a is not null then\n            set end of albumList to {name of a as text, count of media items of a}\n          end if\n        end repeat\n        return albumList\n      end tell\n    `\n\n    try {\n      const { stdout } = await execAsync(`osascript -e '${script.replace(/\\n/g, ' ')}'`)\n      return this.parseAlbumList(stdout)\n    } catch (error) {\n      console.error('AppleScript è·å–ç›¸å†Œå¤±è´¥:', error)\n      return []\n    }\n  }\n\n  /**\n   * é€šè¿‡ PhotosLibrary è·å–ç›¸å†Œ\n   */\n  private getAlbumsViaLibrary(): iCloudAlbum[] {\n    // è¿™éœ€è¦åœ¨ PhotosLibrary å®ä¾‹ä¸Šè°ƒç”¨\n    // ç›®å‰è¿”å›ç©ºæ•°ç»„ï¼Œéœ€è¦åº“æ”¯æŒ\n    console.warn('PhotosLibrary ä¸æ”¯æŒè·å–ç›¸å†Œåˆ—è¡¨')\n    return []\n  }\n\n  /**\n   * è§£æ AppleScript è¿”å›çš„ç›¸å†Œåˆ—è¡¨\n   */\n  private parseAlbumList(stdout: string): iCloudAlbum[] {\n    const albums: iCloudAlbum[] = []\n\n    // AppleScript è¿”å›æ ¼å¼: {albumName1, count1}, {albumName2, count2}, ...\n    const matches = stdout.matchAll(/\\{([^,]+),\\s*(\\d+)\\}/g)\n\n    for (const match of matches) {\n      const name = match[1]?.trim().replace(/\"/g, '')\n      const count = parseInt(match[2], 10)\n\n      if (name && !isNaN(count)) {\n        albums.push({ name, photoCount: count })\n      }\n    }\n\n    return albums\n  }\n\n  /**\n   * è·å–æ¨¡æ‹Ÿç›¸å†Œæ•°æ®\n   */\n  private getMockAlbums(): iCloudAlbum[] {\n    return [\n      { name: 'ä¸ªäººæ”¶è—', photoCount: 1250 },\n      { name: 'æœ€è¿‘é¡¹ç›®', photoCount: 100 },\n      { name: 'è‡ªæ‹', photoCount: 89 },\n      { name: 'å±å¹•å¿«ç…§', photoCount: 234 },\n      { name: 'è§†é¢‘', photoCount: 67 }\n    ]\n  }\n\n  /**\n   * è·å–ç…§ç‰‡åˆ—è¡¨ï¼ˆå¸¦ä¸‹è½½çŠ¶æ€ï¼‰\n   */\n  async getPhotosWithStatus(\n    albumName?: string,\n    options: { limit?: number; offset?: number } = {}\n  ): Promise<iCloudPhoto[]> {\n    const { limit = 100, offset = 0 } = options\n\n    // ä¼˜å…ˆä½¿ç”¨ AppleScript\n    if (this.isAvailable) {\n      try {\n        const photos = await this.getPhotosViaAppleScript(albumName, limit + offset)\n        return photos.slice(offset, offset + limit)\n      } catch (error) {\n        console.warn('AppleScript è·å–ç…§ç‰‡å¤±è´¥:', error)\n      }\n    }\n\n    // ä½¿ç”¨ PhotosLibrary\n    if (this.PhotosLibrary) {\n      try {\n        return await this.getPhotosViaLibrary(limit, offset)\n      } catch (error) {\n        console.warn('PhotosLibrary è·å–ç…§ç‰‡å¤±è´¥:', error)\n      }\n    }\n\n    // è¿”å›æ¨¡æ‹Ÿæ•°æ®\n    return this.getMockPhotos(limit, offset)\n  }\n\n  /**\n   * é€šè¿‡ AppleScript è·å–ç…§ç‰‡\n   */\n  private async getPhotosViaAppleScript(\n    albumName?: string,\n    limit: number = 100\n  ): Promise<iCloudPhoto[]> {\n    let script = `\n      tell application \"Photos\"\n        set photoList to {}\n    `\n\n    if (albumName) {\n      script += `\n        set targetAlbum to album named \"${albumName}\"\n        repeat with p in media items of targetAlbum\n      `\n    } else {\n      script += `\n        repeat with p in media items\n      `\n    }\n\n    script += `\n          set end of photoList to {id of p as text, name of p as text, date of p, size of p, download status of p as text}\n        end repeat\n        return photoList\n      end tell\n    `\n\n    try {\n      const { stdout } = await execAsync(`osascript -e '${script.replace(/\\n/g, ' ')}'`)\n      return this.parsePhotoList(stdout).slice(0, limit)\n    } catch (error) {\n      console.error('AppleScript è·å–ç…§ç‰‡å¤±è´¥:', error)\n      return []\n    }\n  }\n\n  /**\n   * é€šè¿‡ PhotosLibrary è·å–ç…§ç‰‡\n   */\n  private async getPhotosViaLibrary(\n    limit: number,\n    offset: number\n  ): Promise<iCloudPhoto[]> {\n    try {\n      const photos = new this.PhotosLibrary(this.libraryPath)\n      const allPhotos = photos.getAllPhotos()\n\n      return allPhotos.slice(offset, offset + limit).map((photo: any) =>\n        this.normalizePhoto(photo)\n      )\n    } catch (error) {\n      console.error('PhotosLibrary è·å–ç…§ç‰‡å¤±è´¥:', error)\n      return []\n    }\n  }\n\n  /**\n   * è§£æ AppleScript è¿”å›çš„ç…§ç‰‡åˆ—è¡¨\n   */\n  private parsePhotoList(stdout: string): iCloudPhoto[] {\n    const photos: iCloudPhoto[] = []\n\n    // æ ¼å¼: {id, name, date, size, status}, ...\n    const matches = stdout.matchAll(\n      /\\{([^,]+),\\s*([^,]+),\\s*([^,]+),\\s*([^,]+),\\s*([^}]+)\\}/g\n    )\n\n    for (const match of matches) {\n      const id = match[1]?.trim()\n      const filename = match[2]?.trim()\n      const dateStr = match[3]?.trim()\n      const sizeStr = match[4]?.trim()\n      const status = match[5]?.trim()\n\n      if (id && filename && dateStr && sizeStr) {\n        photos.push({\n          id,\n          filename,\n          date: new Date(dateStr.replace(/:/g, '-')),\n          size: parseInt(sizeStr, 10) || 0,\n          cloudStatus: this.parseCloudStatus(status)\n        })\n      }\n    }\n\n    return photos\n  }\n\n  /**\n   * è§£æä¸‹è½½çŠ¶æ€\n   */\n  private parseCloudStatus(status: string): iCloudPhoto['cloudStatus'] {\n    const lowerStatus = status?.toLowerCase() || ''\n\n    if (lowerStatus.includes('waiting') || lowerStatus.includes('not downloaded')) {\n      return 'waiting'\n    }\n    if (lowerStatus.includes('uploading')) {\n      return 'uploading'\n    }\n    return 'downloaded'\n  }\n\n  /**\n   * ä¸‹è½½ç…§ç‰‡åˆ°æœ¬åœ°\n   */\n  async downloadPhoto(photoId: string): Promise<string | null> {\n    if (this.isAvailable) {\n      try {\n        return await this.downloadPhotoViaAppleScript(photoId)\n      } catch (error) {\n        console.error('AppleScript ä¸‹è½½å¤±è´¥:', error)\n      }\n    }\n\n    console.warn('æ— æ³•ä¸‹è½½ç…§ç‰‡ï¼Œç…§ç‰‡åº“ä¸å¯ç”¨')\n    return null\n  }\n\n  /**\n   * é€šè¿‡ AppleScript ä¸‹è½½ç…§ç‰‡\n   */\n  private async downloadPhotoViaAppleScript(photoId: string): Promise<string | null> {\n    const script = `\n      tell application \"Photos\"\n        try\n          set targetPhoto to media item id \"${photoId}\"\n          download targetPhoto\n          return POSIX path of (image file of targetPhoto as text)\n        on error\n          return \"\"\n        end try\n      end tell\n    `\n\n    try {\n      const { stdout } = await execAsync(`osascript -e '${script.replace(/\\n/g, ' ')}'`)\n      const path = stdout.trim()\n      return path || null\n    } catch (error) {\n      console.error('AppleScript ä¸‹è½½ç…§ç‰‡å¤±è´¥:', error)\n      return null\n    }\n  }\n\n  /**\n   * è·å–å­˜å‚¨ç©ºé—´ä¿¡æ¯\n   */\n  async getStorageInfo(): Promise<iCloudStorageInfo | null> {\n    try {\n      // ä½¿ç”¨ df å‘½ä»¤è·å–ç£ç›˜ä¿¡æ¯\n      const output = execSync('df -h / | tail -1 | awk \"{print $3, $4}\"')\n      const [used, available] = output.toString().trim().split(/\\s+/)\n\n      return {\n        used: this.parseSizeToGB(used),\n        available: this.parseSizeToGB(available)\n      }\n    } catch (error) {\n      console.error('è·å–å­˜å‚¨ä¿¡æ¯å¤±è´¥:', error)\n      return null\n    }\n  }\n\n  /**\n   * å°†äººç±»å¯è¯»çš„å¤§å°è½¬æ¢ä¸º GB\n   */\n  private parseSizeToGB(sizeStr: string): number {\n    // sizeStr æ ¼å¼: 100G, 500M, 1.5T ç­‰\n    const match = sizeStr.match(/^([\\d.]+)([KMGT]?)$/i)\n    if (!match) return 0\n\n    const value = parseFloat(match[1])\n    const unit = match[2].toUpperCase()\n\n    switch (unit) {\n      case 'T':\n        return value * 1024\n      case 'G':\n        return value\n      case 'M':\n        return value / 1024\n      case 'K':\n        return value / (1024 * 1024)\n      default:\n        return value\n    }\n  }\n\n  async getPhotos(limit: number = 100, offset: number = 0): Promise<any[]> {\n    if (!this.PhotosLibrary) {\n      // è¿”å›æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘\n      return this.getMockPhotos(limit, offset)\n    }\n\n    try {\n      const photos = new this.PhotosLibrary(this.libraryPath)\n      const allPhotos = photos.getAllPhotos()\n\n      return allPhotos.slice(offset, offset + limit).map((photo: any) => this.normalizePhoto(photo))\n    } catch (error) {\n      console.error('è·å–ç…§ç‰‡å¤±è´¥:', error)\n      return this.getMockPhotos(limit, offset)\n    }\n  }\n\n  /**\n   * æ‰¹é‡ä¸‹è½½ç…§ç‰‡\n   */\n  async downloadPhotos(\n    photoIds: string[],\n    onProgress?: (current: number, total: number) => void\n  ): Promise<Map<string, string>> {\n    const results = new Map<string, string>()\n\n    for (let i = 0; i < photoIds.length; i++) {\n      const photoId = photoIds[i]\n      onProgress?.(i + 1, photoIds.length)\n\n      try {\n        const path = await this.downloadPhoto(photoId)\n        results.set(photoId, path || '')\n      } catch (error) {\n        results.set(photoId, '')\n        console.error(`ä¸‹è½½ç…§ç‰‡ ${photoId} å¤±è´¥:`, error)\n      }\n    }\n\n    return results\n  }\n\n  async getPhotoDetail(photoId: string): Promise<any> {\n    if (!this.PhotosLibrary) {\n      return this.getMockPhotos(1, parseInt(photoId) || 0)[0]\n    }\n\n    try {\n      const photos = new this.PhotosLibrary(this.libraryPath)\n      const photo = photos.getPhotoById(photoId)\n\n      return photo ? this.normalizePhoto(photo) : null\n    } catch (error) {\n      console.error('è·å–ç…§ç‰‡è¯¦æƒ…å¤±è´¥:', error)\n      return this.getMockPhotos(1, parseInt(photoId) || 0)[0]\n    }\n  }\n\n  async syncAll(): Promise<number> {\n    let totalSynced = 0\n\n    try {\n      const photos = await this.getPhotos(10000, 0)\n\n      for (const photo of photos) {\n        this.database.addPhoto(photo)\n        totalSynced++\n      }\n\n      console.log(`åŒæ­¥å®Œæˆ: ${totalSynced} å¼ ç…§ç‰‡`)\n    } catch (error) {\n      console.error('åŒæ­¥å¤±è´¥:', error)\n    }\n\n    return totalSynced\n  }\n\n  private normalizePhoto(photo: any): any {\n    return {\n      uuid: photo.uuid || photo.id || crypto.randomUUID(),\n      cloudId: photo.cloudId || photo.id,\n      filePath: photo.filePath || photo.originalPath,\n      fileName: photo.filename || photo.name,\n      fileSize: photo.fileSize || photo.size,\n      width: photo.width,\n      height: photo.height,\n      takenAt: photo.takenAt || photo.creationDate || new Date().toISOString(),\n      exif: {\n        camera: photo.cameraModel,\n        lens: photo.lensModel,\n        iso: photo.iso,\n        aperture: photo.fNumber,\n        shutterSpeed: photo.exposureTime\n      },\n      location: photo.location ? {\n        latitude: photo.location.latitude,\n        longitude: photo.location.longitude\n      } : null,\n      status: 'icloud'\n    }\n  }\n\n  // æ¨¡æ‹Ÿæ•°æ®ï¼ˆç”¨äºå¼€å‘é˜¶æ®µï¼‰\n  private getMockPhotos(limit: number, offset: number): iCloudPhoto[] {\n    const mockPhotos: iCloudPhoto[] = []\n\n    for (let i = offset; i < offset + limit; i++) {\n      const year = 2015 + Math.floor(i / 100)\n      const month = (i % 12) + 1\n      const day = (i % 28) + 1\n\n      // éšæœºç”Ÿæˆä¸‹è½½çŠ¶æ€\n      const statuses: iCloudPhoto['cloudStatus'][] = ['downloaded', 'downloaded', 'waiting', 'downloaded']\n      const status = statuses[i % statuses.length]\n\n      mockPhotos.push({\n        id: `photo-${i}`,\n        filename: `IMG_${year}${String(month).padStart(2, '0')}${String(day).padStart(2, '0')}_${i}.jpg`,\n        date: new Date(year, month - 1, day, 10, 30),\n        size: Math.floor(Math.random() * 5000000) + 1000000,\n        cloudStatus: status,\n        localPath: status === 'downloaded' ? `/mock/photos/${year}/photo_${i}.jpg` : undefined\n      })\n    }\n\n    return mockPhotos\n  }\n}\n","/**\n * PhotoMind - SQLite æ•°æ®åº“\n * ä½¿ç”¨ sql.js (çº¯ JavaScript å®ç°)\n */\nimport initSqlJs from 'sql.js'\nimport type { PhotoDatabase as SqlJsPhotoDatabase } from 'sql.js'\nimport { resolve } from 'path'\nimport { fileURLToPath } from 'url'\nimport { readFileSync, existsSync, writeFileSync, mkdirSync, statSync } from 'fs'\n\n// ğŸ†• ä½¿ç”¨ process.cwd() ç¡®ä¿æ•°æ®åº“ä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯æ„å»ºè¾“å‡ºç›®å½•\nconst PROJECT_ROOT = process.cwd()\n\n// ğŸ†• æ”¯æŒä¼ å…¥è‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„ï¼ˆç”¨äº Electron userDataï¼‰\nlet customDbPath: string | null = null\nexport function setDatabasePath(path: string) {\n  customDbPath = path\n  console.log('[Database] è‡ªå®šä¹‰è·¯å¾„å·²è®¾ç½®:', path)\n}\n\nexport class PhotoDatabase {\n  private db: SqlJsPhotoDatabase | null = null\n  private dbPath: string\n  private isMemoryDb: boolean = false\n\n  constructor() {\n    // ğŸ†• ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„ï¼Œå¦åˆ™ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„é»˜è®¤è·¯å¾„\n    this.dbPath = customDbPath || resolve(PROJECT_ROOT, 'data/photo-mind.db')\n    console.log('[Database] æ•°æ®åº“è·¯å¾„:', this.dbPath)\n  }\n\n  /**\n   * ğŸ†• è·å–æ•°æ®åº“è¯Šæ–­ä¿¡æ¯\n   */\n  getDiagnostics() {\n    const exists = existsSync(this.dbPath)\n    let size = 0\n    if (exists) {\n      try {\n        size = statSync(this.dbPath).size\n      } catch (e) {\n        // ignore\n      }\n    }\n    return {\n      path: this.dbPath,\n      exists,\n      size,\n      isMemoryDb: this.isMemoryDb,\n      hasConnection: this.db !== null\n    }\n  }\n\n  async init() {\n    try {\n      // ğŸ†• ç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆä½¿ç”¨æ•°æ®åº“æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰\n      const dir = resolve(this.dbPath, '..')\n      if (!existsSync(dir)) {\n        mkdirSync(dir, { recursive: true })\n        console.log('[Database] åˆ›å»ºç›®å½•:', dir)\n      }\n\n      // åˆå§‹åŒ– sql.js\n      const SqlJs = await initSqlJs()\n\n      // å…¼å®¹ä¸åŒç‰ˆæœ¬çš„ sql.js\n      const SQL = SqlJs.default || SqlJs\n      console.log('[Database] sql.js loaded, constructor:', typeof SQL.Database !== 'undefined' ? 'Database' : 'PhotoDatabase')\n\n      // åŠ è½½å·²æœ‰æ•°æ®åº“æˆ–åˆ›å»ºæ–°çš„\n      if (existsSync(this.dbPath)) {\n        const fileBuffer = readFileSync(this.dbPath)\n        console.log('[Database] Loading existing DB, size:', fileBuffer.length, 'path:', this.dbPath)\n        if (typeof SQL.Database === 'function') {\n          this.db = new SQL.Database(fileBuffer)\n        } else if (typeof SQL.PhotoDatabase === 'function') {\n          this.db = new SQL.PhotoDatabase(fileBuffer)\n        } else {\n          throw new Error('Unknown sql.js database constructor')\n        }\n      } else {\n        console.log('[Database] Creating new DB at:', this.dbPath)\n        if (typeof SQL.Database === 'function') {\n          this.db = new SQL.Database()\n        } else if (typeof SQL.PhotoDatabase === 'function') {\n          this.db = new SQL.PhotoDatabase()\n        } else {\n          throw new Error('Unknown sql.js database constructor')\n        }\n      }\n\n      this.isMemoryDb = false\n\n      // åˆ›å»ºè¡¨ï¼ˆå¦‚æœè¡¨ä¸å­˜åœ¨ï¼‰\n      this.createTables()\n      console.log('[Database] Tables created/verified')\n\n      // éªŒè¯æ•°æ®åº“æ˜¯å¦æœ‰æ•°æ®\n      try {\n        const checkResult = this.db.exec('SELECT COUNT(*) as count FROM photos')\n        console.log('[Database] Initial photo count:', checkResult[0]?.values[0]?.[0])\n      } catch (e) {\n        console.log('[Database] Could not count photos (table may be empty)')\n      }\n\n      this.save()\n      console.log('[Database] DB saved')\n    } catch (error) {\n      console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error)\n      // åˆ›å»ºå†…å­˜æ•°æ®åº“ä½œä¸ºé™çº§æ–¹æ¡ˆ\n      console.log('[Database] âš ï¸ ä½¿ç”¨å†…å­˜æ•°æ®åº“ä½œä¸ºé™çº§æ–¹æ¡ˆ')\n      try {\n        const SqlJs = await initSqlJs()\n        const SQL = SqlJs.default || SqlJs\n        this.db = new SQL.Database ? new SQL.Database() : new SQL.PhotoDatabase()\n        this.isMemoryDb = true\n        // ã€å…³é”®ã€‘å†…å­˜æ•°æ®åº“ä¹Ÿéœ€è¦åˆ›å»ºè¡¨ï¼\n        this.createTables()\n        console.log('[Database] Memory DB tables created')\n      } catch (e) {\n        console.error('å†…å­˜æ•°æ®åº“ä¹Ÿæ— æ³•åˆ›å»º:', e)\n      }\n    }\n  }\n\n  private createTables() {\n    if (!this.db) return\n\n    // ç…§ç‰‡è¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS photos (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        uuid TEXT UNIQUE NOT NULL,\n        cloud_id TEXT,\n        file_path TEXT,\n        file_name TEXT,\n        file_size INTEGER,\n        width INTEGER,\n        height INTEGER,\n        taken_at DATETIME,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        exif_data TEXT,\n        location_data TEXT,\n        thumbnail_path TEXT,\n        status TEXT DEFAULT 'local'\n      )\n    `)\n\n    // äººè„¸è¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS faces (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        photo_id INTEGER,\n        person_id INTEGER,\n        bounding_box TEXT,\n        confidence REAL,\n        is_manual INTEGER DEFAULT 0,\n        FOREIGN KEY (photo_id) REFERENCES photos(id),\n        FOREIGN KEY (person_id) REFERENCES persons(id)\n      )\n    `)\n\n    // äººç‰©è¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS persons (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        name TEXT UNIQUE,\n        display_name TEXT,\n        face_count INTEGER DEFAULT 0,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        is_manual INTEGER DEFAULT 0\n      )\n    `)\n\n    // æ ‡ç­¾è¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS tags (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        name TEXT UNIQUE,\n        type TEXT,\n        confidence REAL,\n        parent_id INTEGER\n      )\n    `)\n\n    // ç…§ç‰‡æ ‡ç­¾å…³è”è¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS photo_tags (\n        photo_id INTEGER,\n        tag_id INTEGER,\n        confidence REAL,\n        is_manual INTEGER DEFAULT 0,\n        PRIMARY KEY (photo_id, tag_id),\n        FOREIGN KEY (photo_id) REFERENCES photos(id),\n        FOREIGN KEY (tag_id) REFERENCES tags(id)\n      )\n    `)\n\n    // å‘é‡è¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS vectors (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        photo_id INTEGER,\n        model_name TEXT,\n        embedding BLOB,\n        FOREIGN KEY (photo_id) REFERENCES photos(id)\n      )\n    `)\n\n    // ç›¸å†Œè¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS albums (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        name TEXT,\n        type TEXT,\n        query_params TEXT,\n        cover_photo_id INTEGER,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      )\n    `)\n\n    // åˆ›å»ºç´¢å¼•\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_photos_taken_at ON photos(taken_at)')\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_photos_cloud_id ON photos(cloud_id)')\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_faces_person ON faces(person_id)')\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_persons_name ON persons(name)')\n\n    // äººè„¸æ£€æµ‹ç»“æœè¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS detected_faces (\n        id TEXT PRIMARY KEY,\n        photo_id INTEGER NOT NULL,\n        bbox_x REAL NOT NULL,\n        bbox_y REAL NOT NULL,\n        bbox_width REAL NOT NULL,\n        bbox_height REAL NOT NULL,\n        confidence REAL NOT NULL,\n        person_id INTEGER,\n        embedding BLOB,\n        face_embedding BLOB,\n        semantic_embedding BLOB,\n        vector_version INTEGER DEFAULT 0,\n        created_at TEXT NOT NULL,\n        processed INTEGER DEFAULT 0,\n        FOREIGN KEY (photo_id) REFERENCES photos(id),\n        FOREIGN KEY (person_id) REFERENCES persons(id)\n      )\n    `)\n\n    // æ£€æµ‹ç»“æœç´¢å¼•\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_detected_faces_photo ON detected_faces(photo_id)')\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_detected_faces_processed ON detected_faces(processed)')\n\n    // æ‰«æä»»åŠ¡è¡¨\n    this.db.run(`\n      CREATE TABLE IF NOT EXISTS scan_jobs (\n        id TEXT PRIMARY KEY,\n        status TEXT NOT NULL,\n        total_photos INTEGER DEFAULT 0,\n        processed_photos INTEGER DEFAULT 0,\n        failed_photos INTEGER DEFAULT 0,\n        last_processed_id INTEGER,\n        started_at INTEGER NOT NULL,\n        completed_at INTEGER,\n        last_heartbeat INTEGER,\n        error_message TEXT\n      )\n    `)\n\n    // æ‰«æä»»åŠ¡ç´¢å¼•\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_scan_jobs_status ON scan_jobs(status)')\n    this.db.run('CREATE INDEX IF NOT EXISTS idx_scan_jobs_started_at ON scan_jobs(started_at)')\n\n    // æ‰§è¡Œè¿ç§»ï¼ˆæ·»åŠ æ–°åˆ—ï¼‰\n    this.runMigrations()\n\n    console.log('æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ')\n  }\n\n  /**\n   * æ•°æ®åº“è¿ç§»\n   * ç”¨äºæ·»åŠ æ–°åˆ—è€Œæ— éœ€åˆ é™¤ç°æœ‰æ•°æ®\n   */\n  private runMigrations() {\n    if (!this.db) return\n\n    try {\n      // æ£€æŸ¥ detected_faces è¡¨æ˜¯å¦æœ‰ face_embedding åˆ—\n      const tableInfo = this.db.exec(\"PRAGMA table_info(detected_faces)\")\n      const columns = tableInfo[0]?.values.map((row: any) => row[1]) || []\n\n      // è¿ç§» v1: æ·»åŠ  face_embedding åˆ—\n      if (!columns.includes('face_embedding')) {\n        console.log('[Database] è¿ç§»: æ·»åŠ  face_embedding åˆ—')\n        this.db.run('ALTER TABLE detected_faces ADD COLUMN face_embedding BLOB')\n      }\n\n      // è¿ç§» v2: æ·»åŠ  semantic_embedding åˆ—\n      if (!columns.includes('semantic_embedding')) {\n        console.log('[Database] è¿ç§»: æ·»åŠ  semantic_embedding åˆ—')\n        this.db.run('ALTER TABLE detected_faces ADD COLUMN semantic_embedding BLOB')\n      }\n\n      // è¿ç§» v3: æ·»åŠ  vector_version åˆ—\n      if (!columns.includes('vector_version')) {\n        console.log('[Database] è¿ç§»: æ·»åŠ  vector_version åˆ—')\n        this.db.run('ALTER TABLE detected_faces ADD COLUMN vector_version INTEGER DEFAULT 0')\n      }\n\n      console.log('[Database] è¿ç§»å®Œæˆ')\n    } catch (error) {\n      console.error('[Database] è¿ç§»å¤±è´¥:', error)\n    }\n  }\n\n  // ä¿å­˜æ•°æ®åº“åˆ°æ–‡ä»¶\n  private save() {\n    if (!this.db) return\n    const data = this.db.export()\n    const buffer = Buffer.from(data)\n    writeFileSync(this.dbPath, buffer)\n  }\n\n  // æŸ¥è¯¢è¾…åŠ©æ–¹æ³•\n  public query(sql: string, params: any[] = []): any[] {\n    if (!this.db) return []\n    const stmt = this.db.prepare(sql)\n    stmt.bind(params)\n\n    const results: any[] = []\n    while (stmt.step()) {\n      results.push(stmt.getAsObject())\n    }\n    stmt.free()\n    return results\n  }\n\n  // æ‰§è¡Œï¼ˆç”¨äº INSERT/UPDATE/DELETEï¼‰\n  run(sql: string, params: any[] = []) {\n    if (!this.db) return { lastInsertRowid: -1 }\n    try {\n      this.db.run(sql, params)\n      this.save()\n      // è·å– lastInsertRowid\n      const result = this.db.exec('SELECT last_insert_rowid()')\n      const lastId = result[0]?.values[0]?.[0] || 0\n      return { lastInsertRowid: lastId }\n    } catch (error) {\n      console.error(`[Database] SQLæ‰§è¡Œå¤±è´¥: ${sql}`, error)\n      return { lastInsertRowid: -1 }\n    }\n  }\n\n  // ç…§ç‰‡æ“ä½œ\n  addPhoto(photo: any): number {\n    // ç¡®ä¿æ‰€æœ‰å€¼éƒ½ä¸æ˜¯ undefined\n    const safePhoto = {\n      uuid: photo.uuid || this.generateUUID(),\n      cloudId: photo.cloudId || null,\n      filePath: photo.filePath || null,\n      fileName: photo.fileName || null,\n      fileSize: photo.fileSize || 0,\n      width: photo.width || null,\n      height: photo.height || null,\n      takenAt: photo.takenAt || new Date().toISOString(),\n      exif: photo.exif || {},\n      location: photo.location || {},\n      status: photo.status || 'local',\n      thumbnailPath: photo.thumbnailPath || null\n    }\n\n    try {\n      this.run(\n        `INSERT OR REPLACE INTO photos (uuid, cloud_id, file_path, file_name, file_size, width, height, taken_at, exif_data, location_data, status, thumbnail_path)\n         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n        [\n          safePhoto.uuid,\n          safePhoto.cloudId,\n          safePhoto.filePath,\n          safePhoto.fileName,\n          safePhoto.fileSize,\n          safePhoto.width,\n          safePhoto.height,\n          safePhoto.takenAt,\n          JSON.stringify(safePhoto.exif),\n          JSON.stringify(safePhoto.location),\n          safePhoto.status,\n          safePhoto.thumbnailPath\n        ]\n      )\n      // INSERT OR REPLACE ä¼šåˆ é™¤æ—§è®°å½•å¹¶æ’å…¥æ–°è®°å½•\n      // è¿”å›æœ€åæ’å…¥çš„ rowidï¼ˆå¯¹äº REPLACE å¯èƒ½æ˜¯è¢«åˆ é™¤è®°å½•çš„ idï¼‰\n      const countResult = this.query('SELECT COUNT(*) as count FROM photos', [])\n      console.log(`[Database] æ·»åŠ ç…§ç‰‡æˆåŠŸ: ${safePhoto.fileName}, å½“å‰æ€»æ•°: ${countResult[0]?.count}`)\n      return 1 // åªè¦æ‰§è¡ŒæˆåŠŸå°±è¿”å›æˆåŠŸ\n    } catch (error) {\n      console.error(`[Database] æ·»åŠ ç…§ç‰‡å¤±è´¥: ${safePhoto.fileName}`, error)\n      return -1\n    }\n  }\n\n  private generateUUID(): string {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n      const r = Math.random() * 16 | 0\n      const v = c === 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n  }\n\n  updatePhoto(photo: any): boolean {\n    try {\n      this.run(\n        `UPDATE photos SET\n          file_name = ?,\n          file_size = ?,\n          width = ?,\n          height = ?,\n          taken_at = ?,\n          exif_data = ?,\n          location_data = ?,\n          status = ?\n        WHERE uuid = ?`,\n        [\n          photo.fileName,\n          photo.fileSize,\n          photo.width || null,\n          photo.height || null,\n          photo.takenAt,\n          JSON.stringify(photo.exif || {}),\n          JSON.stringify(photo.location || {}),\n          photo.status || 'local',\n          photo.uuid\n        ]\n      )\n      return true\n    } catch (error) {\n      console.error('æ›´æ–°ç…§ç‰‡å¤±è´¥:', error)\n      return false\n    }\n  }\n\n  deletePhoto(uuid: string): boolean {\n    try {\n      this.run('DELETE FROM photos WHERE uuid = ?', [uuid])\n      return true\n    } catch (error) {\n      console.error('åˆ é™¤ç…§ç‰‡å¤±è´¥:', error)\n      return false\n    }\n  }\n\n  getPhotoByUuid(uuid: string): any {\n    const rows = this.query('SELECT * FROM photos WHERE uuid = ?', [uuid])\n    if (rows.length === 0) return null\n\n    const row = rows[0]\n    row.exif_data = row.exif_data ? JSON.parse(row.exif_data) : {}\n    row.location_data = row.location_data ? JSON.parse(row.location_data) : {}\n    return row\n  }\n\n  getPhotoById(id: number): any {\n    const rows = this.query('SELECT * FROM photos WHERE id = ?', [id])\n    if (rows.length === 0) return null\n\n    const row = rows[0]\n    row.exif_data = row.exif_data ? JSON.parse(row.exif_data) : {}\n    row.location_data = row.location_data ? JSON.parse(row.location_data) : {}\n    return row\n  }\n\n  getPhotoByFilePath(filePath: string): any {\n    const rows = this.query('SELECT * FROM photos WHERE file_path = ?', [filePath])\n    if (rows.length === 0) return null\n\n    const row = rows[0]\n    row.exif_data = row.exif_data ? JSON.parse(row.exif_data) : {}\n    row.location_data = row.location_data ? JSON.parse(row.location_data) : {}\n    return row\n  }\n\n  getPhotosByYear(year: number): any[] {\n    const rows = this.query(\n      `SELECT * FROM photos WHERE strftime('%Y', taken_at) = ? ORDER BY taken_at DESC`,\n      [year.toString()]\n    )\n    return rows.map(row => ({\n      ...row,\n      exif_data: row.exif_data ? JSON.parse(row.exif_data) : {},\n      location_data: row.location_data ? JSON.parse(row.location_data) : {}\n    }))\n  }\n\n  getAllPhotos(limit: number = 100, offset: number = 0): any[] {\n    // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼ï¼Œé¿å… sql.js å‚æ•°ç»‘å®šé—®é¢˜\n    const sql = `SELECT * FROM photos ORDER BY taken_at DESC LIMIT ${Number(limit)} OFFSET ${Number(offset)}`\n    console.log(`[Database] æ‰§è¡ŒæŸ¥è¯¢: ${sql}`)\n    const rows = this.query(sql, [])\n    console.log(`[Database] æŸ¥è¯¢ç»“æœ: ${rows.length} æ¡è®°å½•`)\n    return rows.map(row => ({\n      ...row,\n      exif_data: row.exif_data ? (typeof row.exif_data === 'string' ? JSON.parse(row.exif_data) : row.exif_data) : {},\n      location_data: row.location_data ? (typeof row.location_data === 'string' ? JSON.parse(row.location_data) : row.location_data) : {}\n    }))\n  }\n\n  // è·å–ç…§ç‰‡æ€»æ•°\n  getPhotoCount(): number {\n    const rows = this.query('SELECT COUNT(*) as count FROM photos', [])\n    console.log(`[Database] ç…§ç‰‡æ€»æ•°: ${rows[0]?.count || 0}`)\n    return rows[0]?.count || 0\n  }\n\n  // äººç‰©æ“ä½œ\n  addPerson(person: { name: string; displayName?: string }): number {\n    // First check if person already exists\n    const existing = this.query('SELECT id FROM persons WHERE name = ?', [person.name])\n    if (existing.length > 0) {\n      return existing[0].id\n    }\n\n    // Insert new person\n    const result = this.run(\n      `INSERT INTO persons (name, display_name) VALUES (?, ?)`,\n      [person.name, person.displayName || person.name]\n    )\n\n    if (result.lastInsertRowid <= 0) {\n      // Fallback: query the id we just inserted\n      const inserted = this.query('SELECT id FROM persons WHERE name = ?', [person.name])\n      if (inserted.length > 0) {\n        return inserted[0].id\n      }\n    }\n\n    return result.lastInsertRowid\n  }\n\n  getAllPersons(): any[] {\n    return this.query(`\n      SELECT p.*, COUNT(df.id) as face_count\n      FROM persons p\n      LEFT JOIN detected_faces df ON p.id = df.person_id\n      GROUP BY p.id\n      ORDER BY face_count DESC\n    `)\n  }\n\n  getPersonById(id: number): any {\n    const rows = this.query('SELECT * FROM persons WHERE id = ?', [id])\n    return rows.length > 0 ? rows[0] : null\n  }\n\n  updatePerson(id: number, person: { name?: string; displayName?: string }): boolean {\n    try {\n      if (person.name) {\n        this.run('UPDATE persons SET name = ? WHERE id = ?', [person.name, id])\n      }\n      if (person.displayName) {\n        this.run('UPDATE persons SET display_name = ? WHERE id = ?', [person.displayName, id])\n      }\n      return true\n    } catch (error) {\n      console.error('æ›´æ–°äººç‰©å¤±è´¥:', error)\n      return false\n    }\n  }\n\n  // äººè„¸æ“ä½œ\n  addFace(face: { photoId: number; personId?: number; boundingBox?: any; confidence?: number; isManual?: number }): number {\n    const result = this.run(\n      `INSERT INTO faces (photo_id, person_id, bounding_box, confidence, is_manual) VALUES (?, ?, ?, ?, ?)`,\n      [\n        face.photoId,\n        face.personId || null,\n        face.boundingBox ? JSON.stringify(face.boundingBox) : null,\n        face.confidence || 0,\n        face.isManual ?? 0\n      ]\n    )\n    return result.lastInsertRowid\n  }\n\n  getFacesByPhoto(photoId: number): any[] {\n    return this.query(`\n      SELECT f.*, p.name as person_name\n      FROM faces f\n      LEFT JOIN persons p ON f.person_id = p.id\n      WHERE f.photo_id = ?\n    `, [photoId])\n  }\n\n  getPhotosByPerson(personId: number): any[] {\n    // ğŸš¨ ä¿®å¤ï¼šä½¿ç”¨ detected_faces è¡¨è€Œä¸æ˜¯ faces è¡¨\n    // faces è¡¨æ˜¯æ—§çš„æ‰‹åŠ¨æ ‡è®°è¡¨ï¼Œdetected_faces æ˜¯æ–°çš„è‡ªåŠ¨æ£€æµ‹è¡¨\n    const rows = this.query(`\n      SELECT DISTINCT p.*\n      FROM photos p\n      JOIN detected_faces df ON p.id = df.photo_id\n      WHERE df.person_id = ?\n      ORDER BY p.taken_at DESC\n    `, [personId])\n    return rows.map(row => ({\n      ...row,\n      exif_data: row.exif_data ? JSON.parse(row.exif_data) : {},\n      location_data: row.location_data ? JSON.parse(row.location_data) : {}\n    }))\n  }\n\n  /**\n   * æ ¹æ®äººç‰©åç§°æœç´¢\n   */\n  searchPhotosByPerson(personName: string): any[] {\n    const rows = this.query(`\n      SELECT DISTINCT p.*\n      FROM photos p\n      JOIN faces f ON p.id = f.photo_id\n      JOIN persons ps ON f.person_id = ps.id\n      WHERE ps.name LIKE ? OR ps.display_name LIKE ?\n      ORDER BY p.taken_at DESC\n    `, [`%${personName}%`, `%${personName}%`])\n    return rows.map(row => ({\n      ...row,\n      exif_data: row.exif_data ? JSON.parse(row.exif_data) : {},\n      location_data: row.location_data ? JSON.parse(row.location_data) : {}\n    }))\n  }\n\n  // ============ äººè„¸æ£€æµ‹ç»“æœæ“ä½œ ============\n\n  /**\n   * ä¿å­˜æ£€æµ‹åˆ°çš„äººè„¸\n   * @param photoId ç…§ç‰‡ID\n   * @param faces äººè„¸æ£€æµ‹ç»“æœæ•°ç»„\n   */\n  saveDetectedFaces(photoId: number, faces: Array<{\n    id: string\n    bbox_x: number\n    bbox_y: number\n    bbox_width: number\n    bbox_height: number\n    confidence: number\n    embedding?: number[]\n    face_embedding?: number[]\n    semantic_embedding?: number[]\n    vector_version?: number\n  }>): number {\n    let savedCount = 0\n\n    // å…ˆåˆ é™¤è¯¥ç…§ç‰‡çš„æ—§æ£€æµ‹ç»“æœ\n    this.run('DELETE FROM detected_faces WHERE photo_id = ?', [photoId])\n\n    // ä¿å­˜æ–°æ£€æµ‹ç»“æœ\n    for (const face of faces) {\n      try {\n        // è½¬æ¢å„ç§ embedding ä¸º Buffer\n        const embeddingBuffer = face.embedding\n          ? Buffer.from(new Float32Array(face.embedding).buffer)\n          : null\n        const faceEmbeddingBuffer = face.face_embedding\n          ? Buffer.from(new Float32Array(face.face_embedding).buffer)\n          : null\n        const semanticEmbeddingBuffer = face.semantic_embedding\n          ? Buffer.from(new Float32Array(face.semantic_embedding).buffer)\n          : null\n\n        this.run(\n          `INSERT INTO detected_faces (id, photo_id, bbox_x, bbox_y, bbox_width, bbox_height, confidence, embedding, face_embedding, semantic_embedding, vector_version, created_at)\n           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n          [\n            face.id,\n            photoId,\n            face.bbox_x,\n            face.bbox_y,\n            face.bbox_width,\n            face.bbox_height,\n            face.confidence,\n            embeddingBuffer,\n            faceEmbeddingBuffer,\n            semanticEmbeddingBuffer,\n            face.vector_version || 0,\n            new Date().toISOString()\n          ]\n        )\n        savedCount++\n      } catch (error) {\n        console.error('[Database] ä¿å­˜æ£€æµ‹äººè„¸å¤±è´¥:', error)\n      }\n    }\n\n    return savedCount\n  }\n\n  /**\n   * è·å–ç…§ç‰‡çš„æ£€æµ‹äººè„¸\n   * @param photoId ç…§ç‰‡ID\n   * @returns æ£€æµ‹åˆ°çš„äººè„¸æ•°ç»„\n   */\n  getDetectedFaces(photoId: number): Array<{\n    id: string\n    photo_id: number\n    bbox_x: number\n    bbox_y: number\n    bbox_width: number\n    bbox_height: number\n    confidence: number\n    person_id?: number\n    embedding?: number[]\n    face_embedding?: number[]\n    semantic_embedding?: number[]\n    vector_version?: number\n    created_at: string\n  }> {\n    const rows = this.query(\n      `SELECT df.*, p.name as person_name\n       FROM detected_faces df\n       LEFT JOIN persons p ON df.person_id = p.id\n       WHERE df.photo_id = ?\n       ORDER BY df.confidence DESC`,\n      [photoId]\n    )\n\n    return rows.map(row => {\n      const face: any = {\n        id: row.id,\n        photo_id: row.photo_id,\n        bbox_x: row.bbox_x,\n        bbox_y: row.bbox_y,\n        bbox_width: row.bbox_width,\n        bbox_height: row.bbox_height,\n        confidence: row.confidence,\n        person_id: row.person_id,\n        person_name: row.person_name,\n        vector_version: row.vector_version,\n        created_at: row.created_at\n      }\n\n      // è§£æ embedding (å…¼å®¹æ—§æ•°æ®)\n      if (row.embedding) {\n        try {\n          face.embedding = Array.from(new Float32Array(row.embedding))\n        } catch (e) {\n          face.embedding = null\n        }\n      }\n\n      // è§£æ face_embedding (128ç»´)\n      if (row.face_embedding) {\n        try {\n          face.face_embedding = Array.from(new Float32Array(row.face_embedding))\n        } catch (e) {\n          face.face_embedding = null\n        }\n      }\n\n      // è§£æ semantic_embedding (512ç»´)\n      if (row.semantic_embedding) {\n        try {\n          face.semantic_embedding = Array.from(new Float32Array(row.semantic_embedding))\n        } catch (e) {\n          face.semantic_embedding = null\n        }\n      }\n\n      return face\n    })\n  }\n\n  /**\n   * è·å–æœªå¤„ç†æ£€æµ‹çš„ç…§ç‰‡\n   * @param limit é™åˆ¶æ•°é‡\n   * @param afterId å¯é€‰ï¼Œåªè¿”å›idå¤§äºæ­¤å€¼çš„ç…§ç‰‡ï¼ˆç”¨äºæ–­ç‚¹ç»­ä¼ ï¼‰\n   * @returns æœªå¤„ç†æ£€æµ‹çš„ç…§ç‰‡åˆ—è¡¨\n   */\n  getUnprocessedPhotos(limit: number = 100, afterId?: number): Array<{\n    id: number\n    uuid: string\n    file_path: string\n    file_name: string\n  }> {\n    // è·å–è¿˜æ²¡æœ‰æ£€æµ‹ç»“æœçš„æœ¬åœ°ç…§ç‰‡\n    let sql = `SELECT p.id, p.uuid, p.file_path, p.file_name\n       FROM photos p\n       LEFT JOIN detected_faces df ON p.id = df.photo_id\n       WHERE df.id IS NULL AND p.file_path IS NOT NULL`\n\n    const params: any[] = []\n\n    // å¦‚æœæŒ‡å®šäº†afterIdï¼Œåªè·å–idå¤§äºæ­¤å€¼çš„ç…§ç‰‡\n    if (afterId !== undefined && afterId > 0) {\n      sql += ` AND p.id > ?`\n      params.push(afterId)\n    }\n\n    sql += ` ORDER BY p.created_at DESC LIMIT ?`\n    params.push(limit)\n\n    const rows = this.query(sql, params)\n\n    return rows.map(row => ({\n      id: row.id,\n      uuid: row.uuid,\n      file_path: row.file_path,\n      file_name: row.file_name\n    }))\n  }\n\n  /**\n   * æ ‡è®°æ£€æµ‹ç»“æœå·²å¤„ç†ï¼ˆåŒ¹é…åˆ°äººç‰©ï¼‰\n   * @param faceId æ£€æµ‹äººè„¸ID\n   * @param personId äººç‰©ID\n   */\n  markFaceAsProcessed(faceId: string, personId: number): boolean {\n    try {\n      this.run(\n        'UPDATE detected_faces SET person_id = ?, processed = 1 WHERE id = ?',\n        [personId, faceId]\n      )\n      return true\n    } catch (error) {\n      console.error('[Database] æ ‡è®°æ£€æµ‹äººè„¸å¤„ç†å¤±è´¥:', error)\n      return false\n    }\n  }\n\n  /**\n   * è·å–æ‰€æœ‰æœªåŒ¹é…äººç‰©çš„æ£€æµ‹äººè„¸\n   * @returns æœªåŒ¹é…äººç‰©çš„æ£€æµ‹äººè„¸åˆ—è¡¨\n   */\n  getUnmatchedDetectedFaces(): Array<{\n    id: string\n    photo_id: number\n    file_path: string\n    bbox: { x: number; y: number; width: number; height: number }\n    confidence: number\n    embedding?: number[]\n    face_embedding?: number[]\n    semantic_embedding?: number[]\n    vector_version?: number\n  }> {\n    const rows = this.query(\n      `SELECT df.*, p.file_path\n       FROM detected_faces df\n       JOIN photos p ON df.photo_id = p.id\n       WHERE df.person_id IS NULL\n       ORDER BY df.confidence DESC`\n    )\n\n    return rows.map(row => {\n      const face: any = {\n        id: row.id,\n        photo_id: row.photo_id,\n        file_path: row.file_path,\n        bbox: {\n          x: row.bbox_x,\n          y: row.bbox_y,\n          width: row.bbox_width,\n          height: row.bbox_height\n        },\n        confidence: row.confidence,\n        vector_version: row.vector_version\n      }\n\n      // è§£æ embedding (å…¼å®¹æ—§æ•°æ®)\n      if (row.embedding) {\n        try {\n          face.embedding = Array.from(new Float32Array(row.embedding))\n        } catch (e) {\n          face.embedding = null\n        }\n      }\n\n      // è§£æ face_embedding (128ç»´)\n      if (row.face_embedding) {\n        try {\n          face.face_embedding = Array.from(new Float32Array(row.face_embedding))\n        } catch (e) {\n          face.face_embedding = null\n        }\n      }\n\n      // è§£æ semantic_embedding (512ç»´)\n      if (row.semantic_embedding) {\n        try {\n          face.semantic_embedding = Array.from(new Float32Array(row.semantic_embedding))\n        } catch (e) {\n          face.semantic_embedding = null\n        }\n      }\n\n      return face\n    })\n  }\n\n  /**\n   * è·å–äººè„¸æ£€æµ‹ç»Ÿè®¡\n   */\n  getDetectedFacesStats(): {\n    totalDetections: number\n    processedCount: number\n    unprocessedCount: number\n    photosWithFaces: number\n  } {\n    const total = this.query('SELECT COUNT(*) as count FROM detected_faces')[0]?.count || 0\n    const processed = this.query('SELECT COUNT(*) as count FROM detected_faces WHERE processed = 1')[0]?.count || 0\n    const photosWithFaces = this.query('SELECT COUNT(DISTINCT photo_id) as count FROM detected_faces')[0]?.count || 0\n\n    return {\n      totalDetections: total,\n      processedCount: processed,\n      unprocessedCount: total - processed,\n      photosWithFaces\n    }\n  }\n\n  /**\n   * æœç´¢äººç‰©\n   */\n  searchPersons(query: string): any[] {\n    if (!query.trim()) {\n      return this.getAllPersons()\n    }\n    return this.query(`\n      SELECT p.*, COUNT(f.id) as face_count\n      FROM persons p\n      LEFT JOIN faces f ON p.id = f.person_id\n      WHERE p.name LIKE ? OR p.display_name LIKE ?\n      GROUP BY p.id\n      ORDER BY face_count DESC\n    `, [`%${query}%`, `%${query}%`])\n  }\n\n  // æ ‡ç­¾æ“ä½œ\n  addTag(tag: { name: string; type?: string; parentId?: number }): number {\n    const result = this.run(\n      `INSERT OR IGNORE INTO tags (name, type, parent_id) VALUES (?, ?, ?)`,\n      [tag.name, tag.type || 'general', tag.parentId || null]\n    )\n    return result.lastInsertRowid\n  }\n\n  getAllTags(): any[] {\n    return this.query('SELECT * FROM tags ORDER BY name')\n  }\n\n  getPhotosByTag(tagId: number): any[] {\n    const rows = this.query(`\n      SELECT DISTINCT p.*\n      FROM photos p\n      JOIN photo_tags pt ON p.id = pt.photo_id\n      WHERE pt.tag_id = ?\n      ORDER BY p.taken_at DESC\n    `, [tagId])\n    return rows.map(row => ({\n      ...row,\n      exif_data: row.exif_data ? JSON.parse(row.exif_data) : {},\n      location_data: row.location_data ? JSON.parse(row.location_data) : {}\n    }))\n  }\n\n  addPhotoTag(photoId: number, tagId: number, confidence?: number): number {\n    const result = this.run(\n      `INSERT OR IGNORE INTO photo_tags (photo_id, tag_id, confidence) VALUES (?, ?, ?)`,\n      [photoId, tagId, confidence || 1.0]\n    )\n    return result.lastInsertRowid\n  }\n\n  // å‘é‡æ“ä½œ\n  addVector(vector: { photoId: number; modelName: string; embedding: number[] }): number {\n    // å°† embedding æ•°ç»„è½¬æ¢ä¸º Blob\n    const embeddingBuffer = Buffer.from(new Float32Array(vector.embedding).buffer)\n    const result = this.run(\n      `INSERT INTO vectors (photo_id, model_name, embedding) VALUES (?, ?, ?)`,\n      [vector.photoId, vector.modelName, embeddingBuffer]\n    )\n    return result.lastInsertRowid\n  }\n\n  /**\n   * ä¿å­˜å›¾ç‰‡åµŒå…¥å‘é‡\n   * @param photoUuid ç…§ç‰‡ UUID\n   * @param vector åµŒå…¥å‘é‡\n   * @param embeddingType åµŒå…¥ç±»å‹ (é»˜è®¤ 'image')\n   * @returns æ˜¯å¦æˆåŠŸ\n   */\n  async saveEmbedding(\n    photoUuid: string,\n    vector: number[],\n    embeddingType: string = 'image'\n  ): Promise<boolean> {\n    try {\n      // å°†å‘é‡è½¬æ¢ä¸º Buffer (BLOB)\n      const vectorBuffer = Buffer.from(new Float32Array(vector).buffer)\n\n      this.run(\n        `INSERT OR REPLACE INTO vectors (photo_uuid, embedding, embedding_type, created_at)\n         VALUES (?, ?, ?, datetime('now'))`,\n        [photoUuid, vectorBuffer, embeddingType]\n      )\n\n      console.log(`[Database] Saved ${embeddingType} embedding for photo: ${photoUuid}`)\n      return true\n    } catch (error) {\n      console.error('[Database] Failed to save embedding:', error)\n      return false\n    }\n  }\n\n  /**\n   * æ‰¹é‡ä¿å­˜åµŒå…¥å‘é‡\n   * @param embeddings [{ photoUuid, vector, embeddingType }]\n   * @returns æˆåŠŸæ•°é‡\n   */\n  async saveEmbeddingsBatch(\n    embeddings: Array<{ photoUuid: string; vector: number[]; embeddingType?: string }>\n  ): Promise<number> {\n    let successCount = 0\n\n    try {\n      for (const { photoUuid, vector, embeddingType } of embeddings) {\n        const success = await this.saveEmbedding(photoUuid, vector, embeddingType)\n        if (success) successCount++\n      }\n      console.log(`[Database] Batch saved ${successCount}/${embeddings.length} embeddings`)\n      return successCount\n    } catch (error) {\n      console.error('[Database] Batch save failed:', error)\n      return successCount\n    }\n  }\n\n  /**\n   * è·å–å•ä¸ªç…§ç‰‡çš„åµŒå…¥å‘é‡\n   * @param photoUuid ç…§ç‰‡ UUID\n   * @param embeddingType åµŒå…¥ç±»å‹\n   * @returns åµŒå…¥å‘é‡æˆ– null\n   */\n  async getEmbedding(\n    photoUuid: string,\n    embeddingType: string = 'image'\n  ): Promise<number[] | null> {\n    try {\n      const result = this.query(\n        `SELECT embedding FROM vectors WHERE photo_uuid = ? AND embedding_type = ?`,\n        [photoUuid, embeddingType]\n      )\n\n      if (result.length > 0 && result[0].embedding) {\n        // BLOB è½¬ Float32Array å†è½¬æ•°ç»„\n        const float32Array = new Float32Array(result[0].embedding)\n        return Array.from(float32Array)\n      }\n\n      return null\n    } catch (error) {\n      console.error('[Database] Failed to get embedding:', error)\n      return null\n    }\n  }\n\n  /**\n   * è·å–æ‰€æœ‰åµŒå…¥å‘é‡ï¼ˆç”¨äºå…¨åº“æœç´¢ï¼‰\n   * @param embeddingType åµŒå…¥ç±»å‹\n   * @returns ç…§ç‰‡ UUID å’Œå‘é‡åˆ—è¡¨\n   */\n  async getAllEmbeddings(\n    embeddingType: string = 'image'\n  ): Promise<Array<{ photoUuid: string; vector: number[] }>> {\n    try {\n      const results = this.query(\n        `SELECT photo_uuid, embedding FROM vectors WHERE embedding_type = ?`,\n        [embeddingType]\n      )\n\n      return results.map(result => ({\n        photoUuid: result.photo_uuid,\n        vector: Array.from(new Float32Array(result.embedding))\n      }))\n    } catch (error) {\n      console.error('[Database] Failed to get all embeddings:', error)\n      return []\n    }\n  }\n\n  /**\n   * æ£€æŸ¥ç…§ç‰‡æ˜¯å¦æœ‰åµŒå…¥å‘é‡\n   * @param photoUuid ç…§ç‰‡ UUID\n   * @param embeddingType åµŒå…¥ç±»å‹\n   * @returns æ˜¯å¦æœ‰åµŒå…¥\n   */\n  async hasEmbedding(\n    photoUuid: string,\n    embeddingType: string = 'image'\n  ): Promise<boolean> {\n    try {\n      const result = this.query(\n        `SELECT 1 FROM vectors WHERE photo_uuid = ? AND embedding_type = ? LIMIT 1`,\n        [photoUuid, embeddingType]\n      )\n      return result.length > 0\n    } catch (error) {\n      console.error('[Database] Failed to check embedding existence:', error)\n      return false\n    }\n  }\n\n  /**\n   * åˆ é™¤ç…§ç‰‡çš„åµŒå…¥å‘é‡\n   * @param photoUuid ç…§ç‰‡ UUID\n   * @param embeddingType åµŒå…¥ç±»å‹\n   * @returns æ˜¯å¦æˆåŠŸ\n   */\n  async deleteEmbedding(\n    photoUuid: string,\n    embeddingType?: string\n  ): Promise<boolean> {\n    try {\n      if (embeddingType) {\n        this.run(\n          `DELETE FROM vectors WHERE photo_uuid = ? AND embedding_type = ?`,\n          [photoUuid, embeddingType]\n        )\n      } else {\n        this.run(`DELETE FROM vectors WHERE photo_uuid = ?`, [photoUuid])\n      }\n      return true\n    } catch (error) {\n      console.error('[Database] Failed to delete embedding:', error)\n      return false\n    }\n  }\n\n  /**\n   * è·å–åµŒå…¥ç»Ÿè®¡ä¿¡æ¯\n   * @returns ç»Ÿè®¡å¯¹è±¡\n   */\n  async getEmbeddingStats(): Promise<{\n    totalEmbeddings: number\n    typeBreakdown: Record<string, number>\n  }> {\n    try {\n      const totalResult = this.query(`SELECT COUNT(*) as count FROM vectors`)\n      const typeResults = this.query(\n        `SELECT embedding_type, COUNT(*) as count FROM vectors GROUP BY embedding_type`\n      )\n\n      return {\n        totalEmbeddings: totalResult[0]?.count || 0,\n        typeBreakdown: Object.fromEntries(\n          typeResults.map((r: any) => [r.embedding_type, r.count])\n        )\n      }\n    } catch (error) {\n      console.error('[Database] Failed to get embedding stats:', error)\n      return { totalEmbeddings: 0, typeBreakdown: {} }\n    }\n  }\n\n  /**\n   * è·å–æ²¡æœ‰åµŒå…¥å‘é‡çš„ç…§ç‰‡\n   * @param limit é™åˆ¶æ•°é‡\n   * @returns ç…§ç‰‡åˆ—è¡¨\n   */\n  getPhotosWithoutEmbeddings(limit: number = 100): any[] {\n    const photos = this.getAllPhotos(limit * 2, 0)\n    return photos.filter(p => {\n      const vectors = this.getVectorByPhoto(p.id)\n      return !vectors || vectors.length === 0\n    }).slice(0, limit)\n  }\n\n  getVectorByPhoto(photoId: number): any[] {\n    return this.query('SELECT * FROM vectors WHERE photo_id = ?', [photoId])\n  }\n\n  // ç›¸å†Œæ“ä½œ\n  addAlbum(album: { name: string; type?: string; queryParams?: any; coverPhotoId?: number }): number {\n    const result = this.run(\n      `INSERT INTO albums (name, type, query_params, cover_photo_id) VALUES (?, ?, ?, ?)`,\n      [album.name, album.type || 'manual', album.queryParams ? JSON.stringify(album.queryParams) : null, album.coverPhotoId || null]\n    )\n    return result.lastInsertRowid\n  }\n\n  getAllAlbums(): any[] {\n    return this.query('SELECT * FROM albums ORDER BY updated_at DESC')\n  }\n\n  getAlbumById(id: number): any {\n    const rows = this.query('SELECT * FROM albums WHERE id = ?', [id])\n    if (rows.length === 0) return null\n    const album = rows[0]\n    if (album.query_params) {\n      album.query_params = JSON.parse(album.query_params)\n    }\n    return album\n  }\n\n  updateAlbum(id: number, album: { name?: string; queryParams?: any; coverPhotoId?: number }): boolean {\n    try {\n      if (album.name) {\n        this.run('UPDATE albums SET name = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?', [album.name, id])\n      }\n      if (album.queryParams) {\n        this.run('UPDATE albums SET query_params = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?', [JSON.stringify(album.queryParams), id])\n      }\n      if (album.coverPhotoId) {\n        this.run('UPDATE albums SET cover_photo_id = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?', [album.coverPhotoId, id])\n      }\n      return true\n    } catch (error) {\n      console.error('æ›´æ–°ç›¸å†Œå¤±è´¥:', error)\n      return false\n    }\n  }\n\n  deleteAlbum(id: number): boolean {\n    try {\n      this.run('DELETE FROM albums WHERE id = ?', [id])\n      return true\n    } catch (error) {\n      console.error('åˆ é™¤ç›¸å†Œå¤±è´¥:', error)\n      return false\n    }\n  }\n\n  // ç»Ÿè®¡æŸ¥è¯¢\n  getPhotoCountByYear(): any[] {\n    return this.query(`\n      SELECT strftime('%Y', taken_at) as year, COUNT(*) as count\n      FROM photos\n      WHERE taken_at IS NOT NULL\n      GROUP BY strftime('%Y', taken_at)\n      ORDER BY year DESC\n    `)\n  }\n\n  getStats(): any {\n    const photoCount = this.query('SELECT COUNT(*) as count FROM photos')[0]?.count || 0\n    const personCount = this.query('SELECT COUNT(*) as count FROM persons')[0]?.count || 0\n    const albumCount = this.query('SELECT COUNT(*) as count FROM albums')[0]?.count || 0\n    const tagCount = this.query('SELECT COUNT(*) as count FROM tags')[0]?.count || 0\n\n    return {\n      photoCount,\n      personCount,\n      albumCount,\n      tagCount\n    }\n  }\n\n  // åœ°ç‚¹æ“ä½œ\n  getAllPlaces(): any[] {\n    // å…ˆè·å–æ‰€æœ‰æœ‰åœ°ç‚¹çš„ç…§ç‰‡\n    const rows = this.query(`\n      SELECT id, location_data\n      FROM photos\n      WHERE location_data IS NOT NULL\n        AND location_data != ''\n        AND location_data != 'null'\n    `)\n\n    // åœ¨åº”ç”¨å±‚è§£æ JSON å¹¶åˆ†ç»„\n    const placeMap = new Map<string, number>()\n\n    for (const row of rows) {\n      try {\n        if (row.location_data) {\n          const location = JSON.parse(row.location_data)\n          // ä¼˜å…ˆä½¿ç”¨ name å­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åæ ‡\n          const placeName = location.name || `ä½ç½® ${location.latitude?.toFixed(2) || '?'},${location.longitude?.toFixed(2) || '?'}`\n          placeMap.set(placeName, (placeMap.get(placeName) || 0) + 1)\n        }\n      } catch (e) {\n        // JSON è§£æå¤±è´¥ï¼Œå°è¯•ä»åŸå§‹å­—ç¬¦ä¸²æå–\n        const placeName = row.location_data?.substring(0, 50) || 'æœªçŸ¥åœ°ç‚¹'\n        placeMap.set(placeName, (placeMap.get(placeName) || 0) + 1)\n      }\n    }\n\n    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº\n    return Array.from(placeMap.entries())\n      .map(([place_name, photo_count]) => ({ place_name, photo_count }))\n      .sort((a, b) => b.photo_count - a.photo_count)\n  }\n\n  // æœç´¢\n  searchPhotos(query: string, filters?: any): any[] {\n    let sql = 'SELECT * FROM photos WHERE 1=1'\n    const params: any[] = []\n\n    // æŒ‰å¹´ä»½ç­›é€‰\n    if (filters?.year) {\n      sql += ' AND strftime(\"%Y\", taken_at) = ?'\n      params.push(filters.year.toString())\n    }\n\n    // æŒ‰å­£èŠ‚ç­›é€‰\n    if (filters?.season) {\n      const monthMap: Record<string, string[]> = {\n        'æ˜¥å¤©': ['03', '04', '05'],\n        'å¤å¤©': ['06', '07', '08'],\n        'ç§‹å¤©': ['09', '10', '11'],\n        'å†¬å¤©': ['12', '01', '02']\n      }\n      const months = monthMap[filters.season]\n      if (months) {\n        sql += ` AND strftime(\"%m\", taken_at) IN (${months.map(() => '?').join(',')})`\n        params.push(...months)\n      }\n    }\n\n    // æŒ‰åœ°ç‚¹å…³é”®è¯ç­›é€‰\n    if (filters?.location?.keywords?.length) {\n      const conditions = filters.location.keywords.map((_: string) => {\n        return '(location_data LIKE ? OR location_data LIKE ?)'\n      })\n      sql += ' AND (' + conditions.join(' OR ') + ')'\n      for (const keyword of filters.location.keywords) {\n        params.push(`%\"${keyword}\"%`, `%${keyword}%`)\n      }\n    }\n\n    // æŒ‰äººç‰©ç­›é€‰ï¼ˆé€šè¿‡ faces è¡¨å…³è” personsï¼‰\n    if (filters?.people?.length && filters.people.length > 0) {\n      // ç®€åŒ–å¤„ç†ï¼šæœç´¢äººç‰©åç§°åŒ¹é…ï¼ˆå®é™…éœ€è¦é€šè¿‡ faces è¡¨å…³è”ï¼‰\n      // ç›®å‰ persons è¡¨æ˜¯ç©ºçš„ï¼Œåç»­å®ç°äººè„¸è¯†åˆ«åå†å®Œå–„\n    }\n\n    sql += ' ORDER BY taken_at DESC LIMIT 50'\n\n    const rows = this.query(sql, params)\n    return rows.map(row => ({\n      ...row,\n      exif_data: row.exif_data ? JSON.parse(row.exif_data) : {},\n      location_data: row.location_data ? JSON.parse(row.location_data) : {}\n    }))\n  }\n\n  close() {\n    if (this.db) {\n      this.save()\n      this.db.close()\n      this.db = null\n    }\n  }\n}\n","/**\n * PhotoMind - é…ç½®æœåŠ¡\n *\n * ç®¡ç†åº”ç”¨é…ç½®ï¼ŒåŒ…æ‹¬ API è®¾ç½®\n */\nimport { resolve } from 'path'\nimport { existsSync, readFileSync, writeFileSync, mkdirSync } from 'fs'\nimport { fileURLToPath } from 'url'\n\nconst __dirname = fileURLToPath(new URL('.', import.meta.url))\n\nexport interface AppConfig {\n  llm: {\n    provider: 'deepseek' | 'openai' | 'none'\n    apiKey: string\n    baseUrl: string\n    model: string\n  }\n  appearance: {\n    theme: 'light' | 'dark' | 'system'\n  }\n}\n\nexport class ConfigService {\n  private configPath: string\n  private config: AppConfig\n\n  constructor() {\n    this.configPath = resolve(__dirname, '../../data/config.json')\n    this.config = this.loadConfig()\n  }\n\n  /**\n   * åŠ è½½é…ç½®\n   */\n  private loadConfig(): AppConfig {\n    const defaultConfig: AppConfig = {\n      llm: {\n        provider: 'none',\n        apiKey: '',\n        baseUrl: 'https://api.deepseek.com',\n        model: 'deepseek-chat'\n      },\n      appearance: {\n        theme: 'system'\n      }\n    }\n\n    try {\n      if (existsSync(this.configPath)) {\n        const fileContent = readFileSync(this.configPath, 'utf-8')\n        const loadedConfig = JSON.parse(fileContent)\n        // åˆå¹¶é…ç½®\n        return {\n          llm: { ...defaultConfig.llm, ...loadedConfig.llm },\n          appearance: { ...defaultConfig.appearance, ...loadedConfig.appearance }\n        }\n      }\n    } catch (error) {\n      console.error('åŠ è½½é…ç½®å¤±è´¥:', error)\n    }\n\n    return defaultConfig\n  }\n\n  /**\n   * ä¿å­˜é…ç½®\n   */\n  private saveConfig(): void {\n    try {\n      const dir = resolve(this.configPath, '..')\n      if (!existsSync(dir)) {\n        mkdirSync(dir, { recursive: true })\n      }\n      writeFileSync(this.configPath, JSON.stringify(this.config, null, 2))\n    } catch (error) {\n      console.error('ä¿å­˜é…ç½®å¤±è´¥:', error)\n    }\n  }\n\n  /**\n   * è·å–å®Œæ•´é…ç½®\n   */\n  getConfig(): AppConfig {\n    return this.config\n  }\n\n  /**\n   * è·å– LLM é…ç½®\n   */\n  getLLMConfig(): AppConfig['llm'] {\n    return this.config.llm\n  }\n\n  /**\n   * è®¾ç½® API Key\n   */\n  setApiKey(apiKey: string): void {\n    this.config.llm.apiKey = apiKey\n    if (apiKey) {\n      this.config.llm.provider = 'deepseek'\n    }\n    this.saveConfig()\n  }\n\n  /**\n   * è®¾ç½® LLM æä¾›å•†\n   */\n  setLLMProvider(provider: 'deepseek' | 'openai' | 'none'): void {\n    this.config.llm.provider = provider\n    if (provider === 'none') {\n      this.config.llm.apiKey = ''\n    }\n    this.saveConfig()\n  }\n\n  /**\n   * è®¾ç½® Base URL\n   */\n  setBaseUrl(baseUrl: string): void {\n    this.config.llm.baseUrl = baseUrl\n    this.saveConfig()\n  }\n\n  /**\n   * è®¾ç½®æ¨¡å‹\n   */\n  setModel(model: string): void {\n    this.config.llm.model = model\n    this.saveConfig()\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦å·²é…ç½® LLM\n   */\n  isLLMConfigured(): boolean {\n    return !!(\n      this.config.llm.apiKey &&\n      this.config.llm.provider !== 'none'\n    )\n  }\n\n  /**\n   * è®¾ç½®ä¸»é¢˜\n   */\n  setTheme(theme: 'light' | 'dark' | 'system'): void {\n    this.config.appearance.theme = theme\n    this.saveConfig()\n  }\n\n  /**\n   * è·å–ä¸»é¢˜\n   */\n  getTheme(): 'light' | 'dark' | 'system' {\n    return this.config.appearance.theme\n  }\n}\n\n// å¯¼å‡ºå•ä¾‹\nlet configService: ConfigService | null = null\n\nexport function getConfigService(): ConfigService {\n  if (!configService) {\n    configService = new ConfigService()\n  }\n  return configService\n}\n","/**\n * PhotoMind - æœç´¢æœåŠ¡\n *\n * å¤„ç†è‡ªç„¶è¯­è¨€æœç´¢ï¼Œå°†æŸ¥è¯¢è½¬æ¢ä¸ºæ•°æ®åº“æŸ¥è¯¢\n */\nimport { PhotoDatabase } from '../database/db.js'\nimport { getConfigService } from './configService.js'\n\nexport class SearchService {\n  private database: PhotoDatabase\n  private configService: ReturnType<typeof getConfigService>\n\n  constructor(database: PhotoDatabase) {\n    this.database = database\n    this.configService = getConfigService()\n  }\n\n  async search(query: string, filters?: any): Promise<{ results: any[]; total: number }> {\n    try {\n      // 1. ä½¿ç”¨ LLM ç†è§£æŸ¥è¯¢æ„å›¾\n      const parsedQuery = await this.parseQuery(query)\n\n      // 2. æ„å»ºæœç´¢æ¡ä»¶\n      const searchFilters = { ...filters, ...parsedQuery }\n\n      // 3. æ‰§è¡Œæœç´¢\n      const results = this.database.searchPhotos(query, searchFilters)\n\n      return {\n        results,\n        total: results.length\n      }\n    } catch (error) {\n      console.error('æœç´¢å¤±è´¥:', error)\n      return { results: [], total: 0 }\n    }\n  }\n\n  /**\n   * ä½¿ç”¨ LLM è§£æè‡ªç„¶è¯­è¨€æŸ¥è¯¢\n   */\n  private async parseQuery(query: string): Promise<any> {\n    const llmConfig = this.configService.getLLMConfig()\n\n    // å¦‚æœæ²¡æœ‰é…ç½® LLMï¼Œä½¿ç”¨è§„åˆ™è§£æ\n    if (!this.configService.isLLMConfigured()) {\n      console.log('LLM æœªé…ç½®ï¼Œä½¿ç”¨è§„åˆ™è§£æ')\n      return this.parseQueryByRules(query)\n    }\n\n    try {\n      const response = await fetch(`${llmConfig.baseUrl}/chat/completions`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${llmConfig.apiKey}`\n        },\n        body: JSON.stringify({\n          model: llmConfig.model,\n          messages: [\n            {\n              role: 'system',\n              content: `ä½ æ˜¯ä¸€ä¸ªå›¾ç‰‡æœç´¢åŠ©æ‰‹ã€‚ç”¨æˆ·ä¼šç”¨è‡ªç„¶è¯­è¨€æè¿°æƒ³è¦æ‰¾çš„ç…§ç‰‡ã€‚\nè¯·å°†ç”¨æˆ·æè¿°è½¬æ¢ä¸ºç»“æ„åŒ–çš„æœç´¢æ¡ä»¶ã€‚\n\næ”¯æŒçš„æ¡ä»¶ï¼š\n- æ—¶é—´ï¼šå¹´ä»½ï¼ˆå¦‚ 2015ï¼‰ã€å­£èŠ‚ï¼ˆå¦‚å»å¹´å¤å¤©ï¼‰\n- äººç‰©ï¼šäººåã€æ•°é‡ï¼ˆå¦‚ä¸€å®¶å››å£ï¼‰\n- åœ°ç‚¹ï¼šå›½å®¶/åŸå¸‚/åœ°æ ‡ï¼ˆå¦‚æ—¥æœ¬ã€æ–°ç–†ï¼‰\n\nè¾“å‡º JSON æ ¼å¼ï¼š\n{\n  \"time_range\": {\"year\": null, \"season\": null},\n  \"people\": [\"äººç‰©1\", \"äººç‰©2\"],\n  \"location\": {\"keywords\": [], \"description\": null},\n  \"tags\": [\"åœºæ™¯æ ‡ç­¾\"],\n  \"confidence\": 0.8}`\n            },\n            {\n              role: 'user',\n              content: query\n            }\n          ],\n          temperature: 0.3,\n          max_tokens: 500\n        })\n      })\n\n      const data = await response.json() as any\n      const content = data.choices?.[0]?.message?.content || '{}'\n\n      // å°è¯•è§£æ JSON\n      try {\n        const parsed = JSON.parse(content)\n        return this.convertToFilters(parsed)\n      } catch {\n        return this.parseQueryByRules(query)\n      }\n    } catch (error) {\n      console.error('LLM æŸ¥è¯¢å¤±è´¥:', error)\n      return this.parseQueryByRules(query)\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æœç´¢æœåŠ¡æ˜¯å¦å·²é…ç½®\n   */\n  isConfigured(): boolean {\n    return this.configService.isLLMConfigured()\n  }\n\n  /**\n   * è·å–å½“å‰é…ç½®çŠ¶æ€\n   */\n  getConfigStatus(): { configured: boolean; provider: string } {\n    const config = this.configService.getLLMConfig()\n    return {\n      configured: this.configService.isLLMConfigured(),\n      provider: config.provider\n    }\n  }\n\n  /**\n   * è§„åˆ™è§£æï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰\n   */\n  private parseQueryByRules(query: string): any {\n    const filters: any = {\n      people: [],\n      location: { keywords: [] },\n      time_range: {}\n    }\n\n    // æå–å¹´ä»½\n    const yearMatch = query.match(/(19|20)\\d{2}/)\n    if (yearMatch) {\n      filters.time_range = { year: parseInt(yearMatch[0]) }\n    }\n\n    // æå–å­£èŠ‚\n    const seasons = ['æ˜¥å¤©', 'å¤å¤©', 'ç§‹å¤©', 'å†¬å¤©']\n    for (const season of seasons) {\n      if (query.includes(season)) {\n        filters.time_range.season = season\n        break\n      }\n    }\n\n    // æå–åœ°ç‚¹å…³é”®è¯\n    const locationKeywords = ['æ—¥æœ¬', 'åŒ—äº¬', 'ä¸Šæµ·', 'æ–°ç–†', 'ä¸œäº¬', 'åŒ—æµ·é“', 'å¤§é˜ª']\n    for (const keyword of locationKeywords) {\n      if (query.includes(keyword)) {\n        filters.location.keywords.push(keyword)\n      }\n    }\n\n    // æå–äººç‰©å…³ç³»\n    const peoplePatterns = [\n      { pattern: /ä¸€å®¶å››å£/, people: ['çˆ¸çˆ¸', 'å¦ˆå¦ˆ', 'æˆ‘', 'å„¿å­'] },\n      { pattern: /çˆ¸çˆ¸å¦ˆå¦ˆ/, people: ['çˆ¸çˆ¸', 'å¦ˆå¦ˆ'] },\n      { pattern: /å„¿å­/, people: ['å„¿å­'] },\n      { pattern: /åˆå½±/, people: [] },\n      { pattern: /åˆç…§/, people: [] }\n    ]\n\n    for (const { pattern, people } of peoplePatterns) {\n      if (pattern.test(query)) {\n        filters.people.push(...people)\n      }\n    }\n\n    return filters\n  }\n\n  /**\n   * æ ¹æ®äººç‰©æœç´¢ç…§ç‰‡\n   */\n  async searchByPerson(personName: string): Promise<{ results: any[]; total: number }> {\n    try {\n      const photos = this.database.searchPhotosByPerson(personName)\n      return {\n        results: photos,\n        total: photos.length\n      }\n    } catch (error) {\n      console.error('äººç‰©æœç´¢å¤±è´¥:', error)\n      return { results: [], total: 0 }\n    }\n  }\n\n  /**\n   * æœç´¢äººç‰©\n   */\n  async searchPeople(query: string): Promise<any[]> {\n    try {\n      return this.database.searchPersons(query)\n    } catch (error) {\n      console.error('æœç´¢äººç‰©å¤±è´¥:', error)\n      return []\n    }\n  }\n\n  /**\n   * è½¬æ¢ LLM è¾“å‡ºä¸ºæœç´¢è¿‡æ»¤å™¨\n   */\n  private convertToFilters(parsed: any): any {\n    const filters: any = {\n      people: [],\n      location: { keywords: [] },\n      time_range: {}\n    }\n\n    if (parsed.time_range?.year) {\n      filters.time_range = { year: parsed.time_range.year }\n    }\n\n    if (parsed.people) {\n      filters.people = Array.isArray(parsed.people) ? parsed.people : [parsed.people]\n    }\n\n    if (parsed.location?.keywords) {\n      filters.location.keywords = parsed.location.keywords\n    }\n\n    if (parsed.location?.description) {\n      filters.location.keywords.push(parsed.location.description)\n    }\n\n    if (parsed.tags) {\n      filters.tags = Array.isArray(parsed.tags) ? parsed.tags : [parsed.tags]\n    }\n\n    return filters\n  }\n\n  /**\n   * æ™ºèƒ½æ¨èç›¸å†Œ\n   */\n  async getSmartAlbums(): Promise<any[]> {\n    const albums: any[] = []\n\n    // è·å–çƒ­é—¨åœ°ç‚¹\n    const places = this.database.getAllPlaces()\n    if (places.length > 0) {\n      albums.push({\n        id: 'smart-places',\n        name: 'æŒ‰åœ°ç‚¹æµè§ˆ',\n        type: 'smart',\n        items: places.slice(0, 6)\n      })\n    }\n\n    // è·å–äººç‰©\n    const people = this.database.getAllPersons()\n    if (people.length > 0) {\n      albums.push({\n        id: 'smart-people',\n        name: 'æŒ‰äººç‰©æµè§ˆ',\n        type: 'smart',\n        items: people.slice(0, 6)\n      })\n    }\n\n    // è¿‘å¹´å›å¿†\n    const currentYear = new Date().getFullYear()\n    const years = [currentYear - 1, currentYear - 2, currentYear - 3]\n    albums.push({\n      id: 'smart-years',\n      name: 'å†å¹´å›å¿†',\n      type: 'smart',\n      items: years.map(year => ({\n        year,\n        name: `${year}å¹´`\n      }))\n    })\n\n    return albums\n  }\n}\n","/**\n * PhotoMind - ç¼©ç•¥å›¾æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. ä»ç…§ç‰‡ç”Ÿæˆç¼©ç•¥å›¾\n * 2. ç¼“å­˜ç®¡ç†\n * 3. æ¸…ç†è¿‡æœŸç¼“å­˜\n */\nimport { resolve, join, extname } from 'path'\nimport { fileURLToPath } from 'url'\nimport { existsSync, mkdirSync, readdirSync, unlinkSync, statSync } from 'fs'\nimport crypto from 'crypto'\nimport sharp from 'sharp'\n\n// ğŸ†• ä½¿ç”¨ process.cwd() ç¡®ä¿ç¼©ç•¥å›¾ä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯æ„å»ºè¾“å‡ºç›®å½•\nconst PROJECT_ROOT = process.cwd()\n\nexport interface ThumbnailOptions {\n  width?: number\n  height?: number\n  quality?: number\n  format?: 'jpeg' | 'png' | 'webp'\n}\n\nexport interface ThumbnailResult {\n  path: string\n  width: number\n  height: number\n}\n\nexport class ThumbnailService {\n  private cacheDir: string\n  private thumbnailDir: string\n  private defaultOptions: ThumbnailOptions\n\n  constructor() {\n    this.cacheDir = resolve(PROJECT_ROOT, 'data/cache')\n    this.thumbnailDir = join(this.cacheDir, 'thumbnails')\n    this.defaultOptions = {\n      width: 300,\n      height: 300,\n      quality: 80,\n      format: 'jpeg'\n    }\n  }\n\n  /**\n   * åˆå§‹åŒ–ç¼“å­˜ç›®å½•\n   */\n  async init(): Promise<void> {\n    if (!existsSync(this.cacheDir)) {\n      mkdirSync(this.cacheDir, { recursive: true })\n    }\n    if (!existsSync(this.thumbnailDir)) {\n      mkdirSync(this.thumbnailDir, { recursive: true })\n    }\n    console.log('âœ“ ç¼©ç•¥å›¾æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n  }\n\n  /**\n   * ç”Ÿæˆç¼©ç•¥å›¾è·¯å¾„\n   */\n  private getThumbnailPath(filePath: string, options: ThumbnailOptions): string {\n    const name = crypto.createHash('md5').update(filePath + JSON.stringify(options)).digest('hex')\n    return join(this.thumbnailDir, `${name}.${options.format === 'png' ? 'png' : 'jpg'}`)\n  }\n\n  /**\n   * æ£€æŸ¥ç¼©ç•¥å›¾æ˜¯å¦å­˜åœ¨\n   */\n  async exists(filePath: string, options?: ThumbnailOptions): Promise<boolean> {\n    const thumbnailPath = this.getThumbnailPath(filePath, { ...this.defaultOptions, ...options })\n    return existsSync(thumbnailPath)\n  }\n\n  /**\n   * ç”Ÿæˆç¼©ç•¥å›¾\n   */\n  async generate(filePath: string, options?: ThumbnailOptions): Promise<ThumbnailResult | null> {\n    const opts = { ...this.defaultOptions, ...options }\n    const thumbnailPath = this.getThumbnailPath(filePath, opts)\n\n    // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n    if (existsSync(thumbnailPath)) {\n      return {\n        path: thumbnailPath,\n        width: opts.width || 0,\n        height: opts.height || 0\n      }\n    }\n\n    try {\n      // å°è¯•ä½¿ç”¨ sharp\n      if (!sharp) {\n        console.warn('sharp æœªå®‰è£…ï¼Œç¼©ç•¥å›¾åŠŸèƒ½å—é™')\n        return null\n      }\n\n      await sharp(filePath)\n        .resize(opts.width, opts.height, {\n          fit: 'cover',\n          position: 'center'\n        })\n        .jpeg({ quality: opts.quality })\n        .toFile(thumbnailPath)\n\n      return {\n        path: thumbnailPath,\n        width: opts.width || 0,\n        height: opts.height || 0\n      }\n    } catch (error) {\n      console.error('ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥:', error)\n      return null\n    }\n  }\n\n  /**\n   * æ‰¹é‡ç”Ÿæˆç¼©ç•¥å›¾\n   */\n  async generateBatch(filePaths: string[], onProgress?: (current: number, total: number) => void): Promise<{\n    success: number\n    failed: number\n  }> {\n    let success = 0\n    let failed = 0\n\n    for (let i = 0; i < filePaths.length; i++) {\n      const filePath = filePaths[i]\n      const result = await this.generate(filePath)\n\n      if (result) {\n        success++\n      } else {\n        failed++\n      }\n\n      onProgress?.(i + 1, filePaths.length)\n    }\n\n    return { success, failed }\n  }\n\n  /**\n   * è·å–ç¼©ç•¥å›¾è·¯å¾„ï¼ˆå¼‚æ­¥ï¼‰\n   */\n  async getThumbnailPathAsync(filePath: string): Promise<string> {\n    const existsThumb = await this.exists(filePath)\n    if (existsThumb) {\n      return this.getThumbnailPath(filePath, this.defaultOptions)\n    }\n    const result = await this.generate(filePath)\n    return result?.path || filePath\n  }\n\n  /**\n   * æ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆé»˜è®¤ 7 å¤©ï¼‰\n   */\n  async cleanCache(maxAge: number = 7 * 24 * 60 * 60 * 1000): Promise<number> {\n    if (!existsSync(this.thumbnailDir)) {\n      return 0\n    }\n\n    const now = Date.now()\n    let cleaned = 0\n\n    try {\n      const files = readdirSync(this.thumbnailDir)\n      for (const file of files) {\n        const filePath = join(this.thumbnailDir, file)\n        const stats = statSync(filePath)\n\n        if (now - stats.mtimeMs > maxAge) {\n          unlinkSync(filePath)\n          cleaned++\n        }\n      }\n    } catch (error) {\n      console.error('æ¸…ç†ç¼“å­˜å¤±è´¥:', error)\n    }\n\n    console.log(`æ¸…ç†äº† ${cleaned} ä¸ªè¿‡æœŸç¼©ç•¥å›¾`)\n    return cleaned\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰ç¼“å­˜\n   */\n  async clearCache(): Promise<number> {\n    if (!existsSync(this.thumbnailDir)) {\n      return 0\n    }\n\n    let count = 0\n    try {\n      const files = readdirSync(this.thumbnailDir)\n      for (const file of files) {\n        const filePath = join(this.thumbnailDir, file)\n        unlinkSync(filePath)\n        count++\n      }\n    } catch (error) {\n      console.error('æ¸…ç©ºç¼“å­˜å¤±è´¥:', error)\n    }\n\n    console.log(`æ¸…ç©ºäº† ${count} ä¸ªç¼©ç•¥å›¾`)\n    return count\n  }\n\n  /**\n   * è·å–ç¼“å­˜ç»Ÿè®¡\n   */\n  getCacheStats(): { count: number; size: number } {\n    if (!existsSync(this.thumbnailDir)) {\n      return { count: 0, size: 0 }\n    }\n\n    let count = 0\n    let size = 0\n\n    try {\n      const files = readdirSync(this.thumbnailDir)\n      for (const file of files) {\n        const filePath = join(this.thumbnailDir, file)\n        const stats = statSync(filePath)\n        count++\n        size += stats.size\n      }\n    } catch {\n      return { count: 0, size: 0 }\n    }\n\n    return { count, size }\n  }\n}\n\nexport const thumbnailService = new ThumbnailService()\n","import crypto from 'crypto';\nconst rnds8Pool = new Uint8Array(256); // # of random values to pre-allocate\n\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n  if (poolPtr > rnds8Pool.length - 16) {\n    crypto.randomFillSync(rnds8Pool);\n    poolPtr = 0;\n  }\n\n  return rnds8Pool.slice(poolPtr, poolPtr += 16);\n}","import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nconst byteToHex = [];\n\nfor (let i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).slice(1));\n}\n\nexport function unsafeStringify(arr, offset = 0) {\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  return byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]];\n}\n\nfunction stringify(arr, offset = 0) {\n  const uuid = unsafeStringify(arr, offset); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;","import crypto from 'crypto';\nexport default {\n  randomUUID: crypto.randomUUID\n};","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  if (native.randomUUID && !buf && !options) {\n    return native.randomUUID();\n  }\n\n  options = options || {};\n  const rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (let i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return unsafeStringify(rnds);\n}\n\nexport default v4;","/**\n * PhotoMind - æœ¬åœ°ç…§ç‰‡å¯¼å…¥æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹\n * 2. æ‰«æç…§ç‰‡æ–‡ä»¶ (jpg, png, heic, webp, etc.)\n * 3. æå– EXIF/å…ƒæ•°æ®\n * 4. ç”Ÿæˆç¼©ç•¥å›¾\n * 5. å­˜å…¥æ•°æ®åº“\n */\nimport { PhotoDatabase } from '../database/db.js'\nimport { thumbnailService, type ThumbnailService } from './thumbnailService.js'\nimport { readdirSync, statSync, existsSync, promises as fs } from 'fs'\nimport { resolve, extname, join, basename } from 'path'\nimport { v4 as uuidv4 } from 'uuid'\n\n// ç…§ç‰‡æ–‡ä»¶æ‰©å±•å\nconst PHOTO_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.heic', '.webp', '.gif', '.tiff', '.tif', '.JPG', '.JPEG', '.PNG', '.HEIC', '.WEBP', '.GIF', '.TIFF', '.TIF']\n\n// æ”¯æŒçš„ RAW æ ¼å¼\nconst RAW_EXTENSIONS = ['.raw', '.cr2', '.nef', '.arw', '.dng']\n\nexport interface PhotoMetadata {\n  id?: number\n  uuid: string\n  fileName: string\n  filePath: string\n  fileSize: number\n  width?: number\n  height?: number\n  takenAt?: string\n  exif?: {\n    camera?: string\n    lens?: string\n    iso?: number\n    aperture?: number\n    shutterSpeed?: string\n    focalLength?: number\n    fNumber?: number\n  }\n  location?: {\n    name?: string\n    latitude?: number\n    longitude?: number\n    altitude?: number\n  }\n  thumbnailPath?: string | null\n  status: 'local'\n}\n\nexport interface LocalImportProgress {\n  current: number\n  total: number\n  currentFile: string\n  status: 'scanning' | 'importing' | 'completed' | 'error'\n  importedCount: number\n  errorCount: number\n  skippedCount: number\n}\n\nexport interface ExtendedPhotoMetadata {\n  // åŸºæœ¬ä¿¡æ¯\n  make?: string           // ç›¸æœºå‚å•†\n  model?: string          // ç›¸æœºå‹å·\n  lensModel?: string      // é•œå¤´å‹å·\n\n  // æ—¥æœŸæ—¶é—´\n  dateTimeOriginal?: Date // æ‹æ‘„æ—¶é—´\n  createDate?: Date      // åˆ›å»ºæ—¶é—´\n  modifyDate?: Date       // ä¿®æ”¹æ—¶é—´\n\n  // ä½ç½®ä¿¡æ¯\n  latitude?: number       // çº¬åº¦\n  longitude?: number     // ç»åº¦\n  altitude?: number       // æµ·æ‹”\n  gpsTimestamp?: Date    // GPS æ—¶é—´æˆ³\n\n  // ç›¸æœºè®¾ç½®\n  fNumber?: number       // å…‰åœˆå€¼\n  exposureTime?: number  // å¿«é—¨é€Ÿåº¦\n  iso?: number           // ISO\n  focalLength?: number   // ç„¦è·\n  focalLength35mm?: number // 35mm ç­‰æ•ˆç„¦è·\n\n  // å›¾åƒä¿¡æ¯\n  width?: number         // å®½åº¦\n  height?: number        // é«˜åº¦\n  orientation?: number   // æ–¹å‘\n\n  // é¢å¤–ä¿¡æ¯\n  title?: string         // æ ‡é¢˜\n  description?: string   // æè¿°\n  copyright?: string     // ç‰ˆæƒ\n  artist?: string        // ä½œè€…\n}\n\nexport class LocalPhotoService {\n  private database: PhotoDatabase\n  private thumbnailService: ThumbnailService\n  private importCallback: ((progress: LocalImportProgress) => void) | null = null\n\n  constructor(database: PhotoDatabase, thumbnailSvc?: ThumbnailService) {\n    this.database = database\n    this.thumbnailService = thumbnailSvc || thumbnailService\n  }\n\n  /**\n   * è®¾ç½®è¿›åº¦å›è°ƒ\n   */\n  onProgress(callback: (progress: LocalImportProgress) => void): void {\n    this.importCallback = callback\n  }\n\n  /**\n   * é€šçŸ¥è¿›åº¦æ›´æ–°\n   */\n  private updateProgress(progress: Partial<LocalImportProgress>): void {\n    if (this.importCallback) {\n      this.importCallback({\n        current: 0,\n        total: 0,\n        currentFile: '',\n        status: 'scanning',\n        importedCount: 0,\n        errorCount: 0,\n        skippedCount: 0,\n        ...progress\n      })\n    }\n  }\n\n  /**\n   * æ‰«ææ–‡ä»¶å¤¹ä¸­çš„ç…§ç‰‡\n   */\n  async scanFolder(folderPath: string): Promise<string[]> {\n    const photos: string[] = []\n\n    if (!existsSync(folderPath)) {\n      throw new Error(`æ–‡ä»¶å¤¹ä¸å­˜åœ¨: ${folderPath}`)\n    }\n\n    // æ£€æŸ¥æ˜¯å¦æ˜¯åº”ç”¨ç¨‹åºç›®å½•ï¼ˆé˜²æ­¢ç”¨æˆ·è¯¯é€‰é¡¹ç›®æ–‡ä»¶å¤¹ï¼‰\n    const appDir = process.cwd()\n    const userHome = process.env.HOME || process.env.USERPROFILE || ''\n    if (folderPath === appDir || folderPath.startsWith(appDir + '/')) {\n      console.warn(`[LocalPhotoService] è·³è¿‡åº”ç”¨ç¨‹åºç›®å½•: ${folderPath}`)\n      return []\n    }\n\n    const scanDirectory = (dir: string): void => {\n      try {\n        const entries = readdirSync(dir, { withFileTypes: true })\n\n        for (const entry of entries) {\n          const fullPath = join(dir, entry.name)\n\n          if (entry.isDirectory()) {\n            // è·³è¿‡éšè—æ–‡ä»¶å¤¹å’Œç³»ç»Ÿæ–‡ä»¶å¤¹\n            if (!entry.name.startsWith('.') && entry.name !== 'node_modules') {\n              scanDirectory(fullPath)\n            }\n          } else if (entry.isFile()) {\n            const ext = extname(entry.name).toLowerCase()\n            // åªæ¥å—å›¾ç‰‡æ–‡ä»¶ï¼ˆå¸¦æ‰©å±•åæ£€æŸ¥ï¼‰\n            if (PHOTO_EXTENSIONS.includes(ext) && entry.name.split('.').length > 1) {\n              photos.push(fullPath)\n            }\n          }\n        }\n      } catch (error) {\n        console.error(`æ‰«ææ–‡ä»¶å¤¹å¤±è´¥: ${dir}`, error)\n      }\n    }\n\n    scanDirectory(folderPath)\n    return photos.sort()\n  }\n\n  /**\n   * æå–ç…§ç‰‡å…ƒæ•°æ®\n   * æ”¯æŒ EXIFã€GPSã€ç›¸æœºä¿¡æ¯ç­‰\n   */\n  async extractMetadata(filePath: string): Promise<PhotoMetadata> {\n    const stats = statSync(filePath)\n    const fileName = basename(filePath)\n    const ext = extname(filePath).toLowerCase()\n\n    const metadata: PhotoMetadata = {\n      uuid: uuidv4(),\n      fileName,\n      filePath,\n      fileSize: stats.size,\n      status: 'local'\n    }\n\n    // RAW æ ¼å¼åªä½¿ç”¨æ–‡ä»¶ä¿¡æ¯\n    if (RAW_EXTENSIONS.includes(ext)) {\n      metadata.takenAt = stats.mtime.toISOString()\n      return metadata\n    }\n\n    // å°è¯•æå– EXIF æ•°æ®\n    try {\n      const exifData = await this.extractEXIFData(filePath, ext)\n\n      if (exifData) {\n        // åŸºæœ¬ä¿¡æ¯\n        if (exifData.Make || exifData.Model) {\n          metadata.exif = {\n            camera: `${exifData.Make || ''} ${exifData.Model || ''}`.trim(),\n            iso: exifData.ISO || exifData.ISO200 || undefined,\n            aperture: exifData.FNumber,\n            shutterSpeed: exifData.ExposureTime ? this.formatShutterSpeed(exifData.ExposureTime) : undefined,\n            focalLength: exifData.FocalLength,\n            fNumber: exifData.FNumber\n          }\n        }\n\n        // æ—¥æœŸæ—¶é—´\n        metadata.takenAt = exifData.DateTimeOriginal?.toISOString() ||\n                          exifData.CreateDate?.toISOString() ||\n                          stats.mtime.toISOString()\n\n        // å›¾åƒå°ºå¯¸\n        if (exifData.ImageWidth || exifData.ExifImageWidth) {\n          metadata.width = exifData.ImageWidth || exifData.ExifImageWidth\n        }\n        if (exifData.ImageHeight || exifData.ExifImageHeight) {\n          metadata.height = exifData.ImageHeight || exifData.ExifImageHeight\n        }\n\n        // GPS ä½ç½®\n        if (exifData.latitude && exifData.longitude) {\n          metadata.location = {\n            latitude: exifData.latitude,\n            longitude: exifData.longitude,\n            altitude: exifData.GPSAltitude\n          }\n        }\n      } else {\n        metadata.takenAt = stats.mtime.toISOString()\n      }\n    } catch (error) {\n      console.warn(`æå–å…ƒæ•°æ®å¤±è´¥: ${filePath}`, error)\n      metadata.takenAt = stats.mtime.toISOString()\n    }\n\n    return metadata\n  }\n\n  /**\n   * æå– EXIF æ•°æ®ï¼ˆå¢å¼ºç‰ˆï¼‰\n   */\n  private async extractEXIFData(filePath: string, ext: string): Promise<any | null> {\n    try {\n      const buffer = await fs.readFile(filePath)\n\n      // JPEG: æ£€æŸ¥ JPEG æ ‡è®° (0xFF 0xD8)\n      if (ext === '.jpg' || ext === '.jpeg') {\n        if (buffer[0] !== 0xFF || buffer[1] !== 0xD8) {\n          return null\n        }\n        return this.parseJPEGEXIF(buffer)\n      }\n\n      // PNG: æ£€æŸ¥ PNG ç­¾å\n      if (ext === '.png') {\n        const pngSignature = Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A])\n        if (!buffer.slice(0, 8).equals(pngSignature)) {\n          return null\n        }\n        return this.parsePNGEXIF(buffer)\n      }\n\n      // HEIC: éœ€è¦ä¸“é—¨åº“æ”¯æŒ\n      if (ext === '.heic' || ext === '.heif') {\n        console.warn('HEIC æ ¼å¼éœ€è¦ä¸“é—¨åº“æ”¯æŒ')\n        return null\n      }\n\n      return null\n    } catch (error) {\n      return null\n    }\n  }\n\n  /**\n   * è§£æ JPEG EXIF æ•°æ®\n   */\n  private parseJPEGEXIF(buffer: Buffer): any {\n    const result: any = {}\n\n    let offset = 2 // è·³è¿‡ JPEG ç­¾å\n\n    while (offset < buffer.length - 1) {\n      // æŸ¥æ‰¾ APP1 æ®µ (0xFF 0xE1)\n      if (buffer[offset] === 0xFF && buffer[offset + 1] === 0xE1) {\n        // è·å–æ®µé•¿åº¦\n        const segmentLength = (buffer[offset + 2] << 8) | buffer[offset + 3]\n\n        // æ£€æŸ¥æ˜¯å¦æ˜¯ EXIF\n        const exifHeader = buffer.toString('latin1', offset + 4, offset + 10)\n        if (exifHeader === 'Exif\\x00\\x00') {\n          // è§£æ TIFF å¤´\n          const tiffOffset = offset + 10\n          const byteOrder = buffer.readUInt16BE(tiffOffset)\n\n          let ifdOffset: number\n          if (byteOrder === 0x4949) {\n            // Little endian\n            ifdOffset = tiffOffset + buffer.readUInt32LE(tiffOffset + 4)\n          } else {\n            // Big endian\n            ifdOffset = tiffOffset + buffer.readUInt32BE(tiffOffset + 4)\n          }\n\n          this.parseEXIFIFD(buffer, ifdOffset, byteOrder, result)\n          break\n        }\n\n        offset += segmentLength + 2\n      } else if (buffer[offset] === 0xFF && buffer[offset + 1] !== 0x00) {\n        // è·³è¿‡å…¶ä»–æ®µ\n        const segmentLength = (buffer[offset + 2] << 8) | buffer[offset + 3]\n        offset += segmentLength + 2\n      } else {\n        offset++\n      }\n    }\n\n    return result\n  }\n\n  /**\n   * è§£æ EXIF IFD\n   */\n  private parseEXIFIFD(buffer: Buffer, offset: number, byteOrder: number, result: any): void {\n    try {\n      const numEntries = byteOrder === 0x4949\n        ? buffer.readUInt16LE(offset)\n        : buffer.readUInt16BE(offset)\n\n      for (let i = 0; i < numEntries; i++) {\n        const entryOffset = offset + 2 + (i * 12)\n        const tag = byteOrder === 0x4949\n          ? buffer.readUInt16LE(entryOffset)\n          : buffer.readUInt16BE(entryOffset)\n\n        const type = byteOrder === 0x4949\n          ? buffer.readUInt16LE(entryOffset + 2)\n          : buffer.readUInt16BE(entryOffset + 2)\n\n        const count = byteOrder === 0x4949\n          ? buffer.readUInt32LE(entryOffset + 4)\n          : buffer.readUInt32BE(entryOffset + 4)\n\n        const value = this.readEXIFValue(buffer, entryOffset, type, count, byteOrder, result)\n\n        // æ˜ å°„å¸¸ç”¨æ ‡ç­¾\n        this.mapEXIFTag(tag, value, result)\n      }\n    } catch (error) {\n      console.warn('è§£æ EXIF IFD å¤±è´¥:', error)\n    }\n  }\n\n  /**\n   * æ˜ å°„ EXIF æ ‡ç­¾åˆ°ç»“æœ\n   */\n  private mapEXIFTag(tag: number, value: any, result: any): void {\n    const tagMap: Record<number, string> = {\n      0x010F: 'Make',           // ç›¸æœºå‚å•†\n      0x0110: 'Model',         // ç›¸æœºå‹å·\n      0x011A: 'XResolution',\n      0x011B: 'YResolution',\n      0x0128: 'ResolutionUnit',\n      0x0131: 'Software',\n      0x0132: 'DateTime',\n      0x013B: 'Artist',\n      0x8298: 'Copyright',\n      0x8769: 'ExifIFDPointer',\n      0x8825: 'GPSInfoIFDPointer',\n    }\n\n    const exifTagMap: Record<number, string> = {\n      0x829A: 'ExposureTime',   // å¿«é—¨é€Ÿåº¦\n      0x829D: 'FNumber',       // å…‰åœˆ\n      0x8827: 'ISO',           // ISO\n      0x9000: 'ExifVersion',\n      0x9003: 'DateTimeOriginal',\n      0x9004: 'DateTimeDigitized',\n      0x9201: 'ShutterSpeedValue',\n      0x9202: 'ApertureValue',\n      0x9204: 'ExposureBiasValue',\n      0x9207: 'MeteringMode',\n      0x9208: 'LightSource',\n      0x9209: 'Flash',\n      0x920A: 'FocalLength',\n      0xA001: 'ColorSpace',\n      0xA002: 'PixelXDimension',\n      0xA003: 'PixelYDimension',\n      0xA402: 'ExposureMode',\n      0xA403: 'WhiteBalance',\n      0xA406: 'SceneCaptureType',\n      0x0000: 'GPSVersionID',\n      0x0001: 'GPSLatitudeRef',\n      0x0002: 'GPSLatitude',\n      0x0003: 'GPSLongitudeRef',\n      0x0004: 'GPSLongitude',\n      0x0005: 'GPSAltitudeRef',\n      0x0006: 'GPSAltitude',\n    }\n\n    const gpsTagMap: Record<number, string> = {\n      0x0000: 'GPSVersionID',\n      0x0001: 'GPSLatitudeRef',\n      0x0002: 'GPSLatitude',\n      0x0003: 'GPSLongitudeRef',\n      0x0004: 'GPSLongitude',\n      0x0005: 'GPSAltitudeRef',\n      0x0006: 'GPSAltitude',\n      0x0007: 'GPSTimeStamp',\n      0x001D: 'GPSDateStamp',\n    }\n\n    if (tagMap[tag]) {\n      result[tagMap[tag]] = value\n    }\n  }\n\n  /**\n   * è¯»å– EXIF å€¼\n   */\n  private readEXIFValue(\n    buffer: Buffer,\n    entryOffset: number,\n    type: number,\n    count: number,\n    byteOrder: number,\n    result: any\n  ): any {\n    const typeSizes: Record<number, number> = {\n      1: 1,   // BYTE\n      2: 1,   // ASCII\n      3: 2,   // SHORT\n      4: 4,   // LONG\n      5: 8,   // RATIONAL\n      6: 1,   // SBYTE\n      7: 1,   // UNDEFINED\n      8: 2,   // SSHORT\n      9: 4,   // SLONG\n      10: 8,  // SRATIONAL\n    }\n\n    try {\n      const typeSize = typeSizes[type] || 1\n      const valueSize = typeSize * count\n\n      let valueOffset = entryOffset + 8\n      if (valueSize > 4) {\n        valueOffset = byteOrder === 0x4949\n          ? buffer.readUInt32LE(entryOffset + 8)\n          : buffer.readUInt32BE(entryOffset + 8)\n      }\n\n      switch (type) {\n        case 2: // ASCII\n          return buffer.toString('utf8', valueOffset, valueOffset + count - 1).replace(/\\0+$/, '')\n        case 3: // SHORT\n          return count === 1\n            ? (byteOrder === 0x4949 ? buffer.readUInt16LE(valueOffset) : buffer.readUInt16BE(valueOffset))\n            : undefined\n        case 4: // LONG\n          return count === 1\n            ? (byteOrder === 0x4949 ? buffer.readUInt32LE(valueOffset) : buffer.readUInt32BE(valueOffset))\n            : undefined\n        case 5: // RATIONAL\n          if (count === 1) {\n            const num = byteOrder === 0x4949 ? buffer.readUInt32LE(valueOffset) : buffer.readUInt32BE(valueOffset)\n            const den = byteOrder === 0x4949 ? buffer.readUInt32LE(valueOffset + 4) : buffer.readUInt32BE(valueOffset + 4)\n            return den ? num / den : 0\n          }\n          return undefined\n        default:\n          return undefined\n      }\n    } catch {\n      return undefined\n    }\n  }\n\n  /**\n   * è§£æ PNG å…ƒæ•°æ®\n   */\n  private parsePNGEXIF(buffer: Buffer): any {\n    // PNG ä¸ä½¿ç”¨ EXIFï¼Œä½¿ç”¨æ–‡æœ¬å—\n    const result: any = {}\n    let offset = 8 // è·³è¿‡ PNG ç­¾å\n\n    while (offset < buffer.length - 8) {\n      const length = buffer.readUInt32BE(offset)\n      const chunkType = buffer.toString('ascii', offset + 4, offset + 8)\n\n      if (chunkType === 'tEXt' || chunkType === 'iTXt' || chunkType === 'zTXt') {\n        const data = buffer.slice(offset + 8, offset + 8 + length)\n        const nullIndex = data.indexOf(0)\n        if (nullIndex > 0) {\n          const keyword = data.slice(0, nullIndex).toString('ascii')\n          const text = data.slice(nullIndex + 1).toString('utf8')\n\n          if (keyword === 'Description') result.Description = text\n          if (keyword === 'Title') result.Title = text\n          if (keyword === 'Author') result.Artist = text\n          if (keyword === 'Copyright') result.Copyright = text\n          if (keyword === 'DateTime') result.DateTime = text\n        }\n      }\n\n      if (chunkType === 'IEND') break\n      offset += length + 12\n    }\n\n    return result\n  }\n\n  /**\n   * æ ¼å¼åŒ–å¿«é—¨é€Ÿåº¦\n   */\n  private formatShutterSpeed(seconds: number): string {\n    if (seconds >= 1) {\n      return `${seconds}s`\n    }\n    const denominator = Math.round(1 / seconds)\n    return `1/${denominator}`\n  }\n\n  /**\n   * å¯¼å…¥æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ç…§ç‰‡\n   */\n  async importFolder(folderPath: string): Promise<{\n    imported: number\n    skipped: number\n    errors: number\n    photos: PhotoMetadata[]\n  }> {\n    let importedCount = 0\n    let skippedCount = 0\n    let errorCount = 0\n    const importedPhotos: PhotoMetadata[] = []\n\n    this.updateProgress({\n      status: 'scanning',\n      total: 0\n    })\n\n    try {\n      // 1. æ‰«æç…§ç‰‡\n      const photos = await this.scanFolder(folderPath)\n\n      this.updateProgress({\n        status: 'importing',\n        total: photos.length,\n        current: 0,\n        importedCount: 0,\n        errorCount: 0,\n        skippedCount: 0\n      })\n\n      console.log(`æ‰¾åˆ° ${photos.length} å¼ ç…§ç‰‡`)\n\n      // 2. é€ä¸ªå¤„ç†ç…§ç‰‡\n      for (let i = 0; i < photos.length; i++) {\n        const filePath = photos[i]\n\n        this.updateProgress({\n          current: i + 1,\n          total: photos.length,\n          currentFile: basename(filePath),\n          importedCount,\n          errorCount,\n          skippedCount\n        })\n\n        try {\n          // æå–å…ƒæ•°æ®\n          const metadata = await this.extractMetadata(filePath)\n\n          // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼ˆé€šè¿‡ filePath åˆ¤æ–­ï¼‰\n          const existingPhoto = this.database.getPhotoByFilePath(filePath)\n          if (existingPhoto) {\n            console.log(`[LocalPhotoService] æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡: ${basename(filePath)}`)\n            skippedCount++\n            this.updateProgress({\n              current: i + 1,\n              total: photos.length,\n              currentFile: basename(filePath),\n              importedCount,\n              errorCount,\n              skippedCount\n            })\n            continue\n          }\n\n          // ç”Ÿæˆç¼©ç•¥å›¾\n          let thumbnailPath: string | null = null\n          try {\n            const thumbnailResult = await this.thumbnailService.generate(filePath)\n            if (thumbnailResult) {\n              thumbnailPath = thumbnailResult.path\n              console.log(`[LocalPhotoService] ç¼©ç•¥å›¾ç”ŸæˆæˆåŠŸ: ${basename(filePath)}`)\n            }\n          } catch (thumbError) {\n            console.warn(`[LocalPhotoService] ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥: ${filePath}`, thumbError)\n          }\n\n          // ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆåŒ…å«ç¼©ç•¥å›¾è·¯å¾„ï¼‰\n          const photoData = {\n            ...metadata,\n            thumbnailPath\n          }\n          const photoId = this.database.addPhoto(photoData)\n\n          if (photoId > 0) {\n            importedCount++\n            importedPhotos.push({\n              ...photoData,\n              id: photoId\n            })\n          } else {\n            errorCount++\n          }\n\n        } catch (error) {\n          console.error(`å¯¼å…¥ç…§ç‰‡å¤±è´¥: ${filePath}`, error)\n          errorCount++\n        }\n      }\n\n      this.updateProgress({\n        status: 'completed',\n        current: photos.length,\n        total: photos.length,\n        importedCount,\n        errorCount,\n        skippedCount\n      })\n\n    } catch (error) {\n      console.error('æ‰«ææ–‡ä»¶å¤¹å¤±è´¥:', error)\n      this.updateProgress({\n        status: 'error',\n        errorCount: 1\n      })\n      throw error\n    }\n\n    return {\n      imported: importedCount,\n      skipped: skippedCount,\n      errors: errorCount,\n      photos: importedPhotos\n    }\n  }\n\n  /**\n   * å¯¼å…¥å•å¼ ç…§ç‰‡\n   */\n  async importPhoto(filePath: string): Promise<PhotoMetadata | null> {\n    try {\n      const metadata = await this.extractMetadata(filePath)\n      const photoId = this.database.addPhoto(metadata)\n\n      if (photoId > 0) {\n        return {\n          ...metadata,\n          id: photoId\n        }\n      }\n      return null\n    } catch (error) {\n      console.error(`å¯¼å…¥ç…§ç‰‡å¤±è´¥: ${filePath}`, error)\n      return null\n    }\n  }\n\n  /**\n   * è·å–å·²å¯¼å…¥çš„ç…§ç‰‡æ•°é‡\n   */\n  getPhotoCount(): number {\n    try {\n      return this.database.getPhotoCount()\n    } catch (error) {\n      console.error('è·å–ç…§ç‰‡æ•°é‡å¤±è´¥:', error)\n      return 0\n    }\n  }\n\n  /**\n   * è·å–æ²¡æœ‰åµŒå…¥å‘é‡çš„ç…§ç‰‡\n   */\n  getPhotosWithoutEmbeddings(limit: number = 100): any[] {\n    try {\n      const photos = this.database.getPhotosWithoutEmbeddings(limit)\n      return photos.map(p => ({\n        id: p.id,\n        uuid: p.uuid,\n        filePath: p.file_path,\n        fileName: p.file_name,\n        thumbnailPath: p.thumbnail_path,\n        takenAt: p.taken_at\n      }))\n    } catch (error) {\n      console.error('è·å–æ— å‘é‡ç…§ç‰‡å¤±è´¥:', error)\n      return []\n    }\n  }\n\n  /**\n   * è·å–æœ¬åœ°ç…§ç‰‡ï¼ˆä¾› photos:get-list è°ƒç”¨ï¼‰\n   */\n  getLocalPhotos(limit: number = 100, offset: number = 0): any[] {\n    try {\n      console.log(`[LocalPhotoService] getLocalPhotos - limit: ${limit}, offset: ${offset}`)\n      console.log(`[LocalPhotoService] database å¯ç”¨: ${!!this.database}`)\n\n      const photos = this.database.getAllPhotos(limit, offset)\n      console.log(`[LocalPhotoService] getAllPhotos è¿”å› ${photos.length} æ¡è®°å½•`)\n\n      const result = photos.map(p => ({\n        id: p.id,\n        uuid: p.uuid,\n        cloudId: p.cloud_id,\n        filePath: p.file_path,\n        fileName: p.file_name,\n        fileSize: p.file_size,\n        width: p.width,\n        height: p.height,\n        takenAt: p.taken_at,\n        exif: this.parseJsonField(p.exif_data),\n        location: this.parseJsonField(p.location_data),\n        thumbnailPath: p.thumbnail_path,\n        status: p.status || 'local'\n      }))\n\n      console.log(`[LocalPhotoService] æ˜ å°„åè¿”å› ${result.length} å¼ ç…§ç‰‡`)\n      return result\n    } catch (error) {\n      console.error('[LocalPhotoService] è·å–æœ¬åœ°ç…§ç‰‡å¤±è´¥:', error)\n      return []\n    }\n  }\n\n  /**\n   * å®‰å…¨è§£æ JSON å­—æ®µï¼ˆå…¼å®¹å·²è§£æçš„å¯¹è±¡å’Œ JSON å­—ç¬¦ä¸²ï¼‰\n   */\n  private parseJsonField(field: any): any {\n    if (!field) return {}\n    if (typeof field === 'object') return field  // å·²ç»æ˜¯å¯¹è±¡\n    if (typeof field === 'string') {\n      try { return JSON.parse(field) } catch { return {} }\n    }\n    return {}\n  }\n\n  /**\n   * åˆ é™¤ç…§ç‰‡\n   * @param photoId ç…§ç‰‡ ID\n   * @returns æ˜¯å¦åˆ é™¤æˆåŠŸ\n   */\n  deletePhoto(photoId: number): boolean {\n    try {\n      console.log(`[LocalPhotoService] åˆ é™¤ç…§ç‰‡: ${photoId}`)\n\n      // å…ˆé€šè¿‡ ID è·å–ç…§ç‰‡çš„ UUID\n      const photo = this.database.getPhotoById(photoId)\n\n      if (!photo) {\n        console.warn(`[LocalPhotoService] ç…§ç‰‡ ${photoId} ä¸å­˜åœ¨äºæ•°æ®åº“`)\n        return false\n      }\n\n      // ä½¿ç”¨ UUID åˆ é™¤ç…§ç‰‡\n      const success = this.database.deletePhoto(photo.uuid)\n\n      if (success) {\n        console.log(`[LocalPhotoService] ç…§ç‰‡ ${photoId} (uuid: ${photo.uuid}) å·²ä»æ•°æ®åº“åˆ é™¤`)\n      }\n\n      return success\n    } catch (error) {\n      console.error(`[LocalPhotoService] åˆ é™¤ç…§ç‰‡å¤±è´¥: ${photoId}`, error)\n      return false\n    }\n  }\n}\n","/**\n * PhotoMind - æ–‡ä»¶å¤¹æ‰«ææœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. æ‰«ææ–‡ä»¶å¤¹åŠå…¶å­ç›®å½•\n * 2. è¯†åˆ«æ”¯æŒçš„å›¾ç‰‡æ ¼å¼\n * 3. ä¼°ç®—å¯¼å…¥æ—¶é—´\n */\nimport { promises as fs } from 'fs'\nimport { join, extname } from 'path'\n\nexport interface ScanOptions {\n  extensions?: string[]\n  recursive?: boolean\n  skipHidden?: boolean\n}\n\nexport interface ScannedFile {\n  path: string\n  filename: string\n  extension: string\n  size: number\n  mtime: Date\n}\n\nexport class FolderScanner {\n  private supportedExtensions = [\n    '.jpg', '.jpeg', '.png', '.gif', '.webp',\n    '.heic', '.heif', '.raw', '.cr2', '.nef', '.arw',\n    '.tiff', '.tif', '.bmp'\n  ]\n\n  /**\n   * æ‰«ææ–‡ä»¶å¤¹\n   */\n  async scanFolder(\n    folderPath: string,\n    options: ScanOptions = {}\n  ): Promise<ScannedFile[]> {\n    const {\n      extensions = this.supportedExtensions,\n      recursive = true,\n      skipHidden = true\n    } = options\n\n    // æ£€æŸ¥æ˜¯å¦æ˜¯åº”ç”¨ç¨‹åºç›®å½•ï¼ˆé˜²æ­¢ç”¨æˆ·è¯¯é€‰é¡¹ç›®æ–‡ä»¶å¤¹ï¼‰\n    const appDir = process.cwd()\n    if (folderPath === appDir || folderPath.startsWith(appDir + '/')) {\n      console.warn(`[FolderScanner] è·³è¿‡åº”ç”¨ç¨‹åºç›®å½•: ${folderPath}`)\n      return []\n    }\n\n    const files: ScannedFile[] = []\n\n    await this.scanDirectory(folderPath, '', files, {\n      extensions,\n      recursive,\n      skipHidden\n    })\n\n    return files\n  }\n\n  /**\n   * é€’å½’æ‰«æç›®å½•\n   */\n  private async scanDirectory(\n    rootPath: string,\n    relativePath: string,\n    files: ScannedFile[],\n    options: ScanOptions\n  ): Promise<void> {\n    const fullPath = join(rootPath, relativePath)\n\n    try {\n      const entries = await fs.readdir(fullPath, { withFileTypes: true })\n\n      for (const entry of entries) {\n        const entryPath = join(relativePath, entry.name)\n\n        if (entry.isDirectory()) {\n          if (options.recursive && !(options.skipHidden && entry.name.startsWith('.'))) {\n            await this.scanDirectory(rootPath, entryPath, files, options)\n          }\n        } else if (entry.isFile()) {\n          if (this.shouldIncludeFile(entry.name, options)) {\n            const filePath = join(rootPath, entryPath)\n            const stats = await fs.stat(filePath)\n\n            files.push({\n              path: filePath,\n              filename: entry.name,\n              extension: extname(entry.name).toLowerCase(),\n              size: stats.size,\n              mtime: stats.mtime\n            })\n          }\n        }\n      }\n    } catch (error) {\n      console.error(`æ‰«æç›®å½•å¤±è´¥: ${fullPath}`, error)\n      throw error\n    }\n  }\n\n  /**\n   * åˆ¤æ–­æ˜¯å¦åº”è¯¥åŒ…å«è¯¥æ–‡ä»¶\n   */\n  private shouldIncludeFile(filename: string, options: ScanOptions): boolean {\n    const ext = extname(filename).toLowerCase()\n\n    // å¿…é¡»æœ‰æ‰©å±•å\n    if (!ext || ext === filename) {\n      return false\n    }\n\n    if (options.skipHidden && filename.startsWith('.')) {\n      return false\n    }\n\n    return options.extensions!.includes(ext)\n  }\n\n  /**\n   * ä¼°ç®—å¯¼å…¥æ—¶é—´ï¼ˆç§’ï¼‰\n   */\n  async estimateImportTime(files: ScannedFile[]): Promise<number> {\n    const totalSize = files.reduce((sum, f) => sum + f.size, 0)\n    // å‡è®¾å¹³å‡å¤åˆ¶é€Ÿåº¦ 30MB/s\n    const estimatedSeconds = totalSize / (30 * 1024 * 1024)\n    return Math.ceil(estimatedSeconds)\n  }\n\n  /**\n   * è·å–æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å\n   */\n  getSupportedExtensions(): string[] {\n    return [...this.supportedExtensions]\n  }\n\n  /**\n   * æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯æ”¯æŒçš„å›¾ç‰‡æ ¼å¼\n   */\n  isSupportedFile(filePath: string): boolean {\n    const ext = extname(filePath).toLowerCase()\n    return this.supportedExtensions.includes(ext)\n  }\n}\n\nexport const folderScanner = new FolderScanner()\n","/**\n * PhotoMind - å¯¼å…¥è¿›åº¦æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. å®æ—¶è·Ÿè¸ªå¯¼å…¥è¿›åº¦\n * 2. å¤šé˜¶æ®µè¿›åº¦ç®¡ç†\n * 3. é¢„è®¡å‰©ä½™æ—¶é—´è®¡ç®—\n * 4. å¤šç›‘å¬å™¨æ”¯æŒ\n */\nimport { EventEmitter } from 'events'\n\nexport type ImportStage = 'scanning' | 'preparing' | 'importing' | 'metadata' | 'thumbnails' | 'complete' | 'cancelled'\n\nexport interface ImportProgress {\n  stage: ImportStage\n  currentFile?: string\n  currentIndex: number\n  total: number\n  imported: number\n  skipped: number\n  failed: number\n  errors: Array<{ file: string; error: string }>\n  startTime: number\n  estimatedTimeRemaining?: number\n  bytesProcessed?: number\n  totalBytes?: number\n}\n\nexport interface ProgressListener {\n  (progress: ImportProgress): void\n}\n\nexport class ImportProgressService extends EventEmitter {\n  private currentProgress: ImportProgress | null = null\n  private progressInterval: NodeJS.Timeout | null = null\n  private progressListeners: Set<ProgressListener> = new Set()\n  private lastUpdateTime: number = 0\n\n  constructor() {\n    super()\n  }\n\n  /**\n   * è®¢é˜…è¿›åº¦æ›´æ–°\n   */\n  subscribe(listener: ProgressListener): () => void {\n    this.progressListeners.add(listener)\n    return () => this.progressListeners.delete(listener)\n  }\n\n  /**\n   * é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨\n   */\n  private notify(): void {\n    if (!this.currentProgress) return\n\n    // é™åˆ¶æ›´æ–°é¢‘ç‡ï¼ˆæ¯ç§’æœ€å¤š 2 æ¬¡ï¼‰\n    const now = Date.now()\n    if (now - this.lastUpdateTime < 500 && this.currentProgress.stage !== 'complete') {\n      return\n    }\n    this.lastUpdateTime = now\n\n    for (const listener of this.progressListeners) {\n      try {\n        listener({ ...this.currentProgress })\n      } catch (error) {\n        console.error('[ImportProgress] ç›‘å¬å™¨é”™è¯¯:', error)\n      }\n    }\n  }\n\n  /**\n   * å¼€å§‹æ–°çš„å¯¼å…¥ä¼šè¯\n   */\n  startSession(total: number, stage: ImportStage = 'preparing'): void {\n    this.currentProgress = {\n      stage,\n      currentIndex: 0,\n      total,\n      imported: 0,\n      skipped: 0,\n      failed: 0,\n      errors: [],\n      startTime: Date.now()\n    }\n\n    // å¯åŠ¨å®šæœŸè¿›åº¦æ›´æ–°\n    this.startProgressTimer()\n    this.notify()\n  }\n\n  /**\n   * å¯åŠ¨è¿›åº¦å®šæ—¶å™¨\n   */\n  private startProgressTimer(): void {\n    if (this.progressInterval) {\n      clearInterval(this.progressInterval)\n    }\n\n    this.progressInterval = setInterval(() => {\n      this.updateEstimatedTime()\n      this.notify()\n    }, 1000)\n  }\n\n  /**\n   * æ›´æ–°é˜¶æ®µ\n   */\n  setStage(stage: ImportStage): void {\n    if (this.currentProgress) {\n      this.currentProgress.stage = stage\n      this.notify()\n    }\n  }\n\n  /**\n   * æ›´æ–°å½“å‰æ–‡ä»¶\n   */\n  updateCurrentFile(file: string): void {\n    if (this.currentProgress) {\n      this.currentProgress.currentFile = file\n      this.notify()\n    }\n  }\n\n  /**\n   * æ›´æ–°è¿›åº¦ï¼ˆæ¯å¤„ç†ä¸€ä¸ªæ–‡ä»¶åè°ƒç”¨ï¼‰\n   */\n  advanceProgress(\n    imported: boolean = true,\n    skipped: boolean = false,\n    failed: boolean = false\n  ): void {\n    if (!this.currentProgress) return\n\n    this.currentProgress.currentIndex++\n\n    if (imported) this.currentProgress.imported++\n    if (skipped) this.currentProgress.skipped++\n    if (failed) this.currentProgress.failed++\n\n    this.updateEstimatedTime()\n    this.notify()\n  }\n\n  /**\n   * æ·»åŠ é”™è¯¯\n   */\n  addError(file: string, error: string): void {\n    if (this.currentProgress) {\n      // åªä¿ç•™å‰ 20 ä¸ªé”™è¯¯\n      if (this.currentProgress.errors.length < 20) {\n        this.currentProgress.errors.push({ file, error })\n      } else if (this.currentProgress.errors.length === 20) {\n        this.currentProgress.errors.push({ file, error: 'æ›´å¤šé”™è¯¯å·²çœç•¥...' })\n      }\n      this.currentProgress.failed++\n      this.notify()\n    }\n  }\n\n  /**\n   * è®¡ç®—é¢„è®¡å‰©ä½™æ—¶é—´\n   */\n  private updateEstimatedTime(): void {\n    if (!this.currentProgress || this.currentProgress.currentIndex === 0) {\n      return\n    }\n\n    const elapsed = Date.now() - this.currentProgress.startTime\n    const avgTimePerFile = elapsed / this.currentProgress.currentIndex\n    const remaining = (this.currentProgress.total - this.currentProgress.currentIndex) * avgTimePerFile\n\n    this.currentProgress.estimatedTimeRemaining = Math.ceil(remaining / 1000)\n  }\n\n  /**\n   * è®¾ç½®å­—èŠ‚è¿›åº¦\n   */\n  setBytesProgress(bytesProcessed: number, totalBytes: number): void {\n    if (this.currentProgress) {\n      this.currentProgress.bytesProcessed = bytesProcessed\n      this.currentProgress.totalBytes = totalBytes\n      this.notify()\n    }\n  }\n\n  /**\n   * å®Œæˆå¯¼å…¥\n   */\n  complete(success: boolean = true): ImportProgress | null {\n    if (!this.currentProgress) return null\n\n    this.currentProgress.stage = success ? 'complete' : 'cancelled'\n    this.currentProgress.estimatedTimeRemaining = 0\n    this.stop()\n\n    const result = { ...this.currentProgress }\n    this.notify()\n    return result\n  }\n\n  /**\n   * å–æ¶ˆå¯¼å…¥\n   */\n  cancel(): void {\n    if (this.currentProgress) {\n      this.currentProgress.stage = 'cancelled'\n      this.stop()\n      this.notify()\n    }\n  }\n\n  /**\n   * åœæ­¢è¿›åº¦è¿½è¸ª\n   */\n  private stop(): void {\n    if (this.progressInterval) {\n      clearInterval(this.progressInterval)\n      this.progressInterval = null\n    }\n  }\n\n  /**\n   * è·å–å½“å‰è¿›åº¦\n   */\n  getProgress(): ImportProgress | null {\n    return this.currentProgress ? { ...this.currentProgress } : null\n  }\n\n  /**\n   * è·å–è¿›åº¦ç™¾åˆ†æ¯”\n   */\n  getPercentage(): number {\n    if (!this.currentProgress || this.currentProgress.total === 0) return 0\n    return Math.round((this.currentProgress.currentIndex / this.currentProgress.total) * 100)\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¯¼å…¥\n   */\n  isActive(): boolean {\n    return this.currentProgress !== null &&\n           this.currentProgress.stage !== 'complete' &&\n           this.currentProgress.stage !== 'cancelled'\n  }\n\n  /**\n   * æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’ï¼‰ä¸ºå¯è¯»å­—ç¬¦ä¸²\n   */\n  static formatTime(seconds: number): string {\n    if (seconds < 60) {\n      return `${seconds}ç§’`\n    } else if (seconds < 3600) {\n      const minutes = Math.floor(seconds / 60)\n      const secs = seconds % 60\n      return `${minutes}åˆ†${secs}ç§’`\n    } else {\n      const hours = Math.floor(seconds / 3600)\n      const minutes = Math.floor((seconds % 3600) / 60)\n      return `${hours}å°æ—¶${minutes}åˆ†`\n    }\n  }\n\n  /**\n   * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°\n   */\n  static formatBytes(bytes: number): string {\n    if (bytes === 0) return '0 B'\n    const k = 1024\n    const sizes = ['B', 'KB', 'MB', 'GB']\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]\n  }\n}\n\nexport const importProgressService = new ImportProgressService()\n","/**\n * PhotoMind - CLIP åµŒå…¥æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. åŠ è½½å’Œç®¡ç† CLIP æ¨¡å‹\n * 2. æ–‡æœ¬è½¬å‘é‡\n * 3. å›¾ç‰‡è½¬å‘é‡\n * 4. æ¨¡å‹ç¼“å­˜ç®¡ç†\n */\nimport { env, pipeline, type FeatureExtractionPipeline } from '@xenova/transformers';\nimport type {\n  EmbeddingVector,\n  EmbeddingResult,\n  ModelStatus\n} from '../types/embedding.js';\n\n// é…ç½®ç¯å¢ƒå˜é‡\nenv.allowLocalModels = false;\nenv.useBrowserCache = true;\nenv.cacheDir = './model_cache';\n\n/**\n * CLIP åµŒå…¥æœåŠ¡\n */\nexport class EmbeddingService {\n  // å•ä¾‹å®ä¾‹\n  private static instance: EmbeddingService;\n\n  // ç‰¹å¾æå–ç®¡é“\n  private extractor: FeatureExtractionPipeline | null = null;\n\n  // æ¨¡å‹åç§° (Hugging Face Hub)\n  private readonly MODEL_NAME = 'Xenova/clip-vit-base-patch32';\n\n  // æ¨¡å‹ç¼“å­˜ç›®å½•\n  private readonly CACHE_DIR = './model_cache';\n\n  // åŠ è½½çŠ¶æ€\n  private _isLoaded = false;\n  private _loadError: string | null = null;\n  private _loadStartTime = 0;\n\n  /**\n   * è·å–å•ä¾‹å®ä¾‹\n   */\n  static getInstance(): EmbeddingService {\n    if (!EmbeddingService.instance) {\n      EmbeddingService.instance = new EmbeddingService();\n    }\n    return EmbeddingService.instance;\n  }\n\n  /**\n   * ç§æœ‰æ„é€ å‡½æ•°ï¼Œç¡®ä¿å•ä¾‹æ¨¡å¼\n   */\n  private constructor() {\n    console.log('[EmbeddingService] Initialized');\n  }\n\n  /**\n   * æ£€æŸ¥æ¨¡å‹æ˜¯å¦å·²åŠ è½½\n   */\n  get isLoaded(): boolean {\n    return this._isLoaded;\n  }\n\n  /**\n   * è·å–åŠ è½½é”™è¯¯ä¿¡æ¯\n   */\n  get loadError(): string | null {\n    return this._loadError;\n  }\n\n  /**\n   * è·å–æ¨¡å‹åç§°\n   */\n  get modelName(): string {\n    return this.MODEL_NAME;\n  }\n\n  /**\n   * åˆå§‹åŒ–å¹¶åŠ è½½ CLIP æ¨¡å‹\n   */\n  async initialize(): Promise<void> {\n    if (this._isLoaded) {\n      console.log('[EmbeddingService] Model already loaded');\n      return;\n    }\n\n    if (this._loadError) {\n      throw new Error(`Model load failed: ${this._loadError}`);\n    }\n\n    console.log('[EmbeddingService] Starting model initialization...');\n    this._loadStartTime = Date.now();\n\n    try {\n      // åˆ›å»ºç‰¹å¾æå–ç®¡é“\n      this.extractor = await pipeline('feature-extraction', this.MODEL_NAME);\n\n      this._isLoaded = true;\n      const loadTime = Date.now() - this._loadStartTime;\n      console.log(`[EmbeddingService] Model loaded successfully in ${loadTime}ms`);\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      this._loadError = errorMessage;\n      console.error('[EmbeddingService] Failed to load model:', errorMessage);\n      throw error;\n    }\n  }\n\n  /**\n   * æ–‡æœ¬è½¬å‘é‡\n   * @param text è¾“å…¥æ–‡æœ¬\n   * @returns 512 ç»´å½’ä¸€åŒ–å‘é‡\n   */\n  async textToEmbedding(text: string): Promise<EmbeddingResult> {\n    const startTime = Date.now();\n\n    try {\n      // ç¡®ä¿æ¨¡å‹å·²åŠ è½½\n      await this.ensureModelLoaded();\n\n      // æ‰§è¡Œç‰¹å¾æå–\n      const output = await this.extractor!(text, {\n        pooling: 'mean',\n        normalize: true\n      });\n\n      // è½¬æ¢ä¸ºæ•°ç»„\n      const vector = Array.from(output.data);\n\n      const processingTime = Date.now() - startTime;\n      console.log(`[EmbeddingService] Text embedding generated in ${processingTime}ms`);\n\n      return {\n        success: true,\n        vector,\n        processingTimeMs: processingTime\n      };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      console.error('[EmbeddingService] Text embedding failed:', errorMessage);\n\n      return {\n        success: false,\n        error: errorMessage,\n        processingTimeMs: Date.now() - startTime\n      };\n    }\n  }\n\n  /**\n   * å›¾ç‰‡è½¬å‘é‡\n   * @param imagePath å›¾ç‰‡æ–‡ä»¶è·¯å¾„\n   * @returns 512 ç»´å½’ä¸€åŒ–å‘é‡\n   */\n  async imageToEmbedding(imagePath: string): Promise<EmbeddingResult> {\n    const startTime = Date.now();\n\n    try {\n      // ç¡®ä¿æ¨¡å‹å·²åŠ è½½\n      await this.ensureModelLoaded();\n\n      // éªŒè¯æ–‡ä»¶å­˜åœ¨\n      const fs = await import('fs/promises');\n      try {\n        await fs.access(imagePath);\n      } catch {\n        throw new Error(`Image file not found: ${imagePath}`);\n      }\n\n      // æ‰§è¡Œç‰¹å¾æå–\n      const output = await this.extractor!(imagePath, {\n        pooling: 'mean',\n        normalize: true\n      });\n\n      // è½¬æ¢ä¸ºæ•°ç»„\n      const vector = Array.from(output.data);\n\n      const processingTime = Date.now() - startTime;\n      console.log(`[EmbeddingService] Image embedding generated in ${processingTime}ms`);\n\n      return {\n        success: true,\n        vector,\n        processingTimeMs: processingTime\n      };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      console.error('[EmbeddingService] Image embedding failed:', errorMessage);\n\n      return {\n        success: false,\n        error: errorMessage,\n        processingTimeMs: Date.now() - startTime\n      };\n    }\n  }\n\n  /**\n   * æ‰¹é‡å¤„ç†å›¾ç‰‡è½¬å‘é‡\n   * @param imagePaths å›¾ç‰‡è·¯å¾„æ•°ç»„\n   * @param onProgress è¿›åº¦å›è°ƒ\n   * @returns åµŒå…¥ç»“æœæ•°ç»„\n   */\n  async imageToEmbeddingsBatch(\n    imagePaths: string[],\n    onProgress?: (current: number, total: number) => void\n  ): Promise<EmbeddingResult[]> {\n    const results: EmbeddingResult[] = [];\n\n    for (let i = 0; i < imagePaths.length; i++) {\n      const result = await this.imageToEmbedding(imagePaths[i]);\n      results.push(result);\n      onProgress?.(i + 1, imagePaths.length);\n    }\n\n    return results;\n  }\n\n  /**\n   * è·å–æ¨¡å‹çŠ¶æ€\n   */\n  getModelStatus(): ModelStatus {\n    return {\n      isLoaded: this._isLoaded,\n      modelName: this.MODEL_NAME,\n      modelPath: this.CACHE_DIR,\n      loadedAt: this._isLoaded ? new Date() : undefined\n    };\n  }\n\n  /**\n   * ç¡®ä¿æ¨¡å‹å·²åŠ è½½\n   */\n  private async ensureModelLoaded(): Promise<void> {\n    if (!this._isLoaded) {\n      await this.initialize();\n    }\n  }\n\n  /**\n   * é‡Šæ”¾æ¨¡å‹èµ„æº\n   */\n  async dispose(): Promise<void> {\n    if (this.extractor) {\n      this.extractor = null;\n      this._isLoaded = false;\n      console.log('[EmbeddingService] Model disposed');\n    }\n  }\n}\n\n// å¯¼å‡ºå•ä¾‹è®¿é—®å‡½æ•°\nexport const getEmbeddingService = () => EmbeddingService.getInstance();\n","/**\n * PhotoMind - åå°å‘é‡ç”ŸæˆæœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. å¼‚æ­¥é˜Ÿåˆ—å¤„ç†å‘é‡ç”Ÿæˆ\n * 2. åå°ä»»åŠ¡ç®¡ç†\n * 3. è¿›åº¦è¿½è¸ª\n */\nimport { getEmbeddingService } from './embeddingService.js'\nimport { PhotoDatabase } from '../database/db.js'\n\nexport interface VectorTask {\n  id: string\n  photoUuids: string[]\n  status: 'pending' | 'processing' | 'completed' | 'failed'\n  progress: number\n  total: number\n  successCount: number\n  failedCount: number\n  createdAt: Date\n  updatedAt: Date\n}\n\ninterface VectorTaskResult {\n  taskId: string\n  successCount: number\n  failedCount: number\n  errors: Array<{ photoUuid: string; error: string }>\n}\n\nexport class BackgroundVectorService {\n  private queue: Map<string, VectorTask> = new Map()\n  private currentTaskId: string | null = null\n  private database: PhotoDatabase\n  private isProcessing = false\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || new PhotoDatabase()\n  }\n\n  /**\n   * æ·»åŠ æ‰¹é‡ç”Ÿæˆä»»åŠ¡\n   */\n  addGenerateTask(photoUuids: string[]): string {\n    const taskId = `vector_task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n\n    this.queue.set(taskId, {\n      id: taskId,\n      photoUuids,\n      status: 'pending',\n      progress: 0,\n      total: photoUuids.length,\n      successCount: 0,\n      failedCount: 0,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    })\n\n    // å¯åŠ¨å¤„ç†\n    this.processQueue()\n\n    return taskId\n  }\n\n  /**\n   * æ·»åŠ å•å¼ ç…§ç‰‡åˆ°å‘é‡ç”Ÿæˆé˜Ÿåˆ—\n   */\n  addPhoto(photoUuid: string): void {\n    this.addGenerateTask([photoUuid])\n  }\n\n  /**\n   * å¤„ç†ä»»åŠ¡é˜Ÿåˆ—\n   */\n  private async processQueue(): Promise<void> {\n    if (this.isProcessing) return\n\n    // æ‰¾åˆ°å¾…å¤„ç†çš„ä»»åŠ¡\n    let pendingTask: VectorTask | null = null\n    for (const task of this.queue.values()) {\n      if (task.status === 'pending') {\n        pendingTask = task\n        break\n      }\n    }\n\n    if (!pendingTask) {\n      this.isProcessing = false\n      return\n    }\n\n    this.isProcessing = true\n    pendingTask.status = 'processing'\n    pendingTask.updatedAt = new Date()\n    this.currentTaskId = pendingTask.id\n\n    const embeddingService = getEmbeddingService()\n\n    // ç¡®ä¿æ¨¡å‹å·²åŠ è½½\n    if (!embeddingService.isLoaded) {\n      await embeddingService.initialize()\n    }\n\n    console.log(`[BackgroundVector] å¼€å§‹å¤„ç†ä»»åŠ¡ ${pendingTask.id}ï¼Œå…± ${pendingTask.total} ä¸ªç…§ç‰‡`)\n\n    for (let i = 0; i < pendingTask.photoUuids.length; i++) {\n      const photoUuid = pendingTask.photoUuids[i]\n\n      // æ£€æŸ¥æ˜¯å¦å·²æœ‰å‘é‡\n      try {\n        const hasEmbedding = await this.database.hasEmbedding(photoUuid, 'image')\n        if (hasEmbedding) {\n          pendingTask.progress++\n          pendingTask.successCount++\n          pendingTask.updatedAt = new Date()\n          continue\n        }\n      } catch (error) {\n        console.error(`[BackgroundVector] æ£€æŸ¥å‘é‡å­˜åœ¨æ€§å¤±è´¥: ${photoUuid}`, error)\n      }\n\n      // è·å–ç…§ç‰‡ä¿¡æ¯\n      const photo = this.database.getPhotoByUuid(photoUuid)\n      if (!photo || !photo.file_path) {\n        pendingTask.progress++\n        pendingTask.failedCount++\n        pendingTask.updatedAt = new Date()\n        continue\n      }\n\n      try {\n        // ç”Ÿæˆå‘é‡\n        const result = await embeddingService.imageToEmbedding(photo.file_path)\n\n        if (result.success && result.vector) {\n          await this.database.saveEmbedding(photoUuid, result.vector, 'image')\n          pendingTask.successCount++\n          console.log(`[BackgroundVector] å‘é‡ç”ŸæˆæˆåŠŸ: ${photoUuid}`)\n        } else {\n          pendingTask.failedCount++\n          console.error(`[BackgroundVector] å‘é‡ç”Ÿæˆå¤±è´¥: ${photoUuid}`, result.error)\n        }\n      } catch (error) {\n        pendingTask.failedCount++\n        console.error(`[BackgroundVector] å‘é‡ç”Ÿæˆå¼‚å¸¸: ${photoUuid}`, error)\n      }\n\n      pendingTask.progress++\n      pendingTask.updatedAt = new Date()\n    }\n\n    // æ ‡è®°ä»»åŠ¡å®Œæˆ\n    pendingTask.status = pendingTask.failedCount === pendingTask.total ? 'failed' : 'completed'\n    pendingTask.updatedAt = new Date()\n\n    console.log(`[BackgroundVector] ä»»åŠ¡ ${pendingTask.id} å®Œæˆ: æˆåŠŸ ${pendingTask.successCount}, å¤±è´¥ ${pendingTask.failedCount}`)\n\n    // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡\n    this.currentTaskId = null\n    this.processQueue()\n  }\n\n  /**\n   * è·å–ä»»åŠ¡çŠ¶æ€\n   */\n  getTaskStatus(taskId: string): VectorTask | undefined {\n    return this.queue.get(taskId)\n  }\n\n  /**\n   * è·å–å½“å‰æ­£åœ¨å¤„ç†çš„ä»»åŠ¡\n   */\n  getCurrentTask(): VectorTask | null {\n    if (this.currentTaskId) {\n      return this.queue.get(this.currentTaskId) || null\n    }\n    return null\n  }\n\n  /**\n   * è·å–æ‰€æœ‰ä»»åŠ¡\n   */\n  getAllTasks(): VectorTask[] {\n    return Array.from(this.queue.values())\n  }\n\n  /**\n   * å–æ¶ˆä»»åŠ¡\n   */\n  cancelTask(taskId: string): boolean {\n    const task = this.queue.get(taskId)\n    if (task && (task.status === 'pending' || task.status === 'processing')) {\n      task.status = 'failed'\n      task.updatedAt = new Date()\n      return true\n    }\n    return false\n  }\n\n  /**\n   * æ¸…ç†å·²å®Œæˆçš„ä»»åŠ¡\n   */\n  cleanupCompletedTasks(): void {\n    const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000\n    for (const [taskId, task] of this.queue.entries()) {\n      if (task.status === 'completed' && task.updatedAt.getTime() < oneDayAgo) {\n        this.queue.delete(taskId)\n      }\n    }\n  }\n\n  /**\n   * è·å–ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats(): { pending: number; processing: number; completed: number; failed: number } {\n    let pending = 0, processing = 0, completed = 0, failed = 0\n\n    for (const task of this.queue.values()) {\n      switch (task.status) {\n        case 'pending': pending++; break\n        case 'processing': processing++; break\n        case 'completed': completed++; break\n        case 'failed': failed++; break\n      }\n    }\n\n    return { pending, processing, completed, failed }\n  }\n}\n\nexport const backgroundVectorService = new BackgroundVectorService()\n","/**\n * PhotoMind - æ··åˆæ¶æ„åµŒå…¥æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. ä¸»è¿›ç¨‹è°ƒåº¦ + æ¸²æŸ“è¿›ç¨‹æ‰§è¡Œå‘é‡ç”Ÿæˆ\n * 2. é€šè¿‡ IPC ä¸æ¸²æŸ“è¿›ç¨‹é€šä¿¡\n * 3. ä¼˜é›…é™çº§æ”¯æŒ\n */\nimport { PhotoDatabase } from '../database/db.js'\n\nexport interface EmbeddingVector {\n  values: number[]\n  dimension: number\n}\n\nexport interface EmbeddingResult {\n  success: boolean\n  vector?: EmbeddingVector\n  error?: string\n  processingTimeMs: number\n}\n\nexport interface ModelStatus {\n  loaded: boolean\n  modelName: string\n  loadError: string | null\n  rendererAvailable: boolean\n}\n\nclass HybridEmbeddingService {\n  private database: PhotoDatabase | null = null\n  private pendingRequests: Map<string, { resolve: Function; reject: Function; timeout: NodeJS.Timeout }> = new Map()\n  private requestIdCounter = 0\n  private _isLoaded = false\n  private _loadError: string | null = null\n  private _rendererAvailable = false\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || null\n    this.setupResponseListeners()\n  }\n\n  /**\n   * è®¾ç½® IPC å“åº”ç›‘å¬å™¨\n   */\n  private setupResponseListeners(): void {\n    const { ipcMain } = require('electron')\n\n    // ç›‘å¬æ¸²æŸ“è¿›ç¨‹çš„åˆå§‹åŒ–å“åº”\n    ipcMain.on('embedding:init-response', (event: any, result: { success: boolean; error?: string }) => {\n      this._isLoaded = result.success\n      this._loadError = result.error || null\n      this._rendererAvailable = result.success\n      console.log(`[HybridEmbedding] æ¸²æŸ“è¿›ç¨‹æ¨¡å‹åˆå§‹åŒ–: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`)\n    })\n\n    // ç›‘å¬æ¸²æŸ“è¿›ç¨‹çš„çŠ¶æ€å“åº”\n    ipcMain.on('embedding:status-response', (event: any, status: ModelStatus) => {\n      this._rendererAvailable = status.loaded\n      console.log(`[HybridEmbedding] æ¸²æŸ“è¿›ç¨‹çŠ¶æ€: ${this._rendererAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`)\n    })\n\n    // ç›‘å¬æ¸²æŸ“è¿›ç¨‹çš„å‘é‡ç”Ÿæˆå“åº”\n    ipcMain.on('embedding:generate-response', (event: any, response: { id: string; success: boolean; vector?: EmbeddingVector; error?: string; processingTimeMs: number }) => {\n      const pending = this.pendingRequests.get(response.id)\n      if (pending) {\n        clearTimeout(pending.timeout)\n        if (response.success) {\n          pending.resolve(response)\n        } else {\n          pending.reject(new Error(response.error || 'Unknown error'))\n        }\n        this.pendingRequests.delete(response.id)\n      }\n    })\n  }\n\n  /**\n   * è·å–æ¨¡å‹çŠ¶æ€\n   */\n  getModelStatus(): ModelStatus {\n    return {\n      loaded: this._isLoaded,\n      modelName: 'Xenova/clip-vit-base-patch32',\n      loadError: this._loadError,\n      rendererAvailable: this._rendererAvailable\n    }\n  }\n\n  /**\n   * åˆå§‹åŒ– CLIP æ¨¡å‹ï¼ˆåœ¨æ¸²æŸ“è¿›ç¨‹ä¸­ï¼‰\n   */\n  async initialize(): Promise<{ success: boolean; error?: string }> {\n    try {\n      console.log('[HybridEmbedding] æ­£åœ¨åˆå§‹åŒ– CLIP æ¨¡å‹...')\n\n      // å‘æ¸²æŸ“è¿›ç¨‹å‘é€åˆå§‹åŒ–è¯·æ±‚\n      const { BrowserWindow } = require('electron')\n      const windows = BrowserWindow.getAllWindows()\n\n      if (windows.length > 0) {\n        windows[0].webContents.send('embedding:init-request')\n\n        // ç­‰å¾…æ¸²æŸ“è¿›ç¨‹å“åº”ï¼ˆæœ€å¤š 5 ç§’ï¼‰\n        await new Promise<void>((resolve) => {\n          const timeout = setTimeout(() => {\n            console.warn('[HybridEmbedding] æ¸²æŸ“è¿›ç¨‹åˆå§‹åŒ–è¶…æ—¶')\n            resolve()\n          }, 5000)\n\n          // ç›‘å¬ä¸€æ¬¡æ€§å“åº”\n          const { ipcMain } = require('electron')\n          const handler = (event: any, result: { success: boolean; error?: string }) => {\n            this._isLoaded = result.success\n            this._loadError = result.error || null\n            this._rendererAvailable = result.success\n            ipcMain.off('embedding:init-response', handler)\n            clearTimeout(timeout)\n            resolve()\n          }\n          ipcMain.on('embedding:init-response', handler)\n        })\n      } else {\n        console.warn('[HybridEmbedding] æ²¡æœ‰å¯ç”¨çš„æ¸²æŸ“è¿›ç¨‹çª—å£')\n        this._loadError = 'No renderer window available'\n      }\n\n      if (this._isLoaded) {\n        console.log('[HybridEmbedding] CLIP æ¨¡å‹åˆå§‹åŒ–æˆåŠŸ')\n        return { success: true }\n      } else {\n        console.warn('[HybridEmbedding] CLIP æ¨¡å‹åˆå§‹åŒ–å¤±è´¥æˆ–è¶…æ—¶')\n        return { success: false, error: this._loadError || 'Initialization timeout' }\n      }\n    } catch (error) {\n      this._loadError = error instanceof Error ? error.message : String(error)\n      console.error('[HybridEmbedding] åˆå§‹åŒ–å¤±è´¥:', this._loadError)\n      return { success: false, error: this._loadError }\n    }\n  }\n\n  /**\n   * é€šè¿‡ IPC è¯·æ±‚æ¸²æŸ“è¿›ç¨‹ç”Ÿæˆå‘é‡\n   */\n  private async requestEmbedding(type: 'image' | 'text', data: string): Promise<EmbeddingResult> {\n    const requestId = `emb_${++this.requestIdCounter}_${Date.now()}`\n\n    const { BrowserWindow } = require('electron')\n    const windows = BrowserWindow.getAllWindows()\n\n    if (windows.length === 0 || !this._rendererAvailable) {\n      // æ¸²æŸ“è¿›ç¨‹ä¸å¯ç”¨ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ\n      return this.fallbackEmbedding(type, data)\n    }\n\n    return new Promise((resolve, reject) => {\n      // è®¾ç½®è¶…æ—¶ï¼ˆ2 åˆ†é’Ÿï¼‰\n      const timeout = setTimeout(() => {\n        const pending = this.pendingRequests.get(requestId)\n        if (pending) {\n          this.pendingRequests.delete(requestId)\n          console.warn(`[HybridEmbedding] è¯·æ±‚è¶…æ—¶: ${requestId}`)\n          // é™çº§åˆ°ç®€å•æ–¹æ¡ˆ\n          this.fallbackEmbedding(type, data).then(resolve).catch(reject)\n        }\n      }, 120000)\n\n      this.pendingRequests.set(requestId, { resolve, reject, timeout })\n\n      // å‘é€è¯·æ±‚åˆ°æ¸²æŸ“è¿›ç¨‹\n      windows[0].webContents.send('embedding:generate-request', {\n        id: requestId,\n        type,\n        data\n      })\n    })\n  }\n\n  /**\n   * é™çº§æ–¹æ¡ˆï¼šå½“æ¸²æŸ“è¿›ç¨‹ä¸å¯ç”¨æ—¶ä½¿ç”¨\n   */\n  private async fallbackEmbedding(type: 'image' | 'text', data: string): Promise<EmbeddingResult> {\n    console.warn(`[HybridEmbedding] ä½¿ç”¨é™çº§æ–¹æ¡ˆ: ${type}`)\n\n    if (type === 'text') {\n      // æ–‡æœ¬é™çº§ï¼šåŸºäº TF-IDL çš„ç®€å•å‘é‡åŒ–\n      const words = data.toLowerCase().split(/\\s+/)\n      const vocabulary = new Map<string, number>()\n\n      for (const word of words) {\n        if (word.length > 2) {\n          vocabulary.set(word, (vocabulary.get(word) || 0) + 1)\n        }\n      }\n\n      const dimension = 512 // CLIP é»˜è®¤ç»´åº¦\n      const vector = new Array(dimension).fill(0)\n\n      // åŸºäºè¯é¢‘ç”Ÿæˆä¼ªå‘é‡\n      let index = 0\n      for (const [word, count] of vocabulary) {\n        if (index < dimension) {\n          // ä½¿ç”¨å­—ç¬¦ä¸²å“ˆå¸Œç”Ÿæˆç¡®å®šæ€§å‘é‡\n          const hash = this.hashString(word)\n          vector[index % dimension] += count * Math.sin(hash)\n          vector[(index + 1) % dimension] += count * Math.cos(hash)\n        }\n        index++\n      }\n\n      // å½’ä¸€åŒ–\n      const norm = Math.sqrt(vector.reduce((sum, v) => sum + v * v, 0))\n      if (norm > 0) {\n        for (let i = 0; i < vector.length; i++) {\n          vector[i] /= norm\n        }\n      }\n\n      return {\n        success: true,\n        vector: {\n          values: vector,\n          dimension\n        },\n        processingTimeMs: 0\n      }\n    } else {\n      // å›¾ç‰‡é™çº§ï¼šè¿”å›é›¶å‘é‡\n      return {\n        success: false,\n        error: 'Renderer not available, cannot process images',\n        processingTimeMs: 0\n      }\n    }\n  }\n\n  /**\n   * å­—ç¬¦ä¸²å“ˆå¸Œ\n   */\n  private hashString(str: string): number {\n    let hash = 0\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i)\n      hash = ((hash << 5) - hash) + char\n      hash = hash & hash\n    }\n    return Math.abs(hash)\n  }\n\n  /**\n   * æ–‡æœ¬è½¬å‘é‡\n   */\n  async textToEmbedding(text: string): Promise<EmbeddingResult> {\n    console.log(`[HybridEmbedding] æ–‡æœ¬è½¬å‘é‡: \"${text.substring(0, 50)}...\"`)\n    return await this.requestEmbedding('text', text)\n  }\n\n  /**\n   * å›¾ç‰‡è½¬å‘é‡\n   */\n  async imageToEmbedding(imagePath: string): Promise<EmbeddingResult> {\n    console.log(`[HybridEmbedding] å›¾ç‰‡è½¬å‘é‡: ${imagePath}`)\n\n    const result = await this.requestEmbedding('image', imagePath)\n\n    // å¦‚æœæˆåŠŸï¼Œä¿å­˜åˆ°æ•°æ®åº“\n    if (result.success && result.vector && this.database) {\n      try {\n        // ä»è·¯å¾„æå– UUID\n        const photoUuid = this.extractPhotoUuidFromPath(imagePath)\n        if (photoUuid) {\n          // saveEmbedding éœ€è¦ number[]ï¼Œä½† result.vector æ˜¯ EmbeddingVector\n          const vectorValues = result.vector.values || result.vector\n          await this.database.saveEmbedding(photoUuid, vectorValues, 'image')\n          console.log(`[HybridEmbedding] å‘é‡å·²ä¿å­˜: ${photoUuid}`)\n        }\n      } catch (error) {\n        console.error('[HybridEmbedding] ä¿å­˜å‘é‡å¤±è´¥:', error)\n      }\n    }\n\n    return result\n  }\n\n  /**\n   * ä»æ–‡ä»¶è·¯å¾„æå–ç…§ç‰‡ UUID\n   */\n  private extractPhotoUuidFromPath(path: string): string | null {\n    const match = path.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i)\n    return match ? match[1] : null\n  }\n}\n\n// å•ä¾‹å®ä¾‹\nlet embeddingInstance: HybridEmbeddingService | null = null\n\nexport function getEmbeddingService(): HybridEmbeddingService {\n  if (!embeddingInstance) {\n    embeddingInstance = new HybridEmbeddingService()\n  }\n  return embeddingInstance\n}\n\nexport { HybridEmbeddingService }\n","/**\n * PhotoMind - äººè„¸æ£€æµ‹æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. ç…§ç‰‡äººè„¸æ£€æµ‹ï¼ˆåŸºäº @vladmandic/face-apiï¼‰\n * 2. 128 ç»´äººè„¸ç‰¹å¾å‘é‡ç”Ÿæˆ\n * 3. æ‰¹é‡æ£€æµ‹ä¸è¿›åº¦è¿½è¸ª\n */\nimport { resolve } from 'path'\nimport { existsSync } from 'fs'\nimport { PhotoDatabase } from '../database/db.js'\nimport * as faceapi from '@vladmandic/face-api'\nimport * as tf from '@tensorflow/tfjs'\nimport '@tensorflow/tfjs-backend-cpu'\nimport sharp from 'sharp'\nimport { getEmbeddingService } from './hybridEmbeddingService.js'\n\nexport interface FaceDetectionResult {\n  success: boolean\n  detections: FaceInfo[]\n  error?: string\n  processingTimeMs: number\n}\n\nexport interface FaceInfo {\n  box: BoundingBox\n  confidence: number\n  landmarks?: FaceLandmarks\n  descriptor?: number[]  // 128 ç»´äººè„¸ç‰¹å¾å‘é‡\n}\n\nexport interface BoundingBox {\n  x: number\n  y: number\n  width: number\n  height: number\n}\n\nexport interface FaceLandmarks {\n  jawOutline: Point[]\n  nose: Point[]\n  mouth: Point[]\n  leftEye: Point[]\n  rightEye: Point[]\n}\n\nexport interface Point {\n  x: number\n  y: number\n}\n\nexport interface DetectionOptions {\n  maxResults?: number\n  minConfidence?: number\n}\n\nexport interface BatchDetectionProgress {\n  current: number\n  total: number\n  currentPhoto: string\n  detectedFaces: number\n  status: 'pending' | 'processing' | 'completed' | 'cancelled'\n}\n\nexport interface FaceDetectionServiceConfig {\n  modelsPath?: string\n  minConfidence?: number\n  maxFaces?: number\n}\n\nexport class FaceDetectionService {\n  private modelsPath: string\n  private isLoaded = false\n  private abortController: AbortController | null = null\n  private minConfidence = 0.5\n  private maxFaces = 10\n\n  private tfBackendReady = false\n\n  constructor(config?: FaceDetectionServiceConfig) {\n    // ä½¿ç”¨ @vladmandic/face-api åŒ…å†…çš„æ¨¡å‹è·¯å¾„\n    this.modelsPath = config?.modelsPath || resolve(\n      process.cwd(),\n      'node_modules/@vladmandic/face-api/model'\n    )\n    if (config?.minConfidence) this.minConfidence = config.minConfidence\n    if (config?.maxFaces) this.maxFaces = config.maxFaces\n  }\n\n  private async ensureTfBackend(): Promise<void> {\n    if (!this.tfBackendReady) {\n      // å¼ºåˆ¶ CPU æ¨¡å¼ï¼Œé¿å… WebGL å…¼å®¹æ€§é—®é¢˜\n      await tf.setBackend('cpu')\n      await tf.ready()\n      this.tfBackendReady = true\n      console.log('[FaceDetection] TF.js åç«¯å·²è®¾ç½®ä¸º CPU æ¨¡å¼')\n\n      // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ³„éœ² tensor\n      const numTensors = tf.memory().numTensors\n      if (numTensors > 100) {\n        console.warn(`[FaceDetection] æ£€æµ‹åˆ° ${numTensors} ä¸ªæœªé‡Šæ”¾çš„ tensorï¼Œæ‰§è¡Œæ¸…ç†`)\n        tf.disposeVariables()\n      }\n    }\n  }\n\n  /**\n   * åŠ è½½æ£€æµ‹æ¨¡å‹\n   */\n  async loadModels(): Promise<{ success: boolean; error?: string }> {\n    if (this.isLoaded) {\n      return { success: true }\n    }\n\n    try {\n      // ç¡®ä¿ TensorFlow.js åç«¯å·²åˆå§‹åŒ–\n      await this.ensureTfBackend()\n\n      console.log('[FaceDetection] åŠ è½½ face-api.js æ¨¡å‹...')\n      console.log(`[FaceDetection] ğŸ“ æ¨¡å‹è·¯å¾„: ${this.modelsPath}`)\n\n      // æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n      const requiredModels = [\n        'tiny_face_detector_model-weights_manifest.json',\n        'face_landmark_68_model-weights_manifest.json',\n        'face_recognition_model-weights_manifest.json'\n      ]\n\n      for (const model of requiredModels) {\n        const modelPath = resolve(this.modelsPath, model)\n        const exists = existsSync(modelPath)\n        console.log(`[FaceDetection] ${exists ? 'âœ…' : 'âŒ'} ${model}`)\n        if (!exists) {\n          return { success: false, error: `æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: ${model}` }\n        }\n      }\n\n      // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ¨¡å‹\n      await Promise.all([\n        faceapi.nets.tinyFaceDetector.loadFromDisk(this.modelsPath),\n        faceapi.nets.faceLandmark68Net.loadFromDisk(this.modelsPath),\n        faceapi.nets.faceRecognitionNet.loadFromDisk(this.modelsPath)\n      ])\n\n      this.isLoaded = true\n      console.log('[FaceDetection] æ¨¡å‹åŠ è½½æˆåŠŸ')\n      return { success: true }\n    } catch (error) {\n      console.error('[FaceDetection] æ¨¡å‹åŠ è½½å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æ¨¡å‹çŠ¶æ€\n   */\n  getModelStatus(): { loaded: boolean; modelsPath: string; configured: boolean } {\n    return {\n      loaded: this.isLoaded,\n      modelsPath: this.modelsPath,\n      configured: this.isLoaded\n    }\n  }\n\n  /**\n   * æ£€æµ‹ç…§ç‰‡ä¸­çš„äººè„¸\n   */\n  async detect(imagePath: string, options: DetectionOptions = {}): Promise<FaceDetectionResult> {\n    const startTime = Date.now()\n    const { minConfidence = this.minConfidence } = options\n\n    console.log(`[FaceDetection] ğŸ¯ å¼€å§‹æ£€æµ‹: ${imagePath.split('/').pop()}`)\n\n    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n    if (!existsSync(imagePath)) {\n      console.error(`[FaceDetection] âŒ æ–‡ä»¶ä¸å­˜åœ¨: ${imagePath}`)\n      return {\n        success: false,\n        detections: [],\n        error: 'å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨',\n        processingTimeMs: Date.now() - startTime\n      }\n    }\n\n    try {\n      // ç¡®ä¿æ¨¡å‹å·²åŠ è½½\n      const loadResult = await this.loadModels()\n      if (!loadResult.success) {\n        console.error(`[FaceDetection] âŒ æ¨¡å‹åŠ è½½å¤±è´¥: ${loadResult.error}`)\n        return {\n          success: false,\n          detections: [],\n          error: `æ¨¡å‹åŠ è½½å¤±è´¥: ${loadResult.error}`,\n          processingTimeMs: Date.now() - startTime\n        }\n      }\n\n      console.log(`[FaceDetection] ğŸ¤– æ¨¡å‹å°±ç»ªï¼Œå¼€å§‹å¤„ç†å›¾åƒ...`)\n\n      // åŠ è½½å›¾ç‰‡å¹¶è½¬æ¢ä¸º tensor\n      const { data, info } = await sharp(imagePath)\n        .raw()\n        .ensureAlpha()\n        .resize(416, 416, { fit: 'inside' })\n        .toBuffer({ resolveWithObject: true })\n\n      const { width, height } = info\n\n      // å»æ‰ alpha é€šé“ (RGBA -> RGB)\n      const rgbData = new Uint8Array(width * height * 3)\n      for (let i = 0; i < width * height; i++) {\n        rgbData[i * 3] = data[i * 4]       // R\n        rgbData[i * 3 + 1] = data[i * 4 + 1] // G\n        rgbData[i * 3 + 2] = data[i * 4 + 2] // B\n      }\n\n      const imageTensor = tf.tensor3d(rgbData, [height, width, 3])\n\n      let detections: faceapi.WithFaceDescriptor<faceapi.WithFaceLandmarks<{\n        detection: faceapi.FaceDetection\n      }, faceapi.FaceLandmarks68>>[] = []\n\n      try {\n        // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ45ç§’ï¼‰\n        const detectionPromise = faceapi\n          .detectAllFaces(imageTensor, new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: minConfidence }))\n          .withFaceLandmarks()\n          .withFaceDescriptors()\n\n        const timeoutPromise = new Promise<never>((_, reject) =>\n          setTimeout(() => reject(new Error('äººè„¸æ£€æµ‹è¶…æ—¶ (45s)')), 45000)\n        )\n\n        detections = await Promise.race([detectionPromise, timeoutPromise])\n        console.log(`[FaceDetection] ğŸ“Š åŸå§‹æ£€æµ‹ç»“æœ: ${detections.length} å¼ äººè„¸`)\n      } finally {\n        // ç¡®ä¿ tensor è¢«é‡Šæ”¾\n        imageTensor.dispose()\n      }\n\n      // è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼ - è¿‡æ»¤æ‰æ²¡æœ‰ descriptor çš„äººè„¸\n      const faces: FaceInfo[] = detections\n        .filter(d => d.descriptor && d.descriptor.length === 128)  // ç¡®ä¿æœ‰æœ‰æ•ˆçš„128ç»´ç‰¹å¾å‘é‡\n        .map(d => ({\n          box: {\n            x: d.detection.box.x,\n            y: d.detection.box.y,\n            width: d.detection.box.width,\n            height: d.detection.box.height\n          },\n          confidence: d.detection.score,\n          landmarks: this.convertLandmarks(d.landmarks),\n          descriptor: Array.from(d.descriptor)  // Float32Array -> number[] (128ç»´)\n        }))\n\n      console.log(`[FaceDetection] ğŸ“Š æœ‰æœ‰æ•ˆæè¿°ç¬¦çš„äººè„¸: ${faces.length}/${detections.length}`)\n\n      // é™åˆ¶æœ€å¤§äººè„¸æ•°\n      const limitedFaces = faces.slice(0, this.maxFaces)\n\n      console.log(`[FaceDetection] âœ… æ£€æµ‹å®Œæˆ: ${limitedFaces.length} å¼ äººè„¸ (${Date.now() - startTime}ms)`)\n\n      return {\n        success: true,\n        detections: limitedFaces,\n        processingTimeMs: Date.now() - startTime\n      }\n    } catch (error) {\n      console.error('[FaceDetection] æ£€æµ‹å¤±è´¥:', error)\n      return {\n        success: false,\n        detections: [],\n        error: error instanceof Error ? error.message : 'æ£€æµ‹å¤±è´¥',\n        processingTimeMs: Date.now() - startTime\n      }\n    }\n  }\n\n  /**\n   * è½¬æ¢ face-api.js çš„ landmarks åˆ°å†…éƒ¨æ ¼å¼\n   */\n  private convertLandmarks(landmarks: faceapi.FaceLandmarks68): FaceLandmarks {\n    const positions = landmarks.positions\n\n    return {\n      jawOutline: positions.slice(0, 17).map(p => ({ x: p.x, y: p.y })),\n      nose: positions.slice(27, 36).map(p => ({ x: p.x, y: p.y })),\n      mouth: positions.slice(48, 68).map(p => ({ x: p.x, y: p.y })),\n      leftEye: positions.slice(36, 42).map(p => ({ x: p.x, y: p.y })),\n      rightEye: positions.slice(42, 48).map(p => ({ x: p.x, y: p.y }))\n    }\n  }\n\n  /**\n   * æ‰¹é‡æ£€æµ‹\n   */\n  async detectBatch(\n    imagePaths: string[],\n    options: DetectionOptions = {},\n    onProgress?: (progress: BatchDetectionProgress) => void\n  ): Promise<{\n    results: Map<string, FaceDetectionResult>\n    totalDetected: number\n    processingTimeMs: number\n  }> {\n    const startTime = Date.now()\n    const results = new Map<string, FaceDetectionResult>()\n    let totalDetected = 0\n\n    // è®¾ç½®å–æ¶ˆæ§åˆ¶å™¨\n    this.abortController = new AbortController()\n\n    for (let i = 0; i < imagePaths.length; i++) {\n      // æ£€æŸ¥æ˜¯å¦å–æ¶ˆ\n      if (this.abortController?.signal.aborted) {\n        console.log('[FaceDetection] æ£€æµ‹ä»»åŠ¡å·²å–æ¶ˆ')\n        break\n      }\n\n      const imagePath = imagePaths[i]\n      const filename = imagePath.split('/').pop() || `photo_${i}`\n\n      // æŠ¥å‘Šè¿›åº¦\n      onProgress?.({\n        current: i + 1,\n        total: imagePaths.length,\n        currentPhoto: filename,\n        detectedFaces: totalDetected,\n        status: 'processing'\n      })\n\n      // æ£€æµ‹\n      const result = await this.detect(imagePath, options)\n      results.set(imagePath, result)\n\n      if (result.success) {\n        totalDetected += result.detections.length\n      }\n\n      console.log(`[FaceDetection] ${i + 1}/${imagePaths.length}: ${filename} - ${result.detections.length} å¼ äººè„¸`)\n    }\n\n    // æŠ¥å‘Šå®Œæˆ\n    onProgress?.({\n      current: imagePaths.length,\n      total: imagePaths.length,\n      currentPhoto: '',\n      detectedFaces: totalDetected,\n      status: this.abortController?.signal.aborted ? 'cancelled' : 'completed'\n    })\n\n    return {\n      results,\n      totalDetected,\n      processingTimeMs: Date.now() - startTime\n    }\n  }\n\n  /**\n   * å–æ¶ˆæ£€æµ‹ä»»åŠ¡\n   */\n  cancel(): void {\n    this.abortController?.abort()\n    console.log('[FaceDetection] æ£€æµ‹ä»»åŠ¡å·²å–æ¶ˆ')\n  }\n\n  /**\n   * æ£€æµ‹å¹¶ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆåŒå‘é‡ç‰ˆæœ¬ï¼‰\n   * åŒæ—¶ç”Ÿæˆ 128ç»´ face_embedding å’Œ 512ç»´ semantic_embedding\n   */\n  async detectAndSave(imagePath: string, database: PhotoDatabase): Promise<FaceDetectionResult> {\n    const startTime = Date.now()\n\n    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n    if (!existsSync(imagePath)) {\n      console.warn(`[FaceDetection] æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: ${imagePath}`)\n      return {\n        success: false,\n        detections: [],\n        error: 'æ–‡ä»¶ä¸å­˜åœ¨',\n        processingTimeMs: Date.now() - startTime\n      }\n    }\n\n    const result = await this.detect(imagePath, {})\n\n    if (result.success && result.detections.length > 0) {\n      // è·å–ç…§ç‰‡\n      const photo = database.getPhotoByFilePath(imagePath)\n\n      if (!photo) {\n        console.warn(`[FaceDetection] æ•°æ®åº“ä¸­æœªæ‰¾åˆ°ç…§ç‰‡: ${imagePath}`)\n        return result\n      }\n\n      // å®‰å…¨è·å– photoId\n      const photoId = (photo as any).id ?? null\n\n      if (!photoId) {\n        console.warn(`[FaceDetection] ç…§ç‰‡ç¼ºå°‘ idï¼Œè·³è¿‡: ${imagePath}`)\n        return result\n      }\n\n      // è·å–å›¾ç‰‡å°ºå¯¸ç”¨äºåæ ‡è½¬æ¢\n      const imageInfo = await sharp(imagePath).metadata()\n      const imgWidth = imageInfo.width || 1\n      const imgHeight = imageInfo.height || 1\n\n      // åŠ è½½ sharp å®ä¾‹ç”¨äºè£å‰ª\n      const sharpInstance = sharp(imagePath)\n\n      // ä¸ºæ¯ä¸ªäººè„¸ç”ŸæˆåŒå‘é‡\n      const facesToSave: Array<{\n        id: string\n        bbox_x: number\n        bbox_y: number\n        bbox_width: number\n        bbox_height: number\n        confidence: number\n        embedding?: number[]\n        face_embedding?: number[]\n        semantic_embedding?: number[]\n        vector_version?: number\n      }> = []\n      for (let index = 0; index < result.detections.length; index++) {\n        const face = result.detections[index]\n        const faceId = `${photoId}_${index}_${Date.now()}`\n\n        // è½¬æ¢ç›¸å¯¹åæ ‡ä¸ºç»å¯¹åƒç´ åæ ‡\n        const absX = Math.round((face.box.x / 416) * imgWidth)\n        const absY = Math.round((face.box.y / 416) * imgHeight)\n        const absWidth = Math.round((face.box.width / 416) * imgWidth)\n        const absHeight = Math.round((face.box.height / 416) * imgHeight)\n\n        // ç¡®ä¿åæ ‡åœ¨å›¾ç‰‡èŒƒå›´å†…\n        const cropX = Math.max(0, absX)\n        const cropY = Math.max(0, absY)\n        const cropWidth = Math.min(absWidth, imgWidth - cropX)\n        const cropHeight = Math.min(absHeight, imgHeight - cropY)\n\n        let semanticEmbedding: number[] | undefined = undefined\n\n        try {\n          // è£å‰ªäººè„¸åŒºåŸŸ\n          const faceBuffer = await sharpInstance\n            .clone()\n            .extract({ left: cropX, top: cropY, width: cropWidth, height: cropHeight })\n            .resize(224, 224, { fit: 'cover' })\n            .jpeg({ quality: 90 })\n            .toBuffer()\n\n          // è½¬æ¢ä¸º base64 ä¼ é€’ç»™ CLIP\n          const faceBase64 = `data:image/jpeg;base64,${faceBuffer.toString('base64')}`\n\n          // ç”Ÿæˆ 512ç»´è¯­ä¹‰å‘é‡\n          const embeddingService = getEmbeddingService()\n          const clipResult = await embeddingService.imageToEmbedding(faceBase64)\n\n          if (clipResult.success && clipResult.vector) {\n            semanticEmbedding = clipResult.vector.values || (clipResult.vector as any)\n            console.log(`[FaceDetection] ç”Ÿæˆ CLIP å‘é‡æˆåŠŸ: ${faceId}, ç»´åº¦: ${semanticEmbedding?.length}`)\n          } else {\n            console.warn(`[FaceDetection] CLIP å‘é‡ç”Ÿæˆå¤±è´¥: ${faceId}, é”™è¯¯: ${clipResult.error}`)\n          }\n        } catch (clipError) {\n          console.warn(`[FaceDetection] ç”Ÿæˆè¯­ä¹‰å‘é‡å¤±è´¥: ${faceId}`, clipError)\n          // ç»§ç»­ä¿å­˜ï¼Œsemantic_embedding å¯ä»¥ä¸º null\n        }\n\n        facesToSave.push({\n          id: faceId,\n          bbox_x: face.box.x,\n          bbox_y: face.box.y,\n          bbox_width: face.box.width,\n          bbox_height: face.box.height,\n          confidence: face.confidence,\n          embedding: face.descriptor,  // 128 ç»´ face-api å‘é‡ (å…¼å®¹æ—§å­—æ®µ)\n          face_embedding: face.descriptor,  // 128 ç»´ face-api å‘é‡\n          semantic_embedding: semanticEmbedding,  // 512 ç»´ CLIP å‘é‡\n          vector_version: semanticEmbedding ? 2 : 1  // 2=åŒå‘é‡, 1=åªæœ‰faceå‘é‡\n        })\n      }\n\n      try {\n        database.saveDetectedFaces(photoId, facesToSave)\n        const withSemantic = facesToSave.filter(f => f.semantic_embedding).length\n        console.log(`[FaceDetection] ä¿å­˜ ${facesToSave.length} å¼ äººè„¸: ${withSemantic} å¼ æœ‰è¯­ä¹‰å‘é‡, ${facesToSave.length - withSemantic} å¼ åªæœ‰äººè„¸å‘é‡`)\n      } catch (e) {\n        console.error(`[FaceDetection] ä¿å­˜äººè„¸å¤±è´¥: ${imagePath}`, e)\n      }\n    }\n\n    return result\n  }\n\n  /**\n   * æ£€æµ‹ç…§ç‰‡ä¸­çš„äººè„¸å¹¶è¿”å›è¾¹ç•Œæ¡†ï¼ˆç®€åŒ–ç‰ˆï¼‰\n   */\n  async detectFaces(imagePath: string): Promise<{\n    faces: BoundingBox[]\n    processingTimeMs: number\n  }> {\n    const result = await this.detect(imagePath)\n    return {\n      faces: result.detections.map(d => d.box),\n      processingTimeMs: result.processingTimeMs\n    }\n  }\n\n  /**\n   * è·å–æ£€æµ‹ç»Ÿè®¡\n   */\n  getStats(): {\n    modelLoaded: boolean\n    configured: boolean\n  } {\n    return {\n      modelLoaded: this.isLoaded,\n      configured: this.isLoaded\n    }\n  }\n}\n\nexport const faceDetectionService = new FaceDetectionService()\n","/**\n * PhotoMind - æ‰«æä»»åŠ¡æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. ç®¡ç†äººè„¸æ‰«æä»»åŠ¡çš„æŒä¹…åŒ–çŠ¶æ€\n * 2. æ”¯æŒä»»åŠ¡è¿›åº¦è·Ÿè¸ª\n * 3. æ”¯æŒåº”ç”¨å´©æºƒåæ¢å¤ä»»åŠ¡\n * 4. æ”¯æŒæ–­ç‚¹ç»­ä¼ \n */\nimport { v4 as uuidv4 } from 'uuid'\nimport { PhotoDatabase } from '../database/db.js'\n\nexport type ScanJobStatus =\n  | 'pending'\n  | 'detecting'\n  | 'embedding'\n  | 'clustering'\n  | 'completed'\n  | 'failed'\n  | 'cancelled'\n\nexport interface ScanJob {\n  id: string\n  status: ScanJobStatus\n  totalPhotos: number\n  processedPhotos: number\n  failedPhotos: number\n  lastProcessedId: number | null\n  startedAt: number\n  completedAt: number | null\n  lastHeartbeat: number\n  errorMessage: string | null\n}\n\nexport class ScanJobService {\n  private db: PhotoDatabase\n\n  constructor(db: PhotoDatabase) {\n    this.db = db\n  }\n\n  /**\n   * åˆ›å»ºæ–°çš„æ‰«æä»»åŠ¡\n   * @param totalPhotos æ€»ç…§ç‰‡æ•°\n   * @returns ä»»åŠ¡ID\n   */\n  createJob(totalPhotos: number): string {\n    const id = uuidv4()\n    const now = Date.now()\n\n    this.db.run(\n      `\n      INSERT INTO scan_jobs (id, status, total_photos, processed_photos, failed_photos,\n                            last_processed_id, started_at, completed_at, last_heartbeat, error_message)\n      VALUES (?, 'detecting', ?, 0, 0, NULL, ?, NULL, ?, NULL)\n    `,\n      [id, totalPhotos, now, now]\n    )\n\n    console.log('[ScanJobService] Created job:', id, 'totalPhotos:', totalPhotos)\n    return id\n  }\n\n  /**\n   * æ›´æ–°ä»»åŠ¡è¿›åº¦\n   * @param jobId ä»»åŠ¡ID\n   * @param processed å·²å¤„ç†æ•°é‡\n   * @param lastPhotoId æœ€åå¤„ç†çš„ç…§ç‰‡ID\n   */\n  updateProgress(jobId: string, processed: number, lastPhotoId: number): void {\n    const now = Date.now()\n\n    this.db.run(\n      `\n      UPDATE scan_jobs\n      SET processed_photos = ?, last_processed_id = ?, last_heartbeat = ?\n      WHERE id = ?\n    `,\n      [processed, lastPhotoId, now, jobId]\n    )\n\n    console.log(`[ScanJobService] Updated progress: ${processed}, lastPhotoId: ${lastPhotoId}`)\n  }\n\n  /**\n   * æ›´æ–°å¿ƒè·³æ—¶é—´ï¼ˆæ¯å¤„ç†ä¸€å¼ ç…§ç‰‡æ—¶è°ƒç”¨ï¼‰\n   * @param jobId ä»»åŠ¡ID\n   */\n  updateHeartbeat(jobId: string): void {\n    const now = Date.now()\n\n    this.db.run(\n      `\n      UPDATE scan_jobs\n      SET last_heartbeat = ?\n      WHERE id = ?\n    `,\n      [now, jobId]\n    )\n  }\n\n  /**\n   * å¢åŠ å¤±è´¥è®¡æ•°\n   * @param jobId ä»»åŠ¡ID\n   */\n  incrementFailedCount(jobId: string): void {\n    this.db.run(\n      `\n      UPDATE scan_jobs\n      SET failed_photos = failed_photos + 1, last_heartbeat = ?\n      WHERE id = ?\n    `,\n      [Date.now(), jobId]\n    )\n  }\n\n  /**\n   * å®Œæˆä»»åŠ¡\n   * @param jobId ä»»åŠ¡ID\n   * @param detectedFaces æ£€æµ‹åˆ°çš„äººè„¸æ•°é‡\n   */\n  completeJob(jobId: string, detectedFaces: number): void {\n    const now = Date.now()\n\n    this.db.run(\n      `\n      UPDATE scan_jobs\n      SET status = 'completed', completed_at = ?, last_heartbeat = ?\n      WHERE id = ?\n    `,\n      [now, now, jobId]\n    )\n\n    console.log('[ScanJobService] Completed job:', jobId, 'detectedFaces:', detectedFaces)\n  }\n\n  /**\n   * æ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥\n   * @param jobId ä»»åŠ¡ID\n   * @param error é”™è¯¯ä¿¡æ¯\n   */\n  failJob(jobId: string, error: string): void {\n    const now = Date.now()\n\n    this.db.run(\n      `\n      UPDATE scan_jobs\n      SET status = 'failed', error_message = ?, last_heartbeat = ?\n      WHERE id = ?\n    `,\n      [error, now, jobId]\n    )\n\n    console.log('[ScanJobService] Failed job:', jobId, 'error:', error)\n  }\n\n  /**\n   * å–æ¶ˆä»»åŠ¡\n   * @param jobId ä»»åŠ¡ID\n   */\n  cancelJob(jobId: string): void {\n    const now = Date.now()\n\n    this.db.run(\n      `\n      UPDATE scan_jobs\n      SET status = 'cancelled', completed_at = ?, last_heartbeat = ?\n      WHERE id = ?\n    `,\n      [now, now, jobId]\n    )\n\n    console.log('[ScanJobService] Cancelled job:', jobId)\n  }\n\n  /**\n   * è·å–æ´»è·ƒä»»åŠ¡ï¼ˆæœªå®Œæˆçš„ä»»åŠ¡ï¼‰\n   * @returns æ´»è·ƒä»»åŠ¡æˆ–null\n   */\n  getActiveJob(): ScanJob | null {\n    const result = this.db.query(\n      `\n      SELECT * FROM scan_jobs\n      WHERE status NOT IN ('completed', 'failed', 'cancelled')\n      ORDER BY started_at DESC\n      LIMIT 1\n    `\n    )\n\n    if (result.length === 0) return null\n\n    return this.rowToScanJob(result[0])\n  }\n\n  /**\n   * æ ¹æ®IDè·å–ä»»åŠ¡\n   * @param jobId ä»»åŠ¡ID\n   * @returns ä»»åŠ¡æˆ–null\n   */\n  getJobById(jobId: string): ScanJob | null {\n    const result = this.db.query('SELECT * FROM scan_jobs WHERE id = ?', [jobId])\n\n    if (result.length === 0) return null\n\n    return this.rowToScanJob(result[0])\n  }\n\n  /**\n   * æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡5åˆ†é’Ÿæ²¡æœ‰å¿ƒè·³ï¼‰\n   * @param job ä»»åŠ¡\n   * @returns æ˜¯å¦è¿‡æœŸ\n   */\n  isJobStale(job: ScanJob): boolean {\n    const fiveMinutes = 5 * 60 * 1000\n    return Date.now() - job.lastHeartbeat > fiveMinutes\n  }\n\n  /**\n   * æ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥ï¼ˆç”¨äºè¿‡æœŸä»»åŠ¡ï¼‰\n   * @param jobId ä»»åŠ¡ID\n   */\n  markJobAsFailed(jobId: string): void {\n    this.failJob(jobId, 'Task timed out - no heartbeat for 5 minutes')\n  }\n\n  /**\n   * è·å–æ‰€æœ‰ä»»åŠ¡ï¼ˆç”¨äºç®¡ç†ç•Œé¢ï¼‰\n   * @param limit é™åˆ¶æ•°é‡\n   * @returns ä»»åŠ¡åˆ—è¡¨\n   */\n  getAllJobs(limit: number = 100): ScanJob[] {\n    const result = this.db.query(\n      `\n      SELECT * FROM scan_jobs\n      ORDER BY started_at DESC\n      LIMIT ?\n    `,\n      [limit]\n    )\n\n    return result.map((row) => this.rowToScanJob(row))\n  }\n\n  /**\n   * è·å–ä»»åŠ¡ç»Ÿè®¡\n   * @returns ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats(): {\n    total: number\n    active: number\n    completed: number\n    failed: number\n    cancelled: number\n  } {\n    const total = this.db.query('SELECT COUNT(*) as count FROM scan_jobs')[0]?.count || 0\n    const active =\n      this.db.query(\n        \"SELECT COUNT(*) as count FROM scan_jobs WHERE status NOT IN ('completed', 'failed', 'cancelled')\"\n      )[0]?.count || 0\n    const completed =\n      this.db.query(\"SELECT COUNT(*) as count FROM scan_jobs WHERE status = 'completed'\")[0]?.count ||\n      0\n    const failed =\n      this.db.query(\"SELECT COUNT(*) as count FROM scan_jobs WHERE status = 'failed'\")[0]?.count ||\n      0\n    const cancelled =\n      this.db.query(\"SELECT COUNT(*) as count FROM scan_jobs WHERE status = 'cancelled'\")[0]\n        ?.count || 0\n\n    return { total, active, completed, failed, cancelled }\n  }\n\n  /**\n   * åˆ é™¤æ—§ä»»åŠ¡ï¼ˆæ¸…ç†å†å²è®°å½•ï¼‰\n   * @param beforeDate åˆ é™¤æ­¤æ—¥æœŸä¹‹å‰çš„ä»»åŠ¡ï¼ˆæ—¶é—´æˆ³ï¼‰\n   * @returns åˆ é™¤çš„ä»»åŠ¡æ•°\n   */\n  cleanupOldJobs(beforeDate: number): number {\n    const result = this.db.run('DELETE FROM scan_jobs WHERE started_at < ?', [beforeDate])\n    console.log('[ScanJobService] Cleaned up old jobs before:', beforeDate)\n    return result.lastInsertRowid >= 0 ? 1 : 0\n  }\n\n  /**\n   * å°†æ•°æ®åº“è¡Œè½¬æ¢ä¸ºScanJobå¯¹è±¡\n   */\n  private rowToScanJob(row: any): ScanJob {\n    return {\n      id: row.id,\n      status: row.status as ScanJobStatus,\n      totalPhotos: row.total_photos,\n      processedPhotos: row.processed_photos,\n      failedPhotos: row.failed_photos,\n      lastProcessedId: row.last_processed_id,\n      startedAt: row.started_at,\n      completedAt: row.completed_at,\n      lastHeartbeat: row.last_heartbeat,\n      errorMessage: row.error_message\n    }\n  }\n}\n\n// å¯¼å‡ºå•ä¾‹å®ä¾‹ï¼ˆå°†åœ¨main/index.tsä¸­åˆå§‹åŒ–ï¼‰\nexport let scanJobService: ScanJobService | null = null\n\n/**\n * åˆå§‹åŒ–æ‰«æä»»åŠ¡æœåŠ¡\n * @param db æ•°æ®åº“å®ä¾‹\n */\nexport function initializeScanJobService(db: PhotoDatabase): ScanJobService {\n  scanJobService = new ScanJobService(db)\n  console.log('[ScanJobService] Initialized')\n  return scanJobService\n}\n","/**\n * PhotoMind - äººè„¸åŒ¹é…æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. äººè„¸ç‰¹å¾ç›¸ä¼¼åº¦è®¡ç®—\n * 2. è‡ªåŠ¨åŒ¹é…åŒä¸€äººè„¸\n * 3. äººç‰©èšç±»\n * 4. äººç‰©åˆå¹¶/æ‹†åˆ†\n *\n * ä¾èµ–ï¼š\n * - æ•°æ®åº“ä¸­çš„ detected_faces è¡¨å­˜å‚¨äººè„¸åµŒå…¥å‘é‡\n * - persons è¡¨å­˜å‚¨äººç‰©ä¿¡æ¯\n * - faces è¡¨å­˜å‚¨äººè„¸ä¸äººç‰©çš„å…³è”\n */\nimport { PhotoDatabase } from '../database/db.js'\n\nexport interface FaceDescriptor {\n  faceId: number | string  // æ”¯æŒ detected_faces çš„ string id\n  photoId: number\n  personId?: number\n  descriptor: number[]\n  boundingBox: { x: number; y: number; width: number; height: number } | null\n  confidence: number\n  isManual: boolean\n}\n\nexport interface FaceMatch {\n  faceId: number | string\n  photoId: number\n  matchedFaceId: number | string\n  matchedPhotoId: number\n  similarity: number\n  personId?: number\n}\n\nexport interface PersonCluster {\n  personId?: number\n  faces: FaceDescriptor[]\n  suggestedName?: string\n  confidence: number\n}\n\nexport interface MatchingOptions {\n  threshold?: number\n  minSimilarity?: number\n  maxClusterSize?: number\n  onProgress?: (current: number, total: number) => void\n}\n\n/**\n * å°† Blob è½¬æ¢ä¸º number[]\n */\nfunction blobToArray(blob: any): number[] | null {\n  if (!blob) return null\n  try {\n    // ğŸš¨ æ·»åŠ è°ƒè¯•æ—¥å¿—\n    console.log('[blobToArray] è¾“å…¥ç±»å‹:', typeof blob, 'æ„é€ å‡½æ•°:', blob?.constructor?.name, 'é•¿åº¦:', blob?.length)\n\n    // å¤„ç† SQL.js è¿”å›çš„ Uint8Array\n    if (blob instanceof Uint8Array) {\n      console.log('[blobToArray] æ£€æµ‹åˆ° Uint8Array')\n      return Array.from(new Float32Array(blob.buffer, blob.byteOffset, blob.byteLength / 4))\n    }\n\n    // å¤„ç† Buffer\n    if (typeof blob === 'object' && blob.constructor === Buffer) {\n      console.log('[blobToArray] æ£€æµ‹åˆ° Buffer')\n      return Array.from(new Float32Array(blob))\n    }\n\n    // å¤„ç† ArrayBuffer\n    if (blob instanceof ArrayBuffer) {\n      console.log('[blobToArray] æ£€æµ‹åˆ° ArrayBuffer')\n      return Array.from(new Float32Array(blob))\n    }\n\n    // å¤„ç† ArrayBufferView\n    if (ArrayBuffer.isView(blob)) {\n      console.log('[blobToArray] æ£€æµ‹åˆ° ArrayBufferView')\n      return Array.from(new Float32Array(blob.buffer))\n    }\n\n    // å¦‚æœæ˜¯æ™®é€šæ•°ç»„ï¼Œç›´æ¥è¿”å›\n    if (Array.isArray(blob)) {\n      console.log('[blobToArray] æ£€æµ‹åˆ°æ™®é€šæ•°ç»„')\n      return blob\n    }\n\n    console.log('[blobToArray] æ— æ³•è¯†åˆ«çš„ç±»å‹ï¼Œè¿”å› null')\n    return null\n  } catch (e) {\n    console.error('[blobToArray] è½¬æ¢å¤±è´¥:', e)\n    return null\n  }\n}\n\nexport class FaceMatchingService {\n  private database: PhotoDatabase\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || new PhotoDatabase()\n  }\n\n  /**\n   * è·å–æ‰€æœ‰äººè„¸æè¿°ç¬¦ï¼ˆä» detected_faces è¡¨è·å– 128ç»´ face_embeddingï¼‰\n   */\n  async getAllFaceDescriptors(): Promise<FaceDescriptor[]> {\n    const descriptors: FaceDescriptor[] = []\n\n    const detectedFaces = this.database.query(`\n      SELECT df.*, p.id as person_id, p.name as person_name\n      FROM detected_faces df\n      LEFT JOIN persons p ON df.person_id = p.id\n      ORDER BY df.confidence DESC\n    `)\n\n    for (const row of detectedFaces) {\n      // ä¼˜å…ˆä½¿ç”¨ face_embedding (128ç»´)ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›é€€åˆ° embedding (å…¼å®¹æ—§æ•°æ®)\n      let faceEmbedding = blobToArray(row.face_embedding)\n      if (!faceEmbedding || faceEmbedding.length === 0) {\n        faceEmbedding = blobToArray(row.embedding)\n      }\n\n      descriptors.push({\n        faceId: row.id,\n        photoId: row.photo_id,\n        personId: row.person_id,\n        descriptor: faceEmbedding || [],\n        boundingBox: {\n          x: row.bbox_x,\n          y: row.bbox_y,\n          width: row.bbox_width,\n          height: row.bbox_height\n        },\n        confidence: row.confidence || 0,\n        isManual: !!row.is_manual\n      })\n    }\n\n    return descriptors\n  }\n\n  /**\n   * è·å–æœªåŒ¹é…çš„äººè„¸ï¼ˆæ²¡æœ‰åˆ†é…ç»™äººç‰©çš„äººè„¸ï¼‰\n   */\n  async getUnmatchedFaces(): Promise<FaceDescriptor[]> {\n    const detectedFaces = this.database.query(`\n      SELECT df.*, p.id as person_id\n      FROM detected_faces df\n      LEFT JOIN persons p ON df.person_id = p.id\n      WHERE df.person_id IS NULL\n      ORDER BY df.confidence DESC\n    `)\n\n    return detectedFaces.map((row: any) => {\n      // ä¼˜å…ˆä½¿ç”¨ face_embedding (128ç»´)ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›é€€åˆ° embedding\n      let faceEmbedding = blobToArray(row.face_embedding)\n      if (!faceEmbedding || faceEmbedding.length === 0) {\n        faceEmbedding = blobToArray(row.embedding)\n      }\n\n      return {\n        faceId: row.id,\n        photoId: row.photo_id,\n        personId: row.person_id,\n        descriptor: faceEmbedding || [],\n        boundingBox: {\n          x: row.bbox_x,\n          y: row.bbox_y,\n          width: row.bbox_width,\n          height: row.bbox_height\n        },\n        confidence: row.confidence || 0,\n        isManual: !!row.is_manual\n      }\n    })\n  }\n\n  /**\n   * è®¡ç®—ä¸¤ä¸ªäººè„¸çš„ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰\n   */\n  calculateSimilarity(descriptor1: number[], descriptor2: number[]): number {\n    if (!descriptor1 || !descriptor2 || descriptor1.length === 0 || descriptor2.length === 0) {\n      return 0\n    }\n\n    // ä½¿ç”¨è¾ƒçŸ­çš„å‘é‡é•¿åº¦\n    const length = Math.min(descriptor1.length, descriptor2.length)\n\n    let dotProduct = 0\n    let norm1 = 0\n    let norm2 = 0\n\n    for (let i = 0; i < length; i++) {\n      dotProduct += descriptor1[i] * descriptor2[i]\n      norm1 += descriptor1[i] * descriptor1[i]\n      norm2 += descriptor2[i] * descriptor2[i]\n    }\n\n    if (norm1 === 0 || norm2 === 0) return 0\n\n    return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2))\n  }\n\n  /**\n   * æŸ¥æ‰¾ç›¸ä¼¼äººè„¸\n   */\n  async findSimilarFaces(\n    faceId: string | number,\n    options: MatchingOptions = {}\n  ): Promise<Array<{ faceId: string | number; similarity: number; photoId: number }>> {\n    const { minSimilarity = 0.4, threshold = 0.45 } = options\n\n    const targetFace = await this.getFaceById(faceId)\n    if (!targetFace || !targetFace.descriptor || targetFace.descriptor.length === 0) {\n      console.log('[FaceMatching] ç›®æ ‡äººè„¸ä¸å­˜åœ¨æˆ–æ²¡æœ‰åµŒå…¥å‘é‡')\n      return []\n    }\n\n    const allFaces = await this.getAllFaceDescriptors()\n    const targetDescriptor = targetFace.descriptor\n\n    const similarities: Array<{ faceId: string | number; similarity: number; photoId: number }> = []\n\n    for (const face of allFaces) {\n      if (String(face.faceId) === String(faceId)) continue\n      if (!face.descriptor || face.descriptor.length === 0) continue\n\n      const similarity = this.calculateSimilarity(targetDescriptor, face.descriptor)\n\n      if (similarity >= minSimilarity) {\n        similarities.push({\n          faceId: face.faceId,\n          similarity,\n          photoId: face.photoId\n        })\n      }\n    }\n\n    // æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº\n    similarities.sort((a, b) => b.similarity - a.similarity)\n\n    return similarities.filter(s => s.similarity >= threshold)\n  }\n\n  /**\n   * è®¡ç®—äººç‰©ä¸­å¿ƒç‚¹ï¼ˆcentroidï¼‰\n   */\n  calculatePersonCentroid(personId: number): number[] | null {\n    const faces = this.database.query(`\n      SELECT face_embedding, embedding\n      FROM detected_faces\n      WHERE person_id = ? AND (face_embedding IS NOT NULL OR embedding IS NOT NULL)\n    `, [personId])\n\n    if (faces.length === 0) return null\n\n    const vectors: number[][] = []\n    for (const face of faces) {\n      let vec = blobToArray(face.face_embedding)\n      if (!vec || vec.length === 0) {\n        vec = blobToArray(face.embedding)\n      }\n      if (vec && vec.length > 0) {\n        vectors.push(vec)\n      }\n    }\n\n    if (vectors.length === 0) return null\n\n    // è®¡ç®—å¹³å‡å€¼\n    const dimension = vectors[0].length\n    const centroid = new Array(dimension).fill(0)\n\n    for (const vec of vectors) {\n      for (let i = 0; i < dimension; i++) {\n        centroid[i] += vec[i]\n      }\n    }\n\n    for (let i = 0; i < dimension; i++) {\n      centroid[i] /= vectors.length\n    }\n\n    return centroid\n  }\n\n  /**\n   * è·å–æ‰€æœ‰å·²å‘½åäººç‰©åŠå…¶ä¸­å¿ƒç‚¹\n   */\n  getNamedPersonsWithCentroids(): Array<{ id: number; name: string; centroid: number[] }> {\n    const persons = this.database.query(`\n      SELECT id, name FROM persons WHERE name IS NOT NULL AND name != ''\n    `)\n\n    const result: Array<{ id: number; name: string; centroid: number[] }> = []\n\n    for (const person of persons) {\n      const centroid = this.calculatePersonCentroid(person.id)\n      if (centroid) {\n        result.push({ id: person.id, name: person.name, centroid })\n      }\n    }\n\n    return result\n  }\n\n  /**\n   * æŸ¥æ‰¾æœ€ç›¸ä¼¼çš„å·²å‘½åäººç‰©\n   */\n  findBestMatchingPerson(\n    faceDescriptor: number[],\n    namedPersons: Array<{ id: number; name: string; centroid: number[] }>,\n    threshold: number\n  ): { id: number; name: string; similarity: number } | null {\n    let bestMatch: { id: number; name: string; similarity: number } | null = null\n    let bestSimilarity = threshold\n\n    for (const person of namedPersons) {\n      const similarity = this.calculateSimilarity(faceDescriptor, person.centroid)\n      if (similarity > bestSimilarity) {\n        bestSimilarity = similarity\n        bestMatch = { id: person.id, name: person.name, similarity }\n      }\n    }\n\n    return bestMatch\n  }\n\n  /**\n   * åˆ†æ‰¹å¤„ç†è¾…åŠ©å‡½æ•° - é¿å…é˜»å¡äº‹ä»¶å¾ªç¯\n   */\n  private async processInBatches<T, R>(\n    items: T[],\n    batchSize: number,\n    processor: (item: T, index: number) => Promise<R>,\n    onProgress?: (current: number, total: number) => void\n  ): Promise<R[]> {\n    const results: R[] = []\n    const total = items.length\n\n    for (let i = 0; i < total; i += batchSize) {\n      const batch = items.slice(i, i + batchSize)\n      const batchResults = await Promise.all(\n        batch.map((item, idx) => processor(item, i + idx))\n      )\n      results.push(...batchResults)\n\n      onProgress?.(Math.min(i + batchSize, total), total)\n\n      // ğŸš¨ æ¯æ‰¹å¤„ç†åè®©å‡ºäº‹ä»¶å¾ªç¯ï¼Œé¿å…é˜»å¡\n      if (i + batchSize < total) {\n        await new Promise(resolve => setTimeout(resolve, 0))\n      }\n    }\n\n    return results\n  }\n\n  /**\n   * è‡ªåŠ¨åŒ¹é…æ‰€æœ‰äººè„¸ï¼ˆé”šç‚¹åŒ¹é…ç®—æ³•ï¼‰\n   * 1. ä¼˜å…ˆåŒ¹é…åˆ°å·²å‘½åäººç‰©\n   * 2. æœªåŒ¹é…çš„åˆ›å»ºä¸º Pending Person\n   */\n  async autoMatch(options: MatchingOptions = {}): Promise<{\n    matched: number\n    clusters: PersonCluster[]\n    processingTimeMs: number\n    warning?: string\n    personsCreated?: number\n    message?: string\n  }> {\n    const startTime = Date.now()\n    const {\n      threshold = 0.45,  // ğŸš¨ é™ä½åˆ° 0.45ï¼Œæé«˜åŒ¹é…ç‡\n      maxClusterSize = 100,\n      onProgress\n    } = options\n\n    console.log('[FaceMatching] å¼€å§‹è‡ªåŠ¨åŒ¹é…ï¼ˆé”šç‚¹åŒ¹é…ç®—æ³•ï¼‰...')\n\n    const unmatchedFaces = await this.getUnmatchedFaces()\n    console.log(`[FaceMatching] æ‰¾åˆ° ${unmatchedFaces.length} å¼ æœªåŒ¹é…çš„äººè„¸`)\n\n    if (unmatchedFaces.length === 0) {\n      return { matched: 0, clusters: [], processingTimeMs: Date.now() - startTime, message: 'æ²¡æœ‰æœªåŒ¹é…çš„äººè„¸' }\n    }\n\n    // è¿‡æ»¤å‡ºæœ‰åµŒå…¥å‘é‡çš„äººè„¸\n    const facesWithEmbeddings = unmatchedFaces.filter(f => f.descriptor && f.descriptor.length > 0)\n    console.log(`[FaceMatching] å…¶ä¸­ ${facesWithEmbeddings.length} å¼ æœ‰äººè„¸åµŒå…¥å‘é‡`)\n\n    if (facesWithEmbeddings.length === 0) {\n      return {\n        matched: 0,\n        clusters: [],\n        processingTimeMs: Date.now() - startTime,\n        warning: 'æ²¡æœ‰äººè„¸åµŒå…¥å‘é‡ï¼Œè¯·å…ˆè¿è¡Œäººè„¸æ£€æµ‹å’Œç‰¹å¾æå–'\n      }\n    }\n\n    // ğŸš¨ è·å–æ‰€æœ‰å·²å‘½åäººç‰©åŠå…¶ä¸­å¿ƒç‚¹\n    const namedPersons = this.getNamedPersonsWithCentroids()\n    console.log(`[FaceMatching] å·²å‘½åäººç‰©æ•°é‡: ${namedPersons.length}`)\n\n    // ğŸš¨ é”šç‚¹åŒ¹é…ï¼šå…ˆå°è¯•åŒ¹é…åˆ°å·²å‘½åäººç‰©\n    const clusters: PersonCluster[] = []\n    const assigned = new Set<string | number>()\n    const total = facesWithEmbeddings.length\n\n    // ğŸš¨ åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ 50 ä¸ªï¼Œé¿å…é˜»å¡\n    const BATCH_SIZE = 50\n\n    for (let i = 0; i < facesWithEmbeddings.length; i += BATCH_SIZE) {\n      const batch = facesWithEmbeddings.slice(i, Math.min(i + BATCH_SIZE, facesWithEmbeddings.length))\n\n      for (const face of batch) {\n        onProgress?.(assigned.size, total)\n\n        if (assigned.has(face.faceId)) continue\n\n        // ğŸš¨ ç¬¬ä¸€æ­¥ï¼šå°è¯•åŒ¹é…åˆ°å·²å‘½åäººç‰©\n        if (namedPersons.length > 0) {\n          const bestMatch = this.findBestMatchingPerson(face.descriptor, namedPersons, threshold)\n          if (bestMatch) {\n            // åŒ¹é…åˆ°å·²å‘½åäººç‰©ï¼Œåˆ›å»ºå•äººè„¸èšç±»\n            clusters.push({\n              personId: bestMatch.id,\n              faces: [face],\n              confidence: bestMatch.similarity,\n              suggestedName: bestMatch.name\n            })\n            assigned.add(face.faceId)\n            continue\n          }\n        }\n\n        // ğŸš¨ ç¬¬äºŒæ­¥ï¼šæœªåŒ¹é…åˆ°å·²å‘½åäººç‰©ï¼Œè¿›è¡Œèšç±»\n        const cluster: PersonCluster = {\n          faces: [face],\n          confidence: face.confidence\n        }\n\n        assigned.add(face.faceId)\n\n        // åœ¨å½“å‰æ‰¹æ¬¡ä¸­æŸ¥æ‰¾ç›¸ä¼¼äººè„¸\n        for (const otherFace of facesWithEmbeddings) {\n          if (assigned.has(otherFace.faceId)) continue\n          if (cluster.faces.length >= maxClusterSize) break\n\n          const similarity = this.calculateSimilarity(\n            face.descriptor || [],\n            otherFace.descriptor || []\n          )\n\n          if (similarity >= threshold) {\n            cluster.faces.push(otherFace)\n            assigned.add(otherFace.faceId)\n            cluster.confidence = Math.min(cluster.confidence, similarity)\n          }\n        }\n\n        if (cluster.faces.length > 0) {\n          clusters.push(cluster)\n        }\n      }\n\n      // ğŸš¨ æ¯æ‰¹å¤„ç†åè®©å‡ºäº‹ä»¶å¾ªç¯\n      if (i + BATCH_SIZE < facesWithEmbeddings.length) {\n        await new Promise(resolve => setTimeout(resolve, 0))\n      }\n    }\n\n    console.log(`[FaceMatching] é”šç‚¹åŒ¹é…å®Œæˆï¼Œç”Ÿæˆ ${clusters.length} ä¸ªèšç±»`)\n\n    // ğŸš¨ åˆ†æ‰¹åˆ›å»ºäººç‰©ï¼Œæ¯æ‰¹ 10 ä¸ª\n    let personsCreated = 0\n    let pendingIndex = 1\n    const PERSON_BATCH_SIZE = 10\n\n    for (let i = 0; i < clusters.length; i += PERSON_BATCH_SIZE) {\n      const batch = clusters.slice(i, i + PERSON_BATCH_SIZE)\n\n      await Promise.all(batch.map(async (cluster) => {\n        // å¦‚æœèšç±»å·²ç»æœ‰ personIdï¼ˆåŒ¹é…åˆ°å·²å‘½åäººç‰©ï¼‰ï¼Œè·³è¿‡\n        if (cluster.personId) {\n          // å°†äººè„¸åˆ†é…ç»™è¯¥äººç‰©\n          for (const face of cluster.faces) {\n            await this.assignFaceToPerson(face.faceId, cluster.personId)\n          }\n          return\n        }\n\n        // åˆ›å»º Pending Person\n        const personName = `æœªå‘½å ${pendingIndex++}`\n        try {\n          const result = await this.createPersonFromCluster(cluster, personName)\n          if (result.success && result.personId) {\n            personsCreated++\n            cluster.personId = result.personId\n            cluster.suggestedName = personName\n          }\n        } catch (error) {\n          console.error(`[FaceMatching] åˆ›å»ºäººç‰© \"${personName}\" å¤±è´¥:`, error)\n        }\n      }))\n\n      // è®©å‡ºäº‹ä»¶å¾ªç¯\n      if (i + PERSON_BATCH_SIZE < clusters.length) {\n        await new Promise(resolve => setTimeout(resolve, 0))\n      }\n    }\n\n    if (personsCreated > 0) {\n      console.log(`[FaceMatching] è‡ªåŠ¨åˆ›å»ºäº† ${personsCreated} ä½æœªå‘½åäººç‰©`)\n    }\n\n    return {\n      matched: assigned.size,\n      clusters,\n      processingTimeMs: Date.now() - startTime,\n      personsCreated,\n      message: `åŒ¹é…å®Œæˆï¼š${assigned.size}/${facesWithEmbeddings.length} å¼ äººè„¸å·²åŒ¹é…æˆ–èšç±»`\n    }\n  }\n\n  /**\n   * ä¸ºèšç±»åˆ›å»ºæ–°äººç‰©\n   */\n  async createPersonFromCluster(cluster: PersonCluster, personName: string): Promise<{\n    success: boolean\n    personId?: number\n    error?: string\n  }> {\n    try {\n      // åˆ›å»ºæ–°äººç‰©\n      const personId = this.database.addPerson({\n        name: personName,\n        displayName: personName\n      })\n\n      console.log(`[FaceMatching] åˆ›å»ºäººç‰© \"${personName}\" (ID: ${personId})`)\n\n      // ä¸ºèšç±»ä¸­çš„æ¯ä¸ªäººè„¸åˆ†é…äººç‰©\n      let assignedCount = 0\n      for (const face of cluster.faces) {\n        const success = await this.assignFaceToPerson(face.faceId, personId)\n        if (success) assignedCount++\n      }\n\n      console.log(`[FaceMatching] åˆ›å»ºäººç‰© \"${personName}\"ï¼Œå…³è” ${assignedCount}/${cluster.faces.length} å¼ äººè„¸`)\n\n      // ğŸ†• äº‹åŠ¡å®Œæ•´æ€§æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰æˆåŠŸåˆ†é…ä»»ä½•äººè„¸ï¼Œåˆ é™¤ç©ºäººç‰©\n      if (assignedCount === 0) {\n        console.warn(`[FaceMatching] äººç‰© \"${personName}\" æœªå…³è”ä»»ä½•äººè„¸ï¼Œåˆ é™¤ç©ºäººç‰©`)\n        this.database.run('DELETE FROM persons WHERE id = ?', [personId])\n        return { success: false, error: 'æœªæˆåŠŸåˆ†é…ä»»ä½•äººè„¸' }\n      }\n\n      return { success: true, personId }\n    } catch (error) {\n      console.error('[FaceMatching] åˆ›å»ºäººç‰©å¤±è´¥:', error)\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'åˆ›å»ºå¤±è´¥'\n      }\n    }\n  }\n\n  /**\n   * è·å–äººè„¸è¯¦æƒ…\n   */\n  async getFaceById(faceId: string | number): Promise<FaceDescriptor | null> {\n    const rows = this.database.query(\n      'SELECT df.*, p.id as person_id FROM detected_faces df LEFT JOIN persons p ON df.person_id = p.id WHERE df.id = ?',\n      [faceId]\n    )\n\n    if (rows.length === 0) return null\n\n    const row = rows[0]\n    // ä¼˜å…ˆä½¿ç”¨ face_embedding (128ç»´)ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›é€€åˆ° embedding\n    let faceEmbedding = blobToArray(row.face_embedding)\n    if (!faceEmbedding || faceEmbedding.length === 0) {\n      faceEmbedding = blobToArray(row.embedding)\n    }\n\n    return {\n      faceId: row.id,\n      photoId: row.photo_id,\n      personId: row.person_id,\n      descriptor: faceEmbedding || [],\n      boundingBox: {\n        x: row.bbox_x,\n        y: row.bbox_y,\n        width: row.bbox_width,\n        height: row.bbox_height\n      },\n      confidence: row.confidence || 0,\n      isManual: !!row.is_manual\n    }\n  }\n\n  /**\n   * å°†å•ä¸ªäººè„¸åˆ†é…ç»™äººç‰©\n   */\n  async assignFaceToPerson(faceId: string | number, personId: number): Promise<boolean> {\n    try {\n      const success = this.database.markFaceAsProcessed(String(faceId), personId)\n      if (success) {\n        console.log(`[FaceMatching] äººè„¸ ${faceId} å·²åˆ†é…ç»™äººç‰© ${personId}`)\n      }\n      return success\n    } catch (error) {\n      console.error('[FaceMatching] åˆ†é…äººè„¸å¤±è´¥:', error)\n      return false\n    }\n  }\n\n  /**\n   * å°†å¤šä¸ªäººè„¸åˆ†é…ç»™äººç‰©\n   */\n  async assignToPerson(faceIds: (string | number)[], personId: number): Promise<{\n    success: boolean\n    assigned: number\n    error?: string\n  }> {\n    try {\n      let assigned = 0\n\n      for (const faceId of faceIds) {\n        const success = await this.assignFaceToPerson(faceId, personId)\n        if (success) assigned++\n      }\n\n      return { success: true, assigned }\n    } catch (error) {\n      console.error('[FaceMatching] æ‰¹é‡åˆ†é…å¤±è´¥:', error)\n      return {\n        success: false,\n        assigned: 0,\n        error: String(error)\n      }\n    }\n  }\n\n  /**\n   * å–æ¶ˆäººè„¸åŒ¹é…ï¼ˆè§£é™¤äººç‰©å…³è”ï¼‰\n   */\n  async unmatchFace(faceId: string | number): Promise<boolean> {\n    try {\n      this.database.run(\n        'UPDATE detected_faces SET person_id = NULL, processed = 0 WHERE id = ?',\n        [faceId]\n      )\n      console.log(`[FaceMatching] å–æ¶ˆäººè„¸ ${faceId} çš„åŒ¹é…`)\n      return true\n    } catch (error) {\n      console.error('[FaceMatching] å–æ¶ˆåŒ¹é…å¤±è´¥:', error)\n      return false\n    }\n  }\n\n  /**\n   * è·å–æŸäººç‰©çš„æ‰€æœ‰äººè„¸\n   */\n  async getPersonFaces(personId: number): Promise<FaceDescriptor[]> {\n    const detectedFaces = this.database.query(`\n      SELECT df.*, p.id as person_id\n      FROM detected_faces df\n      LEFT JOIN persons p ON df.person_id = p.id\n      WHERE df.person_id = ?\n      ORDER BY df.confidence DESC\n    `, [personId])\n\n    return detectedFaces.map((row: any) => {\n      // ä¼˜å…ˆä½¿ç”¨ face_embedding (128ç»´)ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›é€€åˆ° embedding\n      let faceEmbedding = blobToArray(row.face_embedding)\n      if (!faceEmbedding || faceEmbedding.length === 0) {\n        faceEmbedding = blobToArray(row.embedding)\n      }\n\n      return {\n        faceId: row.id,\n        photoId: row.photo_id,\n        personId: row.person_id,\n        descriptor: faceEmbedding || [],\n        boundingBox: {\n          x: row.bbox_x,\n          y: row.bbox_y,\n          width: row.bbox_width,\n          height: row.bbox_height\n        },\n        confidence: row.confidence || 0,\n        isManual: !!row.is_manual\n      }\n    })\n  }\n\n  /**\n   * åˆå¹¶ä¸¤ä¸ªäººç‰©ï¼ˆå°†æºäººç‰©çš„æ‰€æœ‰äººè„¸åˆå¹¶åˆ°ç›®æ ‡äººç‰©ï¼‰\n   */\n  async mergePersons(\n    sourcePersonId: number,\n    targetPersonId: number\n  ): Promise<{ success: boolean; merged: number; error?: string }> {\n    try {\n      // è·å–æºäººç‰©çš„æ‰€æœ‰äººè„¸\n      const sourceFaces = await this.getPersonFaces(sourcePersonId)\n\n      if (sourceFaces.length === 0) {\n        return { success: true, merged: 0 }\n      }\n\n      // å°†æ‰€æœ‰äººè„¸åˆ†é…ç»™ç›®æ ‡äººç‰©\n      let merged = 0\n      for (const face of sourceFaces) {\n        const success = await this.assignFaceToPerson(face.faceId, targetPersonId)\n        if (success) merged++\n      }\n\n      // åˆ é™¤æºäººç‰©\n      this.database.run('DELETE FROM persons WHERE id = ?', [sourcePersonId])\n\n      console.log(`[FaceMatching] åˆå¹¶äººç‰© ${sourcePersonId} åˆ° ${targetPersonId}ï¼Œåˆå¹¶ ${merged} å¼ äººè„¸`)\n\n      return { success: true, merged }\n    } catch (error) {\n      console.error('[FaceMatching] åˆå¹¶å¤±è´¥:', error)\n      return {\n        success: false,\n        merged: 0,\n        error: String(error)\n      }\n    }\n  }\n\n  /**\n   * è·å–åŒ¹é…ç»Ÿè®¡\n   */\n  getStats(): {\n    totalFaces: number\n    matchedFaces: number\n    unmatchedFaces: number\n    matchRate: number\n  } {\n    const totalFaces = this.database.query('SELECT COUNT(*) as count FROM detected_faces')[0]?.count || 0\n    const matchedFaces = this.database.query('SELECT COUNT(*) as count FROM detected_faces WHERE person_id IS NOT NULL')[0]?.count || 0\n\n    return {\n      totalFaces,\n      matchedFaces,\n      unmatchedFaces: totalFaces - matchedFaces,\n      matchRate: totalFaces > 0 ? matchedFaces / totalFaces : 0\n    }\n  }\n\n  /**\n   * è·å–æ£€æµ‹ç»Ÿè®¡ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰\n   */\n  getDetectionStats(): {\n    totalDetections: number\n    processedCount: number\n    unprocessedCount: number\n    photosWithFaces: number\n  } {\n    return this.database.getDetectedFacesStats()\n  }\n}\n\nexport const faceMatchingService = new FaceMatchingService()\n","/**\n * PhotoMind - äººè„¸æ£€æµ‹é˜Ÿåˆ—æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. ç®¡ç†äººè„¸æ£€æµ‹ä»»åŠ¡é˜Ÿåˆ—\n * 2. æ§åˆ¶å¹¶å‘å¤„ç†æ•°é‡\n * 3. æ”¯æŒæ‰¹é‡æ·»åŠ ä»»åŠ¡\n * 4. æä¾›è¿›åº¦è¿½è¸ª\n * 5. æ”¯æŒæ‰«æä»»åŠ¡æŒä¹…åŒ–ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰\n */\nimport { FaceDetectionService, FaceDetectionResult, BatchDetectionProgress } from './faceDetectionService.js'\nimport { PhotoDatabase } from '../database/db.js'\nimport { ScanJobService, scanJobService } from './scanJobService.js'\nimport { faceMatchingService } from './faceMatchingService.js'\n\nexport interface DetectionTask {\n  photoId: string\n  uuid: string\n  filePath: string\n  status: 'pending' | 'processing' | 'completed' | 'failed'\n  error?: string\n  faces?: number\n}\n\nexport interface QueueOptions {\n  maxConcurrent?: number\n  onProgress?: (progress: QueueProgress) => void\n  onComplete?: (stats: { total: number; completed: number; failed: number; detectedFaces: number }) => void\n  autoStart?: boolean\n}\n\nexport interface QueueProgress {\n  total: number\n  pending: number\n  processing: number\n  completed: number\n  failed: number\n  currentPhoto?: string\n  detectedFaces: number\n  status: 'idle' | 'running' | 'paused' | 'completed' | 'error'\n}\n\nexport class FaceDetectionQueue {\n  private service: FaceDetectionService\n  private database: PhotoDatabase\n  private queue: DetectionTask[] = []\n  private processingCount = 0\n  private maxConcurrent: number\n  private onProgress?: (progress: QueueProgress) => void\n  private onComplete?: (stats: { total: number; completed: number; failed: number; detectedFaces: number }) => void\n  private isRunning = false\n  private abortController: AbortController | null = null\n  private hasCompleted = false\n\n  // ğŸ†• æ‰«æä»»åŠ¡æŒä¹…åŒ–ç›¸å…³\n  private currentJobId: string | null = null\n  private processedCount = 0\n  private detectedFacesCount = 0\n\n  constructor(database: PhotoDatabase, options?: QueueOptions) {\n    this.service = new FaceDetectionService()\n    this.database = database\n    this.maxConcurrent = options?.maxConcurrent || 1\n    this.onProgress = options?.onProgress\n    this.onComplete = options?.onComplete\n    this.hasCompleted = false\n\n    // ğŸš¨ å¯åŠ¨è¿›åº¦ä¸ŠæŠ¥å®šæ—¶å™¨ï¼ˆæ¯ 500ms ä¸ŠæŠ¥ä¸€æ¬¡ï¼‰\n    setInterval(() => {\n      this.reportProgress()\n    }, 500)\n  }\n\n  /**\n   * æ·»åŠ å•ä¸ªæ£€æµ‹ä»»åŠ¡\n   */\n  async addTask(photoId: string, uuid: string, filePath: string): Promise<void> {\n    const task: DetectionTask = {\n      photoId,\n      uuid,\n      filePath,\n      status: 'pending'\n    }\n\n    this.queue.push(task)\n    console.log(`[FaceDetectionQueue] æ·»åŠ ä»»åŠ¡: ${photoId} (${this.queue.length} å¾…å¤„ç†)`)\n\n    if (!this.isRunning) {\n      await this.processQueue()\n    }\n  }\n\n  /**\n   * æ‰¹é‡æ·»åŠ æ£€æµ‹ä»»åŠ¡\n   */\n  async addBatch(tasks: Array<{ photoId: string; uuid: string; filePath: string }>): Promise<void> {\n    for (const task of tasks) {\n      await this.addTask(task.photoId, task.uuid, task.filePath)\n    }\n  }\n\n  /**\n   * ä»æ•°æ®åº“æ·»åŠ æœªå¤„ç†çš„ç…§ç‰‡\n   * @param limit é™åˆ¶æ•°é‡\n   * @param afterId å¯é€‰ï¼Œåªæ·»åŠ idå¤§äºæ­¤å€¼çš„ç…§ç‰‡ï¼ˆç”¨äºæ–­ç‚¹ç»­ä¼ ï¼‰\n   */\n  async addFromDatabase(limit: number = 100, afterId?: number): Promise<number> {\n    const photos = this.database.getUnprocessedPhotos(limit, afterId)\n\n    for (const photo of photos) {\n      await this.addTask(\n        photo.id.toString(),\n        photo.uuid,\n        photo.file_path\n      )\n    }\n\n    console.log(`[FaceDetectionQueue] ä»æ•°æ®åº“æ·»åŠ  ${photos.length} ä¸ªä»»åŠ¡${afterId ? ` (afterId: ${afterId})` : ''}`)\n    return photos.length\n  }\n\n  /**\n   * ğŸ†• ä»æ–­ç‚¹ç»­ä¼ ï¼ˆæ¢å¤æ‰«æï¼‰\n   * @param lastProcessedId æœ€åå¤„ç†çš„ç…§ç‰‡ID\n   * @param limit é™åˆ¶æ•°é‡\n   * @returns æ·»åŠ çš„ä»»åŠ¡æ•°\n   */\n  async resumeFromCheckpoint(lastProcessedId: number, limit: number = 100): Promise<number> {\n    console.log(`[FaceDetectionQueue] ä»æ–­ç‚¹ç»­ä¼ : lastProcessedId=${lastProcessedId}`)\n    return await this.addFromDatabase(limit, lastProcessedId)\n  }\n\n  /**\n   * ğŸ†• åˆ›å»ºæ‰«æä»»åŠ¡ï¼ˆå¼€å§‹æ–°çš„æ‰«æï¼‰\n   * @param totalPhotos æ€»ç…§ç‰‡æ•°\n   */\n  startScanJob(totalPhotos: number): string | null {\n    if (!scanJobService) {\n      console.warn('[FaceDetectionQueue] ScanJobService not available')\n      return null\n    }\n\n    this.currentJobId = scanJobService.createJob(totalPhotos)\n    this.processedCount = 0\n    this.detectedFacesCount = 0\n    console.log(`[FaceDetectionQueue] Started scan job: ${this.currentJobId}`)\n    return this.currentJobId\n  }\n\n  /**\n   * ğŸ†• æ£€æŸ¥æ˜¯å¦æœ‰æœªèšç±»çš„äººè„¸ï¼ˆå·²æœ‰æ£€æµ‹æ•°æ®ä½† person_id ä¸º NULLï¼‰\n   */\n  hasUnclusteredFaces(): boolean {\n    const result = this.database.query(`\n      SELECT COUNT(*) as count FROM detected_faces WHERE person_id IS NULL\n    `)\n    return (result[0]?.count || 0) > 0\n  }\n\n  /**\n   * ğŸ†• è·å–æœªèšç±»çš„äººè„¸æ•°é‡\n   */\n  getUnclusteredFaceCount(): number {\n    const result = this.database.query(`\n      SELECT COUNT(*) as count FROM detected_faces WHERE person_id IS NULL\n    `)\n    return result[0]?.count || 0\n  }\n\n  /**\n   * ğŸ†• ä»…æ‰§è¡Œèšç±»ï¼ˆä¸é‡æ–°æ‰«æï¼‰\n   */\n  async clusterExistingFaces(): Promise<{\n    success: boolean\n    matched: number\n    personsCreated: number\n    message?: string\n  }> {\n    const unclusteredCount = this.getUnclusteredFaceCount()\n    console.log(`[FaceDetectionQueue] å‘ç° ${unclusteredCount} ä¸ªæœªèšç±»äººè„¸ï¼Œå¼€å§‹èšç±»...`)\n\n    if (unclusteredCount === 0) {\n      return { success: true, matched: 0, personsCreated: 0, message: 'æ²¡æœ‰éœ€è¦èšç±»çš„äººè„¸' }\n    }\n\n    try {\n      const matchResult = await faceMatchingService.autoMatch({\n        threshold: 0.45,\n        onProgress: (current, total) => {\n          console.log(`[FaceMatching] èšç±»è¿›åº¦: ${current}/${total}`)\n        }\n      })\n\n      console.log(`[FaceMatching] èšç±»å®Œæˆ: ${matchResult.matched} å¼ äººè„¸å·²åŒ¹é…, åˆ›å»º ${matchResult.personsCreated} ä½äººç‰©`)\n\n      return {\n        success: true,\n        matched: matchResult.matched,\n        personsCreated: matchResult.personsCreated || 0,\n        message: matchResult.message\n      }\n    } catch (error) {\n      console.error('[FaceMatching] èšç±»å¤±è´¥:', error)\n      return {\n        success: false,\n        matched: 0,\n        personsCreated: 0,\n        message: error instanceof Error ? error.message : 'èšç±»å¤±è´¥'\n      }\n    }\n  }\n\n  /**\n   * ğŸ†• è·å–å½“å‰æ‰«æä»»åŠ¡ID\n   */\n  getCurrentJobId(): string | null {\n    return this.currentJobId\n  }\n\n  /**\n   * å¤„ç†é˜Ÿåˆ— - ğŸš¨ è¯¦ç»†è¯Šæ–­ç‰ˆæœ¬\n   */\n  private async processQueue(): Promise<void> {\n    // ğŸš¨ ç¬¬ä¸€è¡Œæ—¥å¿—ï¼šç¡®è®¤å‡½æ•°è¢«è°ƒç”¨\n    console.log(`[Worker] >>> processQueue() ENTER`)\n    console.log(`[Worker] isRunning=${this.isRunning}, queue.length=${this.queue.length}`)\n\n    // è¯Šæ–­ï¼šé˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡çš„çŠ¶æ€\n    const pendingCount = this.queue.filter(t => t.status === 'pending').length\n    const processingCount = this.queue.filter(t => t.status === 'processing').length\n    const completedCount = this.queue.filter(t => t.status === 'completed').length\n    console.log(`[Worker] ä»»åŠ¡ç»Ÿè®¡: pending=${pendingCount}, processing=${processingCount}, completed=${completedCount}`)\n\n    // ğŸš¨ çŠ¶æ€åŠ å›ºï¼šå¦‚æœå‘ç°å¡ä½ï¼Œå¼ºåˆ¶é‡ç½®\n    if (this.isRunning && !this.hasPendingTasks()) {\n      console.log('[Worker] ğŸ”§ æ£€æµ‹åˆ°çŠ¶æ€æ­»é”ï¼Œå¼ºåˆ¶é‡ç½® isRunning=false')\n      this.isRunning = false\n    }\n\n    if (this.isRunning) {\n      console.log('[Worker] âš ï¸ isRunning=trueï¼Œé€€å‡º')\n      return\n    }\n\n    // ğŸš¨ try...finally ç¡®ä¿çŠ¶æ€å›æ»š\n    this.isRunning = true\n    this.abortController = new AbortController()\n\n    console.log(`[Worker] ğŸš€ å¼€å§‹å¤„ç†ï¼Œå…± ${this.queue.length} å¼ ç…§ç‰‡`)\n\n    let processed = 0\n    const totalCount = this.queue.length\n\n    // ğŸ†• å¦‚æœæœ‰æ´»è·ƒä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€\n    if (this.currentJobId && scanJobService) {\n      console.log(`[FaceDetectionQueue] æ‰«æä»»åŠ¡ ${this.currentJobId} å¼€å§‹å¤„ç†`)\n    }\n\n    try {\n      while (this.hasPendingTasks() && !this.abortController.signal.aborted) {\n        // ç­‰å¾…æœ‰å¯ç”¨çš„å¤„ç†æ§½\n        await this.waitForSlot()\n\n        if (this.abortController.signal.aborted) {\n          console.log('[Worker] âš ï¸ ä¿¡å·ä¸­æ­¢')\n          break\n        }\n\n        // è·å–ä¸‹ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡\n        const task = this.getNextTask()\n        if (!task) {\n          console.log('[Worker] âš ï¸ getNextTask() è¿”å› null')\n          break\n        }\n\n        // ğŸš¨ æ¯å¼ ç…§ç‰‡å¤„ç†æ—¶æ‰“å°\n        console.log(`[Worker] ğŸ“¸ ${task.photoId} (${processed + 1}/${totalCount})`)\n\n        await this.processTask(task)\n        processed++\n        this.processedCount++\n\n        // ğŸ†• æ›´æ–°æ‰«æä»»åŠ¡è¿›åº¦ï¼ˆæ¯50å¼ ï¼‰\n        if (this.currentJobId && scanJobService && this.processedCount % 50 === 0) {\n          const photoIdNum = parseInt(task.photoId, 10)\n          if (!isNaN(photoIdNum)) {\n            scanJobService.updateProgress(this.currentJobId, this.processedCount, photoIdNum)\n            console.log(`[FaceDetectionQueue] æ›´æ–°è¿›åº¦: ${this.processedCount}, lastPhotoId: ${photoIdNum}`)\n          }\n        }\n\n        // ğŸ†• æ›´æ–°å¿ƒè·³ï¼ˆæ¯å¼ ç…§ç‰‡ï¼‰\n        if (this.currentJobId && scanJobService) {\n          scanJobService.updateHeartbeat(this.currentJobId)\n        }\n      }\n\n      if (!this.hasPendingTasks()) {\n        console.log('[Worker] âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ')\n      }\n\n    } catch (error) {\n      // ğŸ†• æ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥\n      if (this.currentJobId && scanJobService) {\n        const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'\n        scanJobService.failJob(this.currentJobId, errorMsg)\n        console.error(`[FaceDetectionQueue] æ‰«æä»»åŠ¡å¤±è´¥: ${errorMsg}`)\n      }\n      throw error\n    } finally {\n      // ğŸš¨ å…³é”®ï¼šæ— è®ºæˆåŠŸå¤±è´¥ï¼Œå¿…é¡»é‡ç½®çŠ¶æ€\n      this.isRunning = false\n      console.log(`[Worker] <<< processQueue() EXIT (processed=${processed}/${totalCount})`)\n\n      // ğŸ†• å®Œæˆä»»åŠ¡\n      if (this.currentJobId && scanJobService) {\n        const stats = this.getStats()\n        const detectedFaces = this.queue.reduce((sum, t) => sum + (t.faces || 0), 0)\n\n        if (this.abortController?.signal.aborted) {\n          // è¢«å–æ¶ˆ\n          scanJobService.cancelJob(this.currentJobId)\n          console.log(`[FaceDetectionQueue] æ‰«æä»»åŠ¡è¢«å–æ¶ˆ: ${this.currentJobId}`)\n        } else if (stats.failed === stats.total && stats.total > 0) {\n          // å…¨éƒ¨å¤±è´¥\n          scanJobService.failJob(this.currentJobId, 'All tasks failed')\n          console.log(`[FaceDetectionQueue] æ‰«æä»»åŠ¡å¤±è´¥: ${this.currentJobId}`)\n        } else {\n          // å®Œæˆ\n          scanJobService.completeJob(this.currentJobId, detectedFaces)\n          console.log(`[FaceDetectionQueue] æ‰«æä»»åŠ¡å®Œæˆ: ${this.currentJobId}, æ£€æµ‹åˆ° ${detectedFaces} å¼ äººè„¸`)\n\n          // ğŸ†• è‡ªåŠ¨è§¦å‘äººè„¸èšç±»\n          if (detectedFaces > 0) {\n            console.log('[FaceDetectionQueue] å¼€å§‹è‡ªåŠ¨èšç±»...')\n            const clusterStartTime = Date.now()\n            try {\n              const matchResult = await faceMatchingService.autoMatch({\n                threshold: 0.45,\n                onProgress: (current, total) => {\n                  console.log(`[FaceMatching] èšç±»è¿›åº¦: ${current}/${total}`)\n                }\n              })\n              const clusterDuration = Date.now() - clusterStartTime\n\n              // ğŸ†• CTOè¦æ±‚çš„ç›‘æ§æŒ‡æ ‡\n              const avgFacesPerPerson = matchResult.personsCreated > 0\n                ? matchResult.matched / matchResult.personsCreated\n                : 0\n\n              console.log(`[FaceMatching] èšç±»å®Œæˆ: ${matchResult.matched} å¼ äººè„¸å·²åŒ¹é…, åˆ›å»º ${matchResult.personsCreated} ä½äººç‰©`)\n              console.log(`[Analytics] face_clustering_completed:`, {\n                total_faces: detectedFaces,\n                matched_faces: matchResult.matched,\n                persons_created: matchResult.personsCreated,\n                avg_faces_per_person: avgFacesPerPerson.toFixed(2),\n                clustering_duration_ms: clusterDuration,\n                threshold_used: 0.45\n              })\n\n              // ğŸ†• å¥åº·é˜ˆå€¼å‘Šè­¦ï¼ˆCTOè¦æ±‚ï¼‰\n              if (avgFacesPerPerson > 20) {\n                console.warn(`[Analytics] âš ï¸ èšç±»è¿‡äºæ¿€è¿›: avg_faces_per_person=${avgFacesPerPerson.toFixed(2)} > 20`)\n              }\n              if (matchResult.personsCreated > 0 && matchResult.matched / detectedFaces < 0.1) {\n                console.warn(`[Analytics] âš ï¸ èšç±»è¿‡äºä¿å®ˆ: match_rate=${(matchResult.matched / detectedFaces).toFixed(2)} < 0.1`)\n              }\n              if (clusterDuration > 30000) {\n                console.warn(`[Analytics] âš ï¸ èšç±»æ€§èƒ½ç“¶é¢ˆ: duration=${clusterDuration}ms > 30000ms`)\n              }\n            } catch (clusterError) {\n              console.error('[FaceMatching] èšç±»å¤±è´¥:', clusterError)\n            }\n          }\n        }\n\n        this.currentJobId = null\n        this.processedCount = 0\n      }\n\n      // ğŸš¨ è§¦å‘å®Œæˆå›è°ƒ\n      if (!this.hasCompleted && this.onComplete) {\n        this.hasCompleted = true\n        const stats = this.getStats()\n        const detectedFaces = this.queue.reduce((sum, t) => sum + (t.faces || 0), 0)\n        console.log(`[Worker] ğŸ‰ è§¦å‘ onComplete: total=${stats.total}, completed=${stats.completed}, failed=${stats.failed}, faces=${detectedFaces}`)\n        this.onComplete({\n          total: stats.total,\n          completed: stats.completed,\n          failed: stats.failed,\n          detectedFaces\n        })\n      }\n    }\n  }\n\n  /**\n   * æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†ä»»åŠ¡\n   */\n  private hasPendingTasks(): boolean {\n    return this.queue.some(t => t.status === 'pending')\n  }\n\n  /**\n   * è·å–ä¸‹ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡\n   */\n  private getNextTask(): DetectionTask | undefined {\n    return this.queue.find(t => t.status === 'pending')\n  }\n\n  /**\n   * ç­‰å¾…æœ‰å¯ç”¨çš„å¤„ç†æ§½\n   */\n  private waitForSlot(): Promise<void> {\n    return new Promise((resolve) => {\n      const check = () => {\n        if (this.processingCount < this.maxConcurrent) {\n          resolve()\n        } else {\n          setTimeout(check, 100)\n        }\n      }\n      check()\n    })\n  }\n\n  /**\n   * å¤„ç†å•ä¸ªä»»åŠ¡\n   */\n  private async processTask(task: DetectionTask): Promise<void> {\n    task.status = 'processing'\n    this.processingCount++\n    this.reportProgress()\n\n    try {\n      console.log(`[FaceDetectionQueue] å¤„ç†ä¸­: ${task.photoId}`)\n\n      // éªŒè¯ä»»åŠ¡æ•°æ®\n      if (!task.filePath) {\n        throw new Error('ä»»åŠ¡ç¼ºå°‘æ–‡ä»¶è·¯å¾„')\n      }\n      if (!task.photoId) {\n        throw new Error('ä»»åŠ¡ç¼ºå°‘ photoId')\n      }\n\n      // ğŸš¨ CTOè¯Šæ–­ï¼šæ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œå­˜åœ¨æ€§\n      const fs = await import('fs')\n      console.log(`[DEBUG] ğŸ¯ å¼€å§‹æ£€æµ‹: ${task.photoId}`)\n      console.log(`[DEBUG] ğŸ“ åŸå§‹è·¯å¾„: ${task.filePath}`)\n      console.log(`[DEBUG] ğŸ” è·¯å¾„ç±»å‹: ${task.filePath?.startsWith('local-resource://') ? 'åè®®URL' : 'ç»å¯¹è·¯å¾„'}`)\n\n      // è½¬æ¢åè®®è·¯å¾„ä¸ºæœ¬åœ°è·¯å¾„\n      const absolutePath = task.filePath?.startsWith('local-resource://')\n        ? task.filePath.replace('local-resource://', '')\n        : task.filePath\n      console.log(`[DEBUG] ğŸ“‚ è½¬æ¢åè·¯å¾„: ${absolutePath}`)\n\n      // æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§\n      const exists = fs.existsSync(absolutePath)\n      console.log(`[DEBUG] ğŸ“‚ æ–‡ä»¶å­˜åœ¨: ${exists}`)\n\n      if (!exists) {\n        console.error(`[DEBUG] âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æµ‹: ${absolutePath}`)\n        task.status = 'failed'\n        task.error = 'æ–‡ä»¶ä¸å­˜åœ¨'\n        task.faces = 0\n        return\n      }\n\n      // æ‰§è¡Œæ£€æµ‹ï¼ˆä½¿ç”¨è½¬æ¢åçš„ç»å¯¹è·¯å¾„ï¼‰\n      console.log(`[DEBUG] ğŸ¤– è°ƒç”¨æ£€æµ‹æ¨¡å‹...`)\n      const result = await this.service.detect(absolutePath)\n      console.log(`[DEBUG] âœ… æ£€æµ‹å®Œæˆ: success=${result.success}, detections=${result.detections.length}`)\n\n      // æ·»åŠ æ£€æµ‹ç»“æœåˆ†æ\n      if (!result.success) {\n        console.error(`[DEBUG] ğŸ’¥ æ£€æµ‹å¤±è´¥: ${result.error}`)\n      } else if (result.detections.length === 0) {\n        console.warn(`[DEBUG] âš ï¸ æ£€æµ‹æˆåŠŸä½†è¿”å›0å¼ äººè„¸ - å¯èƒ½åŸå› : æ¨¡å‹æœªåŠ è½½/å›¾ç‰‡æ¨¡ç³Š/æ— äººè„¸`)\n      }\n\n      if (result.success && result.detections.length > 0) {\n        // å®‰å…¨è§£æ photoId ä¸ºæ•°å­—\n        const photoIdNum = parseInt(task.photoId, 10)\n        if (isNaN(photoIdNum)) {\n          console.warn(`[FaceDetectionQueue] æ— æ•ˆçš„ photoId: ${task.photoId}`)\n          task.status = 'failed'\n          task.error = 'æ— æ•ˆçš„ photoId'\n          return\n        }\n\n        // ä¿å­˜åˆ°æ•°æ®åº“\n        const faces = result.detections.map((detection, index) => ({\n          id: `${task.uuid}-face-${index}`,\n          bbox_x: detection.box.x,\n          bbox_y: detection.box.y,\n          bbox_width: detection.box.width,\n          bbox_height: detection.box.height,\n          confidence: detection.confidence,\n          embedding: detection.landmarks ? this.extractEmbedding(detection.landmarks) : undefined,\n          face_embedding: detection.descriptor // âœ… 128ç»´äººè„¸ç‰¹å¾å‘é‡ï¼Œç”¨äºäººç‰©åŒ¹é…\n        }))\n\n        this.database.saveDetectedFaces(photoIdNum, faces)\n        task.faces = faces.length\n\n        console.log(`[FaceDetectionQueue] æ£€æµ‹åˆ° ${faces.length} å¼ äººè„¸: ${task.photoId}`)\n        console.log(`[DEBUG] ğŸ’¾ å·²ä¿å­˜åˆ°æ•°æ®åº“: ${faces.length} å¼ äººè„¸, photoId=${photoIdNum}`)\n      } else {\n        task.faces = 0\n        console.log(`[FaceDetectionQueue] æœªæ£€æµ‹åˆ°äººè„¸: ${task.photoId}`)\n        console.log(`[DEBUG] âš ï¸ æ£€æµ‹ç»“æœä¸ºç©º: success=${result.success}, error=${result.error || 'æ— '}`)\n      }\n\n      task.status = 'completed'\n    } catch (error) {\n      task.status = 'failed'\n      task.error = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'\n      console.error(`[FaceDetectionQueue] å¤„ç†å¤±è´¥: ${task.photoId}`, error)\n    } finally {\n      this.processingCount--\n      this.reportProgress()\n    }\n  }\n\n  /**\n   * ä»åœ°æ ‡ç‚¹æå–ç®€åŒ–çš„ embedding\n   */\n  private extractEmbedding(landmarks: any): number[] {\n    // ç®€åŒ–çš„äººè„¸ç‰¹å¾å‘é‡\n    const embedding: number[] = []\n\n    // é¼»å­ä½ç½®\n    if (landmarks.nose && landmarks.nose.length > 0) {\n      embedding.push(landmarks.nose[0].x, landmarks.nose[0].y)\n    }\n\n    // çœ¼ç›ä¸­å¿ƒ\n    if (landmarks.leftEye && landmarks.leftEye.length > 0) {\n      const leftEyeX = landmarks.leftEye.reduce((sum: number, p: Point) => sum + p.x, 0) / landmarks.leftEye.length\n      const leftEyeY = landmarks.leftEye.reduce((sum: number, p: Point) => sum + p.y, 0) / landmarks.leftEye.length\n      embedding.push(leftEyeX, leftEyeY)\n    }\n\n    if (landmarks.rightEye && landmarks.rightEye.length > 0) {\n      const rightEyeX = landmarks.rightEye.reduce((sum: number, p: Point) => sum + p.x, 0) / landmarks.rightEye.length\n      const rightEyeY = landmarks.rightEye.reduce((sum: number, p: Point) => sum + p.y, 0) / landmarks.rightEye.length\n      embedding.push(rightEyeX, rightEyeY)\n    }\n\n    return embedding\n  }\n\n  /**\n   * æŠ¥å‘Šè¿›åº¦\n   */\n  private reportProgress(): void {\n    const stats = this.getStats()\n    const detectedFaces = this.queue.reduce((sum, t) => sum + (t.faces || 0), 0)\n    const isCompleted = !this.isRunning && stats.total > 0 && stats.completed === stats.total\n\n    // ğŸš¨ æ£€æµ‹å®ŒæˆçŠ¶æ€å¹¶è§¦å‘ onComplete\n    if (isCompleted && !this.hasCompleted && this.onComplete) {\n      this.hasCompleted = true\n      console.log(`[Worker] ğŸ‰ reportProgress æ£€æµ‹åˆ°å®Œæˆï¼Œè§¦å‘ onComplete: total=${stats.total}, completed=${stats.completed}, failed=${stats.failed}, faces=${detectedFaces}`)\n      this.onComplete({\n        total: stats.total,\n        completed: stats.completed,\n        failed: stats.failed,\n        detectedFaces\n      })\n    }\n\n    if (!this.onProgress) return\n\n    const progress: QueueProgress = {\n      ...stats,\n      currentPhoto: this.queue.find(t => t.status === 'processing')?.filePath || undefined,\n      detectedFaces,\n      status: this.isRunning ? 'running' : isCompleted ? 'completed' : 'idle'\n    }\n\n    this.onProgress(progress)\n  }\n\n  /**\n   * è·å–é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats(): {\n    total: number\n    pending: number\n    processing: number\n    completed: number\n    failed: number\n  } {\n    return {\n      total: this.queue.length,\n      pending: this.queue.filter(t => t.status === 'pending').length,\n      processing: this.queue.filter(t => t.status === 'processing').length,\n      completed: this.queue.filter(t => t.status === 'completed').length,\n      failed: this.queue.filter(t => t.status === 'failed').length\n    }\n  }\n\n  /**\n   * è·å–é˜Ÿåˆ—çŠ¶æ€ï¼ˆæš´éœ²ç»™ IPCï¼‰- ğŸš¨ çŠ¶æ€è¯Šæ–­ä¸“ç”¨\n   */\n  getDetailedStatus(): {\n    isRunning: boolean\n    queueLength: number\n    hasPending: boolean\n    processingCount: number\n    total: number\n    pending: number\n    completed: number\n    failed: number\n  } {\n    const stats = this.getStats()\n    return {\n      isRunning: this.isRunning,\n      queueLength: this.queue.length,\n      hasPending: this.hasPendingTasks(),\n      processingCount: this.processingCount,\n      ...stats\n    }\n  }\n\n  /**\n   * å¼ºåˆ¶é‡ç½®çŠ¶æ€ï¼ˆç”¨äºæ¢å¤å¡ä½çš„é˜Ÿåˆ—ï¼‰\n   */\n  forceReset(): void {\n    const wasRunning = this.isRunning\n    this.isRunning = false\n    this.abortController = null\n\n    console.log(`[FaceDetectionQueue] å¼ºåˆ¶é‡ç½®: ä¹‹å‰è¿è¡Œ=${wasRunning}, é˜Ÿåˆ—é•¿åº¦=${this.queue.length}`)\n\n    // ä¸æ”¹å˜ä»»åŠ¡çŠ¶æ€ï¼Œè®©å®ƒä»¬ä¿æŒåŸæ ·ç­‰å¾…å¤„ç†\n  }\n\n  /**\n   * å¼ºåˆ¶å¯åŠ¨é˜Ÿåˆ—ï¼ˆç»•è¿‡ addTask è‡ªåŠ¨è§¦å‘ï¼‰\n   */\n  async forceStart(): Promise<void> {\n    console.log(`[Worker] === forceStart() ===`)\n    console.log(`[Worker] this.isRunning = ${this.isRunning}`)\n    console.log(`[Worker] this.queue.length = ${this.queue.length}`)\n\n    const pendingBefore = this.queue.filter(t => t.status === 'pending').length\n    console.log(`[Worker] pending before = ${pendingBefore}`)\n\n    if (this.isRunning) {\n      console.log('[Worker] âš ï¸ isRunning=trueï¼Œè·³è¿‡')\n      return\n    }\n\n    const hasPending = this.hasPendingTasks()\n    console.log(`[Worker] hasPendingTasks() = ${hasPending}`)\n\n    if (!hasPending) {\n      console.log('[Worker] âš ï¸ æ²¡æœ‰ pending ä»»åŠ¡ï¼Œè·³è¿‡')\n      return\n    }\n\n    console.log('[Worker] ğŸš€ è°ƒç”¨ processQueue()...')\n    await this.processQueue()\n    console.log('[Worker] === forceStart() å®Œæˆ ===')\n  }\n\n  /**\n   * å–æ¶ˆå¤„ç†\n   */\n  cancel(): void {\n    this.abortController?.abort()\n    this.isRunning = false\n    console.log('[FaceDetectionQueue] å–æ¶ˆå¤„ç†')\n\n    // ğŸ†• å–æ¶ˆæ‰«æä»»åŠ¡\n    if (this.currentJobId && scanJobService) {\n      scanJobService.cancelJob(this.currentJobId)\n      console.log(`[FaceDetectionQueue] æ‰«æä»»åŠ¡å·²å–æ¶ˆ: ${this.currentJobId}`)\n      this.currentJobId = null\n    }\n\n    // é‡ç½®å¾…å¤„ç†ä»»åŠ¡\n    for (const task of this.queue) {\n      if (task.status === 'pending') {\n        task.status = 'pending' // ä¿æŒå¾…å¤„ç†çŠ¶æ€\n      }\n    }\n  }\n\n  /**\n   * æ¸…ç©ºé˜Ÿåˆ—\n   */\n  clear(): void {\n    this.cancel()\n    this.queue = []\n    this.reportProgress()\n    console.log('[FaceDetectionQueue] é˜Ÿåˆ—å·²æ¸…ç©º')\n  }\n\n  /**\n   * è·å–æ‰€æœ‰ä»»åŠ¡\n   */\n  getTasks(): DetectionTask[] {\n    return [...this.queue]\n  }\n\n  /**\n   * è·å–å¤±è´¥çš„ä»»åŠ¡\n   */\n  getFailedTasks(): DetectionTask[] {\n    return this.queue.filter(t => t.status === 'failed')\n  }\n\n  /**\n   * é‡è¯•å¤±è´¥çš„ä»»åŠ¡\n   */\n  async retryFailed(): Promise<void> {\n    const failedTasks = this.getFailedTasks()\n\n    for (const task of failedTasks) {\n      task.status = 'pending'\n      task.error = undefined\n    }\n\n    console.log(`[FaceDetectionQueue] é‡è¯• ${failedTasks.length} ä¸ªå¤±è´¥ä»»åŠ¡`)\n    await this.processQueue()\n  }\n}\n\ninterface Point {\n  x: number\n  y: number\n}\n\nexport const faceDetectionQueue = new FaceDetectionQueue(new PhotoDatabase())\n","/**\n * PhotoMind - å¯¼å…¥æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. åè°ƒæ–‡ä»¶å¤¹æ‰«æå’Œç…§ç‰‡å¯¼å…¥\n * 2. è¿‡æ»¤é‡å¤ç…§ç‰‡\n * 3. è®°å½•å¯¼å…¥çŠ¶æ€\n * 4. æ”¯æŒå–æ¶ˆæ“ä½œ\n * 5. è‡ªåŠ¨ç”Ÿæˆå‘é‡ï¼ˆå¼‚æ­¥ï¼‰\n */\nimport { folderScanner, ScanOptions, ScannedFile } from './folderScanner.js'\nimport { PhotoDatabase } from '../database/db.js'\nimport { importProgressService, ImportProgress } from './importProgressService.js'\nimport { backgroundVectorService, VectorTask } from './backgroundVectorService.js'\nimport { faceDetectionQueue } from './faceDetectionQueue.js'\nimport crypto from 'crypto'\nimport { promises as fs } from 'fs'\n\nexport interface ImportOptions {\n  copyFiles?: boolean\n  moveFiles?: boolean\n  createBackup?: boolean\n  skipDuplicates?: boolean\n  generateThumbnails?: boolean\n}\n\nexport interface ImportResult {\n  success: boolean\n  imported: number\n  skipped: number\n  failed: number\n  errors: Array<{ file: string; error: string }>\n  duration: number\n}\n\n// ImportProgress å·²ä» importProgressService å¯¼å‡ºï¼Œè¿™é‡Œä¸å†é‡å¤å®šä¹‰\n\nexport class ImportService {\n  private database: PhotoDatabase\n  private isImporting = false\n  private cancelImport = false\n\n  constructor(database: PhotoDatabase) {\n    this.database = database\n  }\n\n  /**\n   * è®¾ç½®è¿›åº¦å›è°ƒï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰\n   */\n  onProgress(callback: (progress: ImportProgress) => void): () => void {\n    return importProgressService.subscribe(callback)\n  }\n\n  /**\n   * ä»æ–‡ä»¶å¤¹å¯¼å…¥ç…§ç‰‡\n   */\n  async importFromFolder(\n    folderPath: string,\n    options: ImportOptions = {}\n  ): Promise<ImportResult> {\n    if (this.isImporting) {\n      throw new Error('å¯¼å…¥å·²åœ¨è¿›è¡Œä¸­')\n    }\n\n    this.isImporting = true\n    this.cancelImport = false\n\n    const startTime = Date.now()\n    const result: ImportResult = {\n      success: true,\n      imported: 0,\n      skipped: 0,\n      failed: 0,\n      errors: [],\n      duration: 0\n    }\n\n    try {\n      // 1. æ‰«ææ–‡ä»¶å¤¹\n      console.log(`[Import] å¼€å§‹æ‰«ææ–‡ä»¶å¤¹: ${folderPath}`)\n      importProgressService.setStage('scanning')\n      const files = await folderScanner.scanFolder(folderPath)\n\n      if (files.length === 0) {\n        console.log('[Import] æœªæ‰¾åˆ°æ”¯æŒçš„ç…§ç‰‡æ–‡ä»¶')\n        importProgressService.complete(true)\n        return result\n      }\n\n      console.log(`[Import] æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶`)\n\n      // 2. è¿‡æ»¤å·²å­˜åœ¨çš„ç…§ç‰‡\n      importProgressService.setStage('preparing')\n      const toImport = options.skipDuplicates\n        ? await this.filterDuplicates(files)\n        : files\n\n      console.log(`[Import] å°†å¯¼å…¥ ${toImport.length} ä¸ªæ–‡ä»¶ï¼ˆ${options.skipDuplicates ? `è¿‡æ»¤äº† ${files.length - toImport.length} ä¸ªé‡å¤æ–‡ä»¶` : 'ä¸è¿‡æ»¤é‡å¤'}ï¼‰`)\n\n      // 3. å¼€å§‹å¯¼å…¥é˜¶æ®µ\n      importProgressService.startSession(toImport.length, 'importing')\n\n      // 4. å¯¼å…¥ç…§ç‰‡\n      const total = toImport.length\n\n      for (let i = 0; i < toImport.length; i++) {\n        if (this.cancelImport) {\n          result.success = false\n          importProgressService.cancel()\n          break\n        }\n\n        const file = toImport[i]\n        importProgressService.updateCurrentFile(file.filename)\n\n        try {\n          // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n          try {\n            await fs.access(file.path)\n          } catch {\n            importProgressService.addError(file.path, 'æ–‡ä»¶ä¸å­˜åœ¨')\n            continue\n          }\n\n          // è®¡ç®—æ–‡ä»¶å“ˆå¸Œ\n          const fileHash = await this.calculateFileHash(file.path)\n\n          // æ£€æŸ¥æ˜¯å¦å·²å¯¼å…¥ï¼ˆé€šè¿‡æ–‡ä»¶è·¯å¾„æˆ–å“ˆå¸Œï¼‰\n          const existingPhoto = this.findExistingPhoto(file.path, fileHash)\n          if (existingPhoto) {\n            importProgressService.advanceProgress(false, true, false)\n            console.log(`[Import] è·³è¿‡å·²å­˜åœ¨çš„ç…§ç‰‡: ${file.filename}`)\n            continue\n          }\n\n          // è¯»å–æ–‡ä»¶å¹¶ä¿å­˜\n          const photoData = {\n            uuid: this.generateUUID(),\n            fileName: file.filename,\n            filePath: file.path,\n            fileSize: file.size,\n            width: null as number | null,\n            height: null as number | null,\n            takenAt: file.mtime.toISOString(),\n            exif: {},\n            location: {},\n            status: 'local' as const\n          }\n\n          const photoId = this.database.addPhoto(photoData)\n\n          if (photoId > 0) {\n            importProgressService.advanceProgress(true, false, false)\n            console.log(`[Import] æˆåŠŸå¯¼å…¥: ${file.filename}`)\n          } else {\n            importProgressService.addError(file.path, 'æ•°æ®åº“æ’å…¥å¤±è´¥')\n          }\n        } catch (error) {\n          importProgressService.addError(file.path, error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯')\n          console.error(`[Import] å¯¼å…¥æ–‡ä»¶å¤±è´¥: ${file.path}`, error)\n        }\n      }\n\n      // å®Œæˆ\n      importProgressService.complete(true)\n      return result\n    } finally {\n      this.isImporting = false\n      result.duration = Date.now() - startTime\n      console.log(`[Import] å¯¼å…¥å®Œæˆ: æˆåŠŸ ${result.imported}, è·³è¿‡ ${result.skipped}, å¤±è´¥ ${result.failed}, è€—æ—¶ ${result.duration}ms`)\n    }\n  }\n\n  /**\n   * è¿‡æ»¤å·²å­˜åœ¨çš„ç…§ç‰‡\n   */\n  private async filterDuplicates(files: ScannedFile[]): Promise<ScannedFile[]> {\n    const existingPhotos = this.database.query('SELECT file_path, file_size FROM photos')\n    const existingMap = new Set<string>()\n\n    // åˆ›å»ºå·²å­˜åœ¨æ–‡ä»¶çš„æ˜ å°„ï¼ˆè·¯å¾„+å¤§å°ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰\n    for (const photo of existingPhotos) {\n      const key = `${photo.file_path}_${photo.file_size}`\n      existingMap.add(key)\n    }\n\n    // è¿‡æ»¤\n    const toImport: ScannedFile[] = []\n\n    for (const file of files) {\n      const key = `${file.path}_${file.size}`\n      if (!existingMap.has(key)) {\n        toImport.push(file)\n      }\n    }\n\n    return toImport\n  }\n\n  /**\n   * æŸ¥æ‰¾å·²å­˜åœ¨çš„ç…§ç‰‡\n   */\n  private findExistingPhoto(filePath: string, fileHash: string): any | null {\n    const photos = this.database.query(\n      'SELECT * FROM photos WHERE file_path = ? OR uuid = ?',\n      [filePath, fileHash]\n    )\n    return photos.length > 0 ? photos[0] : null\n  }\n\n  /**\n   * è®¡ç®—æ–‡ä»¶å“ˆå¸Œ\n   */\n  private async calculateFileHash(filePath: string): Promise<string> {\n    try {\n      const buffer = await fs.readFile(filePath)\n      return crypto.createHash('md5').update(buffer).digest('hex')\n    } catch {\n      return ''\n    }\n  }\n\n  /**\n   * ç”Ÿæˆ UUID\n   */\n  private generateUUID(): string {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n      const r = Math.random() * 16 | 0\n      const v = c === 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n  }\n\n  /**\n   * å–æ¶ˆå¯¼å…¥\n   */\n  cancel(): void {\n    this.cancelImport = true\n    console.log('[Import] æ”¶åˆ°å–æ¶ˆä¿¡å·ï¼Œå°†åœ¨å½“å‰æ–‡ä»¶å¤„ç†å®Œæˆååœæ­¢')\n  }\n\n  /**\n   * è·å–æ˜¯å¦æ­£åœ¨å¯¼å…¥\n   */\n  getIsImporting(): boolean {\n    return this.isImporting\n  }\n\n  // ==================== å‘é‡ç”Ÿæˆç›¸å…³æ–¹æ³• ====================\n\n  /**\n   * å¯¼å…¥å•å¼ ç…§ç‰‡å¹¶è‡ªåŠ¨ç”Ÿæˆå‘é‡\n   * æ³¨æ„ï¼šå‘é‡ç”Ÿæˆæ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šé˜»å¡å¯¼å…¥æµç¨‹\n   */\n  async importPhotoWithVector(\n    filePath: string,\n    options: { generateThumbnails?: boolean } = {}\n  ): Promise<{ success: boolean; photoUuid?: string; vectorQueued?: boolean }> {\n    try {\n      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n      try {\n        await fs.access(filePath)\n      } catch {\n        return { success: false }\n      }\n\n      // è®¡ç®—æ–‡ä»¶å“ˆå¸Œ\n      const fileHash = await this.calculateFileHash(filePath)\n\n      // æ£€æŸ¥æ˜¯å¦å·²å¯¼å…¥\n      const existingPhoto = this.findExistingPhoto(filePath, fileHash)\n      if (existingPhoto) {\n        console.log(`[Import] ç…§ç‰‡å·²å­˜åœ¨: ${filePath}`)\n        return { success: true, photoUuid: existingPhoto.uuid, vectorQueued: false }\n      }\n\n      // è·å–æ–‡ä»¶ä¿¡æ¯\n      const filename = filePath.split('/').pop() || 'unknown'\n      const stats = await fs.stat(filePath)\n\n      // å¯¼å…¥ç…§ç‰‡\n      const photoData = {\n        uuid: this.generateUUID(),\n        fileName: filename,\n        filePath: filePath,\n        fileSize: stats.size,\n        width: null as number | null,\n        height: null as number | null,\n        takenAt: stats.mtime.toISOString(),\n        exif: {},\n        location: {},\n        status: 'local' as const\n      }\n\n      const photoId = this.database.addPhoto(photoData)\n\n      if (photoId > 0) {\n        console.log(`[Import] ç…§ç‰‡å¯¼å…¥æˆåŠŸ: ${photoData.uuid}`)\n\n        // æ·»åŠ åˆ°å‘é‡ç”Ÿæˆé˜Ÿåˆ—ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰\n        backgroundVectorService.addPhoto(photoData.uuid)\n\n        // æ·»åŠ åˆ°äººè„¸æ£€æµ‹é˜Ÿåˆ—ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰\n        this.triggerFaceDetection(photoId, photoData.uuid, filePath)\n\n        return {\n          success: true,\n          photoUuid: photoData.uuid,\n          vectorQueued: true\n        }\n      }\n\n      return { success: false }\n    } catch (error) {\n      console.error(`[Import] å¯¼å…¥ç…§ç‰‡å¤±è´¥: ${filePath}`, error)\n      return { success: false }\n    }\n  }\n\n  /**\n   * æ‰¹é‡å¯¼å…¥æ–‡ä»¶å¤¹å¹¶ä¸ºæ¯å¼ ç…§ç‰‡ç”Ÿæˆå‘é‡\n   */\n  async importFolderWithVectors(\n    folderPath: string,\n    options: ImportOptions = {}\n  ): Promise<{\n    importResult: ImportResult\n    vectorTaskId?: string\n  }> {\n    // å…ˆæ‰§è¡Œæ™®é€šå¯¼å…¥\n    const importResult = await this.importFromFolder(folderPath, options)\n\n    // å¦‚æœå¯¼å…¥æˆåŠŸï¼Œæ·»åŠ æ‰€æœ‰æ–°ç…§ç‰‡åˆ°å‘é‡ç”Ÿæˆé˜Ÿåˆ—\n    if (importResult.imported > 0) {\n      // è·å–åˆšå¯¼å…¥çš„ç…§ç‰‡ UUID åˆ—è¡¨\n      const recentPhotos = this.database.query(\n        `SELECT uuid FROM photos WHERE status = 'local' ORDER BY id DESC LIMIT ?`,\n        [importResult.imported]\n      )\n\n      if (recentPhotos.length > 0) {\n        const photoUuids = recentPhotos.map((p: any) => p.uuid)\n        const taskId = backgroundVectorService.addGenerateTask(photoUuids)\n\n        console.log(`[Import] å·²æ·»åŠ  ${photoUuids.length} å¼ ç…§ç‰‡åˆ°å‘é‡ç”Ÿæˆé˜Ÿåˆ—ï¼Œä»»åŠ¡ID: ${taskId}`)\n\n        // è§¦å‘äººè„¸æ£€æµ‹ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰\n        await this.triggerFaceDetectionBatch(photoUuids)\n\n        return {\n          importResult,\n          vectorTaskId: taskId\n        }\n      }\n    }\n\n    return { importResult }\n  }\n\n  /**\n   * è·å–å½“å‰å‘é‡ç”ŸæˆçŠ¶æ€\n   */\n  getVectorGenerationStatus(): {\n    hasActiveTask: boolean\n    currentTask: VectorTask | null\n    stats: { pending: number; processing: number; completed: number; failed: number }\n  } {\n    const currentTask = backgroundVectorService.getCurrentTask()\n    return {\n      hasActiveTask: currentTask !== null,\n      currentTask,\n      stats: backgroundVectorService.getStats()\n    }\n  }\n\n  /**\n   * è·å–å¾…ç”Ÿæˆå‘é‡çš„ç…§ç‰‡æ•°é‡\n   */\n  getPendingVectorCount(): number {\n    const stats = backgroundVectorService.getStats()\n    return stats.pending\n  }\n\n  /**\n   * è§¦å‘äººè„¸æ£€æµ‹\n   * å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡å¯¼å…¥æµç¨‹\n   */\n  private async triggerFaceDetection(photoId: number, photoUuid: string, filePath: string): Promise<void> {\n    try {\n      await faceDetectionQueue.addTask(\n        photoId.toString(),\n        photoUuid,\n        filePath\n      )\n      console.log(`[Import] å·²æ·»åŠ åˆ°äººè„¸æ£€æµ‹é˜Ÿåˆ—: ${photoUuid}`)\n    } catch (error) {\n      console.error(`[Import] äººè„¸æ£€æµ‹è§¦å‘å¤±è´¥: ${photoUuid}`, error)\n      // ä¸é˜»å¡å¯¼å…¥æµç¨‹\n    }\n  }\n\n  /**\n   * æ‰¹é‡è§¦å‘äººè„¸æ£€æµ‹\n   */\n  private async triggerFaceDetectionBatch(photoUuids: string[]): Promise<void> {\n    if (photoUuids.length === 0) return\n\n    try {\n      // è·å–ç…§ç‰‡ä¿¡æ¯\n      const photos = this.database.query(\n        `SELECT id, uuid, file_path FROM photos WHERE uuid IN (${photoUuids.map(() => '?').join(',')})`,\n        photoUuids\n      )\n\n      // æ‰¹é‡æ·»åŠ åˆ°äººè„¸æ£€æµ‹é˜Ÿåˆ—\n      for (const photo of photos) {\n        await this.triggerFaceDetection(photo.id, photo.uuid, photo.file_path)\n      }\n\n      console.log(`[Import] å·²æ‰¹é‡æ·»åŠ  ${photos.length} å¼ ç…§ç‰‡åˆ°äººè„¸æ£€æµ‹é˜Ÿåˆ—`)\n    } catch (error) {\n      console.error('[Import] æ‰¹é‡äººè„¸æ£€æµ‹è§¦å‘å¤±è´¥:', error)\n    }\n  }\n}\n\n// å¯¼å‡ºå•ä¾‹ï¼Œç”± main/index.ts åˆå§‹åŒ–æ—¶ä¼ å…¥ database å®ä¾‹\nexport let importService: ImportService | null = null\n\n/**\n * åˆå§‹åŒ–å¯¼å…¥æœåŠ¡ï¼ˆä½¿ç”¨ä¸ä¸»è¿›ç¨‹ç›¸åŒçš„æ•°æ®åº“å®ä¾‹ï¼‰\n */\nexport function initializeImportService(database: PhotoDatabase): ImportService {\n  importService = new ImportService(database)\n  return importService\n}\n","/**\n * PhotoMind - å‘é‡ç”ŸæˆæœåŠ¡ï¼ˆæ··åˆæ¶æ„ç‰ˆæœ¬ï¼‰\n *\n * åŠŸèƒ½ï¼š\n * 1. æ‰¹é‡ç”Ÿæˆç…§ç‰‡çš„è¯­ä¹‰å‘é‡\n * 2. å¢é‡æ›´æ–°ï¼ˆåªç”Ÿæˆæ–°ç…§ç‰‡çš„å‘é‡ï¼‰\n * 3. è¿›åº¦è¿½è¸ªå’Œå–æ¶ˆæ”¯æŒ\n * 4. ä¸»è¿›ç¨‹è°ƒåº¦ + æ¸²æŸ“è¿›ç¨‹æ‰§è¡Œ\n */\nimport { getEmbeddingService } from './hybridEmbeddingService.js'\nimport { PhotoDatabase } from '../database/db.js'\nimport type { BatchEmbeddingProgress } from '../types/embedding.js'\nimport { BrowserWindow } from 'electron'\n\ninterface GenerationOptions {\n  batchSize?: number\n  onProgress?: (progress: BatchEmbeddingProgress) => void\n}\n\ninterface GenerationResult {\n  success: number\n  failed: number\n  total: number\n  errors: Array<{ photoUuid: string; error: string }>\n  cancelled: boolean\n}\n\nexport class VectorGenerationService {\n  private isGenerating = false\n  private abortController: AbortController | null = null\n  private database: PhotoDatabase\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || new PhotoDatabase()\n  }\n\n  /**\n   * ç”Ÿæˆæ‰€æœ‰ç…§ç‰‡çš„å‘é‡\n   */\n  async generateAll(options: GenerationOptions = {}): Promise<GenerationResult> {\n    if (this.isGenerating) {\n      throw new Error('ç”Ÿæˆä»»åŠ¡å·²åœ¨è¿›è¡Œä¸­')\n    }\n\n    this.isGenerating = true\n    this.abortController = new AbortController()\n\n    const { batchSize = 50, onProgress } = options\n\n    let success = 0\n    let failed = 0\n    let total = 0\n    let processed = 0\n    const errors: Array<{ photoUuid: string; error: string }> = []\n\n    try {\n      // è·å–æ²¡æœ‰å‘é‡çš„ç…§ç‰‡\n      const photos = this.database.getPhotosWithoutEmbeddings(10000)\n      total = photos.length\n\n      console.log(`[VectorGeneration] å¼€å§‹ç”Ÿæˆ ${total} å¼ ç…§ç‰‡çš„å‘é‡`)\n\n      if (total === 0) {\n        console.log('[VectorGeneration] æ‰€æœ‰ç…§ç‰‡å·²æœ‰å‘é‡ï¼Œæ— éœ€ç”Ÿæˆ')\n        return { success: 0, failed, total, errors, cancelled: false }\n      }\n\n      // åˆ†æ‰¹å¤„ç†\n      for (let i = 0; i < total; i += batchSize) {\n        if (this.abortController?.signal.aborted) {\n          console.log('[VectorGeneration] ç”Ÿæˆä»»åŠ¡å·²å–æ¶ˆ')\n          break\n        }\n\n        const batch = photos.slice(i, i + batchSize)\n\n        for (const photo of batch) {\n          if (this.abortController?.signal.aborted) {\n            break\n          }\n\n          try {\n            // å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²æœ‰å‘é‡\n            const hasEmbedding = await this.database.hasEmbedding(photo.uuid, 'image')\n            if (hasEmbedding) {\n              processed++\n              continue\n            }\n\n            // é€šè¿‡æ¸²æŸ“è¿›ç¨‹ç”Ÿæˆå‘é‡\n            const result = await this.callRendererEmbedding(photo.file_path)\n\n            if (result.success && result.vector) {\n              await this.database.saveEmbedding(photo.uuid, result.vector.values, 'image')\n              success++\n            } else {\n              failed++\n              errors.push({\n                photoUuid: photo.uuid,\n                error: result.error || 'Unknown error'\n              })\n            }\n          } catch (error) {\n            failed++\n            errors.push({\n              photoUuid: photo.uuid,\n              error: error instanceof Error ? error.message : 'Unknown error'\n            })\n          }\n\n          processed++\n\n          const progress: BatchEmbeddingProgress = {\n            total,\n            processed,\n            currentPhotoUuid: photo.uuid,\n            percentComplete: Math.round((processed / total) * 100)\n          }\n\n          onProgress?.(progress)\n        }\n      }\n\n      console.log(`[VectorGeneration] ç”Ÿæˆå®Œæˆ: æˆåŠŸ ${success}, å¤±è´¥ ${failed}`)\n      return { success, failed, total, errors, cancelled: this.abortController?.signal.aborted || false }\n    } catch (error) {\n      console.error('[VectorGeneration] ç”Ÿæˆå¤±è´¥:', error)\n      return {\n        success,\n        failed,\n        total,\n        errors,\n        cancelled: false\n      }\n    } finally {\n      this.isGenerating = false\n      this.abortController = null\n    }\n  }\n\n  /**\n   * é€šè¿‡æ¸²æŸ“è¿›ç¨‹ç”Ÿæˆå‘é‡\n   */\n  private async callRendererEmbedding(imagePath: string): Promise<any> {\n    const windows = BrowserWindow.getAllWindows()\n\n    if (windows.length === 0) {\n      return { success: false, error: 'No renderer window available' }\n    }\n\n    try {\n      // ä½¿ç”¨ Promise.race å®ç°è¶…æ—¶æ§åˆ¶\n      const timeoutMs = 60000 // 60ç§’è¶…æ—¶\n\n      const executePromise = windows[0].webContents.executeJavaScript(`\n        (async () => {\n          try {\n            if (window.embeddingAPI && window.embeddingAPI.imageToEmbedding) {\n              const result = await window.embeddingAPI.imageToEmbedding(\\`${imagePath.replace(/`/g, '\\\\`')}\\`)\n              return JSON.stringify(result)\n            } else {\n              return JSON.stringify({success: false, error: 'Embedding API not available', processingTimeMs: 0})\n            }\n          } catch (err) {\n            return JSON.stringify({success: false, error: err.message || String(err), processingTimeMs: 0})\n          }\n        })()\n      `)\n\n      const timeoutPromise = new Promise<string>((_, reject) => {\n        setTimeout(() => reject(new Error('Embedding timeout after 60s')), timeoutMs)\n      })\n\n      const result = await Promise.race([executePromise, timeoutPromise])\n      return JSON.parse(result)\n    } catch (error) {\n      console.error('[VectorGeneration] è°ƒç”¨æ¸²æŸ“è¿›ç¨‹å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  }\n\n  /**\n   * ç”Ÿæˆå•å¼ ç…§ç‰‡çš„å‘é‡\n   */\n  async generateOne(photoUuid: string): Promise<boolean> {\n    const photo = this.database.getPhotoByUuid(photoUuid)\n    if (!photo) {\n      throw new Error(`ç…§ç‰‡ä¸å­˜åœ¨: ${photoUuid}`)\n    }\n\n    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å‘é‡\n    const hasEmbedding = await this.database.hasEmbedding(photoUuid, 'image')\n    if (hasEmbedding) {\n      console.log(`[VectorGeneration] ç…§ç‰‡å·²æœ‰å‘é‡ï¼Œè·³è¿‡: ${photoUuid}`)\n      return true\n    }\n\n    const result = await this.callRendererEmbedding(photo.file_path)\n\n    if (result.success && result.vector) {\n      await this.database.saveEmbedding(photoUuid, result.vector.values, 'image')\n      console.log(`[VectorGeneration] æˆåŠŸç”Ÿæˆå‘é‡: ${photoUuid}`)\n      return true\n    }\n\n    return false\n  }\n\n  /**\n   * æ‰¹é‡ç”ŸæˆæŒ‡å®šç…§ç‰‡çš„å‘é‡\n   */\n  async generateBatch(\n    photoUuids: string[],\n    options: GenerationOptions = {}\n  ): Promise<GenerationResult> {\n    if (this.isGenerating) {\n      throw new Error('ç”Ÿæˆä»»åŠ¡å·²åœ¨è¿›è¡Œä¸­')\n    }\n\n    this.isGenerating = true\n    this.abortController = new AbortController()\n\n    const { batchSize = 10, onProgress } = options\n\n    let success = 0\n    let failed = 0\n    const errors: Array<{ photoUuid: string; error: string }> = []\n    const total = photoUuids.length\n    let processed = 0\n\n    try {\n      for (const photoUuid of photoUuids) {\n        if (this.abortController?.signal.aborted) {\n          break\n        }\n\n        try {\n          const photo = this.database.getPhotoByUuid(photoUuid)\n          if (!photo) {\n            failed++\n            errors.push({ photoUuid, error: 'ç…§ç‰‡ä¸å­˜åœ¨' })\n            continue\n          }\n\n          const result = await this.callRendererEmbedding(photo.file_path)\n\n          if (result.success && result.vector) {\n            await this.database.saveEmbedding(photoUuid, result.vector.values, 'image')\n            success++\n          } else {\n            failed++\n            errors.push({ photoUuid, error: result.error || 'Unknown error' })\n          }\n        } catch (error) {\n          failed++\n          errors.push({\n            photoUuid,\n            error: error instanceof Error ? error.message : 'Unknown error'\n          })\n        }\n\n        processed++\n\n        const progress: BatchEmbeddingProgress = {\n          total,\n          processed,\n          currentPhotoUuid: photoUuid,\n          percentComplete: Math.round((processed / total) * 100)\n        }\n\n        onProgress?.(progress)\n      }\n\n      return { success, failed, total, errors, cancelled: this.abortController?.signal.aborted || false }\n    } finally {\n      this.isGenerating = false\n      this.abortController = null\n    }\n  }\n\n  /**\n   * å–æ¶ˆç”Ÿæˆä»»åŠ¡\n   */\n  cancel(): void {\n    console.log('[VectorGeneration] æ”¶åˆ°å–æ¶ˆä¿¡å·')\n    this.abortController?.abort()\n  }\n\n  /**\n   * è·å–ç”ŸæˆçŠ¶æ€\n   */\n  getStatus(): { isGenerating: boolean; totalPending?: number } {\n    if (!this.isGenerating) {\n      return { isGenerating: false }\n    }\n\n    const pending = this.database.getPhotosWithoutEmbeddings(1).length\n    return { isGenerating: true, totalPending: pending }\n  }\n\n  /**\n   * è·å–å¾…ç”Ÿæˆçš„ç…§ç‰‡æ•°é‡\n   */\n  async getPendingCount(): Promise<number> {\n    const photos = this.database.getPhotosWithoutEmbeddings(10000)\n    return photos.length\n  }\n}\n\nexport const vectorGenerationService = new VectorGenerationService()\n","/**\n * PhotoMind - ç›¸ä¼¼åº¦è®¡ç®—æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—\n * 2. æ‰¹é‡ç›¸ä¼¼åº¦è®¡ç®—\n * 3. Top-k æ’åº\n */\nimport type { EmbeddingVector } from '../types/embedding.js'\n\nexport interface SimilarityResult {\n  id: string\n  similarity: number\n}\n\nexport interface SearchResult {\n  photoUuid: string\n  similarity: number\n  rank: number\n}\n\nexport class SimilarityService {\n  /**\n   * è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦\n   */\n  cosineSimilarity(a: EmbeddingVector, b: EmbeddingVector): number {\n    if (a.length !== b.length) {\n      console.warn('[Similarity] å‘é‡ç»´åº¦ä¸åŒ¹é…')\n      return 0\n    }\n\n    let dotProduct = 0\n    let normA = 0\n    let normB = 0\n\n    for (let i = 0; i < a.length; i++) {\n      dotProduct += a[i] * b[i]\n      normA += a[i] * a[i]\n      normB += b[i] * b[i]\n    }\n\n    const denominator = Math.sqrt(normA) * Math.sqrt(normB)\n    if (denominator === 0) return 0\n\n    return dotProduct / denominator\n  }\n\n  /**\n   * è®¡ç®—æ¬§æ°è·ç¦»\n   */\n  euclideanDistance(a: EmbeddingVector, b: EmbeddingVector): number {\n    if (a.length !== b.length) {\n      return Infinity\n    }\n\n    let sum = 0\n    for (let i = 0; i < a.length; i++) {\n      sum += Math.pow(a[i] - b[i], 2)\n    }\n\n    return Math.sqrt(sum)\n  }\n\n  /**\n   * è®¡ç®—ç‚¹ç§¯\n   */\n  dotProduct(a: EmbeddingVector, b: EmbeddingVector): number {\n    if (a.length !== b.length) {\n      return 0\n    }\n\n    let sum = 0\n    for (let i = 0; i < a.length; i++) {\n      sum += a[i] * b[i]\n    }\n\n    return sum\n  }\n\n  /**\n   * è®¡ç®—å‘é‡èŒƒæ•°\n   */\n  norm(vector: EmbeddingVector): number {\n    return Math.sqrt(vector.reduce((sum, v) => sum + v * v, 0))\n  }\n\n  /**\n   * æ‰¹é‡è®¡ç®—ç›¸ä¼¼åº¦\n   */\n  batchSimilarity(\n    queryVector: EmbeddingVector,\n    targetVectors: Array<{ photoUuid: string; vector: EmbeddingVector }>\n  ): SimilarityResult[] {\n    return targetVectors.map(item => ({\n      id: item.photoUuid,\n      similarity: this.cosineSimilarity(queryVector, item.vector)\n    }))\n  }\n\n  /**\n   * æ’åºå¹¶è¿”å› top-k ç»“æœ\n   */\n  topK(\n    similarities: SimilarityResult[],\n    k: number,\n    minSimilarity: number = 0\n  ): SimilarityResult[] {\n    return similarities\n      .filter(s => s.similarity >= minSimilarity)\n      .sort((a, b) => b.similarity - a.similarity)\n      .slice(0, k)\n  }\n\n  /**\n   * è¯­ä¹‰æœç´¢ï¼ˆå‘é‡ + æ•°æ®åº“ï¼‰\n   */\n  async semanticSearch(\n    queryVector: EmbeddingVector,\n    getAllEmbeddings: () => Promise<Array<{ photoUuid: string; vector: EmbeddingVector }>>,\n    options: { topK?: number; minSimilarity?: number } = {}\n  ): Promise<SearchResult[]> {\n    const { topK = 50, minSimilarity = 0.1 } = options\n\n    // è·å–æ‰€æœ‰åµŒå…¥\n    const embeddings = await getAllEmbeddings()\n\n    // è®¡ç®—ç›¸ä¼¼åº¦\n    const similarities = this.batchSimilarity(queryVector, embeddings)\n\n    // æ’åºè¿”å› top-k\n    const topResults = this.topK(similarities, topK, minSimilarity)\n\n    // æ·»åŠ æ’å\n    return topResults.map((item, index) => ({\n      photoUuid: item.id,\n      similarity: item.similarity,\n      rank: index + 1\n    }))\n  }\n\n  /**\n   * å¤šæŸ¥è¯¢èåˆæœç´¢\n   */\n  async multiQuerySearch(\n    queryVectors: EmbeddingVector[],\n    getAllEmbeddings: () => Promise<Array<{ photoUuid: string; vector: EmbeddingVector }>>,\n    options: { topK?: number; minSimilarity?: number; weights?: number[] } = {}\n  ): Promise<SearchResult[]> {\n    const { topK = 50, minSimilarity = 0.1, weights } = options\n\n    // è·å–æ‰€æœ‰åµŒå…¥\n    const embeddings = await getAllEmbeddings()\n\n    // é»˜è®¤æƒé‡\n    const vectorWeights = weights || queryVectors.map(() => 1 / queryVectors.length)\n\n    // æ”¶é›†æ‰€æœ‰ç›¸ä¼¼åº¦åˆ†æ•°\n    const scoreMap = new Map<string, { totalScore: number; count: number }>()\n\n    for (let i = 0; i < queryVectors.length; i++) {\n      const similarities = this.batchSimilarity(queryVectors[i], embeddings)\n\n      for (const sim of similarities) {\n        const existing = scoreMap.get(sim.id) || { totalScore: 0, count: 0 }\n        existing.totalScore += sim.similarity * vectorWeights[i]\n        existing.count += 1\n        scoreMap.set(sim.id, existing)\n      }\n    }\n\n    // è®¡ç®—å¹³å‡åˆ†æ•°\n    const results: SimilarityResult[] = []\n    for (const [id, data] of scoreMap.entries()) {\n      results.push({\n        id,\n        similarity: data.totalScore / data.count\n      })\n    }\n\n    // æ’åºè¿”å› top-k\n    const topResults = this.topK(results, topK, minSimilarity)\n\n    return topResults.map((item, index) => ({\n      photoUuid: item.id,\n      similarity: item.similarity,\n      rank: index + 1\n    }))\n  }\n\n  /**\n   * ç›¸ä¼¼åº¦åˆ†æ•°è½¬æ¢ï¼ˆ0-1 åˆ°ç™¾åˆ†æ¯”ï¼‰\n   */\n  similarityToPercent(similarity: number): number {\n    return Math.round(similarity * 100)\n  }\n\n  /**\n   * åˆ¤æ–­ç›¸ä¼¼åº¦ç­‰çº§\n   */\n  getSimilarityLevel(similarity: number): 'high' | 'medium' | 'low' {\n    if (similarity >= 0.7) return 'high'\n    if (similarity >= 0.4) return 'medium'\n    return 'low'\n  }\n}\n\nexport const similarityService = new SimilarityService()\n","/**\n * PhotoMind - æ–‡æœ¬é¢„å¤„ç†æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. æ–‡æœ¬æ¸…æ´—\n * 2. å…³é”®è¯æå–\n * 3. è¯­è¨€æ£€æµ‹\n */\nexport interface TextQuery {\n  original: string\n  processed: string\n  keywords: string[]\n  language: 'zh' | 'en' | 'mixed'\n}\n\nexport class TextPreprocessor {\n  /**\n   * é¢„å¤„ç†æœç´¢æ–‡æœ¬\n   */\n  preprocess(text: string): TextQuery {\n    return {\n      original: text,\n      processed: this.cleanText(text),\n      keywords: this.extractKeywords(text),\n      language: this.detectLanguage(text)\n    }\n  }\n\n  /**\n   * æ¸…æ´—æ–‡æœ¬\n   */\n  private cleanText(text: string): string {\n    // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™ä¸­è‹±æ–‡ã€æ•°å­—ã€ç©ºæ ¼ã€è¿å­—ç¬¦\n    return text\n      .replace(/[^\\w\\s\\u4e00-\\u9fff\\-]/g, ' ')\n      .replace(/\\s+/g, ' ')\n      .trim()\n  }\n\n  /**\n   * æå–å…³é”®è¯\n   */\n  private extractKeywords(text: string): string[] {\n    // ç®€å•å…³é”®è¯æå– - æŒ‰ç©ºæ ¼å’Œé€—å·åˆ†è¯\n    return text\n      .split(/[\\s,]+/)\n      .map(w => w.trim())\n      .filter(w => w.length > 0)\n  }\n\n  /**\n   * æ£€æµ‹è¯­è¨€\n   */\n  private detectLanguage(text: string): 'zh' | 'en' | 'mixed' {\n    const chineseCount = (text.match(/[\\u4e00-\\u9fff]/g) || []).length\n    const englishCount = (text.match(/[a-zA-Z]/g) || []).length\n    const total = chineseCount + englishCount\n\n    if (total === 0) return 'en'\n\n    const chineseRatio = chineseCount / total\n    const englishRatio = englishCount / total\n\n    if (chineseRatio > 0.3 && englishRatio > 0.3) return 'mixed'\n    if (chineseRatio > 0.5) return 'zh'\n    return 'en'\n  }\n\n  /**\n   * æ‰©å±•æœç´¢è¯ï¼ˆåŒä¹‰è¯ç­‰ï¼‰\n   */\n  expandQuery(text: string): string[] {\n    const queries: string[] = [text]\n\n    // å¸¸è§ä¸­æ–‡æ‰©å±•\n    const expansions: Record<string, string[]> = {\n      'ç…§ç‰‡': ['photo', 'å›¾ç‰‡', 'image'],\n      'å®¶åº­': ['family', 'å®¶äºº', 'home'],\n      'æœ‹å‹': ['friends', 'friend', 'å‹æƒ…'],\n      'æ—…è¡Œ': ['travel', 'trip', 'journey', 'æ—…æ¸¸'],\n      'æ—¥è½': ['sunset', 'å¤•é™½'],\n      'æ—¥å‡º': ['sunrise', 'æ—¥å‡º', 'æ™¨æ›¦'],\n      'é£æ™¯': ['scenery', 'landscape', 'æ™¯è‰²', 'å±±æ°´'],\n      'ç¾é£Ÿ': ['food', 'delicious', 'å¥½åƒ', 'é¤é¥®']\n    }\n\n    // æ£€æŸ¥æ˜¯å¦æœ‰å¯æ‰©å±•çš„è¯\n    for (const [key, values] of Object.entries(expansions)) {\n      if (text.toLowerCase().includes(key.toLowerCase())) {\n        for (const value of values) {\n          queries.push(`${key} ${value}`)\n        }\n      }\n    }\n\n    return queries\n  }\n}\n\nexport const textPreprocessor = new TextPreprocessor()\n","/**\n * PhotoMind - è¯­ä¹‰æœç´¢æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. é¢„å¤„ç†æœç´¢æ–‡æœ¬\n * 2. æ–‡æœ¬è½¬å‘é‡\n * 3. ç›¸ä¼¼åº¦æœç´¢\n * 4. ç»“æœåˆ†é¡µå’Œæ ¼å¼åŒ–\n */\nimport { getEmbeddingService } from './embeddingService.js'\nimport { PhotoDatabase } from '../database/db.js'\nimport { similarityService } from './similarityService.js'\nimport { textPreprocessor } from './textPreprocessor.js'\n\n// ç±»å‹å®šä¹‰\ntype EmbeddingVector = number[]\n\ninterface PhotoDetail {\n  uuid: string\n  fileName: string\n  filePath: string\n  fileSize: number\n  width?: number\n  height?: number\n  takenAt?: string\n  exif?: Record<string, any>\n  location?: Record<string, any>\n  thumbnailPath?: string\n}\n\ninterface SearchResult {\n  photoUuid: string\n  similarity: number\n  rank: number\n  photo?: PhotoDetail\n}\n\ninterface SemanticSearchOptions {\n  query: string\n  topK?: number\n  minSimilarity?: number\n  page?: number\n  pageSize?: number\n}\n\ninterface SemanticSearchResult {\n  results: SearchResult[]\n  total: number\n  page: number\n  pageSize: number\n  processingTimeMs: number\n  query: {\n    original: string\n    processed: string\n    language: string\n  }\n}\n\ninterface PhotoDetail {\n  uuid: string\n  fileName: string\n  filePath: string\n  fileSize: number\n  width?: number\n  height?: number\n  takenAt?: string\n  exif?: Record<string, any>\n  location?: Record<string, any>\n  thumbnailPath?: string\n}\n\nexport class SemanticSearchService {\n  private database: PhotoDatabase\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || new PhotoDatabase()\n  }\n\n  /**\n   * æ‰§è¡Œè¯­ä¹‰æœç´¢\n   */\n  async search(options: SemanticSearchOptions): Promise<SemanticSearchResult> {\n    const startTime = Date.now()\n    const { query, topK = 50, minSimilarity = 0.1, page = 1, pageSize = 20 } = options\n\n    // 1. é¢„å¤„ç†æ–‡æœ¬\n    const processed = textPreprocessor.preprocess(query)\n\n    // 2. æ–‡æœ¬è½¬å‘é‡\n    const embeddingService = getEmbeddingService()\n    const textResult = await embeddingService.textToEmbedding(processed.processed)\n\n    if (!textResult.success || !textResult.vector) {\n      console.log('[SemanticSearch] æ–‡æœ¬è½¬å‘é‡å¤±è´¥')\n      return {\n        results: [],\n        total: 0,\n        page,\n        pageSize,\n        processingTimeMs: Date.now() - startTime,\n        query: {\n          original: query,\n          processed: processed.processed,\n          language: processed.language\n        }\n      }\n    }\n\n    console.log(`[SemanticSearch] å‘é‡ç”ŸæˆæˆåŠŸï¼Œç»´åº¦: ${textResult.vector.length}`)\n\n    // 3. è·å–æ‰€æœ‰ç…§ç‰‡å‘é‡\n    const allEmbeddings = await this.database.getAllEmbeddings('image')\n    console.log(`[SemanticSearch] è·å–åˆ° ${allEmbeddings.length} ä¸ªå‘é‡`)\n\n    if (allEmbeddings.length === 0) {\n      return {\n        results: [],\n        total: 0,\n        page,\n        pageSize,\n        processingTimeMs: Date.now() - startTime,\n        query: {\n          original: query,\n          processed: processed.processed,\n          language: processed.language\n        }\n      }\n    }\n\n    // 4. è®¡ç®—ç›¸ä¼¼åº¦\n    const similarities = similarityService.batchSimilarity(textResult.vector, allEmbeddings)\n    console.log(`[SemanticSearch] ç›¸ä¼¼åº¦è®¡ç®—å®Œæˆ`)\n\n    // 5. æ’åºå¹¶è¿‡æ»¤\n    const sorted = similarityService.topK(similarities, topK, minSimilarity)\n    console.log(`[SemanticSearch] æ’åºå®Œæˆï¼Œå‰ ${sorted.length} ä¸ªç»“æœ`)\n\n    // 6. è·å–ç…§ç‰‡è¯¦æƒ…\n    const results: SearchResult[] = []\n\n    for (let i = 0; i < sorted.length; i++) {\n      const item = sorted[i]\n      const photo = this.database.getPhotoByUuid(item.id)\n\n      if (photo) {\n        results.push({\n          photoUuid: item.id,\n          similarity: item.similarity,\n          rank: i + 1,\n          photo: this.formatPhoto(photo)\n        })\n      }\n    }\n\n    // 7. åˆ†é¡µ\n    const startIndex = (page - 1) * pageSize\n    const pagedResults = results.slice(startIndex, startIndex + pageSize)\n\n    const processingTime = Date.now() - startTime\n    console.log(`[SemanticSearch] æœç´¢å®Œæˆï¼Œè€—æ—¶ ${processingTime}ms`)\n\n    return {\n      results: pagedResults,\n      total: results.length,\n      page,\n      pageSize,\n      processingTimeMs: processingTime,\n      query: {\n        original: query,\n        processed: processed.processed,\n        language: processed.language\n      }\n    }\n  }\n\n  /**\n   * æ‰¹é‡æœç´¢ï¼ˆå¤šä¸ªæŸ¥è¯¢ï¼‰\n   */\n  async multiQuerySearch(\n    queries: string[],\n    options: { topK?: number; minSimilarity?: number; weights?: number[] } = {}\n  ): Promise<SemanticSearchResult> {\n    const { topK = 50, minSimilarity = 0.1, weights } = options\n\n    // 1. é¢„å¤„ç†æ‰€æœ‰æŸ¥è¯¢\n    const processedQueries = queries.map(q => ({\n      original: q,\n      processed: textPreprocessor.preprocess(q).processed\n    }))\n\n    // 2. è½¬å‘é‡\n    const embeddingService = getEmbeddingService()\n    const vectors: EmbeddingVector[] = []\n\n    for (const q of processedQueries) {\n      const result = await embeddingService.textToEmbedding(q.processed)\n      if (result.success && result.vector) {\n        vectors.push(result.vector)\n      }\n    }\n\n    if (vectors.length === 0) {\n      return {\n        results: [],\n        total: 0,\n        page: 1,\n        pageSize: 20,\n        processingTimeMs: 0,\n        query: {\n          original: queries.join(' '),\n          processed: processedQueries.map(q => q.processed).join(' '),\n          language: 'mixed'\n        }\n      }\n    }\n\n    // 3. è·å–æ‰€æœ‰åµŒå…¥\n    const allEmbeddings = await this.database.getAllEmbeddings('image')\n\n    // 4. å¤šæŸ¥è¯¢èåˆ\n    const defaultWeights = weights || vectors.map(() => 1 / vectors.length)\n    const scoreMap = new Map<string, { totalScore: number; count: number }>()\n\n    for (let i = 0; i < vectors.length; i++) {\n      const similarities = similarityService.batchSimilarity(vectors[i], allEmbeddings)\n      for (const sim of similarities) {\n        const existing = scoreMap.get(sim.id) || { totalScore: 0, count: 0 }\n        existing.totalScore += sim.similarity * defaultWeights[i]\n        existing.count += 1\n        scoreMap.set(sim.id, existing)\n      }\n    }\n\n    // 5. è®¡ç®—å¹³å‡åˆ†æ•°\n    const results: SearchResult[] = []\n    for (const [id, data] of scoreMap.entries()) {\n      const avgScore = data.totalScore / data.count\n      if (avgScore >= minSimilarity) {\n        const photo = this.database.getPhotoByUuid(id)\n        if (photo) {\n          results.push({\n            photoUuid: id,\n            similarity: avgScore,\n            rank: 0,\n            photo: this.formatPhoto(photo)\n          })\n        }\n      }\n    }\n\n    // 6. æ’åº\n    results.sort((a, b) => b.similarity - a.similarity)\n    results.forEach((r, i) => r.rank = i + 1)\n\n    return {\n      results: results.slice(0, topK),\n      total: results.length,\n      page: 1,\n      pageSize: topK,\n      processingTimeMs: 0,\n      query: {\n        original: queries.join(' '),\n        processed: processedQueries.map(q => q.processed).join(' '),\n        language: 'mixed'\n      }\n    }\n  }\n\n  /**\n   * æ ¼å¼åŒ–ç…§ç‰‡æ•°æ®\n   */\n  private formatPhoto(photo: any): PhotoDetail {\n    return {\n      uuid: photo.uuid,\n      fileName: photo.file_name,\n      filePath: photo.file_path,\n      fileSize: photo.file_size,\n      width: photo.width,\n      height: photo.height,\n      takenAt: photo.taken_at,\n      exif: photo.exif_data && typeof photo.exif_data === 'string'\n        ? JSON.parse(photo.exif_data)\n        : (photo.exif_data || {}),\n      location: photo.location_data && typeof photo.location_data === 'string'\n        ? JSON.parse(photo.location_data)\n        : (photo.location_data || {}),\n      thumbnailPath: photo.thumbnail_path\n    }\n  }\n\n  /**\n   * å¿«é€Ÿæœç´¢ï¼ˆä¸è¿”å›ç…§ç‰‡è¯¦æƒ…ï¼‰\n   */\n  async quickSearch(\n    query: string,\n    topK: number = 10\n  ): Promise<Array<{ photoUuid: string; similarity: number }>> {\n    const processed = textPreprocessor.preprocess(query)\n\n    const embeddingService = getEmbeddingService()\n    const textResult = await embeddingService.textToEmbedding(processed.processed)\n\n    if (!textResult.success || !textResult.vector) {\n      return []\n    }\n\n    const allEmbeddings = await this.database.getAllEmbeddings('image')\n    const similarities = similarityService.batchSimilarity(textResult.vector, allEmbeddings)\n\n    return similarityService.topK(similarities, topK, 0)\n      .map((item, index) => ({\n        photoUuid: item.id,\n        similarity: item.similarity\n      }))\n  }\n}\n\nexport const semanticSearchService = new SemanticSearchService()\n","/**\n * PhotoMind - æœç´¢å»ºè®®æœåŠ¡\n *\n * åŠŸèƒ½ï¼š\n * 1. æœç´¢å†å²è®°å½•\n * 2. çƒ­é—¨æœç´¢è¯\n * 3. æœç´¢è‡ªåŠ¨è¡¥å…¨\n * 4. åŸºäºç…§ç‰‡å†…å®¹çš„å»ºè®®\n */\nimport { resolve, dirname } from 'path'\nimport { fileURLToPath } from 'url'\nimport { existsSync, readFileSync, writeFileSync, mkdirSync } from 'fs'\n\nconst __dirname = fileURLToPath(new URL('.', import.meta.url))\n\nexport interface SearchSuggestion {\n  text: string\n  type: 'history' | 'popular' | 'tag' | 'place' | 'person' | 'time'\n  count?: number\n  timestamp?: number\n}\n\nexport interface SearchHistoryItem {\n  query: string\n  timestamp: number\n  resultCount: number\n}\n\nexport class SearchSuggestionService {\n  private dataDir: string\n  private historyFile: string\n  private history: SearchHistoryItem[]\n  private maxHistoryLength: number\n\n  constructor() {\n    this.dataDir = resolve(__dirname, '../../data')\n    this.historyFile = resolve(this.dataDir, 'search-history.json')\n    this.history = []\n    this.maxHistoryLength = 50\n    this.loadHistory()\n  }\n\n  /**\n   * åŠ è½½æœç´¢å†å²\n   */\n  private loadHistory(): void {\n    try {\n      if (existsSync(this.historyFile)) {\n        const content = readFileSync(this.historyFile, 'utf-8')\n        this.history = JSON.parse(content)\n      }\n    } catch (error) {\n      console.error('åŠ è½½æœç´¢å†å²å¤±è´¥:', error)\n      this.history = []\n    }\n  }\n\n  /**\n   * ä¿å­˜æœç´¢å†å²\n   */\n  private saveHistory(): void {\n    try {\n      const dir = dirname(this.historyFile)\n      if (!existsSync(dir)) {\n        mkdirSync(dir, { recursive: true })\n      }\n      writeFileSync(this.historyFile, JSON.stringify(this.history, null, 2))\n    } catch (error) {\n      console.error('ä¿å­˜æœç´¢å†å²å¤±è´¥:', error)\n    }\n  }\n\n  /**\n   * æ·»åŠ æœç´¢è®°å½•\n   */\n  addToHistory(query: string, resultCount: number = 0): void {\n    // ç§»é™¤é‡å¤é¡¹\n    this.history = this.history.filter(item => item.query.toLowerCase() !== query.toLowerCase())\n\n    // æ·»åŠ åˆ°å¼€å¤´\n    this.history.unshift({\n      query,\n      timestamp: Date.now(),\n      resultCount\n    })\n\n    // é™åˆ¶é•¿åº¦\n    if (this.history.length > this.maxHistoryLength) {\n      this.history = this.history.slice(0, this.maxHistoryLength)\n    }\n\n    this.saveHistory()\n  }\n\n  /**\n   * è·å–æœç´¢å†å²\n   */\n  getHistory(limit: number = 10): SearchHistoryItem[] {\n    return this.history.slice(0, limit)\n  }\n\n  /**\n   * æ¸…ç©ºæœç´¢å†å²\n   */\n  clearHistory(): void {\n    this.history = []\n    this.saveHistory()\n  }\n\n  /**\n   * è·å–æœç´¢å»ºè®®\n   */\n  async getSuggestions(query: string): Promise<SearchSuggestion[]> {\n    if (!query.trim()) {\n      // ç©ºæŸ¥è¯¢è¿”å›å†å²è®°å½•\n      return this.getHistory(5).map(item => ({\n        text: item.query,\n        type: 'history' as const,\n        timestamp: item.timestamp\n      }))\n    }\n\n    const suggestions: SearchSuggestion[] = []\n    const lowerQuery = query.toLowerCase()\n\n    // 1. ä»å†å²ä¸­åŒ¹é…\n    const historyMatches = this.history\n      .filter(item => item.query.toLowerCase().includes(lowerQuery))\n      .slice(0, 3)\n      .map(item => ({\n        text: item.query,\n        type: 'history' as const,\n        timestamp: item.timestamp\n      }))\n    suggestions.push(...historyMatches)\n\n    // 2. TODO: ä»åœ°ç‚¹ä¸­åŒ¹é…ï¼ˆéœ€è¦ä»æ•°æ®åº“è·å–ï¼‰\n    // å»ºè®®åŒ…å«å¸¸è§åœ°ç‚¹\n    const commonPlaces = ['æ—¥æœ¬', 'ä¸œäº¬', 'åŒ—äº¬', 'ä¸Šæµ·', 'æ–°ç–†', 'å®¶é‡Œ']\n    for (const place of commonPlaces) {\n      if (place.toLowerCase().includes(lowerQuery)) {\n        suggestions.push({\n          text: place,\n          type: 'place',\n          count: 0\n        })\n      }\n    }\n\n    // 3. æ—¶é—´ç›¸å…³å»ºè®®\n    const timePatterns = [\n      `${new Date().getFullYear()}å¹´`,\n      'å»å¹´',\n      'å‰å¹´',\n      'ä»Šå¹´å¤å¤©',\n      'å»å¹´å†¬å¤©'\n    ]\n    for (const pattern of timePatterns) {\n      if (pattern.toLowerCase().includes(lowerQuery)) {\n        suggestions.push({\n          text: pattern,\n          type: 'time'\n        })\n      }\n    }\n\n    // 4. äººç‰©ç›¸å…³å»ºè®®\n    const peoplePatterns = ['çˆ¸çˆ¸', 'å¦ˆå¦ˆ', 'å„¿å­', 'å¥³å„¿', 'å…¨å®¶ç¦']\n    for (const person of peoplePatterns) {\n      if (person.toLowerCase().includes(lowerQuery)) {\n        suggestions.push({\n          text: person,\n          type: 'person',\n          count: 0\n        })\n      }\n    }\n\n    // 5. åœºæ™¯æ ‡ç­¾å»ºè®®\n    const tagPatterns = ['æ—…è¡Œ', 'ç¾é£Ÿ', 'é£æ™¯', 'äººåƒ', 'å® ç‰©', 'æ—¥è½']\n    for (const tag of tagPatterns) {\n      if (tag.toLowerCase().includes(lowerQuery)) {\n        suggestions.push({\n          text: tag,\n          type: 'tag',\n          count: 0\n        })\n      }\n    }\n\n    return suggestions.slice(0, 8)\n  }\n\n  /**\n   * è·å–çƒ­é—¨æœç´¢\n   */\n  getPopularSearches(limit: number = 5): SearchSuggestion[] {\n    // åŸºäºå†å²é¢‘ç‡è®¡ç®—çƒ­é—¨æœç´¢\n    const frequency: Record<string, number> = {}\n\n    for (const item of this.history) {\n      frequency[item.query] = (frequency[item.query] || 0) + 1\n    }\n\n    return Object.entries(frequency)\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, limit)\n      .map(([text, count]) => ({\n        text,\n        type: 'popular' as const,\n        count\n      }))\n  }\n\n  /**\n   * è·å–æœç´¢å»ºè®®ï¼ˆç”¨äºè‡ªåŠ¨è¡¥å…¨ï¼‰\n   */\n  async getAutocomplete(query: string): Promise<string[]> {\n    if (!query.trim()) {\n      return []\n    }\n\n    const suggestions = await this.getSuggestions(query)\n    return suggestions.map(s => s.text)\n  }\n\n  /**\n   * è·å–æ‰€æœ‰å”¯ä¸€çš„æœç´¢è¯\n   */\n  getAllSearchTerms(): string[] {\n    const terms = new Set<string>()\n\n    // ä»å†å²ä¸­æ·»åŠ \n    for (const item of this.history) {\n      terms.add(item.query)\n    }\n\n    // æ·»åŠ å¸¸è§æœç´¢è¯\n    const commonTerms = [\n      'æ—¥æœ¬', 'ä¸œäº¬', 'åŒ—æµ·é“', 'å¤§é˜ª',\n      'åŒ—äº¬', 'ä¸Šæµ·', 'æ–°ç–†',\n      '2015', '2016', '2017', '2018', '2019', '2020',\n      'æ—…è¡Œ', 'ç¾é£Ÿ', 'é£æ™¯', 'äººåƒ',\n      'çˆ¸çˆ¸', 'å¦ˆå¦ˆ', 'å„¿å­', 'å…¨å®¶ç¦'\n    ]\n\n    for (const term of commonTerms) {\n      terms.add(term)\n    }\n\n    return Array.from(terms).sort()\n  }\n\n  /**\n   * å¯¼å‡ºæœç´¢å†å²\n   */\n  exportHistory(): string {\n    return JSON.stringify(this.history, null, 2)\n  }\n\n  /**\n   * å¯¼å…¥æœç´¢å†å²\n   */\n  importHistory(jsonData: string): boolean {\n    try {\n      const imported = JSON.parse(jsonData)\n      if (Array.isArray(imported)) {\n        this.history = imported.slice(0, this.maxHistoryLength)\n        this.saveHistory()\n        return true\n      }\n      return false\n    } catch (error) {\n      console.error('å¯¼å…¥æœç´¢å†å²å¤±è´¥:', error)\n      return false\n    }\n  }\n}\n\nexport const suggestionService = new SearchSuggestionService()\n","/**\n * PhotoMind - Electron ä¸»è¿›ç¨‹å…¥å£\n */\nimport { app, BrowserWindow, ipcMain, dialog, shell, protocol, net } from 'electron'\nimport { resolve, dirname, basename } from 'path'\nimport { fileURLToPath } from 'url'\nimport { ICloudService } from '../services/iCloudService.js'\nimport { PhotoDatabase } from '../database/db.js'\nimport { SearchService } from '../services/searchService.js'\nimport { LocalPhotoService } from '../services/localPhotoService.js'\nimport { folderScanner } from '../services/folderScanner.js'\nimport { importService, initializeImportService, ImportOptions, ImportResult } from '../services/importService.js'\nimport { importProgressService, ImportProgress } from '../services/importProgressService.js'\nimport { getEmbeddingService, HybridEmbeddingService } from '../services/hybridEmbeddingService.js'\nimport { VectorGenerationService } from '../services/vectorGenerationService.js'\nimport { SemanticSearchService } from '../services/semanticSearchService.js'\nimport { SearchResultFormatter } from '../services/searchResultFormatter.js'\nimport { ConfigService, getConfigService } from '../services/configService.js'\nimport { thumbnailService } from '../services/thumbnailService.js'\nimport { suggestionService } from '../services/searchSuggestionService.js'\nimport { initializeScanJobService, scanJobService, ScanJob } from '../services/scanJobService.js'\n\n// å®‰å…¨è·å– __dirname - å…¼å®¹ Electron Forge æ„å»ºç¯å¢ƒ\nconst __dirname = (() => {\n  try {\n    // Electron Forge Vite æ’ä»¶ä¼šè®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡\n    // æ£€æŸ¥æ˜¯å¦åœ¨å¼€å‘æ¨¡å¼\n    if (process.env.VITE_DEV_SERVER_URL) {\n      // å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨ import.meta.url\n      return fileURLToPath(new URL('.', import.meta.url))\n    }\n  } catch {\n    // å¿½ç•¥é”™è¯¯\n  }\n  // ç”Ÿäº§æ¨¡å¼æˆ–æ„å»ºåï¼šä½¿ç”¨ process.cwd() æˆ– app.getAppPath()\n  return process.cwd()\n})()\n\n// ==================== Electron-Forge æ³¨å…¥çš„å¸¸é‡ ====================\n// Forge åœ¨æ„å»ºæ—¶ä¼šè‡ªåŠ¨æ³¨å…¥è¿™äº›å¸¸é‡\ndeclare const MAIN_WINDOW_VITE_DEV_SERVER_URL: string | undefined\ndeclare const MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY: string | undefined\n\n// ğŸ†• å…¨å±€å­˜å‚¨æ´»è·ƒæ‰«æä»»åŠ¡ï¼ˆç”¨äºå‰ç«¯æ¢å¤ï¼‰\ndeclare global {\n  var activeScanJob: ScanJob | null\n}\nglobal.activeScanJob = null\n\n// è·å–ä¸»çª—å£å¼•ç”¨ï¼ˆç”¨äºå‘é€è¿›åº¦æ¶ˆæ¯ï¼‰\nlet mainWindow: BrowserWindow | null = null\n\n// ==================== è‡ªå®šä¹‰åè®®æ³¨å†Œ ====================\nlet database: PhotoDatabase | null = null\nlet iCloudService: ICloudService | null = null\nlet searchService: SearchService | null = null\nlet localPhotoService: LocalPhotoService | null = null\nlet configService: ConfigService | null = null\nimport type { ThumbnailService } from '../services/thumbnailService'\nimport type { SearchSuggestionService } from '../services/searchSuggestionService'\nlet thumbnailSvc: ThumbnailService | null = null\nlet suggestionSvc: SearchSuggestionService | null = null\n\n// å¼€å‘æ¨¡å¼ï¼šé€šè¿‡ app.isPackaged åˆ¤æ–­ï¼ˆElectron æ ‡å‡†æ–¹å¼ï¼‰\n// æ‰“åŒ…åä¸º falseï¼Œå¼€å‘æ—¶ä¸º true\nconst isDev = !app.isPackaged\n\n// ==================== è‡ªå®šä¹‰åè®®æ³¨å†Œ ====================\n\n/**\n * æ³¨å†Œæœ¬åœ°èµ„æºè‡ªå®šä¹‰åè®®\n * å°† local-resource:// åè®®æ˜ å°„åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„\n * è¿™æ ·å¯ä»¥ç»•è¿‡æµè§ˆå™¨çš„ file:// åè®®å®‰å…¨é™åˆ¶\n */\nfunction registerLocalResourceProtocol() {\n  // ğŸ†• ä½¿ç”¨ handle API æ›¿ä»£ registerFileProtocolï¼ˆElectron 25+ æ¨èï¼‰\n  protocol.handle('local-resource', async (request) => {\n    try {\n      // ç§»é™¤åè®®å‰ç¼€\n      const url = request.url.replace(/^local-resource:\\/\\//, '')\n\n      // è§£ç  URL ç¼–ç çš„è·¯å¾„ï¼ˆå¤„ç†ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦ï¼‰\n      const decodedUrl = decodeURIComponent(url)\n\n      console.log(`[local-resource] è¯·æ±‚: ${decodedUrl}`)\n\n      // ğŸ†• æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n      const fs = await import('fs')\n      if (!fs.existsSync(decodedUrl)) {\n        console.error(`[local-resource] æ–‡ä»¶ä¸å­˜åœ¨: ${decodedUrl}`)\n        return new Response('File not found', { status: 404 })\n      }\n\n      console.log(`[local-resource] æ–‡ä»¶å­˜åœ¨ï¼Œè¿”å›: ${decodedUrl.substring(0, 60)}...`)\n\n      // ä½¿ç”¨ net.fetch è¿”å›æ–‡ä»¶å†…å®¹\n      return await net.fetch('file://' + decodedUrl)\n    } catch (error) {\n      console.error('[local-resource] å¤„ç†å¤±è´¥:', error)\n      return new Response('Not found', { status: 404 })\n    }\n  })\n\n  console.log('âœ“ è‡ªå®šä¹‰åè®® local-resource:// å·²æ³¨å†Œ (handle API)')\n}\n\n// è·¯å¾„è¾…åŠ©å‡½æ•° - é€‚é… Electron-Forge\nfunction getRendererPath(): string {\n  // å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨ Forge æä¾›çš„ Dev Server URL\n  if (isDev) {\n    if (typeof MAIN_WINDOW_VITE_DEV_SERVER_URL !== 'undefined') {\n      console.log('[Main] å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨ Forge URL:', MAIN_WINDOW_VITE_DEV_SERVER_URL)\n      return MAIN_WINDOW_VITE_DEV_SERVER_URL\n    }\n    // ä»ç¯å¢ƒå˜é‡è·å–ç«¯å£ï¼Œé»˜è®¤ 5173\n    const port = process.env.VITE_DEV_SERVER_PORT || '5173'\n    console.log('[Main] å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨ localhost:', port)\n    return `http://localhost:${port}`\n  }\n  // ç”Ÿäº§æ¨¡å¼ï¼šä»æ„å»ºç›®å½•åŠ è½½\n  // Electron Forge Vite æ„å»ºåï¼Œrenderer åœ¨ app.asar å†…\n  const prodPath = resolve(__dirname, '../../renderer/main_window/index.html')\n  console.log('[Main] ç”Ÿäº§æ¨¡å¼ï¼šåŠ è½½æœ¬åœ°æ–‡ä»¶:', prodPath)\n  return prodPath\n}\n\nfunction getPreloadPath(): string {\n  // Forge Vite æ’ä»¶ä¼šè‡ªåŠ¨å¤„ç† preload è·¯å¾„\n  if (typeof MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY !== 'undefined') {\n    return MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY\n  }\n  // å¼€å‘æ¨¡å¼å›é€€è·¯å¾„ - ä½¿ç”¨ .vite/build/preload ç›®å½•\n  return resolve(process.cwd(), '.vite/build/preload/index.js')\n}\n\nfunction createWindow() {\n  // CSP ç­–ç•¥é…ç½®\n  const cspPolicy = {\n    'default-src': [\"'self'\"],\n    'script-src': [\"'self'\", \"'unsafe-inline'\", \"'unsafe-eval'\"],\n    'style-src': [\"'self'\", \"'unsafe-inline'\", \"https://fonts.googleapis.com\"],\n    'img-src': [\"'self'\", \"data:\", \"blob:\", \"https:\", \"local-resource:\"],\n    'font-src': [\"'self'\", \"https://fonts.gstatic.com\"],\n    'connect-src': [\"'self'\", \"http://localhost:*\", \"https://huggingface.co\", \"https://cdn.jsdelivr.net\"]\n  }\n\n  mainWindow = new BrowserWindow({\n    width: 1200,\n    height: 800,\n    minWidth: 900,\n    minHeight: 600,\n    webPreferences: {\n      preload: getPreloadPath(),\n      nodeIntegration: false,\n      contextIsolation: true,\n      sandbox: false,\n      webSecurity: true,  // ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ä¸º true\n      allowRunningInsecureContent: false\n    },\n    titleBarStyle: 'hidden',\n    titleBarOverlay: {\n      color: '#ffffff',\n      symbolColor: '#5E6AD2',\n      height: 40\n    },\n    backgroundColor: '#f5f5f7',\n    show: false,\n    frame: false\n  })\n\n  // è®¾ç½® CSP å¤´\n  if (isDev) {\n    // å¼€å‘ç¯å¢ƒï¼šå®½æ¾çš„ CSP å…è®¸çƒ­é‡è½½\n    mainWindow.webContents.session.webRequest.onBeforeSendHeaders(\n      (details, callback) => {\n        callback({ requestHeaders: details.requestHeaders })\n      }\n    )\n  } else {\n    // ç”Ÿäº§ç¯å¢ƒï¼šä¸¥æ ¼ CSP\n    mainWindow.webContents.session.webRequest.onBeforeSendHeaders(\n      (details, callback) => {\n        const cspHeader = Object.entries(cspPolicy)\n          .map(([key, values]) => `${key} ${values.join(' ')}`)\n          .join('; ')\n        callback({\n          requestHeaders: {\n            ...details.requestHeaders,\n            'Content-Security-Policy': cspHeader\n          }\n        })\n      }\n    )\n  }\n\n  // å¼€å‘æ¨¡å¼åŠ è½½æœ¬åœ°æœåŠ¡å™¨ï¼Œç”Ÿäº§æ¨¡å¼åŠ è½½æ„å»ºæ–‡ä»¶\n  const rendererUrl = getRendererPath()\n  console.log('[Main] Loading renderer from:', rendererUrl)\n\n  mainWindow.loadURL(rendererUrl).catch(err => {\n    console.error('[Main] Failed to load URL:', err)\n  })\n\n  // å¼€å‘æ¨¡å¼æ‰“å¼€ DevTools\n  if (isDev) {\n    mainWindow.webContents.openDevTools({ mode: 'detach' })\n  }\n\n  mainWindow.once('ready-to-show', () => {\n    console.log('[Main] Window ready to show')\n    mainWindow?.show()\n    mainWindow?.focus()\n  })\n\n  // å¤„ç†åŠ è½½å¤±è´¥\n  mainWindow.webContents.on('did-fail-load', (event, errorCode, errorDescription) => {\n    console.error('[Main] Failed to load:', errorCode, errorDescription)\n  })\n\n  // å¼ºåˆ¶æ˜¾ç¤ºçª—å£ï¼ˆå¦‚æœ 3 ç§’åè¿˜æ²¡æœ‰æ˜¾ç¤ºï¼‰\n  setTimeout(() => {\n    if (mainWindow && !mainWindow.isVisible()) {\n      console.log('[Main] Force showing window after 3s')\n      mainWindow.show()\n      mainWindow.focus()\n    }\n  }, 3000)\n\n  // å¤„ç†å¤–éƒ¨é“¾æ¥\n  mainWindow.webContents.setWindowOpenHandler(({ url }) => {\n    shell.openExternal(url)\n    return { action: 'deny' }\n  })\n\n  mainWindow.on('closed', () => {\n    mainWindow = null\n  })\n}\n\n// åˆå§‹åŒ–æœåŠ¡\nasync function initServices() {\n  console.log('æ­£åœ¨åˆå§‹åŒ–æœåŠ¡...')\n\n  try {\n    // åˆå§‹åŒ–é…ç½®æœåŠ¡\n    configService = new ConfigService()\n    console.log('âœ“ é…ç½®æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n\n    // åˆå§‹åŒ–æ•°æ®åº“ - ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼ˆé¡¹ç›®ç›®å½•ä¸‹çš„ data/photo-mind.dbï¼‰\n    // æ³¨æ„ï¼šä¸è¦ä¿®æ”¹æ•°æ®åº“è·¯å¾„ï¼Œå¦åˆ™å·²å¯¼å…¥çš„ç…§ç‰‡æ•°æ®ä¼šä¸¢å¤±\n    database = new PhotoDatabase()\n    await database.init()\n    console.log('âœ“ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ')\n\n    // åˆå§‹åŒ–æœç´¢æœåŠ¡\n    searchService = new SearchService(database)\n    console.log('âœ“ æœç´¢æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n\n    // åˆå§‹åŒ–ç¼©ç•¥å›¾æœåŠ¡\n    thumbnailSvc = thumbnailService\n    await thumbnailSvc.init()\n    console.log('âœ“ ç¼©ç•¥å›¾æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n\n    // åˆå§‹åŒ–æœç´¢å»ºè®®æœåŠ¡\n    suggestionSvc = suggestionService\n    console.log('âœ“ æœç´¢å»ºè®®æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n\n    // åˆå§‹åŒ– iCloud æœåŠ¡\n    if (database) {\n      iCloudService = new ICloudService(database)\n      const initialized = await iCloudService.initialize('')\n      if (initialized) {\n        console.log('âœ“ iCloud æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n      } else {\n        console.log('âœ“ iCloud æœåŠ¡å·²å°±ç»ªï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰')\n      }\n\n      // åˆå§‹åŒ–æœ¬åœ°ç…§ç‰‡æœåŠ¡\n      localPhotoService = new LocalPhotoService(database, thumbnailSvc)\n      console.log('âœ“ æœ¬åœ°ç…§ç‰‡æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n\n      // åˆå§‹åŒ–å¯¼å…¥æœåŠ¡ï¼ˆä½¿ç”¨ç›¸åŒçš„æ•°æ®åº“å®ä¾‹ï¼‰\n      initializeImportService(database)\n      console.log('âœ“ å¯¼å…¥æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n\n      // ğŸ†• åˆå§‹åŒ–æ‰«æä»»åŠ¡æœåŠ¡\n      initializeScanJobService(database)\n      console.log('âœ“ æ‰«æä»»åŠ¡æœåŠ¡åˆå§‹åŒ–å®Œæˆ')\n    }\n\n    console.log('æ‰€æœ‰æœåŠ¡åˆå§‹åŒ–å®Œæˆï¼')\n  } catch (error) {\n    console.error('æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error)\n  }\n}\n\n// ğŸ†• æ£€æŸ¥å¹¶æ¢å¤æ‰«æä»»åŠ¡\nasync function checkAndRecoverScanJob() {\n  if (!scanJobService) {\n    console.log('[Main] ScanJobService not available, skipping recovery check')\n    return\n  }\n\n  const activeJob = scanJobService.getActiveJob()\n\n  if (!activeJob) {\n    console.log('[Main] No active scan job to recover')\n    global.activeScanJob = null\n    return\n  }\n\n  console.log('[Main] Found active scan job:', activeJob.id, 'status:', activeJob.status)\n\n  if (scanJobService.isJobStale(activeJob)) {\n    console.log('[Main] Scan job is stale (>5min no heartbeat), marking as failed')\n    scanJobService.markJobAsFailed(activeJob.id)\n    global.activeScanJob = null\n  } else {\n    console.log('[Main] Scan job is still active (<5min), can be resumed')\n    // å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼Œä¾›å‰ç«¯æŸ¥è¯¢\n    global.activeScanJob = activeJob\n  }\n}\n\n// IPC å¤„ç†ç¨‹åº\nfunction setupIPCHandlers() {\n  // ==================== iCloud ç›¸å…³ ====================\n\n  // é€‰æ‹© Photos Library\n  ipcMain.handle('icloud:select-library', async () => {\n    const result = await dialog.showOpenDialog({\n      properties: ['openDirectory'],\n      title: 'é€‰æ‹© iCloud Photos Library',\n      defaultPath: `/Users/${process.env.USER}/Pictures/Photos Library.photoslibrary`\n    })\n\n    if (!result.canceled && result.filePaths.length > 0) {\n      const libraryPath = result.filePaths[0]\n      // åˆå§‹åŒ– iCloud æœåŠ¡\n      if (iCloudService) {\n        await iCloudService.initialize(libraryPath)\n      }\n      return libraryPath\n    }\n    return null\n  })\n\n  // ==================== ç…§ç‰‡ç›¸å…³ ====================\n\n  // è·å–ç…§ç‰‡åˆ—è¡¨ - æ€»æ˜¯ä»æœ¬åœ°æ•°æ®åº“è·å–\n  ipcMain.handle('photos:get-list', async (event, options) => {\n    try {\n      const limit = options?.limit || 100\n      const offset = options?.offset || 0\n\n      console.log(`[IPC] photos:get-list - limit: ${limit}, offset: ${offset}`)\n      console.log(`[IPC] localPhotoService å¯ç”¨: ${!!localPhotoService}`)\n\n      // æ€»æ˜¯ä»æœ¬åœ°æ•°æ®åº“è·å–å·²å¯¼å…¥çš„ç…§ç‰‡\n      if (localPhotoService) {\n        try {\n          const localPhotos = localPhotoService.getLocalPhotos(limit, offset)\n          console.log(`[IPC] ä»æœ¬åœ°æ•°æ®åº“è·å– ${localPhotos.length} å¼ ç…§ç‰‡`)\n          console.log(`[IPC] å‰3å¼ ç…§ç‰‡:`, localPhotos.slice(0, 3))\n          return localPhotos\n        } catch (innerError) {\n          console.error('[IPC] getLocalPhotos å¤±è´¥:', innerError)\n          return []\n        }\n      }\n\n      // å¦‚æœæ²¡æœ‰æœ¬åœ°æœåŠ¡ï¼Œå°è¯• iCloud\n      if (iCloudService) {\n        return await iCloudService.getPhotos(limit, offset)\n      }\n\n      // å¦åˆ™è¿”å›ç©ºæ•°ç»„ï¼ˆä¸æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼‰\n      console.log('[IPC] æ²¡æœ‰æœ¬åœ°ç…§ç‰‡ï¼Œè¿”å›ç©ºæ•°ç»„')\n      return []\n    } catch (error) {\n      console.error('[IPC] è·å–ç…§ç‰‡åˆ—è¡¨å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // è·å–ç…§ç‰‡æ€»æ•°\n  ipcMain.handle('photos:get-count', async () => {\n    try {\n      if (localPhotoService) {\n        const count = localPhotoService.getPhotoCount()\n        console.log(`[IPC] ç…§ç‰‡æ€»æ•°: ${count}`)\n        return { total: count }\n      }\n      return { total: 0 }\n    } catch (error) {\n      console.error('[IPC] è·å–ç…§ç‰‡æ€»æ•°å¤±è´¥:', error)\n      return { total: 0 }\n    }\n  })\n\n  // è·å–æ²¡æœ‰å‘é‡çš„ç…§ç‰‡ï¼ˆç”¨äºæ‰¹é‡ç”Ÿæˆï¼‰\n  ipcMain.handle('photos:get-without-embeddings', async (event, limit: number = 100) => {\n    try {\n      if (localPhotoService) {\n        const photos = localPhotoService.getPhotosWithoutEmbeddings(limit)\n        return { success: true, photos }\n      }\n      return { success: false, photos: [], error: 'localPhotoService not available' }\n    } catch (error) {\n      console.error('[IPC] è·å–æ— å‘é‡ç…§ç‰‡å¤±è´¥:', error)\n      return { success: false, photos: [], error: String(error) }\n    }\n  })\n\n  // ä¿å­˜ç…§ç‰‡å‘é‡\n  ipcMain.handle('photos:save-embedding', async (event, photoUuid: string, vector: number[]) => {\n    try {\n      if (database) {\n        await database.saveEmbedding(photoUuid, vector, 'image')\n        return { success: true }\n      }\n      return { success: false, error: 'Database not available' }\n    } catch (error) {\n      console.error('[IPC] ä¿å­˜å‘é‡å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // è·å–ç…§ç‰‡è¯¦æƒ…\n  ipcMain.handle('photos:get-detail', async (event, photoId) => {\n    try {\n      if (!iCloudService) {\n        return generateMockPhotos(1, parseInt(photoId) || 0)[0]\n      }\n      return await iCloudService.getPhotoDetail(photoId)\n    } catch (error) {\n      console.error('è·å–ç…§ç‰‡è¯¦æƒ…å¤±è´¥:', error)\n      return null\n    }\n  })\n\n  // åˆ é™¤ç…§ç‰‡\n  ipcMain.handle('photos:delete', async (event, photoId: number) => {\n    try {\n      console.log(`[IPC] åˆ é™¤ç…§ç‰‡: ${photoId}`)\n\n      // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç…§ç‰‡æœåŠ¡åˆ é™¤\n      if (localPhotoService) {\n        const success = localPhotoService.deletePhoto(photoId)\n        if (success) {\n          console.log(`[IPC] ç…§ç‰‡ ${photoId} å·²ä»æœ¬åœ°æ•°æ®åº“åˆ é™¤`)\n          return { success: true }\n        }\n      }\n\n      // å¦‚æœæœ¬åœ°æœåŠ¡åˆ é™¤å¤±è´¥ï¼Œå°è¯• iCloud æœåŠ¡\n      if (iCloudService && 'deletePhoto' in iCloudService) {\n        const success = await (iCloudService as any).deletePhoto(photoId)\n        return { success }\n      }\n\n      // æ²¡æœ‰å¯ç”¨çš„æœåŠ¡æ—¶è¿”å›é”™è¯¯\n      console.warn('[IPC] æ²¡æœ‰å¯ç”¨çš„ç…§ç‰‡æœåŠ¡ï¼Œæ— æ³•åˆ é™¤ç…§ç‰‡')\n      return { success: false, error: 'æ²¡æœ‰å¯ç”¨çš„ç…§ç‰‡æœåŠ¡' }\n    } catch (error) {\n      console.error('[IPC] åˆ é™¤ç…§ç‰‡å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // å¯¼å‡ºç…§ç‰‡\n  ipcMain.handle('photos:export', async (event, params: { photoId: number; filePath: string; exportPath: string }) => {\n    try {\n      const { photoId, filePath, exportPath } = params\n      console.log(`[IPC] å¯¼å‡ºç…§ç‰‡: ${photoId} -> ${exportPath}`)\n\n      // ä½¿ç”¨ dialog è®©ç”¨æˆ·é€‰æ‹©å¯¼å‡ºè·¯å¾„\n      const result = await dialog.showSaveDialog({\n        title: 'é€‰æ‹©å¯¼å‡ºä½ç½®',\n        defaultPath: exportPath,\n        buttonLabel: 'ä¿å­˜'\n      })\n\n      if (result.canceled) {\n        return { success: false, error: 'ç”¨æˆ·å–æ¶ˆå¯¼å‡º' }\n      }\n\n      const targetPath = result.filePath\n      if (!targetPath) {\n        return { success: false, error: 'æœªé€‰æ‹©å¯¼å‡ºè·¯å¾„' }\n      }\n\n      // å¯¼å…¥ fs æ¨¡å—å¤åˆ¶æ–‡ä»¶\n      const fs = await import('fs')\n\n      // æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨\n      if (!fs.existsSync(filePath)) {\n        console.error(`[IPC] æºæ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`)\n        return { success: false, error: 'æºæ–‡ä»¶ä¸å­˜åœ¨' }\n      }\n\n      // å¤åˆ¶æ–‡ä»¶\n      fs.copyFileSync(filePath, targetPath)\n      console.log(`[IPC] ç…§ç‰‡å·²å¯¼å‡ºåˆ°: ${targetPath}`)\n\n      return { success: true, exportPath: targetPath }\n    } catch (error) {\n      console.error('[IPC] å¯¼å‡ºç…§ç‰‡å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ==================== æœç´¢ç›¸å…³ ====================\n\n  // æœç´¢ç…§ç‰‡\n  ipcMain.handle('photos:search', async (event, query, filters) => {\n    try {\n      if (!searchService) {\n        // æ¨¡æ‹Ÿæœç´¢ç»“æœ\n        return { results: generateMockPhotos(10, 0), total: 10 }\n      }\n      return await searchService.search(query, filters)\n    } catch (error) {\n      console.error('æœç´¢å¤±è´¥:', error)\n      return { results: [], total: 0 }\n    }\n  })\n\n  // è·å–æ™ºèƒ½ç›¸å†Œ\n  ipcMain.handle('albums:get-smart', async () => {\n    try {\n      if (!searchService) {\n        return generateMockAlbums()\n      }\n      return await searchService.getSmartAlbums()\n    } catch (error) {\n      console.error('è·å–æ™ºèƒ½ç›¸å†Œå¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // åˆ·æ–°æ™ºèƒ½ç›¸å†Œï¼ˆé€šçŸ¥å‰ç«¯é‡æ–°è·å–ï¼‰\n  ipcMain.handle('albums:refresh', async () => {\n    try {\n      // æ™ºèƒ½ç›¸å†Œæ˜¯åŠ¨æ€è®¡ç®—çš„ï¼Œä¸éœ€è¦é¢å¤–æ“ä½œ\n      // å‰ç«¯è°ƒç”¨ getSmartAlbums æ—¶ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—\n      console.log('[IPC] æ”¶åˆ°ç›¸å†Œåˆ·æ–°è¯·æ±‚')\n      return { success: true, message: 'Albums refreshed' }\n    } catch (error) {\n      console.error('åˆ·æ–°ç›¸å†Œå¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ==================== äººç‰©ç›¸å…³ ====================\n\n  // è·å–æ‰€æœ‰äººç‰©\n  ipcMain.handle('people:get-all', async () => {\n    try {\n      if (!database) {\n        return generateMockPeople()\n      }\n      return database.getAllPersons()\n    } catch (error) {\n      console.error('è·å–äººç‰©åˆ—è¡¨å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // æ·»åŠ äººç‰©\n  ipcMain.handle('people:add', async (event, person) => {\n    try {\n      if (!database) return -1\n      return database.addPerson(person)\n    } catch (error) {\n      console.error('æ·»åŠ äººç‰©å¤±è´¥:', error)\n      return -1\n    }\n  })\n\n  // æœç´¢äººç‰© (ç®€å•)\n  ipcMain.handle('people:search-simple', async (event, query: string) => {\n    try {\n      if (!searchService) {\n        return generateMockPeople().filter(p =>\n          p.name.includes(query) || p.display_name?.includes(query)\n        )\n      }\n      return await searchService.searchPeople(query)\n    } catch (error) {\n      console.error('æœç´¢äººç‰©å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // æ ¹æ®äººç‰©æœç´¢ç…§ç‰‡\n  ipcMain.handle('people:search-photos', async (event, personName: string) => {\n    try {\n      if (!searchService) {\n        return { results: generateMockPhotos(10, 0), total: 10 }\n      }\n      return await searchService.searchByPerson(personName)\n    } catch (error) {\n      console.error('æ ¹æ®äººç‰©æœç´¢ç…§ç‰‡å¤±è´¥:', error)\n      return { results: [], total: 0 }\n    }\n  })\n\n  // æ›´æ–°äººç‰©ä¿¡æ¯\n  ipcMain.handle('people:update', async (event, id: number, person: { name?: string; displayName?: string }) => {\n    try {\n      const { personService } = await import('../services/personService.js')\n      const success = personService.updatePerson(id, person)\n      return { success }\n    } catch (error) {\n      console.error('[IPC] æ›´æ–°äººç‰©å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // åˆ é™¤äººç‰©\n  ipcMain.handle('people:delete', async (event, id: number) => {\n    try {\n      const { personService } = await import('../services/personService.js')\n      const success = personService.deletePerson(id)\n      return { success }\n    } catch (error) {\n      console.error('[IPC] åˆ é™¤äººç‰©å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // æ ‡è®°äººç‰©\n  ipcMain.handle('people:tag', async (event, params: { photoId: number; personId: number; boundingBox?: any }) => {\n    try {\n      const { personService } = await import('../services/personService.js')\n      const result = personService.tagPerson(params)\n      return result\n    } catch (error) {\n      console.error('[IPC] æ ‡è®°äººç‰©å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ç§»é™¤æ ‡ç­¾\n  ipcMain.handle('people:untag', async (event, photoId: number, personId: number) => {\n    try {\n      const { personService } = await import('../services/personService.js')\n      const success = personService.untagPerson(photoId, personId)\n      return { success }\n    } catch (error) {\n      console.error('[IPC] ç§»é™¤æ ‡ç­¾å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // è·å–ç…§ç‰‡çš„äººç‰©æ ‡ç­¾\n  ipcMain.handle('people:get-photo-tags', async (event, photoId: number) => {\n    try {\n      const { personService } = await import('../services/personService.js')\n      return personService.getPhotoTags(photoId)\n    } catch (error) {\n      console.error('[IPC] è·å–ç…§ç‰‡æ ‡ç­¾å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // è·å–æŸäººç‰©çš„æ‰€æœ‰ç…§ç‰‡\n  ipcMain.handle('people:get-person-photos', async (event, personId: number) => {\n    try {\n      const { personService } = await import('../services/personService.js')\n      return personService.getPersonPhotos(personId)\n    } catch (error) {\n      console.error('[IPC] è·å–äººç‰©ç…§ç‰‡å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // è·å–äººç‰©ç»Ÿè®¡\n  ipcMain.handle('people:get-stats', async () => {\n    try {\n      const { personService } = await import('../services/personService.js')\n      return personService.getStats()\n    } catch (error) {\n      console.error('[IPC] è·å–ç»Ÿè®¡å¤±è´¥:', error)\n      return { totalPersons: 0, totalTags: 0 }\n    }\n  })\n\n  // ==================== åœ°ç‚¹ç›¸å…³ ====================\n\n  // è·å–æ‰€æœ‰åœ°ç‚¹\n  ipcMain.handle('places:get-all', async () => {\n    try {\n      if (!database) {\n        return generateMockPlaces()\n      }\n      return database.getAllPlaces()\n    } catch (error) {\n      console.error('è·å–åœ°ç‚¹åˆ—è¡¨å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // ==================== æ—¶é—´çº¿ç›¸å…³ ====================\n\n  // è·å–æŸå¹´ç…§ç‰‡\n  ipcMain.handle('timeline:get', async (event, year) => {\n    try {\n      if (!database) {\n        return generateMockPhotos(20, year ? year * 10 : 0)\n      }\n      return database.getPhotosByYear(year || new Date().getFullYear())\n    } catch (error) {\n      console.error('è·å–æ—¶é—´çº¿å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // ==================== åŒæ­¥ç›¸å…³ ====================\n\n  // å¼€å§‹åŒæ­¥\n  ipcMain.handle('sync:start', async () => {\n    try {\n      if (!iCloudService) {\n        // æ¨¡æ‹ŸåŒæ­¥\n        await new Promise(resolve => setTimeout(resolve, 2000))\n        return 100  // è¿”å›æ¨¡æ‹ŸåŒæ­¥æ•°é‡\n      }\n      return await iCloudService.syncAll()\n    } catch (error) {\n      console.error('åŒæ­¥å¤±è´¥:', error)\n      return 0\n    }\n  })\n\n  // è·å–åŒæ­¥è¿›åº¦\n  ipcMain.handle('sync:get-progress', async () => {\n    // è¿”å›æ¨¡æ‹Ÿè¿›åº¦\n    return { current: 0, total: 0, status: 'idle' }\n  })\n\n  // ==================== æœ¬åœ°ç…§ç‰‡å¯¼å…¥ç›¸å…³ ====================\n\n  // é€‰æ‹©å¯¼å…¥æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶\n  ipcMain.handle('local:select-folder', async () => {\n    const result = await dialog.showOpenDialog({\n      properties: ['openFile', 'openDirectory', 'multiSelections'],\n      title: 'é€‰æ‹©è¦å¯¼å…¥çš„ç…§ç‰‡æˆ–æ–‡ä»¶å¤¹',\n      buttonLabel: 'é€‰æ‹©',\n      filters: [\n        { name: 'å›¾ç‰‡æ–‡ä»¶', extensions: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'tiff'] },\n        { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }\n      ]\n    })\n\n    if (!result.canceled && result.filePaths.length > 0) {\n      return result.filePaths\n    }\n    return []\n  })\n\n  // å¼€å§‹å¯¼å…¥ç…§ç‰‡ï¼ˆæ”¯æŒæ–‡ä»¶å¤¹æˆ–å•ä¸ªæ–‡ä»¶ï¼‰\n  ipcMain.handle('local:import-folder', async (event, folderPath: string) => {\n    try {\n      if (!localPhotoService) {\n        throw new Error('æœ¬åœ°ç…§ç‰‡æœåŠ¡æœªåˆå§‹åŒ–')\n      }\n\n      const fs = await import('fs')\n      const stat = fs.statSync(folderPath)\n\n      // è®¾ç½®è¿›åº¦å›è°ƒ\n      localPhotoService.onProgress((progress) => {\n        event.sender.send('local:import-progress', progress)\n      })\n\n      let result\n      if (stat.isFile()) {\n        // å¯¼å…¥å•ä¸ªæ–‡ä»¶\n        console.log(`[IPC] å¯¼å…¥å•å¼ ç…§ç‰‡: ${folderPath}`)\n        const photo = await localPhotoService.importPhoto(folderPath)\n        result = {\n          imported: photo ? 1 : 0,\n          skipped: 0,\n          errors: photo ? 0 : 1,\n          photos: photo ? [photo] : []\n        }\n      } else {\n        // å¯¼å…¥æ–‡ä»¶å¤¹\n        result = await localPhotoService.importFolder(folderPath)\n      }\n\n      return {\n        success: true,\n        imported: result.imported,\n        errors: result.errors\n      }\n    } catch (error) {\n      console.error('å¯¼å…¥ç…§ç‰‡å¤±è´¥:', error)\n      return {\n        success: false,\n        error: (error as Error).message,\n        imported: 0,\n        errors: 1\n      }\n    }\n  })\n\n  // å¯¼å…¥å•å¼ ç…§ç‰‡\n  ipcMain.handle('local:import-photo', async (event, filePath: string) => {\n    try {\n      if (!localPhotoService) {\n        throw new Error('æœ¬åœ°ç…§ç‰‡æœåŠ¡æœªåˆå§‹åŒ–')\n      }\n\n      const photo = await localPhotoService.importPhoto(filePath)\n      return photo\n    } catch (error) {\n      console.error('å¯¼å…¥å•å¼ ç…§ç‰‡å¤±è´¥:', error)\n      return null\n    }\n  })\n\n  // è·å–æœ¬åœ°ç…§ç‰‡æ•°é‡\n  ipcMain.handle('local:get-count', async () => {\n    try {\n      if (!localPhotoService) {\n        return 0\n      }\n      return localPhotoService.getPhotoCount()\n    } catch (error) {\n      return 0\n    }\n  })\n\n  // ==================== å¯¼å…¥ç›¸å…³ (æ–°) ====================\n\n  // æ‰«ææ–‡ä»¶å¤¹\n  ipcMain.handle('import:scan-folder', async (_, folderPath: string) => {\n    try {\n      console.log(`[IPC] æ‰«ææ–‡ä»¶å¤¹: ${folderPath}`)\n      const files = await folderScanner.scanFolder(folderPath)\n      console.log(`[IPC] æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶`)\n      return files\n    } catch (error) {\n      console.error('[IPC] æ‰«ææ–‡ä»¶å¤¹å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // å¼€å§‹å¯¼å…¥\n  ipcMain.handle('import:start', async (event, folderPath: string, options: ImportOptions) => {\n    try {\n      console.log(`[IPC] å¼€å§‹å¯¼å…¥: ${folderPath}`)\n\n      // éªŒè¯ importService å·²åˆå§‹åŒ–\n      if (!importService) {\n        throw new Error('å¯¼å…¥æœåŠ¡æœªåˆå§‹åŒ–')\n      }\n\n      // ä½¿ç”¨æ–°çš„è¿›åº¦æœåŠ¡è®¢é˜…è¿›åº¦æ›´æ–°\n      const unsubscribe = importProgressService.subscribe((progress: ImportProgress) => {\n        event.sender.send('import:progress', progress)\n      })\n\n      // è®¾ç½®è¿›åº¦å›è°ƒ\n      importService.onProgress((progress) => {\n        event.sender.send('import:progress', progress)\n      })\n\n      const result = await importService.importFromFolder(folderPath, options)\n\n      // å®Œæˆåå–æ¶ˆè®¢é˜…\n      unsubscribe()\n\n      console.log(`[IPC] å¯¼å…¥å®Œæˆ: æˆåŠŸ ${result.imported}, è·³è¿‡ ${result.skipped}, å¤±è´¥ ${result.failed}`)\n\n      return result\n    } catch (error) {\n      console.error('[IPC] å¯¼å…¥å¤±è´¥:', error)\n      return {\n        success: false,\n        imported: 0,\n        skipped: 0,\n        failed: 0,\n        errors: [{ file: folderPath, error: (error as Error).message }],\n        duration: 0\n      } as ImportResult\n    }\n  })\n\n  // å–æ¶ˆå¯¼å…¥\n  ipcMain.handle('import:cancel', async () => {\n    console.log('[IPC] æ”¶åˆ°å–æ¶ˆå¯¼å…¥ä¿¡å·')\n    importService?.cancel()\n    importProgressService.cancel()\n    return { success: true }\n  })\n\n  // è·å–å¯¼å…¥çŠ¶æ€\n  ipcMain.handle('import:get-progress', async () => {\n    const progress = importProgressService.getProgress()\n    return {\n      isImporting: importService?.getIsImporting() || false,\n      progress: progress || null\n    }\n  })\n\n  // ==================== åµŒå…¥æœåŠ¡ç›¸å…³ï¼ˆæ··åˆæ¶æ„ï¼šæ¸²æŸ“è¿›ç¨‹æ‰§è¡Œï¼‰===================\n\n  // åˆå§‹åŒ– CLIP æ¨¡å‹ï¼ˆé€šè¿‡æ¸²æŸ“è¿›ç¨‹ï¼‰\n  ipcMain.handle('embedding:initialize', async () => {\n    console.log('[IPC] æ”¶åˆ° embedding:initialize è¯·æ±‚')\n\n    // å‘é€åˆ°æ¸²æŸ“è¿›ç¨‹å¤„ç†\n    const { BrowserWindow } = require('electron')\n    const windows = BrowserWindow.getAllWindows()\n\n    if (windows.length > 0) {\n      // å‘é€æ¶ˆæ¯åˆ°æ¸²æŸ“è¿›ç¨‹\n      windows[0].webContents.executeJavaScript(`\n        if (window.embeddingAPI && window.embeddingAPI.initialize) {\n          window.embeddingAPI.initialize()\n        } else {\n          Promise.reject(new Error('Embedding API not available'))\n        }\n      `).then((result: any) => {\n        console.log('[IPC] æ¸²æŸ“è¿›ç¨‹æ¨¡å‹åˆå§‹åŒ–ç»“æœ:', result)\n      }).catch((error: Error) => {\n        console.error('[IPC] æ¸²æŸ“è¿›ç¨‹æ¨¡å‹åˆå§‹åŒ–å¤±è´¥:', error)\n      })\n    }\n\n    // ç”±äºæ˜¯å¼‚æ­¥æ“ä½œï¼Œç›´æ¥è¿”å›è¿›è¡Œä¸­çŠ¶æ€\n    return { success: true, message: 'åˆå§‹åŒ–è¯·æ±‚å·²å‘é€åˆ°æ¸²æŸ“è¿›ç¨‹' }\n  })\n\n  // è·å–æ¨¡å‹çŠ¶æ€ï¼ˆé€šè¿‡æ¸²æŸ“è¿›ç¨‹ï¼‰\n  ipcMain.handle('embedding:get-status', async () => {\n    const { BrowserWindow } = require('electron')\n    const windows = BrowserWindow.getAllWindows()\n\n    if (windows.length > 0) {\n      try {\n        const status = await windows[0].webContents.executeJavaScript(`\n          if (window.embeddingAPI && window.embeddingAPI.getStatus) {\n            window.embeddingAPI.getStatus()\n          } else {\n            null\n          }\n        `)\n        if (status) {\n          return status\n        }\n      } catch (error) {\n        console.error('[IPC] è·å–æ¨¡å‹çŠ¶æ€å¤±è´¥:', error)\n      }\n    }\n\n    return { loaded: false, modelName: 'Xenova/clip-vit-base-patch32', rendererAvailable: false }\n  })\n\n  // æ–‡æœ¬è½¬å‘é‡ï¼ˆé€šè¿‡æ¸²æŸ“è¿›ç¨‹ï¼‰\n  ipcMain.handle('embedding:text-to-vector', async (_, text: string) => {\n    const { BrowserWindow } = require('electron')\n    const windows = BrowserWindow.getAllWindows()\n\n    if (windows.length > 0) {\n      try {\n        const result = await windows[0].webContents.executeJavaScript(`\n          if (window.embeddingAPI && window.embeddingAPI.textToEmbedding) {\n            JSON.stringify(window.embeddingAPI.textToEmbedding(\\`${text.replace(/`/g, '\\\\`')}\\`))\n          } else {\n            '{\"success\":false,\"error\":\"Embedding API not available\"}'\n          }\n        `)\n        return JSON.parse(result)\n      } catch (error) {\n        console.error('[IPC] æ–‡æœ¬è½¬å‘é‡å¤±è´¥:', error)\n        return { success: false, error: String(error), processingTimeMs: 0 }\n      }\n    }\n\n    return { success: false, error: 'No renderer window available', processingTimeMs: 0 }\n  })\n\n  // å›¾ç‰‡è½¬å‘é‡ï¼ˆé€šè¿‡æ¸²æŸ“è¿›ç¨‹ï¼‰\n  ipcMain.handle('embedding:image-to-vector', async (_, imagePath: string) => {\n    const { BrowserWindow } = require('electron')\n    const windows = BrowserWindow.getAllWindows()\n\n    if (windows.length > 0) {\n      try {\n        const result = await windows[0].webContents.executeJavaScript(`\n          if (window.embeddingAPI && window.embeddingAPI.imageToEmbedding) {\n            JSON.stringify(window.embeddingAPI.imageToEmbedding(\\`${imagePath.replace(/`/g, '\\\\`')}\\`))\n          } else {\n            '{\"success\":false,\"error\":\"Embedding API not available\"}'\n          }\n        `)\n        const parsed = JSON.parse(result)\n\n        // å¦‚æœæˆåŠŸï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“\n        if (parsed.success && parsed.vector && database) {\n          const photoUuid = extractPhotoUuidFromPath(imagePath)\n          if (photoUuid) {\n            try {\n              await database.saveEmbedding(photoUuid, parsed.vector, 'image')\n              console.log(`[IPC] å‘é‡å·²ä¿å­˜: ${photoUuid}`)\n            } catch (error) {\n              console.error('[IPC] ä¿å­˜å‘é‡å¤±è´¥:', error)\n            }\n          }\n        }\n\n        return parsed\n      } catch (error) {\n        console.error('[IPC] å›¾ç‰‡è½¬å‘é‡å¤±è´¥:', error)\n        return { success: false, error: String(error), processingTimeMs: 0 }\n      }\n    }\n\n    return { success: false, error: 'No renderer window available', processingTimeMs: 0 }\n  })\n\n  // ç”Ÿæˆæ‰€æœ‰ç…§ç‰‡çš„åµŒå…¥å‘é‡\n  ipcMain.handle('embedding:generate-all', async (event) => {\n    console.log('[IPC] å¼€å§‹æ‰¹é‡ç”ŸæˆåµŒå…¥å‘é‡')\n\n    if (!database) {\n      return { success: false, error: 'Database not initialized', successCount: 0, failedCount: 0, total: 0, errors: [], cancelled: false }\n    }\n\n    const vectorService = new VectorGenerationService(database)\n\n    try {\n      const result = await vectorService.generateAll({\n        onProgress: (progress) => {\n          event.sender.send('embedding:progress', progress)\n        }\n      })\n\n      return { success: true, successCount: result.success, failedCount: result.failed, total: result.total, errors: result.errors, cancelled: result.cancelled }\n    } catch (error) {\n      return { success: false, error: error instanceof Error ? error.message : String(error), successCount: 0, failedCount: 0, total: 0, errors: [], cancelled: false }\n    }\n  })\n\n  // ç”Ÿæˆå•å¼ ç…§ç‰‡çš„å‘é‡\n  ipcMain.handle('embedding:generate-one', async (_, photoUuid) => {\n    if (!database) {\n      return { success: false, error: 'Database not initialized' }\n    }\n    const vectorService = new VectorGenerationService(database)\n    try {\n      const success = await vectorService.generateOne(photoUuid)\n      return { success }\n    } catch (error) {\n      return { success: false, error: error instanceof Error ? error.message : String(error) }\n    }\n  })\n\n  // å–æ¶ˆå‘é‡ç”Ÿæˆ\n  ipcMain.handle('embedding:cancel', async () => {\n    const vectorService = new VectorGenerationService()\n    vectorService.cancel()\n    return { success: true }\n  })\n\n  // è·å–å‘é‡ç”ŸæˆçŠ¶æ€\n  ipcMain.handle('embedding:get-generation-status', async () => {\n    const vectorService = new VectorGenerationService()\n    return vectorService.getStatus()\n  })\n\n  // ==================== æ–‡æœ¬æœç´¢ç›¸å…³ ====================\n\n  // é¢„å¤„ç†æœç´¢æ–‡æœ¬\n  ipcMain.handle('search:preprocess', async (_, text: string) => {\n    const { textPreprocessor } = await import('../services/textPreprocessor.js')\n    return textPreprocessor.preprocess(text)\n  })\n\n  // æ–‡æœ¬è½¬å‘é‡\n  ipcMain.handle('search:text-to-vector', async (_, text: string) => {\n    const { textVectorService } = await import('../services/textVectorService.js')\n    return await textVectorService.textToVector(text)\n  })\n\n  // è¯­ä¹‰æœç´¢ (æ—§å®ç°)\n  ipcMain.handle('search:semantic-legacy', async (_, query: string, options?: { topK?: number; minSimilarity?: number }) => {\n    try {\n      const { textVectorService } = await import('../services/textVectorService.js')\n      const { similarityService } = await import('../services/similarityService.js')\n\n      // 1. é¢„å¤„ç†\n      const { textPreprocessor } = await import('../services/textPreprocessor.js')\n      const processed = textPreprocessor.preprocess(query)\n\n      // 2. è½¬å‘é‡\n      const textResult = await textVectorService.textToVector(query)\n      if (!textResult.vector) {\n        return { success: false, error: 'Failed to generate vector', results: [] }\n      }\n\n      // 3. ç›¸ä¼¼åº¦æœç´¢\n      const getEmbeddings = async () => {\n        if (!database) return []\n        return await database.getAllEmbeddings('image')\n      }\n\n      const results = await similarityService.semanticSearch(\n        textResult.vector,\n        getEmbeddings,\n        options\n      )\n\n      return {\n        success: true,\n        processed: {\n          original: processed.original,\n          processed: processed.processed,\n          keywords: processed.keywords,\n          language: processed.language\n        },\n        results,\n        processingTimeMs: textResult.processingTimeMs\n      }\n    } catch (error) {\n      console.error('[IPC] è¯­ä¹‰æœç´¢å¤±è´¥:', error)\n      return { success: false, error: error instanceof Error ? error.message : String(error), results: [] }\n    }\n  })\n\n  // æ¸…é™¤æ–‡æœ¬å‘é‡ç¼“å­˜\n  ipcMain.handle('search:clear-cache', async () => {\n    const { textVectorService } = await import('../services/textVectorService.js')\n    textVectorService.clearCache()\n    return { success: true }\n  })\n\n  // è·å–ç¼“å­˜çŠ¶æ€\n  ipcMain.handle('search:get-cache-stats', async () => {\n    const { textVectorService } = await import('../services/textVectorService.js')\n    return textVectorService.getCacheStats()\n  })\n\n  // ==================== è¯­ä¹‰æœç´¢ç›¸å…³ ====================\n\n  // æ‰§è¡Œè¯­ä¹‰æœç´¢\n  ipcMain.handle('search:semantic', async (_, options: { query: string; topK?: number; minSimilarity?: number; page?: number; pageSize?: number }) => {\n    try {\n      if (!database) {\n        return { success: false, error: 'Database not initialized', results: [] }\n      }\n\n      const searchService = new SemanticSearchService(database)\n      const result = await searchService.search(options)\n\n      // æ ¼å¼åŒ–ç»“æœ\n      const { searchResultFormatter } = await import('../services/searchResultFormatter.js')\n      const formattedResults = searchResultFormatter.formatBatch(result.results)\n      const summary = searchResultFormatter.formatSummary(result)\n\n      return {\n        success: true,\n        ...summary,\n        results: formattedResults\n      }\n    } catch (error) {\n      console.error('[IPC] è¯­ä¹‰æœç´¢å¤±è´¥:', error)\n      return { success: false, error: error instanceof Error ? error.message : String(error), results: [] }\n    }\n  })\n\n  // å¿«é€Ÿæœç´¢ï¼ˆä¸è¿”å›è¯¦æƒ…ï¼‰\n  ipcMain.handle('search:quick', async (_, query: string, topK: number = 10) => {\n    try {\n      if (!database) return []\n      const searchService = new SemanticSearchService(database)\n      return await searchService.quickSearch(query, topK)\n    } catch (error) {\n      console.error('[IPC] å¿«é€Ÿæœç´¢å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // å¤šæŸ¥è¯¢èåˆæœç´¢\n  ipcMain.handle('search:multi', async (_, queries: string[], options?: { topK?: number; minSimilarity?: number }) => {\n    try {\n      if (!database) {\n        return { success: false, error: 'Database not initialized', results: [] }\n      }\n\n      const searchService = new SemanticSearchService(database)\n      const result = await searchService.multiQuerySearch(queries, options)\n\n      return {\n        success: true,\n        total: result.total,\n        results: result.results\n      }\n    } catch (error) {\n      console.error('[IPC] å¤šæŸ¥è¯¢æœç´¢å¤±è´¥:', error)\n      return { success: false, error: error instanceof Error ? error.message : String(error), results: [] }\n    }\n  })\n\n  // ==================== æŸ¥è¯¢è§£æç›¸å…³ ====================\n\n  // è§£æç”¨æˆ·æŸ¥è¯¢\n  ipcMain.handle('query:parse', async (_, query: string) => {\n    try {\n      const { queryParserService } = await import('../services/queryParserService.js')\n      return await queryParserService.parse(query)\n    } catch (error) {\n      console.error('[IPC] æŸ¥è¯¢è§£æå¤±è´¥:', error)\n      return null\n    }\n  })\n\n  // æ¸…é™¤æŸ¥è¯¢è§£æç¼“å­˜\n  ipcMain.handle('query:clear-cache', async () => {\n    try {\n      const { queryParserService } = await import('../services/queryParserService.js')\n      queryParserService.clearCache()\n      return { success: true }\n    } catch (error) {\n      console.error('[IPC] æ¸…é™¤æŸ¥è¯¢ç¼“å­˜å¤±è´¥:', error)\n      return { success: false, error: error instanceof Error ? error.message : String(error) }\n    }\n  })\n\n  // è·å–æŸ¥è¯¢è§£æç¼“å­˜ç»Ÿè®¡\n  ipcMain.handle('query:get-cache-stats', async () => {\n    try {\n      const { queryParserService } = await import('../services/queryParserService.js')\n      return queryParserService.getCacheStats()\n    } catch (error) {\n      console.error('[IPC] è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥:', error)\n      return null\n    }\n  })\n\n  // ==================== å…³é”®è¯æœç´¢ç›¸å…³ ====================\n\n  // å…³é”®è¯æœç´¢\n  ipcMain.handle('search:keyword', async (_, options: {\n    query: string\n    fields?: string[]\n    fuzzy?: boolean\n    limit?: number\n    offset?: number\n  }) => {\n    try {\n      const { keywordSearchService } = await import('../services/keywordSearchService.js')\n      return await keywordSearchService.search(options)\n    } catch (error) {\n      console.error('[IPC] å…³é”®è¯æœç´¢å¤±è´¥:', error)\n      return { results: [], total: 0, query: options.query }\n    }\n  })\n\n  // å¿«é€Ÿå…³é”®è¯æœç´¢\n  ipcMain.handle('search:keyword-quick', async (_, query: string, limit: number = 20) => {\n    try {\n      const { keywordSearchService } = await import('../services/keywordSearchService.js')\n      return await keywordSearchService.quickSearch(query, limit)\n    } catch (error) {\n      console.error('[IPC] å¿«é€Ÿæœç´¢å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // è·å–æœç´¢å»ºè®®\n  ipcMain.handle('search:suggestions', async (_, query: string, limit: number = 10) => {\n    try {\n      const { keywordSearchService } = await import('../services/keywordSearchService.js')\n      return keywordSearchService.getSuggestions(query, limit)\n    } catch (error) {\n      console.error('[IPC] è·å–æœç´¢å»ºè®®å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // ==================== å…¨å±€å‘é‡æœç´¢ç›¸å…³ ====================\n\n  // å…¨å±€å‘é‡æœç´¢\n  ipcMain.handle('search:global', async (_, options: {\n    query: string\n    topK?: number\n    minSimilarity?: number\n    page?: number\n    pageSize?: number\n  }) => {\n    try {\n      const { globalSearchService } = await import('../services/globalSearchService.js')\n      return await globalSearchService.search(options)\n    } catch (error) {\n      console.error('[IPC] å…¨å±€æœç´¢å¤±è´¥:', error)\n      return {\n        results: [],\n        total: 0,\n        page: 1,\n        pageSize: 20,\n        processingTimeMs: 0,\n        query: { original: options.query, processed: '', vectorDimension: 0 }\n      }\n    }\n  })\n\n  // å¿«é€Ÿå…¨å±€æœç´¢\n  ipcMain.handle('search:global-quick', async (_, query: string, topK: number = 10) => {\n    try {\n      const { globalSearchService } = await import('../services/globalSearchService.js')\n      return await globalSearchService.quickSearch(query, topK)\n    } catch (error) {\n      console.error('[IPC] å¿«é€Ÿæœç´¢å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // æŸ¥æ‰¾ç›¸ä¼¼ç…§ç‰‡\n  ipcMain.handle('search:similar', async (_, photoUuid: string, topK: number = 10) => {\n    try {\n      const { globalSearchService } = await import('../services/globalSearchService.js')\n      return await globalSearchService.findSimilarPhotos(photoUuid, topK)\n    } catch (error) {\n      console.error('[IPC] ç›¸ä¼¼ç…§ç‰‡æœç´¢å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // æ‰¹é‡æœç´¢\n  ipcMain.handle('search:batch', async (_, queries: string[], options?: { topK?: number; minSimilarity?: number }) => {\n    try {\n      const { globalSearchService } = await import('../services/globalSearchService.js')\n      return await globalSearchService.batchSearch(queries, options)\n    } catch (error) {\n      console.error('[IPC] æ‰¹é‡æœç´¢å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // ==================== ç»“æœèåˆç›¸å…³ ====================\n\n  // æ··åˆæœç´¢ï¼ˆèåˆç»“æœï¼‰\n  ipcMain.handle('search:hybrid', async (_, options: {\n    query: string\n    keywordWeight?: number\n    vectorWeight?: number\n    limit?: number\n    minScore?: number\n  }) => {\n    try {\n      const { resultMergeService } = await import('../services/resultMergeService.js')\n      return await resultMergeService.search(options)\n    } catch (error) {\n      console.error('[IPC] æ··åˆæœç´¢å¤±è´¥:', error)\n      return {\n        results: [],\n        total: 0,\n        query: options.query,\n        processingTimeMs: 0,\n        stats: { keywordCount: 0, semanticCount: 0, mergedCount: 0 }\n      }\n    }\n  })\n\n  // æ··åˆæœç´¢ï¼ˆå¸¦æ„å›¾ï¼‰\n  ipcMain.handle('search:hybrid-intent', async (_, query: string) => {\n    try {\n      const { resultMergeService } = await import('../services/resultMergeService.js')\n      return await resultMergeService.searchWithIntent(query)\n    } catch (error) {\n      console.error('[IPC] å¸¦æ„å›¾æœç´¢å¤±è´¥:', error)\n      return {\n        results: [],\n        total: 0,\n        query,\n        processingTimeMs: 0,\n        stats: { keywordCount: 0, semanticCount: 0, mergedCount: 0 }\n      }\n    }\n  })\n\n  // é‡æ–°æ’åº\n  ipcMain.handle('search:reorder', async (_, results: any[], sortBy: string) => {\n    try {\n      const { resultMergeService } = await import('../services/resultMergeService.js')\n      return resultMergeService.reorderResults(results, sortBy as 'keyword' | 'semantic' | 'mixed' | 'recency')\n    } catch (error) {\n      console.error('[IPC] é‡æ–°æ’åºå¤±è´¥:', error)\n      return results\n    }\n  })\n\n  // ==================== äººè„¸æ£€æµ‹ç›¸å…³ ====================\n\n  // åŠ è½½äººè„¸æ£€æµ‹æ¨¡å‹\n  ipcMain.handle('face:load-models', async () => {\n    try {\n      const { faceDetectionService } = await import('../services/faceDetectionService.js')\n      return await faceDetectionService.loadModels()\n    } catch (error) {\n      console.error('[IPC] åŠ è½½æ¨¡å‹å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // è·å–æ¨¡å‹çŠ¶æ€\n  ipcMain.handle('face:get-status', async () => {\n    try {\n      const { faceDetectionService } = await import('../services/faceDetectionService.js')\n      return faceDetectionService.getModelStatus()\n    } catch (error) {\n      return { loaded: false, modelsPath: '', configured: false }\n    }\n  })\n\n  // æ£€æµ‹å•å¼ ç…§ç‰‡\n  ipcMain.handle('face:detect', async (_, imagePath: string) => {\n    try {\n      const { faceDetectionService } = await import('../services/faceDetectionService.js')\n      return await faceDetectionService.detect(imagePath)\n    } catch (error) {\n      return { success: false, detections: [], error: String(error), processingTimeMs: 0 }\n    }\n  })\n\n  // æ‰¹é‡æ£€æµ‹\n  ipcMain.handle('face:detect-batch', async (event, imagePaths: string[]) => {\n    try {\n      const { faceDetectionService } = await import('../services/faceDetectionService.js')\n\n      const result = await faceDetectionService.detectBatch(\n        imagePaths,\n        {},\n        (progress) => {\n          event.sender.send('face:progress', progress)\n        }\n      )\n\n      return {\n        success: true,\n        totalDetected: result.totalDetected,\n        processingTimeMs: result.processingTimeMs\n      }\n    } catch (error) {\n      console.error('[IPC] æ‰¹é‡æ£€æµ‹å¤±è´¥:', error)\n      return { success: false, totalDetected: 0, processingTimeMs: 0, error: String(error) }\n    }\n  })\n\n  // å–æ¶ˆæ£€æµ‹\n  ipcMain.handle('face:cancel', async () => {\n    try {\n      const { faceDetectionService } = await import('../services/faceDetectionService.js')\n      faceDetectionService.cancel()\n      return { success: true }\n    } catch (error) {\n      return { success: false }\n    }\n  })\n\n  // ğŸ†• é‡ç½®äººè„¸æ‰«æçŠ¶æ€ï¼ˆåˆ é™¤ detected_faces è®°å½•ï¼Œå…è®¸é‡æ–°æ‰«æï¼‰\n  ipcMain.handle('face:reset-scan-status', async () => {\n    try {\n      if (!database) {\n        return { success: false, error: 'æ•°æ®åº“æœªåˆå§‹åŒ–' }\n      }\n\n      console.log('[IPC] æ·±åº¦é‡ç½®äººè„¸æ‰«æçŠ¶æ€...')\n\n      // 1. è·å–å½“å‰ç»Ÿè®¡\n      const beforeFaces = database.query(`SELECT COUNT(*) as count FROM detected_faces`)[0]\n      const beforePersons = database.query(`SELECT COUNT(*) as count FROM persons`)[0]\n      const beforePhotos = database.query(`SELECT COUNT(*) as count FROM photos WHERE file_path IS NOT NULL`)[0]\n      console.log(`[IPC] é‡ç½®å‰ç»Ÿè®¡: ${beforeFaces?.count || 0} äººè„¸, ${beforePersons?.count || 0} äººç‰©, ${beforePhotos?.count || 0} ç…§ç‰‡`)\n\n      // 2. åˆ é™¤æ‰€æœ‰äººè„¸æ•°æ®\n      database.run('DELETE FROM detected_faces')\n      database.run('DELETE FROM persons')  // ä¹Ÿåˆ é™¤äººç‰©ï¼Œå› ä¸ºäººè„¸æ²¡äº†äººç‰©ä¹Ÿæ²¡æ„ä¹‰\n\n      // 3. ã€å…³é”®ã€‘é‡ç½®æ‰€æœ‰ç…§ç‰‡çš„æ‰«æçŠ¶æ€ï¼ˆè®©getUnprocessedPhotosèƒ½é‡æ–°è·å–ï¼‰\n      // detected_facesè¡¨ä¸ºç©ºæ—¶ï¼ŒLEFT JOINä¼šè¿”å›NULLï¼Œç…§ç‰‡è‡ªç„¶è¢«è§†ä¸º\"æœªå¤„ç†\"\n      // ä½†ä¸ºäº†å½»åº•é‡ç½®ï¼Œæˆ‘ä»¬ç¡®ä¿photosè¡¨æ²¡æœ‰è¢«æ„å¤–æ ‡è®°\n\n      // 4. éªŒè¯åˆ é™¤ç»“æœ\n      const afterFaces = database.query(`SELECT COUNT(*) as count FROM detected_faces`)[0]\n      const afterPersons = database.query(`SELECT COUNT(*) as count FROM persons`)[0]\n\n      // 5. æ£€æŸ¥getUnprocessedPhotosä¼šè¿”å›å¤šå°‘å¼ \n      const unprocessedPhotos = database.getUnprocessedPhotos(1000)\n\n      console.log(`[IPC] æ·±åº¦é‡ç½®å®Œæˆ:`)\n      console.log(`  - åˆ é™¤äººè„¸: ${beforeFaces?.count || 0} â†’ ${afterFaces?.count || 0}`)\n      console.log(`  - åˆ é™¤äººç‰©: ${beforePersons?.count || 0} â†’ ${afterPersons?.count || 0}`)\n      console.log(`  - å¯é‡æ–°æ‰«æç…§ç‰‡: ${unprocessedPhotos.length}`)\n\n      return {\n        success: true,\n        deletedCount: beforeFaces?.count || 0,\n        resetPhotos: unprocessedPhotos.length,\n        message: `å·²æ¸…ç† ${beforeFaces?.count || 0} äººè„¸ã€${beforePersons?.count || 0} äººç‰©ï¼Œ${unprocessedPhotos.length} å¼ ç…§ç‰‡å¯é‡æ–°æ‰«æ`\n      }\n    } catch (error) {\n      console.error('[IPC] é‡ç½®æ‰«æçŠ¶æ€å¤±è´¥:', error)\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'é‡ç½®å¤±è´¥'\n      }\n    }\n  })\n\n  // ğŸ†• è¯Šæ–­APIï¼šè·å–æ•°æ®åº“çŠ¶æ€ï¼ˆCTOè¦æ±‚çš„éªŒè¯ï¼‰\n  ipcMain.handle('diagnostic:get-db-stats', async () => {\n    try {\n      if (!database) {\n        return { success: false, error: 'æ•°æ®åº“æœªåˆå§‹åŒ–' }\n      }\n\n      const stats = {\n        photos: {\n          total: database.query('SELECT COUNT(*) as count FROM photos')[0]?.count || 0,\n          withFilePath: database.query('SELECT COUNT(*) as count FROM photos WHERE file_path IS NOT NULL')[0]?.count || 0,\n          unprocessed: database.getUnprocessedPhotos(1000).length\n        },\n        detected_faces: {\n          total: database.query('SELECT COUNT(*) as count FROM detected_faces')[0]?.count || 0,\n          unassigned: database.query('SELECT COUNT(*) as count FROM detected_faces WHERE person_id IS NULL')[0]?.count || 0,\n          assigned: database.query('SELECT COUNT(*) as count FROM detected_faces WHERE person_id IS NOT NULL')[0]?.count || 0\n        },\n        persons: {\n          total: database.query('SELECT COUNT(*) as count FROM persons')[0]?.count || 0\n        }\n      }\n\n      console.log('[Diagnostic] æ•°æ®åº“çŠ¶æ€:', stats)\n      return { success: true, stats }\n    } catch (error) {\n      console.error('[Diagnostic] è·å–ç»Ÿè®¡å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // æ‰«ææ‰€æœ‰æœªå¤„ç†çš„ç…§ç‰‡ï¼ˆäººè„¸æ£€æµ‹ï¼‰- å…¨é“¾è·¯é€æ˜åŒ–ç‰ˆæœ¬\n  ipcMain.handle('face:scan-all', async (event) => {\n    try {\n      // ğŸ”´ å¼¹çª—ç¡®è®¤ï¼šIPC ç¡®å®è¢«è§¦å‘äº†\n      console.log('[IPC] face:scan-all è¢«è§¦å‘')\n      if (mainWindow) {\n        mainWindow.webContents.send('face:status', { stage: 'started', message: 'å¼€å§‹æ‰«æ...' })\n      }\n\n      if (!database) {\n        const err = 'æ•°æ®åº“æœªåˆå§‹åŒ–'\n        console.error('[IPC]', err)\n        if (mainWindow) {\n          mainWindow.webContents.send('face:status', { stage: 'error', error: err })\n        }\n        return { success: false, count: 0, error: err }\n      }\n\n      // ğŸš¨ å¼ºåˆ¶é‡ç½®é˜Ÿåˆ—çŠ¶æ€ï¼ˆè§£å†³çŠ¶æ€æ­»é”ï¼‰\n      const { FaceDetectionQueue, faceDetectionQueue: existingQueue } = await import('../services/faceDetectionQueue.js')\n\n      // ä½¿ç”¨æ–°çš„é˜Ÿåˆ—å®ä¾‹ï¼Œä¼ å…¥ä¸»è¿›ç¨‹çš„æ•°æ®åº“å’Œè¿›åº¦å›è°ƒ\n      const queue = new FaceDetectionQueue(database, {\n        maxConcurrent: 1,\n        onProgress: (progress) => {\n          // ğŸš¨ å®æ—¶ä¸ŠæŠ¥è¿›åº¦åˆ°å‰ç«¯\n          if (mainWindow) {\n            const stats = queue.getStats()\n            const percent = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0\n            console.log(`[IPC] ğŸ“Š é˜Ÿåˆ—è¿›åº¦: ${stats.completed}/${stats.total} (${percent}%)`)\n            mainWindow.webContents.send('face:progress', {\n              current: stats.completed,\n              total: stats.total,\n              percent: percent,\n              status: progress.status\n            })\n          }\n        },\n        onComplete: (stats) => {\n          // ğŸš¨ æ‰«æå®Œæˆæ—¶è§¦å‘\n          console.log(`[IPC] ğŸ‰ äººè„¸æ£€æµ‹å®Œæˆ: ${stats.completed}/${stats.total}, æ£€æµ‹åˆ° ${stats.detectedFaces} å¼ äººè„¸`)\n          if (mainWindow) {\n            mainWindow.webContents.send('face:scan-complete', {\n              total: stats.total,\n              completed: stats.completed,\n              failed: stats.failed,\n              detectedFaces: stats.detectedFaces\n            })\n            mainWindow.webContents.send('face:status', {\n              stage: 'completed',\n              total: stats.total,\n              detectedFaces: stats.detectedFaces,\n              message: `æ‰«æå®Œæˆï¼Œå…± ${stats.completed} å¼ ç…§ç‰‡ï¼Œæ£€æµ‹åˆ° ${stats.detectedFaces} å¼ äººè„¸`\n            })\n          }\n        }\n      })\n      const prevStatus = queue.getDetailedStatus()\n      console.log(`[IPC] ä¹‹å‰é˜Ÿåˆ—çŠ¶æ€: isRunning=${prevStatus.isRunning}, queueLength=${prevStatus.queueLength}`)\n\n      if (prevStatus.isRunning) {\n        console.log('[IPC] æ£€æµ‹åˆ°é˜Ÿåˆ—å¡ä½ï¼Œå¼ºåˆ¶é‡ç½®...')\n        queue.forceReset()\n      }\n\n      // ğŸš¨ è°ƒè¯•ï¼šæ£€æŸ¥æ•°æ®åº“ä¸­å·²å¤„ç† vs æœªå¤„ç†çš„ç…§ç‰‡\n      const totalPhotos = database.query('SELECT COUNT(*) as cnt FROM photos WHERE file_path IS NOT NULL')\n      const processedPhotos = database.query('SELECT COUNT(DISTINCT p.id) as cnt FROM photos p JOIN detected_faces df ON p.id = df.photo_id WHERE p.file_path IS NOT NULL')\n      console.log(`[IPC] æ•°æ®åº“ç»Ÿè®¡: æ€»æ•°=${totalPhotos[0]?.cnt}, å·²å¤„ç†=${processedPhotos[0]?.cnt}`)\n\n      // ä½¿ç”¨ä¸»è¿›ç¨‹çš„æ•°æ®åº“å®ä¾‹è·å–æœªå¤„ç†çš„ç…§ç‰‡\n      const unprocessedLimit = 1000\n      const photos = database.getUnprocessedPhotos(unprocessedLimit)\n      console.log(`[IPC] getUnprocessedPhotos(${unprocessedLimit}) è¿”å›: ${photos.length} å¼ `)\n\n      if (mainWindow) {\n        mainWindow.webContents.send('face:status', {\n          stage: 'queued',\n          total: photos.length,\n          message: `å·²æ·»åŠ  ${photos.length} å¼ ç…§ç‰‡åˆ°æ‰«æé˜Ÿåˆ—`\n        })\n      }\n\n      if (photos.length === 0) {\n        // ğŸ†• æ£€æŸ¥æ˜¯å¦å·²æœ‰æ£€æµ‹æ•°æ®ä½†æœªèšç±»\n        const unclusteredCount = queue.getUnclusteredFaceCount()\n        console.log(`[IPC] æ²¡æœ‰æ–°ç…§ç‰‡éœ€è¦æ‰«æï¼Œä½†æœªèšç±»äººè„¸æ•°: ${unclusteredCount}`)\n\n        if (unclusteredCount > 0) {\n          console.log(`[IPC] å‘ç° ${unclusteredCount} ä¸ªæœªèšç±»äººè„¸ï¼Œç›´æ¥è§¦å‘èšç±»...`)\n\n          if (mainWindow) {\n            mainWindow.webContents.send('face:status', {\n              stage: 'processing',\n              message: `å‘ç° ${unclusteredCount} ä¸ªæœªè¯†åˆ«äººè„¸ï¼Œæ­£åœ¨èšç±»...`\n            })\n          }\n\n          // ç›´æ¥æ‰§è¡Œèšç±»\n          const clusterResult = await queue.clusterExistingFaces()\n\n          if (mainWindow) {\n            mainWindow.webContents.send('face:status', {\n              stage: 'completed',\n              message: `èšç±»å®Œæˆï¼è¯†åˆ«äº† ${clusterResult.matched} å¼ äººè„¸ï¼Œåˆ›å»ºäº† ${clusterResult.personsCreated} ä½äººç‰©`\n            })\n            mainWindow.webContents.send('face:scan-complete', {\n              total: unclusteredCount,\n              completed: unclusteredCount,\n              failed: 0,\n              detectedFaces: clusterResult.matched\n            })\n            // ğŸ†• é€šçŸ¥å‰ç«¯åˆ·æ–°äººç‰©åˆ—è¡¨\n            mainWindow.webContents.send('people:updated')\n          }\n\n          return {\n            success: true,\n            count: 0,\n            detectedFaces: clusterResult.matched,\n            personsCreated: clusterResult.personsCreated,\n            message: `èšç±»å®Œæˆï¼åˆ›å»ºäº† ${clusterResult.personsCreated} ä½äººç‰©`\n          }\n        }\n\n        if (mainWindow) {\n          mainWindow.webContents.send('face:status', { stage: 'completed', message: 'æ²¡æœ‰éœ€è¦å¤„ç†çš„ç…§ç‰‡' })\n        }\n        return { success: true, count: 0, message: 'æ²¡æœ‰éœ€è¦å¤„ç†çš„ç…§ç‰‡' }\n      }\n\n      // ğŸ†• åˆ›å»ºæ‰«æä»»åŠ¡è®°å½•\n      const jobId = queue.startScanJob(photos.length)\n      console.log(`[IPC] åˆ›å»ºæ‰«æä»»åŠ¡: ${jobId}`)\n\n      // æ‰¹é‡æ·»åŠ åˆ°é˜Ÿåˆ—\n      let processed = 0\n      const totalPhotosToProcess = photos.length\n\n      for (const photo of photos) {\n        console.log(`[IPC] æ·»åŠ ç…§ç‰‡åˆ°é˜Ÿåˆ—: ${photo.id} (${processed + 1}/${totalPhotosToProcess})`)\n        await queue.addTask(\n          photo.id.toString(),\n          photo.uuid,\n          photo.file_path\n        )\n        processed++\n        console.log(`[IPC] å·²å¤„ç†: ${processed}/${totalPhotosToProcess}`)\n\n        // æ¯å¤„ç† 1 å¼ å°±ä¸ŠæŠ¥è¿›åº¦ï¼ˆå®æ—¶åé¦ˆï¼‰\n        if (mainWindow && processed % 1 === 0) {\n          const percent = Math.round((processed / totalPhotosToProcess) * 100)\n          console.log(`[IPC] ğŸ“Š å‘é€è¿›åº¦: ${processed}/${totalPhotosToProcess} (${percent}%)`)\n          mainWindow.webContents.send('face:progress', {\n            current: processed,\n            total: totalPhotosToProcess,\n            percent: percent\n          })\n        }\n      }\n\n      console.log(`[IPC] å·²æ·»åŠ  ${processed} å¼ ç…§ç‰‡åˆ°é˜Ÿåˆ—`)\n\n      // ğŸš¨ æ˜¾å¼è°ƒç”¨ forceStart() è€Œéä¾èµ– addTask è‡ªåŠ¨è§¦å‘\n      console.log('[IPC] è°ƒç”¨ queue.forceStart() å¯åŠ¨å¤„ç†å¼•æ“...')\n      await queue.forceStart()\n\n      console.log('[IPC] forceStart() è¿”å›ï¼Œç­‰å¾…é˜Ÿåˆ—å¤„ç†å®Œæˆ...')\n\n      // ğŸš¨ æ³¨æ„ï¼šå®ŒæˆçŠ¶æ€ç°åœ¨ç”± queue.onComplete å›è°ƒå‘é€\n      // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ onComplete å·²ç»è§¦å‘\n      await new Promise(resolve => setTimeout(resolve, 100))\n\n      const finalStats = queue.getStats()\n      const detectedFaces = queue.getTasks().reduce((sum, t) => sum + (t.faces || 0), 0)\n\n      return { success: true, count: processed, detectedFaces, total: finalStats.total }\n    } catch (error) {\n      const errMsg = String(error)\n      console.error('[IPC] æ‰«æå¤±è´¥:', error)\n      if (mainWindow) {\n        mainWindow.webContents.send('face:status', { stage: 'error', error: errMsg })\n      }\n      return { success: false, count: 0, error: errMsg }\n    }\n  })\n\n  // ğŸš¨ è·å–äººè„¸æ£€æµ‹é˜Ÿåˆ—çŠ¶æ€ï¼ˆç”¨äºè¯Šæ–­ï¼‰\n  ipcMain.handle('face:get-queue-status', async () => {\n    try {\n      const { faceDetectionQueue } = await import('../services/faceDetectionQueue.js')\n      return faceDetectionQueue.getDetailedStatus()\n    } catch (error) {\n      console.error('[IPC] è·å–é˜Ÿåˆ—çŠ¶æ€å¤±è´¥:', error)\n      return null\n    }\n  })\n\n  // ğŸš¨ å¼ºåˆ¶é‡ç½®é˜Ÿåˆ—çŠ¶æ€ï¼ˆç”¨äºæ¢å¤å¡æ­»çš„é˜Ÿåˆ—ï¼‰\n  ipcMain.handle('face:reset-queue', async () => {\n    try {\n      const { faceDetectionQueue } = await import('../services/faceDetectionQueue.js')\n      const status = faceDetectionQueue.getDetailedStatus()\n      faceDetectionQueue.forceReset()\n      console.log('[IPC] é˜Ÿåˆ—çŠ¶æ€å·²å¼ºåˆ¶é‡ç½®')\n      return { success: true, previousStatus: status }\n    } catch (error) {\n      console.error('[IPC] é‡ç½®é˜Ÿåˆ—å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ğŸ†• è·å–æœªå‘½åçš„äººè„¸ï¼ˆæœªèšç±»çš„äººè„¸ï¼Œç”¨äºæ˜¾ç¤ºä¸º\"æœªå‘½åäººç‰©\"ï¼‰\n  ipcMain.handle('face:get-unnamed-faces', async (_, limit: number = 50) => {\n    try {\n      if (!database) return { faces: [], count: 0 }\n\n      const faces = database.query(`\n        SELECT df.id, df.photo_id, df.bbox_x, df.bbox_y, df.bbox_width, df.bbox_height,\n               df.confidence, p.file_path, p.thumbnail_path\n        FROM detected_faces df\n        JOIN photos p ON df.photo_id = p.id\n        WHERE df.person_id IS NULL\n        ORDER BY df.confidence DESC\n        LIMIT ?\n      `, [limit])\n\n      const count = database.query('SELECT COUNT(*) as count FROM detected_faces WHERE person_id IS NULL')[0]?.count || 0\n\n      return {\n        faces: faces.map((f: any) => ({\n          id: f.id,\n          photoId: f.photo_id,\n          bbox: { x: f.bbox_x, y: f.bbox_y, width: f.bbox_width, height: f.bbox_height },\n          confidence: f.confidence,\n          filePath: f.file_path,\n          thumbnailPath: f.thumbnail_path\n        })),\n        count\n      }\n    } catch (error) {\n      console.error('[IPC] è·å–æœªå‘½åäººè„¸å¤±è´¥:', error)\n      return { faces: [], count: 0, error: String(error) }\n    }\n  })\n\n  // ==================== è¯Šæ–­å·¥å…·ç›¸å…³ ====================\n\n  // ğŸš¨ è·å–äººè„¸æ£€æµ‹ç»Ÿè®¡ï¼ˆç”¨äºè¯Šæ–­ï¼‰\n  ipcMain.handle('diagnostic:face-stats', async () => {\n    try {\n      if (!database) return { error: 'æ•°æ®åº“æœªåˆå§‹åŒ–' }\n\n      const stats = {\n        photos: database.query('SELECT COUNT(*) as count FROM photos')[0]?.count || 0,\n        detectedFaces: database.query('SELECT COUNT(*) as count FROM detected_faces')[0]?.count || 0,\n        persons: database.query('SELECT COUNT(*) as count FROM persons')[0]?.count || 0,\n        faces: database.query('SELECT COUNT(*) as count FROM faces')[0]?.count || 0,\n      }\n\n      // æ£€æŸ¥ detected_faces ä¸­æ˜¯å¦æœ‰ embedding\n      const withEmbedding = database.query(`\n        SELECT COUNT(*) as count FROM detected_faces WHERE embedding IS NOT NULL\n      `)[0]?.count || 0\n\n      // è·å–æ ·æœ¬æ•°æ®\n      const sample = database.query(`\n        SELECT id, photo_id, confidence,\n               CASE WHEN embedding IS NULL THEN 'NULL' ELSE 'æœ‰æ•°æ®' END as emb_status\n        FROM detected_faces LIMIT 3\n      `)\n\n      console.log('[Diagnostic] äººè„¸æ£€æµ‹ç»Ÿè®¡:', { ...stats, withEmbedding })\n      return { success: true, stats: { ...stats, withEmbedding }, sample }\n    } catch (error) {\n      console.error('[Diagnostic] è·å–ç»Ÿè®¡å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ğŸš¨ æ¸…ç†æ‰€æœ‰äººè„¸æ•°æ®ï¼ˆç”¨äºé‡ç½®ï¼‰\n  ipcMain.handle('diagnostic:clear-face-data', async () => {\n    try {\n      if (!database) return { error: 'æ•°æ®åº“æœªåˆå§‹åŒ–' }\n\n      console.log('[Diagnostic] å¼€å§‹æ¸…ç†äººè„¸æ•°æ®...')\n\n      // æ¸…ç†è¡¨ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰\n      database.run('DELETE FROM detected_faces')\n      database.run('DELETE FROM faces')\n      database.run('DELETE FROM persons')\n\n      console.log('[Diagnostic] äººè„¸æ•°æ®å·²æ¸…ç†')\n      return { success: true, message: 'æ‰€æœ‰äººè„¸æ•°æ®å·²æ¸…ç†' }\n    } catch (error) {\n      console.error('[Diagnostic] æ¸…ç†æ•°æ®å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ğŸš¨ é‡ç½®äººç‰©å…³è”ï¼ˆç”¨äºé‡æ–°èšç±»ï¼‰\n  ipcMain.handle('diagnostic:reset-person-links', async () => {\n    try {\n      if (!database) return { error: 'æ•°æ®åº“æœªåˆå§‹åŒ–' }\n\n      console.log('[Diagnostic] é‡ç½®äººç‰©å…³è”...')\n\n      // æ¸…é™¤ detected_faces çš„ person_id\n      database.run('UPDATE detected_faces SET person_id = NULL, processed = 0')\n      // æ¸…é™¤ persons è¡¨\n      database.run('DELETE FROM persons')\n\n      console.log('[Diagnostic] äººç‰©å…³è”å·²é‡ç½®')\n      return { success: true, message: 'äººç‰©å…³è”å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°èšç±»' }\n    } catch (error) {\n      console.error('[Diagnostic] é‡ç½®å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ğŸš¨ æ‰§è¡ŒåŸå§‹SQLæŸ¥è¯¢ï¼ˆä»…é™SELECTï¼Œç”¨äºè¯Šæ–­ï¼‰\n  ipcMain.handle('diagnostic:query', async (_, sql: string) => {\n    try {\n      if (!database) return { error: 'æ•°æ®åº“æœªåˆå§‹åŒ–' }\n\n      // å®‰å…¨æ£€æŸ¥ï¼šåªå…è®¸ SELECT è¯­å¥\n      const trimmedSql = sql.trim().toUpperCase()\n      if (!trimmedSql.startsWith('SELECT')) {\n        return { error: 'åªå…è®¸æ‰§è¡Œ SELECT æŸ¥è¯¢' }\n      }\n\n      const result = database.query(sql)\n      return { success: true, result }\n    } catch (error) {\n      console.error('[Diagnostic] SQLæŸ¥è¯¢å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // ==================== äººè„¸åŒ¹é…ç›¸å…³ ====================\n\n  // è‡ªåŠ¨åŒ¹é…\n  ipcMain.handle('face:auto-match', async () => {\n    try {\n      const { faceMatchingService } = await import('../services/faceMatchingService.js')\n      // ğŸš¨ è°ƒè¯•ï¼šå…ˆæ£€æŸ¥æœªåŒ¹é…äººè„¸\n      const unmatched = await faceMatchingService.getUnmatchedFaces()\n      console.log(`[IPC] æœªåŒ¹é…äººè„¸æ•°é‡: ${unmatched.length}`)\n      if (unmatched.length > 0) {\n        console.log(`[IPC] æ ·æœ¬äººè„¸ descriptor é•¿åº¦: ${unmatched[0].descriptor?.length}`)\n      }\n      // ä½¿ç”¨é»˜è®¤é˜ˆå€¼ 0.45\n      return await faceMatchingService.autoMatch()\n    } catch (error) {\n      console.error('[IPC] è‡ªåŠ¨åŒ¹é…å¤±è´¥:', error)\n      return { matched: 0, clusters: [], processingTimeMs: 0, message: 'è‡ªåŠ¨åŒ¹é…å¤±è´¥' }\n    }\n  })\n\n  // æŸ¥æ‰¾ç›¸ä¼¼äººè„¸\n  ipcMain.handle('face:find-similar', async (_, faceId: number) => {\n    try {\n      const { faceMatchingService } = await import('../services/faceMatchingService.js')\n      return await faceMatchingService.findSimilarFaces(faceId)\n    } catch (error) {\n      console.error('[IPC] æŸ¥æ‰¾ç›¸ä¼¼äººè„¸å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // ä¸ºèšç±»åˆ›å»ºäººç‰©\n  ipcMain.handle('face:create-person', async (_, cluster: any, personName: string) => {\n    try {\n      const { faceMatchingService } = await import('../services/faceMatchingService.js')\n      return await faceMatchingService.createPersonFromCluster(cluster, personName)\n    } catch (error) {\n      console.error('[IPC] åˆ›å»ºäººç‰©å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // å°†äººè„¸åˆ†é…ç»™äººç‰©\n  ipcMain.handle('face:assign', async (_, faceIds: number[], personId: number) => {\n    try {\n      const { faceMatchingService } = await import('../services/faceMatchingService.js')\n      return await faceMatchingService.assignToPerson(faceIds, personId)\n    } catch (error) {\n      console.error('[IPC] åˆ†é…äººè„¸å¤±è´¥:', error)\n      return { success: false, assigned: 0, error: String(error) }\n    }\n  })\n\n  // å–æ¶ˆåŒ¹é…\n  ipcMain.handle('face:unmatch', async (_, faceId: number) => {\n    try {\n      const { faceMatchingService } = await import('../services/faceMatchingService.js')\n      return await faceMatchingService.unmatchFace(faceId)\n    } catch (error) {\n      console.error('[IPC] å–æ¶ˆåŒ¹é…å¤±è´¥:', error)\n      return false\n    }\n  })\n\n  // åˆå¹¶äººç‰©\n  ipcMain.handle('face:merge-persons', async (_, sourcePersonId: number, targetPersonId: number) => {\n    try {\n      const { faceMatchingService } = await import('../services/faceMatchingService.js')\n      return await faceMatchingService.mergePersons(sourcePersonId, targetPersonId)\n    } catch (error) {\n      console.error('[IPC] åˆå¹¶äººç‰©å¤±è´¥:', error)\n      return { success: false, merged: 0, error: String(error) }\n    }\n  })\n\n  // è·å–åŒ¹é…ç»Ÿè®¡\n  ipcMain.handle('face:get-matching-stats', async () => {\n    try {\n      const { faceMatchingService } = await import('../services/faceMatchingService.js')\n      return faceMatchingService.getStats()\n    } catch (error) {\n      return { totalFaces: 0, matchedFaces: 0, unmatchedFaces: 0, matchRate: 0 }\n    }\n  })\n\n  // ==================== è´¨é‡éªŒè¯ç›¸å…³ ====================\n\n  // éªŒè¯èšç±»è´¨é‡\n  ipcMain.handle('quality:validate-clustering', async () => {\n    try {\n      const { qualityValidationService } = await import('../services/qualityValidationService.js')\n      return await qualityValidationService.validateClustering()\n    } catch (error) {\n      console.error('[IPC] èšç±»è´¨é‡éªŒè¯å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // æµ‹è¯•è¯­ä¹‰æœç´¢\n  ipcMain.handle('quality:test-semantic', async (_, query: string) => {\n    try {\n      const { qualityValidationService } = await import('../services/qualityValidationService.js')\n      return await qualityValidationService.testSemanticSearch(query)\n    } catch (error) {\n      console.error('[IPC] è¯­ä¹‰æœç´¢æµ‹è¯•å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // è¿è¡Œæ ‡å‡†æµ‹è¯•é›†\n  ipcMain.handle('quality:run-tests', async () => {\n    try {\n      const { qualityValidationService } = await import('../services/qualityValidationService.js')\n      return await qualityValidationService.runStandardTests()\n    } catch (error) {\n      console.error('[IPC] è¿è¡Œæ ‡å‡†æµ‹è¯•å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // ç”Ÿæˆå®Œæ•´è´¨é‡æŠ¥å‘Š\n  ipcMain.handle('quality:generate-report', async () => {\n    try {\n      const { qualityValidationService } = await import('../services/qualityValidationService.js')\n      return await qualityValidationService.generateReport()\n    } catch (error) {\n      console.error('[IPC] ç”Ÿæˆè´¨é‡æŠ¥å‘Šå¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // æ£€æŸ¥å‘é‡ç»´åº¦\n  ipcMain.handle('quality:check-vectors', async () => {\n    try {\n      const { qualityValidationService } = await import('../services/qualityValidationService.js')\n      return await qualityValidationService.checkVectorDimensions()\n    } catch (error) {\n      console.error('[IPC] æ£€æŸ¥å‘é‡ç»´åº¦å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // ==================== æ€§èƒ½æµ‹è¯•ç›¸å…³ ====================\n\n  // æµ‹è¯•æœç´¢æ€§èƒ½\n  ipcMain.handle('perf:test-search', async (_, queryCount?: number) => {\n    try {\n      const { performanceTestService } = await import('../services/performanceTestService.js')\n      return await performanceTestService.testSearchPerformance(queryCount || 50)\n    } catch (error) {\n      console.error('[IPC] æœç´¢æ€§èƒ½æµ‹è¯•å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // æµ‹è¯•å†…å­˜å ç”¨\n  ipcMain.handle('perf:test-memory', async () => {\n    try {\n      const { performanceTestService } = await import('../services/performanceTestService.js')\n      return await performanceTestService.testMemoryUsage()\n    } catch (error) {\n      console.error('[IPC] å†…å­˜æµ‹è¯•å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // æµ‹è¯•å¹¶å‘\n  ipcMain.handle('perf:test-concurrency', async (_, concurrentCount?: number) => {\n    try {\n      const { performanceTestService } = await import('../services/performanceTestService.js')\n      return await performanceTestService.testConcurrency(concurrentCount || 5)\n    } catch (error) {\n      console.error('[IPC] å¹¶å‘æµ‹è¯•å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // æµ‹è¯•æ¨¡å‹åŠ è½½\n  ipcMain.handle('perf:test-models', async () => {\n    try {\n      const { performanceTestService } = await import('../services/performanceTestService.js')\n      return await performanceTestService.testModelLoading()\n    } catch (error) {\n      console.error('[IPC] æ¨¡å‹åŠ è½½æµ‹è¯•å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // è¿è¡Œå®Œæ•´æ€§èƒ½æµ‹è¯•\n  ipcMain.handle('perf:run-full', async () => {\n    try {\n      const { performanceTestService } = await import('../services/performanceTestService.js')\n      return await performanceTestService.runFullTest()\n    } catch (error) {\n      console.error('[IPC] å®Œæ•´æ€§èƒ½æµ‹è¯•å¤±è´¥:', error)\n      return { error: String(error) }\n    }\n  })\n\n  // ==================== äººè„¸å‘é‡é‡æ–°ç”Ÿæˆç›¸å…³ ====================\n\n  // å¼€å§‹é‡æ–°ç”Ÿæˆä»»åŠ¡\n  ipcMain.handle('face:regenerate-start', async (event, options: { batchSize?: number; resume?: boolean }) => {\n    try {\n      const { faceEmbeddingRegenerator } = await import('../scripts/regenerateFaceEmbeddings.js')\n      const result = await faceEmbeddingRegenerator.start({\n        batchSize: options?.batchSize || 50,\n        resumeFromCheckpoint: options?.resume !== false,\n        onProgress: (progress) => {\n          event.sender.send('face:regenerate-progress', progress)\n        }\n      })\n      return result\n    } catch (error) {\n      console.error('[IPC] å¼€å§‹é‡æ–°ç”Ÿæˆå¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // æš‚åœé‡æ–°ç”Ÿæˆä»»åŠ¡\n  ipcMain.handle('face:regenerate-pause', async () => {\n    try {\n      const { faceEmbeddingRegenerator } = await import('../scripts/regenerateFaceEmbeddings.js')\n      faceEmbeddingRegenerator.pause()\n      return { success: true }\n    } catch (error) {\n      console.error('[IPC] æš‚åœé‡æ–°ç”Ÿæˆå¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // è·å–é‡æ–°ç”Ÿæˆè¿›åº¦\n  ipcMain.handle('face:regenerate-progress', async () => {\n    try {\n      const { faceEmbeddingRegenerator } = await import('../scripts/regenerateFaceEmbeddings.js')\n      return faceEmbeddingRegenerator.getProgress()\n    } catch (error) {\n      console.error('[IPC] è·å–é‡æ–°ç”Ÿæˆè¿›åº¦å¤±è´¥:', error)\n      return { status: 'error', error: String(error) }\n    }\n  })\n\n  // é‡ç½®é‡æ–°ç”Ÿæˆè¿›åº¦\n  ipcMain.handle('face:regenerate-reset', async () => {\n    try {\n      const { faceEmbeddingRegenerator } = await import('../scripts/regenerateFaceEmbeddings.js')\n      faceEmbeddingRegenerator.reset()\n      return { success: true }\n    } catch (error) {\n      console.error('[IPC] é‡ç½®é‡æ–°ç”Ÿæˆå¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // æ‰§è¡Œé‡æ–°èšç±»\n  ipcMain.handle('face:regenerate-recluster', async () => {\n    try {\n      const { faceEmbeddingRegenerator } = await import('../scripts/regenerateFaceEmbeddings.js')\n      return await faceEmbeddingRegenerator.recluster()\n    } catch (error) {\n      console.error('[IPC] é‡æ–°èšç±»å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // æ¸…ç†ç©ºäººç‰©\n  ipcMain.handle('face:cleanup-persons', async () => {\n    try {\n      const { faceEmbeddingRegenerator } = await import('../scripts/regenerateFaceEmbeddings.js')\n      return faceEmbeddingRegenerator.cleanupEmptyPersons()\n    } catch (error) {\n      console.error('[IPC] æ¸…ç†ç©ºäººç‰©å¤±è´¥:', error)\n      return { deleted: 0, error: String(error) }\n    }\n  })\n\n  // ==================== æ‰«æä»»åŠ¡ç›¸å…³ ====================\n\n  // è·å–æ´»è·ƒæ‰«æä»»åŠ¡\n  ipcMain.handle('scan-job:get-active', async () => {\n    try {\n      if (!scanJobService) {\n        return { success: false, error: 'ScanJobService not available', job: null }\n      }\n      const job = scanJobService.getActiveJob()\n      return { success: true, job }\n    } catch (error) {\n      console.error('[IPC] è·å–æ´»è·ƒæ‰«æä»»åŠ¡å¤±è´¥:', error)\n      return { success: false, error: String(error), job: null }\n    }\n  })\n\n  // æ¢å¤æ‰«æä»»åŠ¡\n  ipcMain.handle('scan-job:resume', async (event, jobId: string) => {\n    try {\n      if (!scanJobService || !database) {\n        return { success: false, error: 'Services not available' }\n      }\n\n      const job = scanJobService.getJobById(jobId)\n      if (!job) {\n        return { success: false, error: 'Job not found' }\n      }\n\n      if (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled') {\n        return { success: false, error: 'Job is not resumable', status: job.status }\n      }\n\n      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ\n      if (scanJobService.isJobStale(job)) {\n        scanJobService.markJobAsFailed(jobId)\n        return { success: false, error: 'Job is stale (>5min no heartbeat), marked as failed' }\n      }\n\n      console.log(`[IPC] æ¢å¤æ‰«æä»»åŠ¡: ${jobId}, ä» lastProcessedId: ${job.lastProcessedId}`)\n\n      // ä½¿ç”¨ FaceDetectionQueue ä»æ–­ç‚¹ç»­ä¼ \n      const { FaceDetectionQueue } = await import('../services/faceDetectionQueue.js')\n      const queue = new FaceDetectionQueue(database, {\n        maxConcurrent: 1,\n        onProgress: (progress) => {\n          if (mainWindow) {\n            mainWindow.webContents.send('face:progress', {\n              current: progress.completed,\n              total: progress.total,\n              percent: progress.total > 0 ? Math.round((progress.completed / progress.total) * 100) : 0,\n              status: progress.status\n            })\n          }\n        },\n        onComplete: (stats) => {\n          console.log(`[IPC] æ¢å¤æ‰«æå®Œæˆ: ${stats.completed}/${stats.total}, æ£€æµ‹åˆ° ${stats.detectedFaces} å¼ äººè„¸`)\n          if (mainWindow) {\n            mainWindow.webContents.send('face:scan-complete', {\n              total: stats.total,\n              completed: stats.completed,\n              failed: stats.failed,\n              detectedFaces: stats.detectedFaces\n            })\n          }\n        }\n      })\n\n      // è®¾ç½®å½“å‰ä»»åŠ¡ID\n      queue.startScanJob(job.totalPhotos)\n\n      // ä»æ–­ç‚¹ç»­ä¼ \n      const addedCount = await queue.resumeFromCheckpoint(job.lastProcessedId || 0, 1000)\n\n      if (addedCount === 0) {\n        return { success: true, message: 'No more photos to process', addedCount: 0 }\n      }\n\n      // å¯åŠ¨å¤„ç†\n      await queue.forceStart()\n\n      return { success: true, message: 'Job resumed', addedCount, jobId }\n    } catch (error) {\n      console.error('[IPC] æ¢å¤æ‰«æä»»åŠ¡å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // è·å–æ‰«æä»»åŠ¡ç»Ÿè®¡\n  ipcMain.handle('scan-job:get-stats', async () => {\n    try {\n      if (!scanJobService) {\n        return { success: false, error: 'ScanJobService not available' }\n      }\n      const stats = scanJobService.getStats()\n      return { success: true, stats }\n    } catch (error) {\n      console.error('[IPC] è·å–æ‰«æä»»åŠ¡ç»Ÿè®¡å¤±è´¥:', error)\n      return { success: false, error: String(error) }\n    }\n  })\n\n  // è·å–æ‰€æœ‰æ‰«æä»»åŠ¡\n  ipcMain.handle('scan-job:get-all', async (_, limit?: number) => {\n    try {\n      if (!scanJobService) {\n        return { success: false, error: 'ScanJobService not available', jobs: [] }\n      }\n      const jobs = scanJobService.getAllJobs(limit || 100)\n      return { success: true, jobs }\n    } catch (error) {\n      console.error('[IPC] è·å–æ‰«æä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error)\n      return { success: false, error: String(error), jobs: [] }\n    }\n  })\n\n  // ==================== äººç‰©æœç´¢ç›¸å…³ ====================\n\n  // æœç´¢äººç‰©\n  ipcMain.handle('people:search', async (_, options: { query: string; limit?: number; offset?: number; sortBy?: 'count' | 'recent' | 'oldest' }) => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      return await personSearchService.search(options)\n    } catch (error) {\n      console.error('[IPC] æœç´¢äººç‰©å¤±è´¥:', error)\n      return { results: [], total: 0, query: options.query, processingTimeMs: 0 }\n    }\n  })\n\n  // è·å–äººç‰©ç…§ç‰‡\n  ipcMain.handle('people:get-photos', async (_, filter: { personId: number; year?: number; month?: number; limit?: number; offset?: number }) => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      return await personSearchService.getPersonPhotos(filter)\n    } catch (error) {\n      console.error('[IPC] è·å–äººç‰©ç…§ç‰‡å¤±è´¥:', error)\n      return null\n    }\n  })\n\n  // è·å–äººç‰©æ—¶é—´çº¿\n  ipcMain.handle('people:get-timeline', async (_, personId: number) => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      return await personSearchService.getPersonTimeline(personId)\n    } catch (error) {\n      console.error('[IPC] è·å–æ—¶é—´çº¿å¤±è´¥:', error)\n      return {}\n    }\n  })\n\n  // è·å–æœç´¢å»ºè®®\n  ipcMain.handle('people:get-suggestions', async (_, query: string, limit?: number) => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      return personSearchService.getSuggestions(query, limit)\n    } catch (error) {\n      console.error('[IPC] è·å–å»ºè®®å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // è·å–çƒ­é—¨äººç‰©\n  ipcMain.handle('people:get-popular', async (_, limit?: number) => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      return personSearchService.getPopularPersons(limit)\n    } catch (error) {\n      console.error('[IPC] è·å–çƒ­é—¨äººç‰©å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // è·å–äººç‰©ç»Ÿè®¡\n  ipcMain.handle('people:get-search-stats', async () => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      return personSearchService.getStats()\n    } catch (error) {\n      return { totalPersons: 0, totalTaggedPhotos: 0, avgPhotosPerPerson: 0 }\n    }\n  })\n\n  // è·å–æœç´¢å†å²\n  ipcMain.handle('people:get-search-history', async () => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      return personSearchService.getSearchHistory()\n    } catch (error) {\n      return []\n    }\n  })\n\n  // æ·»åŠ æœç´¢å†å²\n  ipcMain.handle('people:add-search-history', async (_, query: string) => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      personSearchService.addToHistory(query)\n      return { success: true }\n    } catch (error) {\n      return { success: false }\n    }\n  })\n\n  // æ¸…ç©ºæœç´¢å†å²\n  ipcMain.handle('people:clear-search-history', async () => {\n    try {\n      const { personSearchService } = await import('../services/personSearchService.js')\n      personSearchService.clearHistory()\n      return { success: true }\n    } catch (error) {\n      return { success: false }\n    }\n  })\n\n  // ==================== é…ç½®ç›¸å…³ ====================\n\n  // è·å–åº”ç”¨é…ç½®\n  ipcMain.handle('config:get', async () => {\n    try {\n      const configService = getConfigService()\n      return configService.getConfig()\n    } catch (error) {\n      console.error('è·å–é…ç½®å¤±è´¥:', error)\n      return null\n    }\n  })\n\n  // è®¾ç½® API Key\n  ipcMain.handle('config:set-api-key', async (event, apiKey: string) => {\n    try {\n      const configService = getConfigService()\n      configService.setApiKey(apiKey)\n      return { success: true }\n    } catch (error) {\n      console.error('è®¾ç½® API Key å¤±è´¥:', error)\n      return { success: false, error: (error as Error).message }\n    }\n  })\n\n  // è·å– LLM é…ç½®çŠ¶æ€\n  ipcMain.handle('config:get-llm-status', async () => {\n    try {\n      const configService = getConfigService()\n      const config = configService.getLLMConfig()\n      return {\n        configured: configService.isLLMConfigured(),\n        provider: config.provider,\n        hasApiKey: !!config.apiKey\n      }\n    } catch (error) {\n      console.error('è·å– LLM çŠ¶æ€å¤±è´¥:', error)\n      return { configured: false, provider: 'none', hasApiKey: false }\n    }\n  })\n\n  // è®¾ç½®ä¸»é¢˜\n  ipcMain.handle('config:set-theme', async (event, theme: string) => {\n    try {\n      const configService = getConfigService()\n      configService.setTheme(theme as 'light' | 'dark' | 'system')\n      return { success: true }\n    } catch (error) {\n      console.error('è®¾ç½®ä¸»é¢˜å¤±è´¥:', error)\n      return { success: false, error: (error as Error).message }\n    }\n  })\n\n  // ==================== æœç´¢å»ºè®®ç›¸å…³ ====================\n\n  // è·å–æœç´¢å»ºè®®\n  ipcMain.handle('suggestions:get', async (event, query: string) => {\n    try {\n      const suggestions = suggestionService?.getSuggestions(query) || []\n      return suggestions\n    } catch (error) {\n      console.error('è·å–æœç´¢å»ºè®®å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // æ·»åŠ æœç´¢åˆ°å†å²\n  ipcMain.handle('suggestions:add-history', async (event, query: string, resultCount: number) => {\n    try {\n      suggestionService?.addToHistory(query, resultCount)\n      return { success: true }\n    } catch (error) {\n      console.error('æ·»åŠ æœç´¢å†å²å¤±è´¥:', error)\n      return { success: false }\n    }\n  })\n\n  // è·å–æœç´¢å†å²\n  ipcMain.handle('suggestions:get-history', async () => {\n    try {\n      return suggestionService?.getHistory() || []\n    } catch (error) {\n      console.error('è·å–æœç´¢å†å²å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // æ¸…ç©ºæœç´¢å†å²\n  ipcMain.handle('suggestions:clear-history', async () => {\n    try {\n      suggestionService?.clearHistory()\n      return { success: true }\n    } catch (error) {\n      console.error('æ¸…ç©ºæœç´¢å†å²å¤±è´¥:', error)\n      return { success: false }\n    }\n  })\n\n  // è·å–çƒ­é—¨æœç´¢\n  ipcMain.handle('suggestions:get-popular', async () => {\n    try {\n      return suggestionService?.getPopularSearches() || []\n    } catch (error) {\n      console.error('è·å–çƒ­é—¨æœç´¢å¤±è´¥:', error)\n      return []\n    }\n  })\n\n  // ==================== ç³»ç»Ÿç›¸å…³ ====================\n\n  // è·å–åº”ç”¨ç‰ˆæœ¬\n  ipcMain.handle('app:get-version', () => {\n    return app.getVersion()\n  })\n\n  // æœ€å°åŒ–çª—å£\n  ipcMain.handle('window:minimize', () => {\n    mainWindow?.minimize()\n  })\n\n  // æœ€å¤§åŒ–/è¿˜åŸçª—å£\n  ipcMain.handle('window:maximize', () => {\n    if (mainWindow) {\n      if (mainWindow.isMaximized()) {\n        mainWindow.unmaximize()\n      } else {\n        mainWindow.maximize()\n      }\n    }\n  })\n\n  // å…³é—­çª—å£\n  ipcMain.handle('window:close', () => {\n    mainWindow?.close()\n  })\n\n  console.log('IPC å¤„ç†ç¨‹åºå·²æ³¨å†Œ')\n}\n\n// ==================== æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨ ====================\n\nfunction generateMockPhotos(limit: number, offset: number): any[] {\n  const photos: any[] = []\n  const locations = [\n    { name: 'æ—¥æœ¬ä¸œäº¬', lat: 35.6762, lng: 139.6503 },\n    { name: 'æ–°ç–†ä¹Œé²æœ¨é½', lat: 43.8256, lng: 87.6168 },\n    { name: 'åŒ—äº¬', lat: 39.9042, lng: 116.4074 },\n    { name: 'ä¸Šæµ·', lat: 31.2304, lng: 121.4737 },\n    { name: 'å®¶é‡Œ', lat: 39.9042, lng: 116.4074 }\n  ]\n\n  for (let i = offset; i < offset + limit; i++) {\n    const year = 2015 + Math.floor(i / 100)\n    const month = (i % 12) + 1\n    const day = (i % 28) + 1\n\n    photos.push({\n      id: i,\n      uuid: `photo-${i}`,\n      cloudId: `cloud-${i}`,\n      fileName: `IMG_${year}${String(month).padStart(2, '0')}${String(day).padStart(2, '0')}_${i}.jpg`,\n      fileSize: Math.floor(Math.random() * 5000000) + 1000000,\n      width: 4032,\n      height: 3024,\n      takenAt: `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T10:30:00Z`,\n      exif: {\n        camera: 'iPhone 15 Pro Max',\n        lens: 'f/1.8',\n        iso: 100,\n        aperture: 1.8,\n        shutterSpeed: '1/120'\n      },\n      location: locations[i % locations.length],\n      status: 'icloud',\n      thumbnailPath: null\n    })\n  }\n\n  return photos\n}\n\nfunction generateMockPeople(): any[] {\n  return [\n    { id: 1, name: 'çˆ¸çˆ¸', face_count: 156 },\n    { id: 2, name: 'å¦ˆå¦ˆ', face_count: 142 },\n    { id: 3, name: 'å„¿å­', face_count: 89 },\n    { id: 4, name: 'æˆ‘', face_count: 234 },\n    { id: 5, name: 'çˆ·çˆ·å¥¶å¥¶', face_count: 67 }\n  ]\n}\n\nfunction generateMockPlaces(): any[] {\n  return [\n    { place_name: 'æ—¥æœ¬ä¸œäº¬', photo_count: 245 },\n    { place_name: 'æ–°ç–†', photo_count: 189 },\n    { place_name: 'åŒ—äº¬', photo_count: 156 },\n    { place_name: 'ä¸Šæµ·', photo_count: 98 },\n    { place_name: 'å®¶é‡Œ', photo_count: 423 }\n  ]\n}\n\nfunction generateMockAlbums(): any[] {\n  return [\n    { id: 'smart-places', name: 'æŒ‰åœ°ç‚¹æµè§ˆ', type: 'smart', items: generateMockPlaces() },\n    { id: 'smart-people', name: 'æŒ‰äººç‰©æµè§ˆ', type: 'smart', items: generateMockPeople() }\n  ]\n}\n\n/**\n * ä»æ–‡ä»¶è·¯å¾„æå–ç…§ç‰‡ UUID\n */\nfunction extractPhotoUuidFromPath(path: string): string | null {\n  // å‡è®¾è·¯å¾„æ ¼å¼: /path/to/photos/{UUID}/{filename}\n  const match = path.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i)\n  return match ? match[1] : null\n}\n\n// ==================== åº”ç”¨ç”Ÿå‘½å‘¨æœŸ ====================\n\napp.whenReady().then(async () => {\n  // æ³¨å†Œè‡ªå®šä¹‰åè®®ï¼ˆå¿…é¡»åœ¨åˆ›å»ºçª—å£ä¹‹å‰ï¼‰\n  registerLocalResourceProtocol()\n\n  // åˆ›å»ºçª—å£å‰å…ˆåˆå§‹åŒ–æœåŠ¡\n  await initServices()\n\n  // ğŸ†• æ£€æŸ¥å¹¶æ¢å¤æœªå®Œæˆçš„æ‰«æä»»åŠ¡\n  await checkAndRecoverScanJob()\n\n  setupIPCHandlers()\n  createWindow()\n\n  app.on('activate', () => {\n    if (BrowserWindow.getAllWindows().length === 0) {\n      createWindow()\n    }\n  })\n})\n\napp.on('window-all-closed', () => {\n  // å…³é—­æ•°æ®åº“è¿æ¥\n  database?.close()\n\n  if (process.platform !== 'darwin') {\n    app.quit()\n  }\n})\n\napp.on('before-quit', () => {\n  database?.close()\n})\n\n// æœªæ•è·çš„å¼‚å¸¸å¤„ç†\nprocess.on('uncaughtException', (error) => {\n  console.error('æœªæ•è·çš„å¼‚å¸¸:', error)\n})\n\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.error('æœªå¤„ç†çš„ Promise æ‹’ç»:', reason)\n})\n"],"names":["database","PROJECT_ROOT","__dirname","configService","crypto","thumbnailSvc","uuidv4","fs","getEmbeddingService","ipcMain","BrowserWindow","resolve","textPreprocessor","similarityService","searchService","faceDetectionService","FaceDetectionQueue","faceDetectionQueue","faceMatchingService"],"mappings":"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","x_google_ignoreList":[5,6,7,8]}