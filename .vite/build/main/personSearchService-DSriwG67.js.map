{"version":3,"file":"personSearchService-DSriwG67.js","sources":["../../../electron/services/personSearchService.ts"],"sourcesContent":["/**\n * PhotoMind - 人物搜索服务\n *\n * 功能：\n * 1. 按人物姓名搜索\n * 2. 获取人物照片列表\n * 3. 时间线筛选\n * 4. 搜索建议和历史\n */\nimport { PhotoDatabase } from '../database/db.js'\nimport { personService, Person } from './personService.js'\n\nexport interface PersonSearchOptions {\n  query: string\n  limit?: number\n  offset?: number\n  sortBy?: 'recent' | 'oldest' | 'count'\n  year?: number\n  month?: number\n}\n\nexport interface PersonPhotoFilter {\n  personId: number\n  year?: number\n  month?: number\n  limit?: number\n  offset?: number\n}\n\nexport interface PersonSearchResult {\n  person: Person\n  matchScore: number\n  matchedField: string\n  photoCount: number\n}\n\nexport interface PersonPhotoResult {\n  photo: any\n  taggedAt: string\n  confidence: number\n}\n\nexport interface PersonSearchResponse {\n  results: PersonSearchResult[]\n  total: number\n  query: string\n  processingTimeMs: number\n}\n\nexport interface PersonPhotosResponse {\n  person: Person\n  photos: PersonPhotoResult[]\n  total: number\n  stats: {\n    totalPhotos: number\n    years: number[]\n    earliestPhoto?: string\n    latestPhoto?: string\n  }\n}\n\nexport interface PersonSuggestion {\n  id: number\n  name: string\n  photoCount: number\n}\n\nexport class PersonSearchService {\n  private database: PhotoDatabase\n  private searchHistory: string[] = []\n  private readonly MAX_HISTORY = 50\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || new PhotoDatabase()\n  }\n\n  /**\n   * 搜索人物\n   */\n  async search(options: PersonSearchOptions): Promise<PersonSearchResponse> {\n    const startTime = Date.now()\n    const { query, limit = 20, offset = 0, sortBy = 'count' } = options\n\n    console.log(`[PersonSearch] 搜索人物: \"${query}\"`)\n\n    const allPersons = personService.getAllPersons()\n\n    if (!query || query.trim() === '') {\n      const sorted = this.sortPersons(allPersons, sortBy)\n      const paged = sorted.slice(offset, offset + limit)\n\n      return {\n        results: paged.map(person => ({\n          person,\n          matchScore: 1,\n          matchedField: 'name',\n          photoCount: person.face_count\n        })),\n        total: allPersons.length,\n        query,\n        processingTimeMs: Date.now() - startTime\n      }\n    }\n\n    const searchTerms = query.toLowerCase().split(/\\s+/)\n    const results: PersonSearchResult[] = []\n\n    for (const person of allPersons) {\n      const result = this.matchPerson(person, searchTerms)\n      if (result) {\n        results.push(result)\n      }\n    }\n\n    results.sort((a, b) => {\n      switch (sortBy) {\n        case 'recent':\n          return (b.person.created_at || '').localeCompare(a.person.created_at || '')\n        case 'oldest':\n          return (a.person.created_at || '').localeCompare(b.person.created_at || '')\n        case 'count':\n        default:\n          return b.photoCount - a.photoCount\n      }\n    })\n\n    const total = results.length\n    const paged = results.slice(offset, offset + limit)\n\n    console.log(`[PersonSearch] 找到 ${total} 个人物`)\n\n    return {\n      results: paged,\n      total,\n      query,\n      processingTimeMs: Date.now() - startTime\n    }\n  }\n\n  /**\n   * 匹配人物\n   */\n  private matchPerson(person: Person, searchTerms: string[]): PersonSearchResult | null {\n    const name = person.name.toLowerCase()\n    const displayName = person.display_name.toLowerCase()\n\n    let maxScore = 0\n    let matchedField = ''\n\n    for (const term of searchTerms) {\n      if (name === term || displayName === term) {\n        return {\n          person,\n          matchScore: 1.0,\n          matchedField: 'name',\n          photoCount: person.face_count\n        }\n      }\n\n      if (name.startsWith(term) || displayName.startsWith(term)) {\n        maxScore = Math.max(maxScore, 0.9)\n        matchedField = 'name'\n      }\n\n      if (name.includes(term) || displayName.includes(term)) {\n        maxScore = Math.max(maxScore, 0.7)\n        matchedField = 'name'\n      }\n    }\n\n    if (maxScore > 0) {\n      return {\n        person,\n        matchScore: maxScore,\n        matchedField,\n        photoCount: person.face_count\n      }\n    }\n\n    return null\n  }\n\n  /**\n   * 排序人物\n   */\n  private sortPersons(persons: Person[], sortBy: string): Person[] {\n    switch (sortBy) {\n      case 'recent':\n        return [...persons].sort((a, b) =>\n          (b.created_at || '').localeCompare(a.created_at || '')\n        )\n      case 'oldest':\n        return [...persons].sort((a, b) =>\n          (a.created_at || '').localeCompare(b.created_at || '')\n        )\n      case 'count':\n      default:\n        return [...persons].sort((a, b) => b.face_count - a.face_count)\n    }\n  }\n\n  /**\n   * 获取某人物的照片\n   */\n  async getPersonPhotos(filter: PersonPhotoFilter): Promise<PersonPhotosResponse> {\n    const { personId, year, month, limit = 50, offset = 0 } = filter\n\n    console.log(`[PersonSearch] 获取人物 ${personId} 的照片`)\n\n    const person = personService.getPersonById(personId)\n    if (!person) {\n      throw new Error('人物不存在')\n    }\n\n    let photos = personService.getPersonPhotos(personId)\n\n    if (year) {\n      photos = photos.filter((p: any) => {\n        const takenAt = p.taken_at || p.takenAt\n        if (!takenAt) return false\n        return new Date(takenAt).getFullYear() === year\n      })\n    }\n\n    if (month !== undefined && year) {\n      photos = photos.filter((p: any) => {\n        const takenAt = p.taken_at || p.takenAt\n        if (!takenAt) return false\n        const date = new Date(takenAt)\n        return date.getFullYear() === year && date.getMonth() === month\n      })\n    }\n\n    photos.sort((a: any, b: any) => {\n      const dateA = new Date(a.taken_at || a.takenAt || 0).getTime()\n      const dateB = new Date(b.taken_at || b.takenAt || 0).getTime()\n      return dateB - dateA\n    })\n\n    const years = new Set<number>()\n    let earliest: string | undefined\n    let latest: string | undefined\n\n    for (const photo of photos) {\n      const takenAt = photo.taken_at || photo.takenAt\n      if (takenAt) {\n        const y = new Date(takenAt).getFullYear()\n        years.add(y)\n        if (!earliest || takenAt < earliest) earliest = takenAt\n        if (!latest || takenAt > latest) latest = takenAt\n      }\n    }\n\n    const total = photos.length\n    const paged = photos.slice(offset, offset + limit)\n\n    return {\n      person,\n      photos: paged.map((p: any) => ({\n        photo: p,\n        taggedAt: p.created_at || new Date().toISOString(),\n        confidence: 1.0\n      })),\n      total,\n      stats: {\n        totalPhotos: total,\n        years: Array.from(years).sort(),\n        earliestPhoto: earliest,\n        latestPhoto: latest\n      }\n    }\n  }\n\n  /**\n   * 获取人物时间线\n   */\n  async getPersonTimeline(personId: number): Promise<Map<number, number[]>> {\n    const photos = personService.getPersonPhotos(personId)\n    const timeline = new Map<number, number[]>()\n\n    for (const photo of photos) {\n      const takenAt = photo.taken_at || photo.takenAt\n      if (takenAt) {\n        const year = new Date(takenAt).getFullYear()\n        const month = new Date(takenAt).getMonth() + 1\n\n        if (!timeline.has(year)) {\n          timeline.set(year, [])\n        }\n        timeline.get(year)?.push(month)\n      }\n    }\n\n    return timeline\n  }\n\n  /**\n   * 获取搜索建议\n   */\n  getSuggestions(query: string, limit: number = 5): PersonSuggestion[] {\n    const persons = personService.getAllPersons()\n    const searchTerm = query.toLowerCase()\n\n    return persons\n      .filter(p =>\n        p.name.toLowerCase().includes(searchTerm) ||\n        p.display_name.toLowerCase().includes(searchTerm)\n      )\n      .slice(0, limit)\n      .map(p => ({\n        id: p.id,\n        name: p.display_name,\n        photoCount: p.face_count\n      }))\n  }\n\n  /**\n   * 获取热门人物\n   */\n  getPopularPersons(limit: number = 10): Person[] {\n    const persons = personService.getAllPersons()\n    return persons\n      .sort((a, b) => b.face_count - a.face_count)\n      .slice(0, limit)\n  }\n\n  /**\n   * 获取搜索历史\n   */\n  getSearchHistory(): string[] {\n    return [...this.searchHistory]\n  }\n\n  /**\n   * 添加搜索历史\n   */\n  addToHistory(query: string): void {\n    if (!query.trim()) return\n\n    this.searchHistory = this.searchHistory.filter(h => h !== query)\n    this.searchHistory.unshift(query)\n\n    if (this.searchHistory.length > this.MAX_HISTORY) {\n      this.searchHistory = this.searchHistory.slice(0, this.MAX_HISTORY)\n    }\n  }\n\n  /**\n   * 清空搜索历史\n   */\n  clearHistory(): void {\n    this.searchHistory = []\n  }\n\n  /**\n   * 获取人物统计\n   */\n  getStats(): {\n    totalPersons: number\n    totalTaggedPhotos: number\n    avgPhotosPerPerson: number\n    mostTaggedPerson?: Person\n  } {\n    const persons = personService.getAllPersons()\n    const totalTaggedPhotos = persons.reduce((sum, p) => sum + p.face_count, 0)\n\n    let mostTagged: Person | undefined\n    if (persons.length > 0) {\n      mostTagged = persons.reduce((a, b) =>\n        a.face_count > b.face_count ? a : b\n      )\n    }\n\n    return {\n      totalPersons: persons.length,\n      totalTaggedPhotos,\n      avgPhotosPerPerson: persons.length > 0 ? totalTaggedPhotos / persons.length : 0,\n      mostTaggedPerson: mostTagged\n    }\n  }\n}\n\nexport const personSearchService = new PersonSearchService()\n"],"names":["paged"],"mappings":"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"}