{"version":3,"file":"globalSearchService-DwFw3EOb.js","sources":["../../../electron/services/globalSearchService.ts"],"sourcesContent":["/**\n * PhotoMind - 全局向量搜索服务\n *\n * 功能：\n * 1. 全局语义向量搜索\n * 2. 相似照片查找\n * 3. 批量搜索\n * 4. 搜索结果分页\n */\nimport { PhotoDatabase } from '../database/db.js'\nimport { getEmbeddingService } from './embeddingService.js'\nimport { textPreprocessor } from './textPreprocessor.js'\nimport { similarityService } from './similarityService.js'\n\nexport interface GlobalSearchOptions {\n  query: string\n  topK?: number\n  minSimilarity?: number\n  page?: number\n  pageSize?: number\n  includeMetadata?: boolean\n}\n\nexport interface GlobalSearchResult {\n  photoUuid: string\n  fileName: string\n  filePath: string\n  similarity: number\n  rank: number\n  thumbnailPath?: string\n  takenAt?: string\n  highlights?: string[]\n}\n\nexport interface GlobalSearchResponse {\n  results: GlobalSearchResult[]\n  total: number\n  page: number\n  pageSize: number\n  processingTimeMs: number\n  query: {\n    original: string\n    processed: string\n    vectorDimension: number\n  }\n}\n\nexport class GlobalSearchService {\n  private database: PhotoDatabase\n\n  constructor(database?: PhotoDatabase) {\n    this.database = database || new PhotoDatabase()\n  }\n\n  /**\n   * 执行全局向量搜索\n   */\n  async search(options: GlobalSearchOptions): Promise<GlobalSearchResponse> {\n    const startTime = Date.now()\n    const {\n      query,\n      topK = 100,\n      minSimilarity = 0.1,\n      page = 1,\n      pageSize = 20,\n      includeMetadata = false\n    } = options\n\n    // 1. 预处理查询\n    const processed = textPreprocessor.preprocess(query)\n    console.log(`[GlobalSearch] 预处理查询: \"${processed.processed}\"`)\n\n    // 2. 生成查询向量\n    const embeddingService = getEmbeddingService()\n    const embeddingResult = await embeddingService.textToEmbedding(processed.processed)\n\n    if (!embeddingResult.success || !embeddingResult.vector) {\n      console.error('[GlobalSearch] 向量生成失败')\n      return {\n        results: [],\n        total: 0,\n        page,\n        pageSize,\n        processingTimeMs: Date.now() - startTime,\n        query: {\n          original: query,\n          processed: processed.processed,\n          vectorDimension: 0\n        }\n      }\n    }\n\n    console.log(`[GlobalSearch] 向量生成成功，维度: ${embeddingResult.vector.length}`)\n\n    // 3. 获取所有照片向量\n    const allEmbeddings = await this.database.getAllEmbeddings('image')\n    console.log(`[GlobalSearch] 获取 ${allEmbeddings.length} 个向量`)\n\n    if (allEmbeddings.length === 0) {\n      return {\n        results: [],\n        total: 0,\n        page,\n        pageSize,\n        processingTimeMs: Date.now() - startTime,\n        query: {\n          original: query,\n          processed: processed.processed,\n          vectorDimension: embeddingResult.vector.length\n        }\n      }\n    }\n\n    // 4. 计算相似度\n    const similarities = similarityService.batchSimilarity(\n      embeddingResult.vector,\n      allEmbeddings\n    )\n    console.log(`[GlobalSearch] 相似度计算完成`)\n\n    // 5. 过滤和排序\n    const filtered = similarities\n      .filter(sim => sim.similarity >= minSimilarity)\n      .sort((a, b) => b.similarity - a.similarity)\n      .slice(0, topK)\n\n    console.log(`[GlobalSearch] 过滤后 ${filtered.length} 个结果`)\n\n    // 6. 构建结果\n    const results: GlobalSearchResult[] = []\n\n    for (let i = 0; i < filtered.length; i++) {\n      const item = filtered[i]\n      const photo = this.database.getPhotoByUuid(item.id)\n\n      if (photo) {\n        const result: GlobalSearchResult = {\n          photoUuid: item.id,\n          fileName: photo.file_name,\n          filePath: photo.file_path,\n          similarity: item.similarity,\n          rank: i + 1,\n          thumbnailPath: photo.thumbnail_path\n        }\n\n        if (includeMetadata) {\n          result.takenAt = photo.taken_at\n        }\n\n        results.push(result)\n      }\n    }\n\n    // 7. 分页\n    const startIndex = (page - 1) * pageSize\n    const pagedResults = results.slice(startIndex, startIndex + pageSize)\n\n    const processingTime = Date.now() - startTime\n    console.log(`[GlobalSearch] 搜索完成，耗时 ${processingTime}ms`)\n\n    return {\n      results: pagedResults,\n      total: results.length,\n      page,\n      pageSize,\n      processingTimeMs: processingTime,\n      query: {\n        original: query,\n        processed: processed.processed,\n        vectorDimension: embeddingResult.vector.length\n      }\n    }\n  }\n\n  /**\n   * 快速搜索（简化版）\n   */\n  async quickSearch(query: string, topK: number = 10): Promise<GlobalSearchResult[]> {\n    const result = await this.search({\n      query,\n      topK,\n      minSimilarity: 0.05,\n      page: 1,\n      pageSize: topK\n    })\n    return result.results\n  }\n\n  /**\n   * 获取相似照片\n   */\n  async findSimilarPhotos(\n    photoUuid: string,\n    topK: number = 10\n  ): Promise<GlobalSearchResult[]> {\n    const startTime = Date.now()\n\n    // 1. 获取目标照片向量\n    const embeddings = await this.database.getAllEmbeddings('image')\n    const targetEmbedding = embeddings.find(e => e.photoUuid === photoUuid)\n\n    if (!targetEmbedding) {\n      console.error('[GlobalSearch] 未找到目标照片的向量')\n      return []\n    }\n\n    console.log(`[GlobalSearch] 查找 ${photoUuid} 的相似照片`)\n\n    // 2. 计算相似度（排除自身）\n    const otherEmbeddings = embeddings.filter(e => e.photoUuid !== photoUuid)\n    const similarities = similarityService.batchSimilarity(\n      targetEmbedding.vector,\n      otherEmbeddings\n    )\n\n    // 3. 排序取 Top-K\n    const sorted = similarities\n      .sort((a, b) => b.similarity - a.similarity)\n      .slice(0, topK)\n\n    // 4. 构建结果\n    const results: GlobalSearchResult[] = []\n\n    for (let i = 0; i < sorted.length; i++) {\n      const item = sorted[i]\n      const photo = this.database.getPhotoByUuid(item.id)\n\n      if (photo) {\n        results.push({\n          photoUuid: item.id,\n          fileName: photo.file_name,\n          filePath: photo.file_path,\n          similarity: item.similarity,\n          rank: i + 1,\n          thumbnailPath: photo.thumbnail_path,\n          takenAt: photo.taken_at\n        })\n      }\n    }\n\n    console.log(`[GlobalSearch] 相似照片搜索耗时 ${Date.now() - startTime}ms`)\n    return results\n  }\n\n  /**\n   * 批量搜索（多查询融合）\n   */\n  async batchSearch(\n    queries: string[],\n    options: { topK?: number; minSimilarity?: number } = {}\n  ): Promise<GlobalSearchResponse[]> {\n    const { topK = 50, minSimilarity = 0.1 } = options\n\n    const results: GlobalSearchResponse[] = []\n\n    for (const query of queries) {\n      const result = await this.search({\n        query,\n        topK,\n        minSimilarity\n      })\n      results.push(result)\n    }\n\n    return results\n  }\n\n  /**\n   * 搜索统计\n   */\n  async getStats(): Promise<{\n    totalPhotos: number\n    totalEmbeddings: number\n    coverage: number\n  }> {\n    const photos = this.database.getAllPhotos()\n    const embeddings = await this.database.getAllEmbeddings('image')\n\n    return {\n      totalPhotos: photos.length,\n      totalEmbeddings: embeddings.length,\n      coverage: photos.length > 0 ? embeddings.length / photos.length : 0\n    }\n  }\n}\n\nexport const globalSearchService = new GlobalSearchService()\n"],"names":[],"mappings":"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"}