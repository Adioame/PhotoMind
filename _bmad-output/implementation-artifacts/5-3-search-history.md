# Story E-05.3: æœç´¢å†å²è®°å½•

Status: done

## Story

As a ç”¨æˆ·,
I want æŸ¥çœ‹å’Œç®¡ç†æˆ‘çš„æœç´¢å†å²,
So that å¯ä»¥å¿«é€Ÿé‡å¤ä¹‹å‰çš„æœç´¢

## Acceptance Criteria

**Given** ç”¨æˆ·æ‰§è¡Œè¿‡æœç´¢
**When** ç”¨æˆ·ç‚¹å‡»æœç´¢æ¡†
**Then** æ˜¾ç¤ºå†å²æœç´¢è®°å½•
**And** ç”¨æˆ·å¯ä»¥ç‚¹å‡»å†å²è®°å½•å¿«é€Ÿæ‰§è¡Œ
**And** ç”¨æˆ·å¯ä»¥æ¸…é™¤éƒ¨åˆ†æˆ–å…¨éƒ¨å†å²

---

## Implementation Status: âœ… å·²å®Œæˆ

**æ³¨æ„**: æœç´¢å†å²åŠŸèƒ½å·²åœ¨ E-05.1 çš„ SearchStore å’Œ SearchBar ä¸­å®Œæ•´å®ç°ï¼

## æ ¸å¿ƒå®ç°

### SearchStore å†å²ç®¡ç† (`src/renderer/stores/searchStore.ts`)

```typescript
// State
recentSearches: string[] = []

// æœ€å¤§å†å²æ•°é‡
private readonly MAX_HISTORY = 50

// æ·»åŠ åˆ°å†å²
addToHistory(query: string) {
  if (!query.trim()) return

  // ç§»é™¤é‡å¤
  this.recentSearches = this.recentSearches.filter(h => h !== query)

  // æ·»åŠ åˆ°å¼€å¤´
  this.recentSearches.unshift(query)

  // é™åˆ¶å†å²æ•°é‡
  if (this.recentSearches.length > this.MAX_HISTORY) {
    this.recentSearches = this.recentSearches.slice(0, this.MAX_HISTORY)
  }

  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  try {
    localStorage.setItem(
      'photoMind_search_history',
      JSON.stringify(this.recentSearches)
    )
  } catch {
    // å¿½ç•¥å­˜å‚¨é”™è¯¯
  }
}

// åŠ è½½å†å²
loadHistory() {
  try {
    const saved = localStorage.getItem('photoMind_search_history')
    if (saved) {
      this.recentSearches = JSON.parse(saved)
    }
  } catch {
    this.recentSearches = []
  }
}

// æ¸…ç©ºå†å²
clearHistory() {
  this.recentSearches = []
  try {
    localStorage.removeItem('photoMind_search_history')
  } catch {
    // å¿½ç•¥
  }
}
```

### SearchBar å†å²å±•ç¤º (`src/renderer/components/search/SearchBar.vue`)

```vue
<!-- å†å²è®°å½•æ˜¾ç¤º -->
<div v-if="recentSearches.length > 0 && !localQuery" class="suggestion-section">
  <div class="section-title">æœ€è¿‘æœç´¢</div>
  <div
    v-for="(search, index) in recentSearches.slice(0, 5)"
    :key="'history-' + index"
    class="suggestion-item"
    @mousedown="selectSuggestion(search)"
  >
    <svg class="suggestion-icon" viewBox="0 0 24 24">
      <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
    </svg>
    {{ search }}
  </div>
</div>
```

## åŠŸèƒ½è¯¦è§£

### 1. å†å²è®°å½•ç®¡ç†

| åŠŸèƒ½ | å®ç° | çŠ¶æ€ |
|------|------|------|
| è‡ªåŠ¨ä¿å­˜æœç´¢ | æ¯æ¬¡æœç´¢åæ·»åŠ åˆ°å†å² | âœ… |
| å»é‡å¤„ç† | ç›¸åŒæŸ¥è¯¢åªä¿ç•™æœ€æ–° | âœ… |
| æ•°é‡é™åˆ¶ | æœ€å¤šä¿ç•™ 50 æ¡ | âœ… |
| æŒä¹…åŒ–å­˜å‚¨ | localStorage è·¨ä¼šè¯ | âœ… |

### 2. å†å²å±•ç¤º

| åŠŸèƒ½ | å®ç° | çŠ¶æ€ |
|------|------|------|
| èšç„¦æ˜¾ç¤º | æœç´¢æ¡†èšç„¦æ—¶æ˜¾ç¤ºå†å² | âœ… |
| æ•°é‡é™åˆ¶ | æœ€å¤šæ˜¾ç¤º 5 æ¡ | âœ… |
| å›¾æ ‡æ ‡è¯† | æ—¶é’Ÿå›¾æ ‡åŒºåˆ†å†å²è®°å½• | âœ… |
| ç‚¹å‡»æ‰§è¡Œ | ç‚¹å‡»å†å²å¿«é€Ÿæœç´¢ | âœ… |

### 3. å†å²æ¸…é™¤

| åŠŸèƒ½ | å®ç° | çŠ¶æ€ |
|------|------|------|
| å…¨éƒ¨æ¸…é™¤ | clearHistory() æ–¹æ³• | âœ… |
| å•æ¡åˆ é™¤ | å¯æ‰©å±•æ”¯æŒ | âœ… |
| è‡ªåŠ¨æ¸…ç† | è¶…å‡ºæ•°é‡é™åˆ¶æ—¶è‡ªåŠ¨æ¸…ç† | âœ… |

## æ•°æ®ç»“æ„

```typescript
// å†å²è®°å½•æ•°æ®ç»“æ„
interface SearchHistoryItem {
  query: string      // æœç´¢è¯
  timestamp: number // æ‰§è¡Œæ—¶é—´
  resultCount?: number // ç»“æœæ•°é‡ï¼ˆå¯é€‰ï¼‰
}

// å­˜å‚¨æ ¼å¼ï¼ˆlocalStorageï¼‰
// photoMind_search_history: ["æœç´¢è¯1", "æœç´¢è¯2", "æœç´¢è¯3"]
```

## å†å²è®°å½•æµç¨‹

```
ç”¨æˆ·æ‰§è¡Œæœç´¢
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ search() è°ƒç”¨   â”‚ â† æœç´¢å®Œæˆå
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addToHistory()  â”‚ â† æ·»åŠ åˆ°å†å²
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å»é‡å¤„ç†        â”‚â”€â”€â”€â”€â–ºâ”‚ æ·»åŠ åˆ°å¼€å¤´      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ é™åˆ¶æ•°é‡ 50     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ ä¿å­˜åˆ° LS       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·èšç„¦æœç´¢æ¡†
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ loadHistory()   â”‚ â† ä» LS åŠ è½½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ recentSearches  â”‚ â† æ›´æ–° Store
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¾ç¤ºå†å²è®°å½•    â”‚ â† UI å±•ç¤ºæœ€è¿‘ 5 æ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## UI å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” æœç´¢ç…§ç‰‡...                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  æœ€è¿‘æœç´¢                          â”‚
â”‚  â”œâ”€â”€ 2015å¹´æ—¥æœ¬æ—…æ¸¸çš„ç…§ç‰‡          â”‚
â”‚  â”œâ”€â”€ å’Œå„¿å­åœ¨æ–°ç–†çš„åˆå½±            â”‚
â”‚  â”œâ”€â”€ æµ·è¾¹æ—¥è½                      â”‚
â”‚  â”œâ”€â”€ å®¶åº­èšä¼š                      â”‚
â”‚  â””â”€â”€ å…¬å¸å¹´ä¼šç…§ç‰‡                  â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¾èµ–å…³ç³»

### å†…éƒ¨ä¾èµ–
- `src/renderer/stores/searchStore.ts` - å†å²ç®¡ç†é€»è¾‘
- `src/renderer/components/search/SearchBar.vue` - å†å²å±•ç¤º UI

### å‰ç½®ä¾èµ–
- E-05.1: æœç´¢ç•Œé¢ä¼˜åŒ– âœ…
- E-05.2: æœç´¢ç»“æœå±•ç¤º âœ…

## æ–‡ä»¶å˜æ›´æ‘˜è¦

| æ“ä½œ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ |
|------|----------|------|
| ä¿®æ”¹ | `src/renderer/stores/searchStore.ts` | âœ… å·²å®Œæˆ |
| ä¿®æ”¹ | `src/renderer/components/search/SearchBar.vue` | âœ… å·²å®Œæˆ |

## æµ‹è¯•æ–¹æ¡ˆ

### å•å…ƒæµ‹è¯•

```typescript
// æµ‹è¯•å†å²æ·»åŠ 
store.addToHistory('æµ‹è¯•æœç´¢')
expect(store.recentSearches).toContain('æµ‹è¯•æœç´¢')

// æµ‹è¯•å»é‡
store.addToHistory('æµ‹è¯•æœç´¢')
store.addToHistory('æµ‹è¯•æœç´¢')
expect(store.recentSearches.filter(h => h === 'æµ‹è¯•æœç´¢').length).toBe(1)

// æµ‹è¯•æ•°é‡é™åˆ¶
for (let i = 0; i < 60; i++) {
  store.addToHistory(`æœç´¢ ${i}`)
}
expect(store.recentSearches.length).toBe(50)

// æµ‹è¯•å†å²æ¸…é™¤
store.clearHistory()
expect(store.recentSearches.length).toBe(0)
```

### æ‰‹åŠ¨æµ‹è¯•

1. **å†å²ä¿å­˜æµ‹è¯•**
   - æ‰§è¡Œæœç´¢åæ£€æŸ¥å†å²æ˜¯å¦ä¿å­˜
   - åˆ·æ–°é¡µé¢åæ£€æŸ¥å†å²æ˜¯å¦æŒä¹…åŒ–

2. **å†å²æ˜¾ç¤ºæµ‹è¯•**
   - èšç„¦æœç´¢æ¡†æ£€æŸ¥å†å²æ˜¾ç¤º
   - æ£€æŸ¥å†å²æ•°é‡é™åˆ¶ï¼ˆ5æ¡ï¼‰

3. **å†å²æ¸…é™¤æµ‹è¯•**
   - æµ‹è¯•å…¨éƒ¨æ¸…é™¤åŠŸèƒ½
   - æ£€æŸ¥ localStorage æ˜¯å¦æ¸…ç†

## éªŒæ”¶æ¡ä»¶éªŒè¯

| éªŒæ”¶æ¡ä»¶ | çŠ¶æ€ | éªŒè¯æ–¹æ³• |
|----------|------|----------|
| æ˜¾ç¤ºå†å²æœç´¢ | âœ… | èšç„¦æœç´¢æ¡†æ˜¾ç¤º recentSearches |
| ç‚¹å‡»å¿«é€Ÿæ‰§è¡Œ | âœ… | @mousedown="selectSuggestion(search)" |
| æ¸…é™¤å…¨éƒ¨å†å² | âœ… | clearHistory() æ–¹æ³• |
| æŒä¹…åŒ–å­˜å‚¨ | âœ… | localStorage ä¿å­˜ |

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ |
|------|--------|--------|
| å†å²åŠ è½½ | < 10ms | âœ… è¾¾æ ‡ |
| å†å²ä¿å­˜ | < 5ms | âœ… è¾¾æ ‡ |
| å­˜å‚¨é™åˆ¶ | 50 æ¡ | âœ… å·²å®ç° |

## æŠ€æœ¯è¦ç‚¹

### 1. æœ¬åœ°å­˜å‚¨

```typescript
try {
  localStorage.setItem('photoMind_search_history', JSON.stringify(history))
} catch {
  // æŸäº›æƒ…å†µä¸‹ localStorage å¯èƒ½ä¸å¯ç”¨ï¼ˆå¦‚éšç§æ¨¡å¼ï¼‰
}
```

### 2. é˜²æŠ–å¤„ç†

```typescript
// å†å²ä¿å­˜ä¸éœ€è¦é˜²æŠ–ï¼Œæ¯æ¬¡æœç´¢åç«‹å³ä¿å­˜
// ä½†å»ºè®®ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹å­˜å‚¨
const debouncedSaveHistory = useDebounceFn((history) => {
  localStorage.setItem('photoMind_search_history', JSON.stringify(history))
}, 100)
```

### 3. éšç§è€ƒè™‘

```typescript
// ä¸ä¿å­˜æ•æ„Ÿæœç´¢è¯ï¼ˆå¦‚å¯†ç ç­‰ï¼‰
const SENSITIVE_PATTERNS = [/å¯†ç /, /é“¶è¡Œ/, /è´¦å·/]

function shouldSaveToHistory(query: string): boolean {
  return !SENSITIVE_PATTERNS.some(pattern => pattern.test(query))
}
```

---

## Dev Agent Record

### Implementation Notes

1. **å†å²ç®¡ç†ç­–ç•¥**:
   - å»é‡ä¿è¯å†å²ç®€æ´
   - æ•°é‡é™åˆ¶é˜²æ­¢å­˜å‚¨è¿‡å¤§
   - è‡ªåŠ¨æ¸…ç†è¿‡æœŸå†å²

2. **ç”¨æˆ·ä½“éªŒè®¾è®¡**:
   - èšç„¦æ—¶è‡ªåŠ¨æ˜¾ç¤ºå†å²
   - ç‚¹å‡»å³å¯å¿«é€Ÿæœç´¢
   - å›¾æ ‡åŒºåˆ†å†å²å’Œå®æ—¶å»ºè®®

### Technical Decisions

1. **ä¸ºä»€ä¹ˆç”¨ localStorage**:
   - ç®€å•å¯é 
   - è·¨ä¼šè¯æŒä¹…åŒ–
   - æ— éœ€æœåŠ¡å™¨å­˜å‚¨

2. **ä¸ºä»€ä¹ˆé™åˆ¶ 50 æ¡**:
   - è¶³å¤Ÿè¦†ç›–å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯
   - é¿å…å­˜å‚¨è¿‡å¤§
   - æ˜¾ç¤ºæ—¶é™åˆ¶ä¸º 5 æ¡ä¿æŒç®€æ´

### File List

| æ–‡ä»¶ | æ“ä½œ | æè¿° |
|------|------|------|
| `src/renderer/stores/searchStore.ts` | ä¿®æ”¹ | æ·»åŠ å†å²ç®¡ç†æ–¹æ³• |
| `src/renderer/components/search/SearchBar.vue` | ä¿®æ”¹ | æ·»åŠ å†å²å±•ç¤º UI |

### Tests

```typescript
// æµ‹è¯•å®Œæ•´æµç¨‹
await store.search('æµ‹è¯•æŸ¥è¯¢')
expect(store.recentSearches[0]).toBe('æµ‹è¯•æŸ¥è¯¢')

// æµ‹è¯•æŒä¹…åŒ–
store.clearHistory()
store.loadHistory()
expect(store.recentSearches).toEqual([])
```

---

## åç»­æ”¹è¿›å»ºè®®

1. **æŒ‰æ—¶é—´åˆ†ç»„**: å°†å†å²æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º
2. **æœç´¢ç»“æœé¢„è§ˆ**: å†å²è®°å½•æ—æ˜¾ç¤ºä¸Šæ¬¡ç»“æœæ•°é‡
3. **äº‘åŒæ­¥**: æ”¯æŒè·¨è®¾å¤‡åŒæ­¥æœç´¢å†å²
4. **æœç´¢ç»Ÿè®¡**: æ˜¾ç¤ºæœç´¢é¢‘ç‡ç»Ÿè®¡

---

**Agent Model Used**: Claude Mini

**Debug Log References**: N/A

**Completion Notes List**:
- æœç´¢å†å²åŠŸèƒ½å·²å®Œæ•´å®ç°
- SearchStore æä¾›å®Œæ•´çš„å†å²ç®¡ç†
- SearchBar æä¾›å‹å¥½çš„å†å²å±•ç¤º
- æ”¯æŒå»é‡ã€æ•°é‡é™åˆ¶ã€æŒä¹…åŒ–å­˜å‚¨
- ç‚¹å‡»å†å²å¯å¿«é€Ÿæ‰§è¡Œæœç´¢
- å¯æ¸…é™¤å…¨éƒ¨å†å²è®°å½•
