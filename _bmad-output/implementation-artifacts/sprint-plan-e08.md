# Sprint Plan: Epic E-08 双向量架构升级

**Sprint 目标**: 修复当前人物聚类质量问题，建立双向量架构（128维人脸 + 512维语义）

**Sprint 周期**: 建议 1-2 周（视 mac 的时间投入而定）

**优先级**: P1（重要非紧急，质量改进）

---

## 📊 当前状态分析

| 指标 | 数值 | 问题 |
|------|------|------|
| 人脸总数 | 1,344 | ✅ 已检测 |
| 有效人物 | 3个 | ⚠️ 过少（预期 5-10个）|
| 空人物 | 4,032个 | ❌ 需要清理 |
| 向量维度 | 6维 | ❌ 严重不足 |
| 相似度分布 | 全1.00 | ❌ 聚类失效 |

**根本原因**: 当前向量只有6维（疑似只存储了bbox坐标），而非128维人脸特征向量。

---

## 🎯 Sprint 目标（SMART）

1. **Specific**: 建立双向量基础设施，重新生成所有人脸向量
2. **Measurable**: 聚类质量达到 3-10个有效人物组，每个组 >5张人脸
3. **Achievable**: 基于现有 E-02 和 E-04 基础，技术可行
4. **Relevant**: 解决当前用户无法查看人物照片的问题
5. **Time-bound**: 1-2周内完成

---

## 📋 Story 执行顺序

### Story 1: E-08.1 双向量基础设施
**优先级**: P0（阻塞后续所有工作）
**预估时间**: 2-3小时
**依赖**: 无

**任务分解**:
1. 数据库迁移（30分钟）
   - 添加 `face_embedding` (128维 BLOB)
   - 添加 `semantic_embedding` (512维 BLOB)
   - 添加 `vector_version` 字段

2. API 修复（30分钟）
   - 修复 `peopleStore.ts` 调用方式
   - 统一使用 `getPhotos` 替代 `searchPhotos`
   - 修复 Preload 桥接

3. 双向量生成逻辑（1-2小时）
   - 修改人脸检测流程
   - 并行生成两种向量
   - 保存到数据库

**验收标准**:
- [ ] 数据库有新字段
- [ ] 点击人物能显示照片
- [ ] 新检测的人脸有双向量

---

### Story 2: E-08.2 人脸向量重新生成
**优先级**: P1（核心质量修复）
**预估时间**: 4-6小时（大部分时间是后台运行）
**依赖**: E-08.1 完成

**任务分解**:
1. 批量重处理脚本（1小时）
   - 创建断点续传脚本
   - 后台队列处理
   - 进度追踪

2. 向量生成（2-4小时，后台运行）
   - 处理 1,344 张人脸
   - 128维 face-api 向量
   - 512维 CLIP 向量

3. 重新聚类（1小时）
   - 清理现有关联
   - DBSCAN 聚类
   - 生成新人物

4. 数据清理（30分钟）
   - 删除 face_count=0 的空人物
   - 更新统计信息

**验收标准**:
- [ ] 所有 1,344 张人脸有 128维向量
- [ ] 聚类结果 3-10个有效人物
- [ ] 无单一人脸分配到多个人物

---

### Story 3: E-08.3 质量验证与优化
**优先级**: P2（质量保证）
**预估时间**: 2-3小时
**依赖**: E-08.2 完成

**任务分解**:
1. 聚类质量验证（1小时）
   - 抽样检查同一人物相似度 >0.6
   - 不同人物相似度 <0.6
   - 人工验证几个边界案例

2. 性能测试（1小时）
   - 搜索响应时间 <500ms
   - 内存占用 <500MB
   - 并发查询测试

3. 文档更新（30分钟）
   - 更新架构文档
   - 记录双向量设计决策

**验收标准**:
- [ ] 聚类质量通过人工抽查
- [ ] 性能指标达标
- [ ] 文档已更新

---

## ⏰ 时间线建议

### 方案A：密集冲刺（2-3天）
```
Day 1 (4小时): E-08.1 基础设施
Day 2 (6小时): E-08.2 向量生成（后台运行）
Day 3 (3小时): E-08.3 验证优化
```

### 方案B：分散进行（1-2周）
```
Week 1:
  - 周一: E-08.1 基础设施
  - 周二-三: E-08.2 向量生成（后台慢慢跑）

Week 2:
  - 周一: E-08.2 聚类完成
  - 周二: E-08.3 验证优化
```

---

## 🚨 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| CLIP模型加载慢 | 中 | 启动时间增加 | 使用轻量模型或延迟加载 |
| 重新聚类后人物变多 | 高 | 用户困惑 | 提供"合并人物"功能 |
| 向量生成中断 | 中 | 数据不完整 | 断点续传机制 |
| 存储空间不足 | 低 | 无法保存向量 | 提前检查磁盘空间 |

---

## 📈 成功指标

### 技术指标
- [ ] 1,344张人脸都有 128维 + 512维向量
- [ ] 聚类结果：3-10个有效人物组
- [ ] 搜索响应时间 <500ms
- [ ] 人物照片显示正常

### 用户指标
- [ ] 点击人物能看到照片
- [ ] 人物分组合理（同一人照片在一起）
- [ ] 搜索"我和妈妈在公园"返回正确结果

---

## 🔄 下一步行动

**立即执行**（由 mac 决定）：
1. **开始 E-08.1** → 运行 `create-story` 创建详细开发文档
2. **直接开发** → Amelia 直接开始编码（如果需求清晰）
3. **调整计划** → 修改优先级或时间安排

**mac，你的选择是？**
