# Epic E-07: æŠ€æœ¯å€ºåŠ¡ä¿®å¤ - ç¼©ç•¥å›¾åŠ è½½é—®é¢˜

**Goal**: ä¿®å¤ Electron + Vite å¼€å‘ç¯å¢ƒä¸‹ç¼©ç•¥å›¾æ— æ³•åŠ è½½çš„ Bugï¼Œå®ç°æœ¬åœ°èµ„æºå®‰å…¨è®¿é—®

**Type**: Bug Fix / Technical Debt

**Severity**: ğŸ”´ P0 - é˜»å¡æ€§ Bugï¼ˆ102 å¼ ç…§ç‰‡æ— æ³•æ˜¾ç¤ºï¼‰

---

## é—®é¢˜èƒŒæ™¯

### ç—‡çŠ¶æè¿°

ç”¨æˆ·åœ¨ä½¿ç”¨ PhotoMind å¯¼å…¥ç…§ç‰‡æ—¶é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

1. **å¯¼å…¥è¿‡ç¨‹æ­£å¸¸**
   - ç‚¹å‡»"å¯¼å…¥ç…§ç‰‡"é€‰æ‹©æ–‡ä»¶å¤¹
   - ç…§ç‰‡æˆåŠŸå¯¼å…¥åˆ°æ•°æ®åº“ï¼ˆå…± 102 å¼ ï¼‰
   - ç¼©ç•¥å›¾æ–‡ä»¶å·²ç”Ÿæˆï¼ˆä½äº `/Users/mac/PhotoMind/data/cache/thumbnails/`ï¼‰
   - æ•°æ®åº“ä¸­ `thumbnail_path` å­—æ®µå·²ä¿å­˜æ­£ç¡®è·¯å¾„

2. **æ˜¾ç¤ºé—®é¢˜**
   - "æœ€è¿‘ç…§ç‰‡"åŒºåŸŸæ˜¾ç¤ºç°è‰²å ä½å—
   - çœ‹ä¸åˆ°å®é™…ç…§ç‰‡å†…å®¹
   - DevTools æ§åˆ¶å°æŠ¥é”™ï¼š`Not allowed to load local resource: file:///Users/mac/PhotoMind/data/cache/thumbnails/xxx.jpg`

### æŠ€æœ¯æ ¹å› 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é—®é¢˜å‰–æ                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¸²æŸ“è¿›ç¨‹ (http://localhost:5177)                                 â”‚
â”‚       âœ— â”€â”€è¯·æ±‚â”€â”€> file:///Users/mac/PhotoMind/...              â”‚
â”‚       âœ— æµè§ˆå™¨å®‰å…¨ç­–ç•¥æ‹¦æˆª                                       â”‚
â”‚                                                                 â”‚
â”‚  æ ¹æœ¬åŸå› ï¼šåè®®ä¸Šä¸‹æ–‡ä¸åŒ¹é…                                      â”‚
â”‚  - Vite å¼€å‘æœåŠ¡å™¨: http:// å®‰å…¨ä¸Šä¸‹æ–‡                           â”‚
â”‚  - æœ¬åœ°æ–‡ä»¶è·¯å¾„: file:// å®‰å…¨ä¸Šä¸‹æ–‡                             â”‚
â”‚  - ä¸¤è€…äº’ä¸ä¿¡ä»»                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å½“å‰ä»£ç é—®é¢˜

**å—å½±å“æ–‡ä»¶** (6+ ä¸ªç»„ä»¶ä½¿ç”¨ `file://` å‰ç¼€)ï¼š

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ä»£ç  |
|------|------|----------|
| `src/renderer/components/PhotoGrid.vue` | 72-73 | `return encodeURI('file://' + photo.thumbnailPath)` |
| `src/renderer/views/PhotosView.vue` | 149 | åŒä¸Š |
| `src/renderer/views/SearchView.vue` | 108 | åŒä¸Š |
| `src/renderer/views/TimelineView.vue` | 179 | åŒä¸Š |
| `src/renderer/views/PhotoDetailView.vue` | 236 | åŒä¸Š |
| `src/renderer/components/album/CoverPhotoSelector.vue` | 87 | åŒä¸Š |
| `src/renderer/components/search/SearchResults.vue` | 44 | åŒä¸Š |

---

## Story E-07.1: ä¿®å¤ç¼©ç•¥å›¾æœ¬åœ°èµ„æºåŠ è½½é—®é¢˜

**Status**: âœ… Completed (Dev Agent: Amelia)

### User Story

As a ç”¨æˆ·,
I want æˆåŠŸæŸ¥çœ‹å¯¼å…¥çš„ç…§ç‰‡ç¼©ç•¥å›¾,
So that æˆ‘å¯ä»¥æ­£å¸¸æµè§ˆå’Œç®¡ç†æˆ‘çš„ç…§ç‰‡åº“

### Acceptance Criteria

**Given** ç”¨æˆ·å·²å¯¼å…¥ç…§ç‰‡åˆ° PhotoMind
**When** ç”¨æˆ·æŸ¥çœ‹"æœ€è¿‘ç…§ç‰‡"ã€ç›¸å†Œã€æ—¶é—´çº¿ç­‰é¡µé¢
**Then** æ‰€æœ‰ç…§ç‰‡ç¼©ç•¥å›¾åº”æ­£å¸¸æ˜¾ç¤º
**And** æ§åˆ¶å°ä¸åº”å‡ºç° `Not allowed to load local resource` é”™è¯¯
**And** ç¼©ç•¥å›¾åŠ è½½åº”ä¿æŒé«˜æ€§èƒ½

**Given** ç…§ç‰‡ç¼©ç•¥å›¾è·¯å¾„ä¸º `/Users/mac/PhotoMind/data/cache/thumbnails/xxx.jpg`
**When** æ¸²æŸ“è¿›ç¨‹è¯·æ±‚æ˜¾ç¤ºè¯¥å›¾ç‰‡
**Then** ç³»ç»Ÿåº”é€šè¿‡å®‰å…¨åè®®åŠ è½½å›¾ç‰‡
**And** ä¸åº”ä½¿ç”¨ `file://` ç›´æ¥è®¿é—®ï¼ˆè¢«æµè§ˆå™¨å®‰å…¨ç­–ç•¥æ‹¦æˆªï¼‰

**Given** åº”ç”¨è¿è¡Œåœ¨ Electron + Vite å¼€å‘ç¯å¢ƒ
**When** åŠ è½½æœ¬åœ°èµ„æº
**Then** åº”ä½¿ç”¨è‡ªå®šä¹‰åè®® `local-resource://` è¿›è¡Œæ˜ å°„
**And** ä¸»è¿›ç¨‹åº”æ³¨å†Œè¯¥åè®®å¹¶å¤„ç†æ–‡ä»¶è¯·æ±‚
**And** CSP åº”å…è®¸æ–°åè®®åŠ è½½å›¾ç‰‡

---

## Technical Approach

### æ¨èè§£å†³æ–¹æ¡ˆï¼šè‡ªå®šä¹‰åè®® (Custom Protocol)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è‡ªå®šä¹‰åè®®æ–¹æ¡ˆæ¶æ„å›¾                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  æ¸²æŸ“è¿›ç¨‹ (http://localhost:5177)                               â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”‚ getPhotoUrl() è½¬æ¢                                      â”‚
â”‚       â–¼                                                         â”‚
â”‚  local-resource:///Users/mac/PhotoMind/cache/thumbnails/xxx.jpg â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”‚ Electron å®‰å…¨ç™½åå•                                      â”‚
â”‚       â–¼                                                         â”‚
â”‚  ä¸»è¿›ç¨‹ protocol.handle() æ˜ å°„                                   â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  ç£ç›˜è¯»å– â†’ è¿”å› blob                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°æ­¥éª¤

1. **ä¸»è¿›ç¨‹æ³¨å†Œè‡ªå®šä¹‰åè®®** (`electron/main/index.ts`)
   - æ³¨å†Œ `local-resource://` åè®®
   - å®ç° `protocol.registerFileProtocol` å¤„ç†å‡½æ•°
   - å°† `local-resource://` è·¯å¾„æ˜ å°„åˆ°ç£ç›˜è·¯å¾„

2. **åˆ›å»ºè·¯å¾„è½¬æ¢å·¥å…·å‡½æ•°** (`src/renderer/utils/localResource.ts`)
   - å°†ç»å¯¹è·¯å¾„è½¬æ¢ä¸º `local-resource://` æ ¼å¼
   - ç»Ÿä¸€å¤„ç†æ‰€æœ‰ç»„ä»¶çš„å›¾ç‰‡ URL è½¬æ¢

3. **æ›´æ–°æ‰€æœ‰å—å½±å“çš„ Vue ç»„ä»¶**
   - `PhotoGrid.vue`
   - `PhotosView.vue`
   - `SearchView.vue`
   - `TimelineView.vue`
   - `PhotoDetailView.vue`
   - `CoverPhotoSelector.vue`
   - `SearchResults.vue`

4. **æ›´æ–° CSP é…ç½®**
   - åœ¨ `electron/main/index.ts` ä¸­æ·»åŠ  `local-resource:` åˆ° `img-src`
   - ç¡®ä¿ Vite å¼€å‘æœåŠ¡å™¨å…è®¸æ–°åè®®

### å…³é”®æ–‡ä»¶å˜æ›´

| æ–‡ä»¶ | æ“ä½œ | æè¿° |
|------|------|------|
| `electron/main/index.ts` | ä¿®æ”¹ | æ³¨å†Œè‡ªå®šä¹‰åè®®ï¼Œä¿®æ”¹ CSP |
| `src/renderer/utils/localResource.ts` | æ–°å»º | è·¯å¾„è½¬æ¢å·¥å…·å‡½æ•° |
| `src/renderer/components/PhotoGrid.vue` | ä¿®æ”¹ | ä½¿ç”¨æ–°åè®®åŠ è½½å›¾ç‰‡ |
| `src/renderer/views/PhotosView.vue` | ä¿®æ”¹ | ä½¿ç”¨æ–°åè®®åŠ è½½å›¾ç‰‡ |
| `src/renderer/views/SearchView.vue` | ä¿®æ”¹ | ä½¿ç”¨æ–°åè®®åŠ è½½å›¾ç‰‡ |
| `src/renderer/views/TimelineView.vue` | ä¿®æ”¹ | ä½¿ç”¨æ–°åè®®åŠ è½½å›¾ç‰‡ |
| `src/renderer/views/PhotoDetailView.vue` | ä¿®æ”¹ | ä½¿ç”¨æ–°åè®®åŠ è½½å›¾ç‰‡ |
| `src/renderer/components/album/CoverPhotoSelector.vue` | ä¿®æ”¹ | ä½¿ç”¨æ–°åè®®åŠ è½½å›¾ç‰‡ |
| `src/renderer/components/search/SearchResults.vue` | ä¿®æ”¹ | ä½¿ç”¨æ–°åè®®åŠ è½½å›¾ç‰‡ |

### å®‰å…¨è€ƒè™‘

- âœ… ç¬¦åˆ Electron å®˜æ–¹å®‰å…¨æœ€ä½³å®è·µ
- âœ… å¯é‡æ–°å¯ç”¨ `webSecurity: true`
- âœ… ä»…æš´éœ²ç‰¹å®šåè®®çš„è®¿é—®æƒé™
- âœ… ä¿æŒæ¶æ„æ¸…æ™°æ€§

---

## Dependencies

- æ— å¤–éƒ¨ä¾èµ–
- ä½¿ç”¨ Electron å†…ç½® `protocol` API

---

## Risks

| é£é™© | çº§åˆ« | ç¼“è§£æªæ–½ |
|------|------|----------|
| åè®®æ³¨å†Œæ—¶æœºé—®é¢˜ | ä¸­ | ç¡®ä¿åœ¨ `app.whenReady()` åæ³¨å†Œ |
| Windows/Linux è·¯å¾„æ ¼å¼å·®å¼‚ | ä½ | ä½¿ç”¨ `path` æ¨¡å—ç»Ÿä¸€å¤„ç† |
| CSP ç­–ç•¥å†²çª | ä½ | æµ‹è¯•ç¯å¢ƒä¸¥æ ¼éªŒè¯ |

---

## Test Strategy

### æµ‹è¯•ç”¨ä¾‹

1. **åŠŸèƒ½æµ‹è¯•**
   - [ ] éªŒè¯ç¼©ç•¥å›¾åœ¨æ‰€æœ‰é¡µé¢æ­£å¸¸æ˜¾ç¤º
   - [ ] éªŒè¯æ§åˆ¶å°æ—  `Not allowed to load local resource` é”™è¯¯
   - [ ] éªŒè¯å¯¼å…¥æ–°ç…§ç‰‡åç¼©ç•¥å›¾æ­£ç¡®æ˜¾ç¤º

2. **è·¨å¹³å°æµ‹è¯•**
   - [ ] macOS éªŒè¯
   - [ ] Windows éªŒè¯ï¼ˆè·¯å¾„æ ¼å¼å·®å¼‚ï¼‰
   - [ ] Linux éªŒè¯

3. **å›å½’æµ‹è¯•**
   - [ ] ç¡®ä¿æœç´¢ç»“æœæ˜¾ç¤ºç¼©ç•¥å›¾
   - [ ] ç¡®ä¿æ—¶é—´çº¿è§†å›¾æ˜¾ç¤ºç¼©ç•¥å›¾
   - [ ] ç¡®ä¿ç›¸å†Œå°é¢æ˜¾ç¤ºæ­£ç¡®

---

## Out of Scope

- ç¼©ç•¥å›¾ç”Ÿæˆé€»è¾‘ï¼ˆå·²åœ¨ E-01.3 å®ç°ï¼‰
- ç…§ç‰‡å¯¼å…¥åŠŸèƒ½ï¼ˆå·²åœ¨ E-01.1 å®ç°ï¼‰
- äººç‰©ç›¸å…³ç¼©ç•¥å›¾ï¼ˆå·²åœ¨ E-04.x å®ç°ï¼‰

---

## Effort Estimate

| ä»»åŠ¡ | ä¼°è®¡æ—¶é—´ |
|------|----------|
| ä¸»è¿›ç¨‹åè®®æ³¨å†Œ | 30 åˆ†é’Ÿ |
| å·¥å…·å‡½æ•°åˆ›å»º | 15 åˆ†é’Ÿ |
| ç»„ä»¶æ›´æ–°ï¼ˆ7ä¸ªæ–‡ä»¶ï¼‰ | 45 åˆ†é’Ÿ |
| CSP é…ç½®æ›´æ–° | 15 åˆ†é’Ÿ |
| æµ‹è¯•éªŒè¯ | 30 åˆ†é’Ÿ |
| **æ€»è®¡** | **~2 å°æ—¶** |
