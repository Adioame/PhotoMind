# 3. 功能需求

## 3.1 FR-01: 照片导入

### 描述

系统应支持从多种来源导入照片，包括 iCloud Photos Library 和本地文件系统。

### 需求详情

| 编号 | 需求描述 | 验收标准 |
|------|----------|----------|
| FR-01.1 | iCloud 照片选择 | 用户可以选择 iCloud 照片库 |
| FR-01.2 | iCloud 照片同步 | 同步 iCloud 中的照片到本地 |
| FR-01.3 | 本地文件夹导入 | 用户可以选择本地文件夹批量导入 |
| FR-01.4 | 支持的照片格式 | JPG, PNG, HEIC, RAW |
| FR-01.5 | 进度显示 | 显示导入进度和状态 |
| FR-01.6 | 元数据提取 | 自动提取 EXIF 日期、位置、设备信息 |

## 3.2 FR-02: 自然语言搜索

### 描述

系统应支持用户使用自然语言描述搜索照片，LLM 理解查询意图并结合 CLIP 向量搜索返回相关照片。

### 搜索架构

```
用户查询: "去年在海边的照片"
    ↓
┌─────────────────────────────────────────┐
│  Step 1: LLM 解析                       │
│  - 提取时间条件: 去年                    │
│  - 提取地点条件: 海边                    │
│  - 解析语义意图: 温暖、阳光、度假氛围    │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Step 2: 混合搜索策略                   │
│  A. 关键词搜索: 满足时间和地点条件的照片 │
│  B. 向量搜索: 语义相似度 top-K 结果      │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Step 3: 结果融合                       │
│  - 加权融合 (关键词 60% + 向量 40%)     │
│  - 去重处理                             │
│  - 置信度排序                           │
└─────────────────────────────────────────┘
    ↓
返回最终排序结果
```

### 需求详情

| 编号 | 需求描述 | 验收标准 |
|------|----------|----------|
| FR-02.1 | 自然语言输入 | 支持任意自然语言查询 |
| FR-02.2 | LLM 解析 | 调用 LLM API 解析查询意图 |
| FR-02.3 | 时间条件解析 | 支持"去年"、"上个月"、"2024年"等 |
| FR-02.4 | 地点条件解析 | 支持地点名称、相对位置 |
| FR-02.5 | 语义意图提取 | 提取描述性关键词用于向量搜索 |
| FR-02.6 | 关键词搜索 | 基于解析条件执行 SQL 查询 |
| FR-02.7 | 全局向量搜索 | 在整个照片库执行语义相似度搜索 |
| FR-02.8 | 候选集向量搜索 | 在关键词结果中执行向量搜索 |
| FR-02.9 | 结果融合 | 关键词结果 + 向量结果加权合并 |
| FR-02.10 | 置信度排序 | 按综合置信度降序排列 |

## 3.3 FR-03: 语义搜索服务

### 描述

语义搜索服务集成 CLIP 模型，支持图片和文本的双向嵌入，实现真正的语义相似度搜索。

### 技术架构

```
┌─────────────────────────────────────────┐
│          CLIP Embedding Service         │
├─────────────────────────────────────────┤
│  textToEmbedding(text) → vector[512]  │
│  imageToEmbedding(imagePath) → vector  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│            向量搜索服务                  │
├─────────────────────────────────────────┤
│  searchByVector(queryVector) → photos  │
│  cosineSimilarity(v1, v2) → score      │
└─────────────────────────────────────────┘
```

### 需求详情

| 编号 | 需求描述 | 验收标准 |
|------|----------|----------|
| FR-03.1 | CLIP 模型加载 | 支持本地加载 CLIP 模型 |
| FR-03.2 | 文本转向量 | 自然语言查询转为 512 维向量 |
| FR-03.3 | 图片转向量 | 照片转为 CLIP 向量存储 |
| FR-03.4 | 向量存储 | 存入 SQLite vectors 表 |
| FR-03.5 | 余弦相似度搜索 | 在向量表中搜索相似向量 |
| FR-03.6 | 批量向量生成 | 遍历照片库生成所有向量 |
| FR-03.7 | 增量向量生成 | 新照片导入时自动生成向量 |

## 3.4 FR-04: 人物管理与搜索

### 描述

系统应支持人物的手动标记和自动人脸识别，让用户能通过人物名称搜索照片。

### 人物管理流程

```
┌─────────────────────────────────────────┐
│  Step 1: 手动标记                        │
│  - 用户选择照片                          │
│  - 添加人物标签（姓名）                  │
│  - 系统提取人脸特征                     │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Step 2: 自动识别                       │
│  - 新照片导入时自动检测人脸              │
│  - 与已知人物特征比对                   │
│  - 高置信度自动关联                     │
│  - 低置信度提示用户确认                 │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Step 3: 智能命名                       │
│  - 基于照片元数据推断姓名                │
│  - 用户可修正和确认                     │
└─────────────────────────────────────────┘
```

### 需求详情

| 编号 | 需求描述 | 验收标准 |
|------|----------|----------|
| FR-04.1 | 手动标记人物 | 用户可为照片添加人物标签 |
| FR-04.2 | 人脸特征提取 | 标记时自动提取人脸编码 |
| FR-04.3 | 自动人脸检测 | 导入时自动检测照片中的人脸 |
| FR-04.4 | 人脸自动匹配 | 与已知人物特征比对并关联 |
| FR-04.5 | 置信度提示 | 低置信度匹配需用户确认 |
| FR-04.6 | 人物搜索 | 支持"妈妈的照片"、"和爸爸的合影" |
| FR-04.7 | 人物相册 | 自动生成人物照片合集 |
